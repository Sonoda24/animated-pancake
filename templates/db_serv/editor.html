{% load static %}
<!DOCTYPE html>
<!--html lang="ja" class="notranslate" translate="no" -->
<!-- html lang="en" -->
<head>
  <title>SVG Editor</title>
  <!-- meta name="google" content="notranslate" / -->
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <script type="text/javascript" src="https://d3js.org/d3.v5.min.js"></script>
  <link rel="shortcut icon" href="favicon.ico">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
  <!--Bootstrap４を３に変え下記３行の変更でBottomメニュー可能となる-->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

  <!-- link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous" -->
  <!--link rel="stylesheet" href="{% static 'icomoon/style.css' %}">
  <!-- script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script -->
　<!-- script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="  crossorigin="anonymous"></script-->
  <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
  <!-- script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/canvg/1.5/canvg.js"></script>
  <!-- script type="text/javascript" src="{% static 'js/cmanCP_v091.js' %}" --></script>
  <!--script type="text/javascript" src="{% static 'js/Select_comb.js' %}"></script><!-- for combobox -->
  <!--script type="text/javascript" src="{% static 'js/rgbcolor.js' %}"></script><!-- for color 変換 -->
  <script type="text/javascript" src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
  <!--　下記３行はDialog表示で必要　-->
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script>
/**
 * A class to parse color values
 * @author Stoyan Stefanov <sstoo@gmail.com>
 * @link   http://www.phpied.com/rgb-color-parser-in-javascript/
 * @license MIT license
 */
function RGBColor(color_string)
{
    this.ok = false;

    // strip any leading #
    if (color_string.charAt(0) == '#') { // remove # if any
        color_string = color_string.substr(1,6);
    }

    color_string = color_string.replace(/ /g,'');
    color_string = color_string.toLowerCase();

    // before getting into regexps, try simple matches
    // and overwrite the input
    var simple_colors = {
        aliceblue: 'f0f8ff',
        antiquewhite: 'faebd7',
        aqua: '00ffff',
        aquamarine: '7fffd4',
        azure: 'f0ffff',
        beige: 'f5f5dc',
        bisque: 'ffe4c4',
        black: '000000',
        blanchedalmond: 'ffebcd',
        blue: '0000ff',
        blueviolet: '8a2be2',
        brown: 'a52a2a',
        burlywood: 'deb887',
        cadetblue: '5f9ea0',
        chartreuse: '7fff00',
        chocolate: 'd2691e',
        coral: 'ff7f50',
        cornflowerblue: '6495ed',
        cornsilk: 'fff8dc',
        crimson: 'dc143c',
        cyan: '00ffff',
        darkblue: '00008b',
        darkcyan: '008b8b',
        darkgoldenrod: 'b8860b',
        darkgray: 'a9a9a9',
        darkgreen: '006400',
        darkkhaki: 'bdb76b',
        darkmagenta: '8b008b',
        darkolivegreen: '556b2f',
        darkorange: 'ff8c00',
        darkorchid: '9932cc',
        darkred: '8b0000',
        darksalmon: 'e9967a',
        darkseagreen: '8fbc8f',
        darkslateblue: '483d8b',
        darkslategray: '2f4f4f',
        darkturquoise: '00ced1',
        darkviolet: '9400d3',
        deeppink: 'ff1493',
        deepskyblue: '00bfff',
        dimgray: '696969',
        dodgerblue: '1e90ff',
        feldspar: 'd19275',
        firebrick: 'b22222',
        floralwhite: 'fffaf0',
        forestgreen: '228b22',
        fuchsia: 'ff00ff',
        gainsboro: 'dcdcdc',
        ghostwhite: 'f8f8ff',
        gold: 'ffd700',
        goldenrod: 'daa520',
        gray: '808080',
        green: '008000',
        greenyellow: 'adff2f',
        honeydew: 'f0fff0',
        hotpink: 'ff69b4',
        indianred : 'cd5c5c',
        indigo : '4b0082',
        ivory: 'fffff0',
        khaki: 'f0e68c',
        lavender: 'e6e6fa',
        lavenderblush: 'fff0f5',
        lawngreen: '7cfc00',
        lemonchiffon: 'fffacd',
        lightblue: 'add8e6',
        lightcoral: 'f08080',
        lightcyan: 'e0ffff',
        lightgoldenrodyellow: 'fafad2',
        lightgrey: 'd3d3d3',
        lightgreen: '90ee90',
        lightpink: 'ffb6c1',
        lightsalmon: 'ffa07a',
        lightseagreen: '20b2aa',
        lightskyblue: '87cefa',
        lightslateblue: '8470ff',
        lightslategray: '778899',
        lightsteelblue: 'b0c4de',
        lightyellow: 'ffffe0',
        lime: '00ff00',
        limegreen: '32cd32',
        linen: 'faf0e6',
        magenta: 'ff00ff',
        maroon: '800000',
        mediumaquamarine: '66cdaa',
        mediumblue: '0000cd',
        mediumorchid: 'ba55d3',
        mediumpurple: '9370d8',
        mediumseagreen: '3cb371',
        mediumslateblue: '7b68ee',
        mediumspringgreen: '00fa9a',
        mediumturquoise: '48d1cc',
        mediumvioletred: 'c71585',
        midnightblue: '191970',
        mintcream: 'f5fffa',
        mistyrose: 'ffe4e1',
        moccasin: 'ffe4b5',
        navajowhite: 'ffdead',
        navy: '000080',
        oldlace: 'fdf5e6',
        olive: '808000',
        olivedrab: '6b8e23',
        orange: 'ffa500',
        orangered: 'ff4500',
        orchid: 'da70d6',
        palegoldenrod: 'eee8aa',
        palegreen: '98fb98',
        paleturquoise: 'afeeee',
        palevioletred: 'd87093',
        papayawhip: 'ffefd5',
        peachpuff: 'ffdab9',
        peru: 'cd853f',
        pink: 'ffc0cb',
        plum: 'dda0dd',
        powderblue: 'b0e0e6',
        purple: '800080',
        red: 'ff0000',
        rosybrown: 'bc8f8f',
        royalblue: '4169e1',
        saddlebrown: '8b4513',
        salmon: 'fa8072',
        sandybrown: 'f4a460',
        seagreen: '2e8b57',
        seashell: 'fff5ee',
        sienna: 'a0522d',
        silver: 'c0c0c0',
        skyblue: '87ceeb',
        slateblue: '6a5acd',
        slategray: '708090',
        snow: 'fffafa',
        springgreen: '00ff7f',
        steelblue: '4682b4',
        tan: 'd2b48c',
        teal: '008080',
        thistle: 'd8bfd8',
        tomato: 'ff6347',
        turquoise: '40e0d0',
        violet: 'ee82ee',
        violetred: 'd02090',
        wheat: 'f5deb3',
        white: 'ffffff',
        whitesmoke: 'f5f5f5',
        yellow: 'ffff00',
        yellowgreen: '9acd32'
    };
    for (var key in simple_colors) {
        if (color_string == key) {
            color_string = simple_colors[key];
        }
    }
    // emd of simple type-in colors

    // array of color definition objects
    var color_defs = [
        {
            re: /^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,
            example: ['rgb(123, 234, 45)', 'rgb(255,234,245)'],
            process: function (bits){
                return [
                    parseInt(bits[1]),
                    parseInt(bits[2]),
                    parseInt(bits[3])
                ];
            }
        },
        {
            re: /^(\w{2})(\w{2})(\w{2})$/,
            example: ['#00ff00', '336699'],
            process: function (bits){
                return [
                    parseInt(bits[1], 16),
                    parseInt(bits[2], 16),
                    parseInt(bits[3], 16)
                ];
            }
        },
        {
            re: /^(\w{1})(\w{1})(\w{1})$/,
            example: ['#fb0', 'f0f'],
            process: function (bits){
                return [
                    parseInt(bits[1] + bits[1], 16),
                    parseInt(bits[2] + bits[2], 16),
                    parseInt(bits[3] + bits[3], 16)
                ];
            }
        }
    ];

    // search through the definitions to find a match
    for (var i = 0; i < color_defs.length; i++) {
        var re = color_defs[i].re;
        var processor = color_defs[i].process;
        var bits = re.exec(color_string);
        if (bits) {
            channels = processor(bits);
            this.r = channels[0];
            this.g = channels[1];
            this.b = channels[2];
            this.ok = true;
        }

    }

    // validate/cleanup values
    this.r = (this.r < 0 || isNaN(this.r)) ? 0 : ((this.r > 255) ? 255 : this.r);
    this.g = (this.g < 0 || isNaN(this.g)) ? 0 : ((this.g > 255) ? 255 : this.g);
    this.b = (this.b < 0 || isNaN(this.b)) ? 0 : ((this.b > 255) ? 255 : this.b);

    // some getters
    this.toRGB = function () {
        return 'rgb(' + this.r + ', ' + this.g + ', ' + this.b + ')';
    }
    this.toHex = function () {
        var r = this.r.toString(16);
        var g = this.g.toString(16);
        var b = this.b.toString(16);
        if (r.length == 1) r = '0' + r;
        if (g.length == 1) g = '0' + g;
        if (b.length == 1) b = '0' + b;
        return '#' + r + g + b;
    }

    // help
    this.getHelpXML = function () {

        var examples = new Array();
        // add regexps
        for (var i = 0; i < color_defs.length; i++) {
            var example = color_defs[i].example;
            for (var j = 0; j < example.length; j++) {
                examples[examples.length] = example[j];
            }
        }
        // add type-in colors
        for (var sc in simple_colors) {
            examples[examples.length] = sc;
        }

        var xml = document.createElement('ul');
        xml.setAttribute('id', 'rgbcolor-examples');
        for (var i = 0; i < examples.length; i++) {
            try {
                var list_item = document.createElement('li');
                var list_color = new RGBColor(examples[i]);
                var example_div = document.createElement('div');
                example_div.style.cssText =
                        'margin: 3px; '
                        + 'border: 1px solid black; '
                        + 'background:' + list_color.toHex() + '; '
                        + 'color:' + list_color.toHex()
                ;
                example_div.appendChild(document.createTextNode('test'));
                var list_item_value = document.createTextNode(
                    ' ' + examples[i] + ' -> ' + list_color.toRGB() + ' -> ' + list_color.toHex()
                );
                list_item.appendChild(example_div);
                list_item.appendChild(list_item_value);
                xml.appendChild(list_item);

            } catch(e){}
        }
        return xml;

    }

}

/**
 * 選択肢クラス
 * @param parentValue 親の値(null:いつでも表示)
 * @param text 表示テキスト
 * @param value 値
 * @param style ＣＳＳ(省略可)
 */
function SelectOption(parentValue, text, value, style) {
  
  this.parentValue = parentValue;
  
  this.setOption = function() {
    this.text = text;
    this.value = value;
    if(style) {
      this.style.cssText = style;
    }
  };
  
  return this;
}

/**
 * セレクトボックスクラス
 * @param id セレクトボックスID
 */
function SelectBox(id) {
  
  /**
   * IDに対応オブジェクトを取得
   * @return オブジェクトorNULL
   */
//console.log('SelectBox'+id);
  function getObject() {
    var obj = document.getElementById(id);
    if(!obj.options && ( (typeof obj.length) == "number") ) {
      if(obj.length > 0) {
        obj = obj[0];
      } else {
        obj = null;
      }
    }
    return obj;
  }
  
  // オプションのリスト
  var options = [];
  
  /**
   * オプション登録
   * @param condition 表示条件
   */
  this.registOption = function(option) {
//console.log('registOption');
    options[options.length] = option;
  };
  
  // 子のオブジェクト
  var child = null;
  
  /**
   * 子のオブジェクトを設定する
   * @param childObj 子のオブジェクト
   */
  this.setChild = function(childObj) {
//console.log(this,'setChild');
    child = childObj;
  };
  
  /**
   * オプション反映
   * @param parentValue 親の値(null:全部表示)
   * ※比較に==を使っているのでundefinedもnullと等しく扱われる。
   */
  this.make = function(parentValue) {
//console.log(this,'this.make');
    var obj = getObject();
//console.log(obj);
    if(obj) {
      // 選択肢削除
      obj.options.length = 0;
      // 表示すべき選択肢抽出
      var opt = (parentValue != null) ? [] : options;
      if(parentValue != null) {
        for(var i = 0; i < options.length; i++) {
          if( (options[i].parentValue == null) || (options[i].parentValue == parentValue) ) {
            opt[opt.length] = options[i];
          }
        }
      }
      // 選択肢反映
      obj.options.length = opt.length;
      for(var i = 0; i < opt.length; i++) {
//console.log('setOption=',i);
        opt[i].setOption.call(obj.options[i]);
      }
      // 子のオブジェクトにも連鎖反映
      if(child) {
        child.make(obj.value);
      }
    }
  };
  
  return this;
}

</script>
<style>
@font-face {
  font-family: 'icomoon';
  src:  url('fonts/icomoon.eot?28vvx5');
  src:  url('fonts/icomoon.eot?28vvx5#iefix') format('embedded-opentype'),
    url('fonts/icomoon.ttf?28vvx5') format('truetype'),
    url('fonts/icomoon.woff?28vvx5') format('woff'),
    url('fonts/icomoon.svg?28vvx5#icomoon') format('svg');
  font-weight: normal;
  font-style: normal;
  font-display: block;
}

[class^="icon-"], [class*=" icon-"] {
  /* use !important to prevent issues with browser extensions that change fonts */
  font-family: 'icomoon' !important;
  speak: never;
  font-style: normal;
  font-weight: normal;
  font-variant: normal;
  text-transform: none;
  line-height: 1;

  /* Better Font Rendering =========== */
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.icon-home3:before {
  content: "\e902";
}
.icon-pen:before {
  content: "\e908";
}
.icon-camera:before {
  content: "\e90f";
}
.icon-stack:before {
  content: "\e92e";
}
.icon-folder-open:before {
  content: "\e930";
}
.icon-database:before {
  content: "\e964";
}
.icon-undo:before {
  content: "\e965";
}
.icon-redo:before {
  content: "\e966";
}
.icon-spinner3:before {
  content: "\e97c";
}
.icon-list-numbered:before {
  content: "\e9b9";
}
.icon-list:before {
  content: "\e9ba";
}
.icon-list2:before {
  content: "\e9bb";
}
.icon-link:before {
  content: "\e9cb";
}

</style>
<style>
            @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP&display=swap');
            @import url('https://fonts.googleapis.com/css2?family=Open+Sans&display=swap');
            @import url('https://fonts.googleapis.com/css2?family=Kaisei+Opti&display=swap');
            @import url('https://fonts.googleapis.com/css2?family=Reggae+One&display=swap');
            @import url('https://fonts.googleapis.com/css2?family=Kaushan+Script&display=swap');
* { 
    margin: 0px; 
    padding: 0px; 
}
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: auto;
	    font-family: "Noto Serif JP",sans-serif;
        }
	.container-fluid {
            margin: 0;
            padding: 0;
	}
        .row {
            margin: 0;
            padding: 0;
        }
        nav.mt-3 {
	    margin-top: 0 !important;
	    padding: 0;
        }
        .tool {
  	    display: flex;
        }
        .menu {
  	    display: flex;
        }
        .navbar {
	    height: 30px;
	    min-height: 30px;
	}

* {box-sizing: border-box;}
.tool , .tool form , .tool div .tool button .menu , .menu00 .menu01 .menu02 .menu03 {
	display:inline-block;  
	display: flex;
	}
 .tool select{
		font-family: fontAwesome;
	/*	height:30px;  */
		position: relative; top: 0;
		width:100px;
		margine:0px;
		padding:0px;
/*	background-color: #4CAF50; */
	background-color: #337ab7;
	color: #fff;
	}
 .tool button{
		font-family: fontAwesome;
	/*	height:30px;  */
		margine:0px;
		padding:0px;
/*	background-color: #4CAF50;  */
	background-color: #337ab7;
	color: #fff;
	}
 .tool select:hover {
	opacity: 0.6;
}
 .tool button:hover {
	opacity: 0.6;
}

.Thtm {
  position: absolute;
  left: 20px; top: 0px;
  padding:0 0px 0 0px;
  width: 1200px;
  height: auto;
  outline: none;
}
.Tvis {
  position: absolute;
  left: 20px; top: 0px;
  padding:0 0px 0 0px;
  width:1200px;
  height:auto;
  z-index: 30;
  opacity: 0.;
  outline: none;
}

.canv {
  z-index:20;
  padding:0px;
  left: -20px;
  margin:0px;
  width:1200px;
  position: absolute;
  opacity: 0.;  
}

.canv2 {
  z-index:20;
  margin:0px;
  padding;0px;
  position: absolute;
}

.my_button {
  display: block;
  width: 100px;
  height: 36px;
  margin: 10px 10px 10px 10px; /* 外側の時計回りの余白 */
  text-align: center;
  color: #fff;
  line-height: 36px;
  text-decoration: none;
  background-color: #69c;
  border: 1px solid #69c;
  border-radius: 5px;
  float: left;
}
.my_button:hover {color:#ffffff; background:#0000cc;}


.flex_box {
    display: flex;              /* フレックスボックスにする */
    align-items:stretch;        /* 縦の位置指定 */
}

.colm_flex {
    display: flex;              /* フレックスボックスにする */
    flex-direction:column;        /* 縦の位置指定 */
}


.point_none {
  pointer-events:none;
}
.point_auto {
  pointer-events: auto;
}

.select_none {
  user-select:none;
}

.select_auto {
  user-select:auto;
}
.mgr-50{
    margin-right : 50px;
}

#trig1{
	height:25px;
        background-color:#ffffdd;
}
#trig2{
	height:25px;
        background-color:#ffffdd;
}
#trig3{
	height:25px;
        background-color:#ffffdd;
}
#svgtrig1{
	height:25px;
        background-color:#ffffdd;
}
#svgtrig2{
	height:25px;
        background-color:#ffffdd;
}

#svgtrig3{
	height:25px;
        background-color:#ffffdd;
}

.file {
    display: inline-block;
    overflow: hidden;
    position: relative;
    box-sizing: border-box;
    padding: 6 -6 6 -6px;
    margin:-6px;
/*    padding: 1em;  */
    border: 1px solid #000;
}
 
.file input[type="file"] {
    opacity: 0;  
    filter: progid:DXImageTransform.Microsoft.Alpha(opacity=0);
    position: absolute;
    right: 0;
    top: 0;
    margin: 0;
    font-size: 12px;
    cursor: pointer;
}

      #contextmenu_a {
        display:none;
        position:fixed;
        left:0px;
        top:0px;
        width:100px;
        height:160px;
        border:1px solid #000;
        background-color:#fff;
        list-style-position: inside;
  	z-index:1000;
      }
      #contextmenu_a li {
        cursor:pointer;
      }

      #contextmenu_c {
        display:none;
        position:fixed;
        left:0px;
        top:0px;
        width:130px;
        height:65px;
        border:1px solid #000;
        background-color:#fff;
        list-style-position: inside;
  	z-index:1000;
      }
      #contextmenu_c li{
        cursor:pointer;
      }

      #contextmenu_d {
        display:none;
        position:fixed;
        left:0px;
        top:0px;
        width:110px;
        height:100px;
        border:1px solid #000;
        background-color:#fff;
        list-style-position: inside;
  	z-index:1000;
      }
      #contextmenu_d li{
        cursor:pointer;
      }

      #contextmenu_e {
        display:none;
        position:fixed;
        left:0px;
        top:0px;
        width:130px;
        height:110px;
        border:1px solid #000;
        background-color:#fff;
        list-style-position: inside;
  	z-index:1000;
      }

      .contex:hover { 
	background-color: rgba(102, 102, 255, 0.50);
      }

/* PopUp Window に関する部分　*/
.dialog {
  overflow: hidden;
  position: absolute;
  top: 30%;
  height: auto;
  width: 300px;
  display: none;
  border:1px solid #aaa;
  z-index:1000;
}
.dialog-header {
  border: 1px solid #aaa;
  background: #cccccc;
  color: #222222;
  font-weight: bold;
  overflow: hidden;
/*  padding:5px;  */
}
.dialog-title {
  float: left;
}
.dialog-close {
  float: right;
  border: 1px solid #d3d3d3;
  background: #e6e6e6;
  font-weight: normal;
  color: #555555;
}
.dialog-content {
  position: relative;
  border: 0;
  padding: .5em 1em;
  background: #fff;
  overflow: auto;
  width: auto;
  height: auto;
  font-size:12px;
  font-weight:normal;
/* normal, bold, lighter, bolder */
  line-height:0.8;
}
/*  mouse handle              */
rect#rect01 {
    cursor: move;
}
/*
circle {
  stroke-width: 2;
  stroke: #f00;
  fill: #ff0;
}
*/
/*
circle:hover {
  stroke: #090;
  fill: #fff;
}
*/

.movable {   /* これは有効　下のhoverは効かない　*/
  pointer-events: all;
  cursor: pointer;
}

.draggable {   /* これは有効　下のhoverは効かない　*/
  pointer-events: all;
  background: #fee;
  cursor: move;
}

/*
.draggable:hover {
  backgroundColor : "orange";
}
*/

.btn:hover {
      background-color: rgba(102, 102, 255, 0.50);
    }

.wide {   /*　横方向拡大縮小　*/
  pointer-events: all;
  cursor: ew-resize;
}
.height {   /*　上下方向拡大縮小　*/
  pointer-events: all;
  cursor: ns-resize;
}
.ewcross {   /*　easte-west方向拡大縮小　*/
  pointer-events: all;
  cursor: nesw-resize;
}
.wecross {   /*　west-easte方向拡大縮小　*/
  pointer-events: all;
  cursor: nwse-resize;
}
.rotate {   /*　west-easte方向拡大縮小　*/
  pointer-events: all;
  cursor: all-scroll;
}
/*imgタグ関連　　　*/
.img_samp1     { border:solid 5px #000000}
.img_samp2     { border:double 5px #ff0000}
/* Icon説明の吹き出しのテスト　*/
 .my_link {
      position: relative;
    }
 .my_link:hover .my_link_ko {
      display: block;
    }
 .my_link:before {
      margin: 10px;
      font-family: "icomoon";
      content:"\e9cb";
    }
 .my_link .my_link_ko {
      position: relative;
      display: none;
      background-color: rgba(102, 102, 255, 0.50); 
      width:180px;                          /* 吹き出し全体の幅 */
      top:-50px;
      right: 20px;                             /*  left : -1%;  表示位置 */
      font-size: 80%;
    }

  /* SVGアイコン定義コンテナクラス */
  .svg-defs {
    width: 0;
    height: 0;
    visibility: hidden;
  }

  /* SVGアイコンクラス */
  .icon {
    width: 1.25em;
    height: 1.25em;
    fill: currentColor;
    position: relative;
    display: inline-block;
    vertical-align: baseline;
    /* baselineより垂直方向にちょっとだけ下げる */
    top: 0.125em;
  }
/*　#use_icon.icon:hover {  */
  　#use_icon {
  　stroke: #090;
  　fill: blue;
    border: 1px solid #dd0000;
    background: #dd0000;
    color:#fff;
　　}

  .show_icon {
    position:relative;
    left:500px;
    top:50px;
    width: 100px;
    height: 1000px;
  }

.my_navi ul {
  display: flex;
  flex-flow: column;
  margin: 0;
  padding: 6px;
  list-style-type: none;
}
.my_navi li.my_hamburger {
  align-self: flex-end;
}
.my_navi a {
  display: block;
  border-radius: 4px;
  padding: 12px 24px;
  color:white;
  background-color:blue;
  text-decoration: none;
}
.my_navi li a:hover {
  opacity: 0.6;
}

@media only screen and (min-width:550px) {
.my_navi ul {
    display: flex;
    flex-flow: row;
    margin: 0;
    padding: 6px;
    list-style-type: none;
  }

.my_navi li.my_hamburger {
     display: none;
  }

.noTitleDialog .ui-dialog-titlebar {display:none;}

}

.ui-dialog-titlebar {font-size:70%;}

    </style>
</head>
<body>
<nav class="navbar navbar-expand-sm navbar-dark navbar-default navbar-fixed-bottom">
<!-- nav class="navbar navbar-expand-sm navbar-primary navbar-default navbar-fixed-bottom" -->
    <div class="tool">
	<select id="fgedit" onchange="chng_mode()" style="width:100px; height:25px;" ></p>
	<option value="">表示のみ</option>
	<option value="">&#xf044;文書の編集</option>
	<option value="">&#xf1fe;Svg図の編集</option>
	<option value="" >Html言語</option>
	</select>
  <div class="menu">
    <div id="menu00" style="display:block;">
	　　　　　<button id="doc_innsatsu" onclick="doc_print()" style="width:60px;">&#xf02f; 印刷</button>
	　　　　　<button id="send_to_yourPc" onclick="To_your_Pc()" >あなたのPcへ</button>
	<button onclick="From_your_Pc()">あなたのPcから</button>
	<button id="mail_to_who"> メール送信 </button>

	　　　　　<select id="chan_title" onchange="change_titles()" style="width:60px; height:25px;" ></p>
    		<option value="origin"  selected="selected">日本語</option>
    		<option value="english">英語</option>
    		<option value="child">子供</option>
		<option value="favorit">お好み</option>
	</select>
    </div><!-- end menu00 -->
    <div id="menu01" style="display:none;">
	　　<button onclick="doc_save()">&#xf1c0; 保存</button>
	<!-- button onclick="doc_read()">読込み</button -->
	<button id="doc_new">新規</button>
	<button id="copy_new">&#xf0c5; Copy</button>
	<button onclick="pop_inp_search()">概要</button>
	<button id="chain_svg">新Svg</button>

	　　<button id="design_html">HTML設定</button>
	<button id="pallet_dialog">ﾊﾟﾚｯﾄ</button>
        <button id="trig1" style="color:#fff; opacity:0.8;">文字</button>
	<button id="trig2" style="color:#000; opacity:0.8;">背景</button>
	<button id="trig3" style="color:#000; opacity:0.8;">境界</button>
	<button id="html_undo"> &#xf0e2; </button>
	<button id="html_redo"> &#xf01e; </button>
	　　<!--button id="Tochara">色変更</button -->
	    <button id="Cr_to_Br" style="display:none;">Br</button>
	<button id="Br_to_Cr" style="display:none;">Cr</button>
	<button id="Spec_chars" style="display:none;">特殊</button>
	<button id="Google_chars" style="display:none;">G検索</button>
	<button id="link" style="display:none;">&#xf0c1; link</button>
	<select id="edit_Util" onchange="edit_Utility()" style="width:60px; height:25px;" ></p>
    		<option value="s000">utility</option>
    		<option value="s001">Br</option>
    		<option value="s002">Cr</option>
		<option value="s003">特殊</option>
		<option value="s004">Google取得</option>
		<option value="s005">&#xf0c1; link</option>
		<option value="s006">sys_parm</option>
		<option value="s007">repair_recipe</option>
	</select -->
	  <select id="Exp" onchange="export_mode()" style="width:60px; height:25px;" ></p>
		<option value="s_00">export</option>
		<option value="s_01">only svg</option>
		<option value="s_02">to html</option>
		<option value="s_02">dump</option>
	</select>
        <!-- button id="export_svg">export</button -->
        <!-- span id="cp02" onclick="cmanCP_JS_open(this)" cmanCPat="def_color:val=sample2,def_alpha:0,rc_text:sample2,rc_form:#16,rc_bg:cp02"></span>
        <!-- input type='text' value="#0000ff" id="sample2" style="width:60px; height:25px;" onchange="check_svgcolor()" -->
        <!-- label for="selfile"><input type="file" id="selfile">
	</label -->
	<!-- input type="file" id="selfile" -->
	<div class='file' style="display:none;">import<input type="file" id="svgfile" ></div>
	<div class='file' style="display:none;">import<input type="file" id="htmlfile" ></div>
	<select id="Imp" onchange="import_mode()" style="width:60px; height:25px;" ></p>
		<option value="s_00">import</option>
		<option value="s_01">from Net</option>
		<option value="s_02">from .svg</option>
		<option value="s_03">from .html</option>
	</select>
	<!--button id="set_navi">Menu設置</button -->
	<!--button id="html_outer">外部html</button -->
	　　<button id="E_clear">clear</button>
	<!-- select id="List" onchange="chng_list()" style="width:50px; height:25px;" ></p>
    		<option value="s001">List</option>
    		<option value="s002">&#xf0ca; </option>
    		<option value="s003">&#xf0cb; </option>
	</select -->
	<!--select id="image_set" onchange="set_image()" style="width:60px; height:25px;" ></p>
    		<option value="s001">画像</option>
    		<option value="s002">Local</option>
		<option value="s003">My_DB</option>
		<option value="s003">Space</option>
    		<option value="s004">配置etc</option>
    		<option value="s005">消去</option>
	</select -->
	<!--bbutton id="image_place">Image</button>
	<button id="image_db">Image_db</button -->
    </div><!-- end menu01 -->
    <div id="menu02" style="display:none;">
        　　<select name="svg_tag_menu" id="svg_tag_menu" onchange="chang_svg()" style="width:80px; height:25px;">
		<option value="svg_00">top_svg</option>
  	</select>
        <button id="jump_svg">Jump</button>
	<button id="pallet_dialog2">ﾊﾟﾚｯﾄ</button>
        <button id="svgtrig1"  style="color:#fff; opacity:0.8;">線色</button>
	<button id="svgtrig2"  style="color:#000; opacity:0.8;">塗色</button>
        <button id="svgtrig3"  style="color:#fff; opacity:0.8;">文字</button>
	<button id="svg_undo"> &#xf0e2; </button>
	<button id="svg_redo"> &#xf01e; </button>
        <!--select id="arrow" onchange="chng_arrow()" style="width:60px; height:25px;" ></p>
    		<option value="s001" selected>none</option>
    		<option value="s002">start</option>
		<option value="s003">end</option>
    		<option value="s004">both</option>
	</select>
        <select id="Lstyle" onchange="chng_Lstyle()" style="width:40px; height:25px;" ></p>
    		<option value="s001" selected>none</option>
    		<option value="s002">dash</option>
		<option value="s003">1dash</option>
    		<option value="s004">2dash</option>
	</select -->
	<!-- button id="resolv_svg">Resol</button -->
	　　<button id="draw_fig">描画</button>
        <select name="control" id="control" style="display:none;">
		<option value="none"></option>
		<option value="simp_line">simp</option>
    		<option value="seri_line">serial</option>
    		<option value="close_line">closed</option>
		<option value="smooth">smooth</option>
		<option value="close_smooth">c smooth</option>
    		<option value="free_smooth">free_smooth</option>
		<option value="quad_bezier">q bezier</option>
		<option value="cubic_bezier">c bezier</option>
    		<option value="free_line">free</option>
  	</select>
	<button id="basic_figure">図形</button>
        <button id="fig_sel_st">選択</button>
        <button id="fig_reshape">変形</button>
        <button id="fig_scale">拡縮</button>
        <button id="fig_copy">複製</button>
        <button id="fig_rotate">回転</button>
        <button id="fig_updown">反転</button>
        <button id="fig_sel_end">Quit</button>
        　<button id="fig_delete">削除</button>
        <button id="check_anime" style="display:none;">Check</button>
	　<select id="Util2" onchange="Utility2()" style="width:60px; height:25px;" ></p>
		<option value="s_00">others</option>
		<option value="s_01">回転degree</option>
		<option value="s_02">拡縮scale</option>
		<option value="s_03">check</option>
	  </select>
        <!-- select id="line_size" onchange="chng_width()" style="width:40px; height:25px;" ></p>
    		<option value="s001">1</option>
    		<option value="s002" selected>2</option>
		<option value="s003">4</option>
    		<option value="s004">8</option>
    		<option value="s005">12</option>
		<option value="s006">16</option>
		<option value="s006">24</option>
		<option value="s006">32</option>
		<option value="s006">50</option>
	</select -->
        <!-- button id="draw_mesh">mesh</button -->
	<!-- label for="selfile">import<input type="file" id="selfile">
	</label -->
        <button id="icon_gen" style="display:none;">basic</button>
        <button id="basic_fig" style="display:none;">basic</button>
        <button id="repair_recipe" style="display:none;">basic</button>
        <button id="sys_parms" style="display:none;">basic</button>
	<select id="Util" onchange="Utility()" style="width:60px; height:25px;" ></p>
		<option value="s_00">utility</option>
		<option value="a_00">icon_gen</option>
		<option value="a_01">fix</option>
		<option value="a_02">snap</option>
		<option value="s_01">basic</option>
		<option value="s_02">sys_parm</option>
		<option value="s_03">basic3</option>
	</select>
	　<svg class="icon"><use id="menu_show_icon" width="100%" height="100%" /></svg>
	<button id="clear">clear</button>
<!--input type="button" value="Job1" onClick="goScriptB(0)">
<input type="button" value="Job2" onClick="goScriptB(1)">
<input type="button" value="Job3" onClick="goScriptB(2)" -->
    </div><!-- end menu02 -->
    <div id="menu03" style="display:none;">
	<input type="button" value="Exe1" onClick="goScriptC(0)" >
	<input type="button" value="Exe2" onClick="goScriptC(1)" >
	<input type="button" value="Exe3" onClick="goScriptC(2)" >
	</div><!-- end menu03 -->
  </div><!-- End menu -->
 </div><!-- end Tool -->
</nav>

  <div class="main tab-content"><!-- Start main tab-content -->
  <div class="row">
    <!-- div class="col-sm-9" -->
    <div class="tab-pane" id="tab1"><!-- Start tab1 -->
<!-- //My Noteの拡張機能　system functionの起動メカニズム準備  -->
	<div id="sys_expand" style="display:none;">
		<button id="sys_exp_func01" style="display:none;" status="" parm="parm01" result="" ></button>
	   </div>
	<a id="JumpTo" href="#svg_00" style="display:none;"></a>
	<div id="wClone" style="display:none;"></div>
	<textarea id="area_From" style="display:none;">テキストをCopyする</textarea>
	<textarea id="area_To" style="display:none;"></textarea>
        <svg id="chain" class="canv" style="display:none;" width="1200px" height="1800px" version="1.1" xmlns="http://www.w3.org/2000/svg" >
	</svg>
        <!-- svg id="chain" class="canv" style="display:none;" viewBox="0 0 1080 2000" version="1.1" xmlns="http://www.w3.org/2000/svg" >
	</svg -->
        <svg id="mesh_canv" class="canv" width="1200px" height="1000px" version="1.1" xmlns="http://www.w3.org/2000/svg" >
	    <defs>
	      <marker id="bkwd_arw" viewBox="-10 -3 10 6" refX="-10" refY="0" markerWidth="10" markerHeight="6" orient="auto">
	        <path d="M -10 0 L 0 -3 L 0 3 Z"/>
	      </marker>
	      <marker id="fowd_arw" viewBox="0 -3 10 6" refX="10" refY="0" markerWidth="10" markerHeight="6" orient="auto">
	        <path d="M 0 -3 L 0 3 L 10 0 Z"/>
	      </marker>
	    </defs>
    	    <!--defs>
        	<style>
            		<![CDATA[@import url("https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300&display=swap");]]>
            		<![CDATA[@import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP&display=swap');]]>
            		<![CDATA[@import url('https://fonts.googleapis.com/css2?family=Open+Sans&display=swap');]]>
            		<![CDATA[@import url('https://fonts.googleapis.com/css2?family=Kaushan+Script&display=swap');]]>
            		<![CDATA[@import url('https://fonts.googleapis.com/css2?family=Fascinate&display=swap');]]>
        	</style>
    	    </defs -->
	</svg>
	<svg id="basic_svg" style="display:none;" version="1.1" xmlns="http://www.w3.org/2000/svg">
          <line id="line01" x1="100" y1="0" x2="100" y2="800" stroke="blue" stroke-width="5"/>
<!--Text   -->  <g fig="text" style="display:none;">
		  <!-- text text-anchor="start" font-size="14" stroke-width="0" rotate="0" style="display:block;" -->
		  <text text-anchor="start" font-size="14" style="display:block;">
			<tspan x="0" y="0" >Text</tspan>
		  </text>
		</g>
<!--circle -->  <g fig="path" close="close" smooth="smooth" class="none">
                  <path d="M100, 50C100, 58.93 97.77, 67.26 93.3, 75C88.84, 82.74 82.74, 88.84 75, 93.3C67.26, 97.77 58.93, 100 50, 100C41.07, 100 32.74, 97.77 25, 93.3C17.26, 88.84 11.16, 82.74 6.7, 75C2.23, 67.26 0, 58.93 0, 50C0, 41.07 2.23, 32.74 6.7, 25C11.16, 17.26 17.26, 11.16 25, 6.7C32.74, 2.23 41.07, 0 50, 0C58.93, 0 67.26, 2.23 75, 6.7C82.74, 11.16 88.84, 17.26 93.3, 25C97.77, 32.74 100, 41.07 100, 50 Z" style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
<!--smcirc -->  <g fig="path" close="close" smooth="smooth">
                  <path d="M30, 15C30, 17.68 29.33, 20.18 27.99, 22.5C26.65, 24.82 24.82, 26.65 22.5, 27.99C20.18, 29.33 17.68, 30 15, 30C12.32, 30 9.82, 29.33 7.5, 27.99C5.18, 26.65 3.35, 24.82 2.01, 22.5C0.67, 20.18 0, 17.68 0, 15C0, 12.32 0.67, 9.82 2.01, 7.5C3.35, 5.18 5.18, 3.35 7.5, 2.01C9.82, 0.67 12.32, 0 15, 0C17.68, 0 20.18, 0.67 22.5, 2.01C24.82, 3.35 26.65, 5.18 27.99, 7.5C29.33, 9.82 30, 12.32 30, 15 Z" style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
<!--ellips -->  <g fig="path" close="close" smooth="smooth">
		  <path d="M100,25 C99.36,30.02 97.13,34.19 93.3,37.5 C87.98,42.11 81.66,44.73 75,46.65 C66.83,49.01 58.48,50 50,50 C41.52,50 33.17,49.01 25,46.65 C18.34,44.73 12.02,42.11 6.7,37.5 C2.87,34.19 0,30.36 0,25 C0,19.64 2.87,15.81 6.7,12.5 C12.02,7.89 18.34,5.27 25,3.35 C33.17,0.99 41.52,0 50,0 C58.48,0 66.83,0.99 75,3.35 C81.66,5.27 87.98,7.89 93.3,12.5 C97.13,15.81 99.36,19.98 100,25 Z" style="stroke-width: 2px; stroke: rgb(0, 0, 0); fill: none;"></path></g>
<!--if     -->  <g fig="path" close="close" smooth="else">
		  <path d="M50,0 L0,25 L50,50 L100,25 L50,0 Z" style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
<!--rectLg -->  <g fig="path" close="close" smooth="else">
		<path d="M0,0 L0,100 L100,100 L100,0 L0,0 Z" style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
<!--rectSm -->  <g fig="path" close="close" smooth="else">
		  <path d="M0,0 L0,50 L100,50 L100,0 L0,0 Z" style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
<!--rectRLg-->  <g fig="path" close="close" smooth="trim 20">
		  <path d=" M0,2.5 0,97.5 M0,97.5 Q0,100 2.5,100 M2.5,100 97.5,100 M97.5,100 Q100,100 100,97.5 M100,97.5 100,2.5 M100,2.5 Q100,0 97.5,0 M97.5,0 2.5,0 M2.5,0 Q0,0 0,2.5 Z" style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
<!--rectRSm-->  <g fig="path" close="close" smooth="trim 20">
		  <path d=" M0,2.5 0,47.5 M0,47.5 Q0,50 2.5,50 M2.5,50 97.5,50 M97.5,50 Q100,50 100,47.5 M100,47.5 100,2.5 M100,2.5 Q100,0 97.5,0 M97.5,0 2.5,0 M2.5,0 Q0,0 0,2.5 Z" style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
<!--start  -->  <g fig="path" close="close" smooth="else">
		  <path d=" M0,11.25 0,13.75 M0,13.75 Q0,25 11.25,25 M11.25,25 63.75,25 M63.75,25 Q75,25 75,13.75 M75,13.75 75,11.25 M75,11.25 Q75,0 63.75,0 M63.75,0 11.25,0 M11.25,0 Q0,0 0,11.25" style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
		  <!--path d=" M0,11.25 0,13.75 M0,13.75 Q0,25 11.25,25 M11.25,25 63.75,25 M63.75,25 Q75,25 75,13.75 M75,13.75 75,11.25 M75,11.25 Q75,0 63.75,0 M63.75,0 11.25,0 M11.25,0 Q0,0 0,11.25 Z" style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
<!--node   -->	<g fig="path" close="close" smooth="else">
		  <path d="M25,0 L0,25 L25,50 L75,50 L100,25 L75,0 L25,0 Z" style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
<!--input  -->	<g fig="path" close="close" smooth="else">
		  <path d="M75,0 L0,12.5 L0,25 L75,25 L75,0 Z" style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
<!--para   -->	<g fig="path" close="close" smooth="else">
		  <path d="M25,0 L0,50 L75,50 L100,0 L25,0 Z" style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
<!--print  -->	<g fig="group">
	   	  <g fig="path" close="else" smooth="else">
			<path d="M100,50 L100,0 L0,0 L0,57.5 " style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
	   	  <g  fig="path" close="else" smooth="smooth">
			<path d="M0,57.5 C3.02,60.42 6.36,62.92 10,65 C12.33,66.33 14.97,66.78 17.5,67.5 C20.81,68.44 24.07,69.57 27.5,70 C30.83,70.42 34.17,70.42 37.5,70 C40.94,69.57 44.26,68.72 47.5,67.5 C51.01,66.19 54.09,64.02 57.5,62.5 C61.61,60.68 65.69,58.8 70,57.5 C74.09,56.27 78.37,56.03 82.5,55 C85.07,54.36 87.47,53.23 90,52.5 C93.31,51.56 96.64,50.72 100,50 " style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
		</g>
<!--drum   -->	<g fig="group">
		  <g fig="path" close="close" smooth="smooth"><path d="M75,12.5 C74.04,15.01 72.36,16.89 69.97,18.13 C65.66,20.37 60.99,21.42 56.25,22.24 C50.05,23.32 43.79,23.75 37.5,23.75 C31.21,23.75 24.96,23.32 18.75,22.24 C14.01,21.42 9.34,20.37 5.03,18.13 C2.64,16.89 0,15.87 0,12.5 C0,9.13 2.64,8.12 5.03,6.88 C9.34,4.63 14.01,3.58 18.75,2.76 C24.96,1.68 31.21,1.25 37.5,1.25 C43.79,1.25 50.05,1.68 56.25,2.76 C60.99,3.58 65.66,4.63 69.97,6.88 C72.36,8.12 74.04,9.99 75,12.5 Z" style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
		  <g fig="path" close="else" smooth="smooth" class="none"><path d="M0.25,65.25 C1.9,67.71 3.98,69.71 6.5,71.25 C9.36,73 12.55,73.9 15.75,74.75 C18.29,75.42 20.9,75.56 23.5,75.75 C27.74,76.06 31.99,76.25 36.25,76.25 C40.17,76.25 44.09,76.13 48,75.75 C52.62,75.3 57.23,74.86 61.75,73.75 C64.83,73 67.82,72.01 70.5,70.25 C72.64,68.85 74.31,67.02 75.5,64.75 " style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
		  <g fig="line"><path d="M0,12.5 L0,65 " style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
		  <g fig="line"><path d="M75,65 L75,12.5 " style="stroke-width: 2; stroke: rgb(0, 0, 0); fill: none;"></path></g>
	        </g>
	</svg>
        <svg  class="svg-defs" width="1200" height="0" version="1.1" xmlns="http://www.w3.org/2000/svg">
           <symbol id="icon01" viewBox="0 0 440 440">
             <path d="M20, 390L390, 20L420, 50L50, 420" style="stroke-width: 2px; stroke: rgb(0, 0, 0); fill: rgb(0, 0, 0);"></path>
           </symbol>
           <symbol id="icon02" viewBox="0 0 440 440">
             <path d="M20, 390L370, 40L400, 70L50, 420" style="stroke-width: 2px; stroke: rgb(0, 0, 0); fill: rgb(0, 0, 0);"></path>
             <path d="M320, 50L420, 20L390, 120" style="stroke-width: 2px; stroke: rgb(0, 0, 0); fill: rgb(0, 0, 0);"></path>
           </symbol>
	   <symbol id="line" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M20, 390L390, 20L420, 50L50, 420L20, 390 Z" style="stroke-width: 2px; stroke: rgb(0, 0, 0); fill: rgb(0, 0, 0);"></path></symbol>
	   <symbol id="line-endar" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M270, 60L420, 20L370, 170L270, 60 Z" style="stroke-width: 2px; stroke: rgb(0, 0, 0); fill: rgb(0, 0, 0);"></path><path d="M20, 390L370, 40L400, 70L50, 420L20, 390 Z" style="stroke-width: 2px; stroke: rgb(0, 0, 0); fill: rgb(0, 0, 0);"></path></symbol>
	   <symbol id="line-sttar" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M70, 270L20, 420L170, 370L70, 270 Z" style="stroke-width: 2px; stroke: rgb(0, 0, 0); fill: rgb(0, 0, 0);"></path><path d="M390, 20L40, 370L70, 400L420, 50L390, 20 Z" style="stroke-width: 2px; stroke: rgb(0, 0, 0); fill: rgb(0, 0, 0);"></path></symbol>
	   <symbol id="line-stedar" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M40, 370L370, 40L400, 60L70, 400L40, 370 Z" style="stroke-width: 2px; stroke: rgb(0, 0, 0); fill: rgb(0, 0, 0);"></path><path d="M70, 270L20, 420L170, 370L70, 270 Z" style="stroke-width: 2px; stroke: rgb(0, 0, 0); fill: rgb(0, 0, 0);"></path><path d="M270, 70L420, 20L370, 170L270, 70 Z" style="stroke-width: 2px; stroke: rgb(0, 0, 0); fill: rgb(0, 0, 0);"></path></symbol>
           <symbol id="serial" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M40, 340L120, 130L260, 320L320, 90" style="stroke-width: 50px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
           <symbol id="closed" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M60, 220L180, 60L370, 120L220, 360L60, 220 Z" style="stroke-width: 50px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
           <symbol id="smooth" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M50, 320C54.93087557603686, 285.14592933947773 64.93087557603687, 251.8125960061444 80, 220C95.6, 187.06666666666666 100.43478260869566, 146.95652173913044 140, 130C176.24113475177305, 114.46808510638299 197.87878787878788, 137.87878787878788 220, 160C242.12121212121212, 182.12121212121212 237.91962174940898, 214.11347517730496 250, 240C261.4035087719298, 264.4360902255639 248.90804597701154, 302.5287356321839 290, 310C330.49751243781094, 317.363184079602 343.55555555555554, 286.31111111111113 360, 260C381.0355987055016, 226.34304207119743 391.0355987055016, 189.67637540453075 390, 150" style="stroke-width: 50px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
           <symbol id="c-smooth" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M60, 220C73.71212121212122, 172.00757575757575 113.43434343434343, 147.42424242424244 150, 120C170.78431372549022, 104.41176470588235 194.76190476190476, 100 220, 100C248.33333333333331, 100 275.2083333333333, 105.83333333333333 300, 120C325.45454545454544, 134.54545454545456 348.8888888888889, 151.11111111111111 360, 180C369.68992248062017, 205.19379844961242 364.49275362318843, 228.26086956521738 350, 250C332.98850574712645, 275.51724137931035 308.7525562372188, 290.92024539877303 280, 300C240.75498575498574, 312.3931623931624 201.08333333333331, 319.6666666666667 160, 310C133.015873015873, 303.6507936507937 127.54385964912282, 275.7894736842105 110, 260C94.10852713178294, 245.69767441860463 44.81481481481481, 273.14814814814815 60, 220" style="stroke-width: 50px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
           <symbol id="q-bezier" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M50, 340Q220, 10 306, 252" style="stroke-width: 50px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
           <symbol id="c-bezier" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M40, 360C170, 30 230, 340 397, 122" style="stroke-width: 50px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
           <symbol id="free" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M50, 343L50, 338L50, 325L50, 321L50, 314L50, 306L50, 301L50, 297L50, 293L51, 289L54, 281L56, 277L57, 270L60, 263L64, 259L64, 255L67, 250L68, 246L73, 238L78, 231L86, 220L91, 213L97, 206L103, 199L108, 192L119, 183L127, 174L137, 163L147, 154L157, 144L165, 136L172, 130L183, 122L190, 117L196, 112L200, 109L207, 106L211, 104L216, 102L222, 101L228, 97L233, 96L240, 95L246, 94L255, 94L260, 94L266, 94L272, 94L276, 95L280, 98L284, 100L287, 102L291, 107L294, 111L296, 117L300, 122L301, 127L304, 134L305, 140L308, 147L309, 155L311, 165L312, 174L312, 182L312, 197L312, 209L312, 218L312, 230L312, 240L312, 251L311, 258L308, 265L306, 269L304, 274L300, 281L298, 287L292, 298L288, 306L282, 313L278, 317L272, 324L267, 329L263, 330L256, 332L249, 334L245, 334L241, 334L235, 334L227, 334L222, 334L217, 333L212, 327L207, 321L205, 318L201, 306L197, 296L194, 288L191, 279L188, 271L188, 263L188, 254L188, 246L188, 238L188, 231L188, 225L188, 216L188, 210L188, 203L188, 197L189, 191L192, 183L194, 174L197, 167L200, 159L204, 153L208, 145L210, 142L214, 136L217, 129L220, 126L224, 120L226, 116L231, 110L237, 105L239, 102L244, 98L249, 94L256, 90L265, 84L272, 80L280, 75L292, 70L303, 64L313, 60L324, 56L334, 53L349, 46L360, 40L372, 35L382, 30L390, 26L394, 23L397, 21" style="stroke-width: 50px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="Text" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M38,129 L149,129 " style="stroke-width: 16px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M257,189 L320,344 " style="stroke-width: 16px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M142,259 L227,259 " style="stroke-width: 16px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M370,314 C367.64,320.34 368.31,326.34 372,332 C375.13,336.8 380.39,336.05 385,337 C390.29,338.09 395.62,338.43 401,338 " style="stroke-width: 16px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M366,130 L368,320 " style="stroke-width: 16px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M348,194 L395,194 " style="stroke-width: 16px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M327,182 L250,349 " style="stroke-width: 16px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M224,264 C224.38,255.25 223.72,246.59 222,238 C220.66,231.3 218.71,224.83 215,219 C211.37,213.3 206.54,208.8 201,205 C194.53,200.56 188.5,195.19 180,195 C171.08,194.8 163.86,198.94 157,204 C150.26,208.96 146.08,215.94 142,223 C138.57,228.93 136.93,235.52 135,242 C133.24,247.91 131.48,253.81 131,260 C130.46,267.04 131.24,274.02 132,281 C132.91,289.4 133.47,297.86 136,306 C138.24,313.21 142.07,319.63 146,326 C149.14,331.08 152.37,336.09 157,340 C161.43,343.74 165.94,347.33 172,348 C179.41,348.82 186.51,348.03 193,344 C200.4,339.4 204.93,332.4 209,325 C212.6,318.46 214.6,311.46 215,304 " style="stroke-width: 16px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M94,130 L88,349 " style="stroke-width: 16px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M38,129 L149,129 " style="stroke-width: 16px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="circle" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M400,220 C400,252.15 391.96,282.15 375.88,310 C359.81,337.85 337.85,359.81 310,375.88 C282.15,391.96 252.15,400 220,400 C187.85,400 157.85,391.96 130,375.88 C102.15,359.81 80.19,337.85 64.12,310 C48.04,282.15 40,252.15 40,220 C40,187.85 48.04,157.85 64.12,130 C80.19,102.15 102.15,80.19 130,64.12 C157.85,48.04 187.85,40 220,40 C252.15,40 282.15,48.04 310,64.12 C337.85,80.19 359.81,102.15 375.88,130 C391.96,157.85 400,187.85 400,220 Z" style="stroke-width: 25px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M650,310 L650,310 " style="stroke-width: 25px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="smcirc" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M270,220 C270,228.93 267.77,237.26 263.3,245 C258.84,252.74 252.74,258.84 245,263.3 C237.26,267.77 228.93,270 220,270 C211.07,270 202.74,267.77 195,263.3 C187.26,258.84 181.16,252.74 176.7,245 C172.23,237.26 170,228.93 170,220 C170,211.07 172.23,202.74 176.7,195 C181.16,187.26 187.26,181.16 195,176.7 C202.74,172.23 211.07,170 220,170 C228.93,170 237.26,172.23 245,176.7 C252.74,181.16 258.84,187.26 263.3,195 C267.77,202.74 270,211.07 270,220 Z" style="stroke-width: 25px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="ellips" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M400,220 C397.7,238.07 389.66,253.07 375.88,265 C356.73,281.59 333.99,291.02 310,297.94 C280.6,306.43 250.54,310 220,310 C189.46,310 159.4,306.43 130,297.94 C106.01,291.02 83.27,281.59 64.12,265 C50.34,253.07 40,239.31 40,220 C40,200.69 50.34,186.93 64.12,175 C83.27,158.41 106.01,148.98 130,142.06 C159.4,133.57 189.46,130 220,130 C250.54,130 280.6,133.57 310,142.06 C333.99,148.98 356.73,158.41 375.88,175 C389.66,186.93 397.7,201.93 400,220 Z" style="stroke-width: 25px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M400,220 C397.7,238.07 389.66,253.07 375.88,265 C356.73,281.59 333.99,291.02 310,297.94 C280.6,306.43 250.54,310 220,310 C189.46,310 159.4,306.43 130,297.94 C106.01,291.02 83.27,281.59 64.12,265 C50.34,253.07 40,239.31 40,220 C40,200.69 50.34,186.93 64.12,175 C83.27,158.41 106.01,148.98 130,142.06 C159.4,133.57 189.46,130 220,130 C250.54,130 280.6,133.57 310,142.06 C333.99,148.98 356.73,158.41 375.88,175 C389.66,186.93 397.7,201.93 400,220 Z" style="stroke-width: 25px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="if" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M220,100 L40,220 L220,340 L400,220 L220,100 Z" style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M220,100 L40,220 L220,340 L400,220 L220,100 Z" style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="rectLg" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M50,50 L50,390 L390,390 L390,50 L50,50 Z" style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="rectSm" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M80,120 L80,320 L360,320 L360,120 L80,120 Z" style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="rectRLg" viewBox="0 0 440 440" preserveAspectRatio="none"><path d=" M50,70 50,370 M50,370 Q50,390 70,390 M70,390 370,390 M370,390 Q390,390 390,370 M390,370 390,70 M390,70 Q390,50 370,50 M370,50 70,50 M70,50 Q50,50 50,70 Z" style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="rectRSm" viewBox="0 0 440 440" preserveAspectRatio="none"><path d=" M100,140 100,300 M100,300 Q100,320 120,320 M120,320 320,320 M320,320 Q340,320 340,300 M340,300 340,140 M340,140 Q340,120 320,120 M320,120 120,120 M120,120 Q100,120 100,140 Z" style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="start" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M120,140 C102.24,142.46 85.58,148.13 70,157 C60.09,162.64 52.99,170.85 48,181 C42.26,192.67 39.36,204.95 40,218 C40.77,233.86 43.89,249.1 52,263 C59.12,275.2 69.8,283.44 82,290 C93.55,296.21 105.89,299.21 119,299 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M115,298 L324,297 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M113,139 L322,140 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M321,298 C339.79,297.71 356.79,292.04 372,281 C384.33,272.05 388.18,257.93 394,245 C397.43,237.37 399.28,229.4 399,221 C398.58,208.3 397.59,195.72 392,184 C386.52,172.51 379.03,162.74 368,156 C353.23,146.97 337.23,141.64 320,140 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M120,140 C102.24,142.46 85.58,148.13 70,157 C60.09,162.64 52.99,170.85 48,181 C42.26,192.67 39.36,204.95 40,218 C40.77,233.86 43.89,249.1 52,263 C59.12,275.2 69.8,283.44 82,290 C93.55,296.21 105.89,299.21 119,299 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="node" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M120,120 L40,220 L120,320 L320,320 L400,220 L320,120 L120,120 Z" style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="input" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M340,220 L120,240 L120,280 L330,280 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M320,280 L380,140 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="para" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M120,120 L80,320 L320,320 L360,120 L120,120 Z" style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="print" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M370,260 L370,120 L70,120 L70,290 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M69,285 C81.34,293.78 94.34,301.45 108,308 C118.9,313.23 130.2,317.32 142,320 C152.54,322.39 163.01,325.46 174,323 C192.95,318.76 210.1,310.18 227,301 C237.58,295.25 245.18,285.72 255,279 C264.27,272.66 273.32,265.94 284,262 C295.62,257.71 307.87,256.67 320,255 C336.93,252.66 353.93,251 371,250 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M370,260 L370,120 L70,120 L70,290 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
	   <symbol id="drum" viewBox="0 0 440 440" preserveAspectRatio="none"><path d="M370,120 L370,330 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M70,120 L70,330 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M68,319 C78.57,329.91 90.57,338.91 104,346 C115.3,351.96 127.59,354.66 140,357 C156.19,360.05 172.62,360.77 189,362 C199.32,362.77 209.65,363.13 220,363 C236.02,362.8 252.06,363.17 268,361 C286.65,358.46 305,354.52 323,349 C334.65,345.43 345.89,340.96 356,334 C361.79,330.01 365.79,324.68 368,318 " style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path><path d="M370,120 C366.15,130.04 359.45,137.54 349.9,142.5 C332.65,151.47 313.96,155.69 295,158.97 C270.18,163.27 245.16,165 220,165 C194.84,165 169.82,163.27 145,158.97 C126.04,155.69 107.35,151.47 90.1,142.5 C80.55,137.54 70,133.48 70,120 C70,106.52 80.55,102.46 90.1,97.5 C107.35,88.53 126.04,84.31 145,81.03 C169.82,76.73 194.84,75 220,75 C245.16,75 270.18,76.73 295,81.03 C313.96,84.31 332.65,88.53 349.9,97.5 C359.45,102.46 366.15,109.96 370,120 Z" style="stroke-width: 20px; stroke: rgb(0, 0, 0); fill: none;"></path></symbol>
        </svg>
	<div class="Tvis" id="texx" contenteditable="false" draggable="false" width="100%" height="100%" ></div>
    </div><!-- End tab1 -->
    <div class="tab-pane active" id="tab2"><!-- Start tab2 -->
       <textarea class="Thtm" id="texh" contenteditable="false" draggable="false" style="width:100%; height:100%;"></textarea>
    </div><!-- End tab2 -->
    <!-- /div --><!-- End col-sm-9 -->
    <!-- div class="col-sm-3" -->
	<!-- サブメニュー（左カラム） -->

	<!-- form name="selbox"><br><br>
	<p><label>課題名</label><br>
	<select id="comboboxA" list="list_A" onchange="changeCombA()" style="height:25px; width:180px;"></select>
	<!--input type="text" name="comboA" list="list_A" id="comboboxA" onchange="changeCombA()" autocomplete="off" style="height:25px; width:180px;" -->
	<!--datalist id="list_A"></datalist-->
	<!-- p><label>大分類</label><br>
	<select id="comboboxB"  onchange="changeCombB()" style="height:25px; width:180px;"></select>
	<p><label>中分類</label><br>
	<select id="comboboxC"  onchange="changeCombC()" style="height:25px; width:180px;"></select>
	<p><label>小分類</label><br>
	<select id="comboboxD"  onchange="changeCombD()" style="height:25px; width:180px;"></select>
	</form -->
    <!-- /div--><!-- End col-sm-3 -->
  </div><!-- End row -->
  </div><!-- End main tab-content -->
<!--/div><!-- End container-fluid -->
</body>
<script class="minify" id="smain_01">
//
//Global変数など
//
    var cnsvg_field;
　　var cnsvg_nums=0;
    var wfcn_header;
    var cnsvg_header;
    var cnsvg_new_pk
    var cnsvg_tags=[];    // [{ name: "svg_01" ,pk:0}];
    var svg_step_flag=0;

    var svg_now='svg_00';
    var container;
    var org_container;

    var mv_flag=10;
    var isDrawing = false;
    var drawingPoints=[];
    var drawingPtype=[];
    var drawingPath=null;
    var Oper=0;
    var Step=0;
    var Svg_continue=0;
    var Svg_fig_count=0;
    var bz_path='';
    var bz_attribute='';
    var qd_path='';
    var qd_attribute='';
    var bezier_line='';
    var bezier_line1='';
    var first_point='';
    var key_shift=false;
    var my_header='';      //検索keyword群の読み込み用
    var header_term;
    var my_overview='';　　//popup概要のフラグとして使用
    var exe_script01='';
    var overview_term;
    var nav_links=[];
    var save_from="";

    var Editmode="Tvis";
    var Svg_mode=""
    var pre_Svg_mode="";
    var	Draw_mode="";
    var prev_Draw_mode="";
    var Drag_elem='';
    var already_copyed=0;

   var image_root='';
   var image_pos=null;
   var image_width=200;

    var defaultPathStyle = {
        strokeWidth: "2",
        stroke: "#000",
        strokelinecap:"round",
        fill: "none",
    };
    var defaultCharStyle = {
        strokeWidth: "2",
        stroke: "#000",
        strokelinecap:"round",
        fill: "#000",
    };
    var defaultPointStyle = {
        strokeWidth: "1",
        stroke: "red",
	strokelinecap:"round",
        fill: "none",
    };
    var tempoPathStyle = {
        strokeWidth: "1",
        stroke: "red",
        fill: "none",
    };
    var tempoPathStyle2 = {
        strokeWidth: "1",
        stroke: "blue",
        fill: "none",
    };
    var defaultArrowStyle = '';
    var tempArrowStyle='';
    var defaultLineStyle='';
    var exe_script03;
    var new_ptag_flag=0;
    var catch_table=0;
    var g_list;
    var from_svg='';
    var conv_cord=false;

//drag_drag_drag drag,   drag,center_x 
var drag = {
	isMouseDown : false,
	target : null,
	group:null,
	elem:null,
	id_num:0,
	center_x:0,
	center_y:0,
	hf_width:1,
	hf_height:1,
	offsetx : 0,
	offsety : 0,
	c_para:null,
	s_para:null,
	break:false,
	selector:null,
	title:null,
	fixpnt:'',
}
var drag_elem = {
	target : null,
	id_num:0,
	c_para:null,
	s_para:null,
	copy:'',
}

    var body_elem = document.getElementsByTagName("body")[0];
    var wid_body=body_elem.clientWidth;
console.log('body width=',wid_body);
/*
	var div_width="width:"+String(wid_body)+"px;";
	if(wid_body>1350) {
		div_width="width:1350px;"
		}
    	var tvis_elem = document.getElementById("texx");
	tvis_elem.setAttribute('style',div_width);
console.log('tvis width=',div_width,tvis_elem);
*/

    var dumy_group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    dumy_group.setAttribute('fig', 'group');
//
//③System control(mouse handling)の設定
//mousedownのカウントとマウス動作判定用　dblclick,click,Move_mode(mouseupしていない）かの判定
//
    var clickCount = 0 ;
    var Up_count=0;
    var Move_mode=0;
    var mouse_Error=false;

    var first_container = document.getElementById('texx');
    var hand_down=first_container.addEventListener( 'mousedown', draw_down,false);
//console.log('******mousedown set****',first_container);

var getScreenPosition = function() {
	return {
		x : typeof window.screenX !== 'undefined' ? window.screenX : window.screenLeft,
		y : typeof window.screenY !== 'undefined' ? window.screenY : window.screenTop
	};
};

    function resizeWindow(){
console.log('Resized window');
	//org_window_w = window.innerWidth;
	org_window_w = $(window).width();
	org_window_h = $(window).height();
console.log('window size width=',org_window_w,'height=',org_window_h);
/*
	var svg_xx = document.getElementById('svg_00');
	var divsvg_xx = document.getElementById('divsvg_00');
	var pos = getScreenPosition();
console.log('screen pos=',pos);
	var topx=window.screenX;
	var topy=window.screenY;
console.log('screen topx=',topx,'topy=',topy);
var rect = divsvg_xx.getBoundingClientRect();
var pnt2=svgPoint(tagn, rect.left, rect.top);
	//let w=rect_a.right-rect_a.left;
	//let h=rect_a.bottom-rect_a.top;	
console.log('divsvg_00 rect=',rect)
	var svg_top=(topy+rect.top).toString();
	var svg_left=(topx+rect.left).toString();
	var svg_wid=(topx+rect.right).toString();
	var svg_heit=(topy+rect.bottom).toString();
	var view=svg_top+' '+svg_left+' '+svg_wid+' '+svg_heit;
	svg_xx.setAttribute('viewBox', view);
//    	svg_xx.setAttribute('width', svg_wid);
//    	svg_xx.setAttribute('height', svg_heit);
console.log('svg_00=',svg_xx);
*/
	}

//    window.addEventListener('resize', resizeWindow);

    function draw_down( e ) {
	if(clickCount==0) Up_count=0;
	++clickCount ;
//console.log('mousedown');
	if(clickCount==1){             //最初のmousedown後から350ミリ秒待つ（その間clickをカウント）
		setTimeout(mouse_handle,350,e);　//dblclick,click,Move_modeかの判定は下の mouse_handle関数で実施
	}
    }

   var mouse_handle=function(e){
//console.log('enter mouse handle');
			Move_mode=0;
			var mode='';
			if(clickCount>=2){
				if(clickCount==Up_count) {
					key_shift=sfift_key(e);
					//console.log('Double clicked Shift=',key_shift);
					mode='dblclick';
				}
				else {
					key_shift=sfift_key(e);
					//console.log('Pretend Double clicked');
					mode='dblclick';
					mouse_Error=true;
				}
			}
			else {
				if(clickCount==Up_count) {
					key_shift=sfift_key(e);
//					console.log('key_event=',key_event(e),'Clicked  Shift=',key_shift);
					mode='click';
				}
				else {
					Move_mode=1;
					//console.log('Down mode')
					mode='Move_mode';
					if(Drag_elem!='') {
						//console.log('Down mode Drag_elem=',Drag_elem);
						}
				}
			}
			//console.log('down=',clickCount,'Up_count=',Up_count,'mode=',mode,'Editmode=',Editmode);
		clickCount=0;
		Up_count=0;

	if ((Editmode=='Svg')&&(mode=='dblclick')) {
		dbl_click_func(e);
	}
	else if ((Editmode=='Svg')&&(mode=='click')&&(Svg_mode=='Selected')&&(key_shift)){
console.log('After Selected Shift+click catch');
		click_add_del_func(e);
	}
	else if ((Editmode=='Svg')&&(mode=='click')){
		click_func(e);
	}
	else if ((Editmode=='Edit')&&(mode=='click')){
//My Noteの拡張機能　system functionの起動メカニズム準備
		document.getElementById("sys_exp_func01").click();
		place_to_tag();		//2022.5.19 Editmode　では常に現在値を把握
//		display_current_tag(doc_edit_node);	//さらにgreen_line 表示の場合はこれを生かす

		if((!key_shift)&&(e.which=='3')&&in_the_table()) {   //Rightmouseクリックでしかもtable中にあるか
console.log('****Right mouse clicked in table');
//	document.oncontextmenu = function () {return false;}  //contextmenu 表示の禁止
//	document.oncontextmenu = function () {return true;}  //contextmenu 表示の禁止解除
             		document.getElementById('contextmenu_e').style.left=e.clientX+"px";
                	document.getElementById('contextmenu_e').style.top=e.clientY+"px";
		        document.getElementById('contextmenu_e').style.display="block";
			return;
			}

//		if(my_html_design_dialog) my_html_click( e );

		if((key_shift)&&(e.which=='1')) {
console.log('**Copy=Shift+Left mouse button at Editmode');
			var sel = window.getSelection();
    			if(!sel.rangeCount) return; //範囲選択されている箇所がない場合は何もせず終了
    			var range = sel.getRangeAt(0);
console.log('catch text=',range);
			cont_d_copy();
			return;
			}
		if((key_shift)&&(e.which=='3')) {	//paste from clipboard
console.log('**Paste=Shift+Right mouse button at Editmode');
			var sel = window.getSelection();
    			if(!sel.rangeCount) return; //範囲選択されている箇所がない場合は何もせず終了
    			var range = sel.getRangeAt(0);
			cont_d_menu2_b(range);
			return;
			}

		if((!key_shift)&&(e.which=='3')) {
console.log('**Right mouse button at Editmode and key_shift=',key_shift,'X & Y=',e.pageX,e.pageY);
             		document.getElementById('contextmenu_d').style.left=e.clientX+"px";
                	document.getElementById('contextmenu_d').style.top=e.clientY+"px";
		        document.getElementById('contextmenu_d').style.display="block";
			//document.getElementById("copy_tag").click();
			return;
			}

		Drag_elem=null;
//		move_image_func(e);
//		if(Drag_elem) document.getElementById("design_html").click();
//		catch_image();
//		Text_edit();
	}
   }//mouse handle end

//HTML Desin画面のフィールドへのCopy＆Paste   本体側のキーイベントでOKと判明し移動
    function my_html_click( e ) {
console.log('click=',e.which);
		key_shift=sfift_key(e);
		if((key_shift)&&(e.which=='3') || (e.ctrlKey)&&(e.key=='v')) {	//paste from clipboard
console.log('**Paste=Shift+Right mouse button at Editmode');
console.log('element id=',e.target.id);
				paste_shiftright_mouse(e.target.id);
				return;
				}
		if((key_shift)&&(e.which=='1') || (e.ctrlKey)&&(e.key=='c')) {	//copy to clipboard
console.log('**Copy=Shift+Left mouse button at Editmode');
console.log('element id=',e.target.id);
				copy_shiftleft_mouse(e.target.id);
				return;
				}
	}

function in_the_table() {
console.log('**********check in the table');
	var leng=tag_trees.length;
	
	var in_table=0;
	for(let k=0;k<leng;k++) {
		if(tag_trees[k].fig=='table') {
			in_table=tag_trees[k].node;
			break;
			}
// tag_trees=tag:node.nodeName,fig:node_fig,level:level,node:node_id,ind:index
		}
	catch_table=in_table;
	return in_table;
	}

/*
let Right_Event = new KeyboardEvent( "keydown", { keyCode: 229 });
let Bs_Event = new KeyboardEvent( "keydown", { keyCode: 13 });
*/

//Backspaceキーを無効化する
$("#texx").keydown(function(e) {
console.log('key=',e.key);
	text_edit_mend_flag+=1;
	if (e.key === "Backspace"){
console.log("Backspaceキーが押されました");
		var check=check_place_bs();
console.log('at Bs hist=',bs_hist_flag,'Bs able=',check);
		if(bs_hist_flag) {
			var result=check_html_hist(doc_edit_node,tag_trees,tag_trees[0].level,'bs_del');
			bs_hist_flag=false;
			}
    		if(check) return true;
		else return false;
		}
	if (e.key === "Delete"){
console.log("Deleteキーが押されました");
		check_place_del();
console.log('at Delete hist=',dl_hist_flag,'forbid=',dl_forbid);
		if(dl_hist_flag) {
			var result=check_html_hist(doc_edit_node,tag_trees,tag_trees[0].level,'dl_del');
			dl_hist_flag=false;
			}
		if(dl_forbid) return false
		else return true;
		}
	if (e.ctrlKey){
    		if(e.key==='c') {
console.log('*Ctrl+cが押された');
			var sel = window.getSelection();
    			if(!sel.rangeCount) return; //範囲選択されている箇所がない場合は何もせず終了
    			var range = sel.getRangeAt(0);
console.log('catch text=',range);
			cont_d_copy();
			return false;
			}
		if(e.key==='v') {
console.log('*Ctrl+vが押された');
			var sel = window.getSelection();
    			if(!sel.rangeCount) return; //範囲選択されている箇所がない場合は何もせず終了
    			var range = sel.getRangeAt(0);
			cont_d_menu2_b(range);
			return false;
			}
		}
   var res='';
   if(Editmode=="Edit")　{   //　Editモードの場合のみhtml変換
//console.log('Press key=',e.key);
	if(e.key==='Enter') {
		if(doc_edit_node.nodeName=='P'){
			if(e.shiftKey){ //Shift+Enterの場合
				return true;
console.log('Shift Enter');
				}
			else {  //Enterの場合 2022.05.13 再検討必要
console.log('Only Enter');
				cancel_green_line();
				setTimeout(after_enter_only,80);
				return true;
				}
			}
		else return false;
		}
	}	
});

function after_enter_only() {
console.log('********after enter only called');
//	var node=doc_edit_node.nextSibling;
//console.log('first node=',node.childNodes[0].nodeName);
//	if(node.childNodes[0].nodeName=="BR") node.childNodes[0].remove();
    	tag_trees=[];
	place_to_tag('sp_text');
	if(my_html_design_dialog) {
//    		tag_trees=[];
//		place_to_tag();
		setto_current_tag(doc_edit_node);
		display_current_tag(doc_edit_node);
		}
//	var result=check_html_hist(doc_edit_node,tag_trees,tag_trees[0].level,'sp_text');
	}

/*
// 文書のCut処理をキャッチ ( oncut )
first_container.oncut = function() {
	var range=window.getSelection();
//console.log('*cut event catch',range);
}
*/

var reshape_path=null;
var mv_line0=null;
var mv_line1=null;

//Move_modeならばmouseの動きについての処理を記述する
//    var hand_move=org_container.addEventListener('mousemove', draw_move,false);
document.onmousemove = function( e ) {
console.log('** Draw_mode=',Draw_mode,'Move_mde=',Move_mode,'Svg_mode=',Svg_mode);
  if(Move_mode && Editmode=="Svg") {
    switch (Draw_mode){
      case 'Aux':
      case 'Drag':
        	if (drag.isMouseDown == true) {
console.log('@@@@@point moving dragtarget=',drag.target);
			var exx=e.clientX;
			var eyy=e.clientY;
			if(conv_cord) {
//console.log('convert indiv',exx,eyy,off_indivx,off_indivy);
				exx=exx-off_indivx;
				eyy=eyy-off_indivy;
				}
			var tobi=(drag.offsetx-exx)**2+(drag.offsety-eyy)**2;
			if(tobi>100) break;
			drag.target.transform.baseVal[0].matrix.e=drag.target.transform.baseVal[0].matrix.e+exx - drag.offsetx;
			drag.target.transform.baseVal[0].matrix.f=drag.target.transform.baseVal[0].matrix.f+eyy - drag.offsety;
			drag.offsetx = exx;
			drag.offsety = eyy;

/* 図形の移動などに係る時々刻々の描画はここで実施か？　point描画は既に描画済なので動かすのみ　*/
			if(Svg_mode=='Svg_reshape_pending') {

					var leng=drawingPoints.length;
					var pn=drag.id_num; var nx=drag.id_num+1; var nxx=drag.id_num+2;
					var bf=drag.id_num-1; var bff=drag.id_num-2;
					var v_pn,v_nx,v_nxx,v_bf,v_bff;
				//function move_interpol(pn,bf,nx,nxx)
				if(drag.s_para!='else') {
					if(drag.c_para=='close') {		//閉曲線の場合
						if(drag.id_num+1>=leng) nx=nx-leng;
						if(drag.id_num+2>=leng) nxx=nxx-leng;
						if(drag.id_num-1<0) bf=bf+leng-1;
						if(drag.id_num-2<0) bff=bff+leng-1;
console.log('c_para=',drag.c_para,'position=',pn,nx,nxx,bf,bff);
						var rn1=move_interpol({x: exx,y: eyy},drawingPoints[bf],drawingPoints[nx],drawingPoints[nxx]);
						var rn2=move_interpol({x: exx,y: eyy},drawingPoints[nx],drawingPoints[bf],drawingPoints[bff]);
						drawingPoints[drag.id_num]={x: exx,y: eyy};
						
						var path_p=path_cube;    //path_pをdrawingPointsにするのは違っている
console.log('close move_inter result=',rn1,rn2,'path_p=',path_p);
						if(!reshape_path) {	//tempoなreshape_pathがなければpath_pから作る
							reshape_path=createCubicBezier_B(path_p,drawingPtype,drag.c_para)
							Object.assign(reshape_path.style, tempoPathStyle);
							container.appendChild(reshape_path);
							Drag_elem.children[0].removeAttribute("d");  //現物を消す
							}

						n_rn1_1=3*pn+1;
						path_p[3*pn]={x: exx,y: eyy};
						if(pn==0) {
							path_p[path_p.length-1]={x: exx,y: eyy};
							drawingPoints[drawingPoints.length-1]={x: exx,y: eyy};
							}
						path_p[n_rn1_1]={x:rn1[0][0],y:rn1[0][1]};

						path_p[n_rn1_1+1]={x:rn1[1][0],y:rn1[1][1]};
						path_p[n_rn1_1+3]={x:rn1[2][0],y:rn1[2][1]};
						
						n_rn2_1=3*bf+1;					
						path_p[n_rn2_1+1]={x:rn2[0][0],y:rn2[0][1]};
						path_p[n_rn2_1]={x:rn2[1][0],y:rn2[1][1]};
						path_p[n_rn2_1-2]={x:rn2[2][0],y:rn2[2][1]};

						if(reshape_path) {	//mouse操作後のreshape_pathを書き直す
							container.removeChild(reshape_path);
//							reshape_path=null;
							}
						reshape_path=createCubicBezier_B(path_p,drawingPtype,drag.c_para); 
						Object.assign(reshape_path.style, tempoPathStyle);
						container.appendChild(reshape_path);
console.log('path=',reshape_path);
						}
					else {							//開曲線の場合
console.log('c_para=',drag.c_para,'position=',pn,nx,nxx,bf,bff);
						v_nx=drawingPoints[drag.id_num+1];
						if(drag.id_num+1>=leng) v_nx=null;
						v_nxx=drawingPoints[drag.id_num+2];
						if(drag.id_num+2>=leng) v_nxx=null;
						v_bf=drawingPoints[drag.id_num-1];
						if(drag.idnum-1<0) v_bf=null;
						v_bff=drawingPoints[drag.id_num-2];
						if(drag.idnum-2<0) v_bff=null;
console.log('nx nxx bf bff=',v_nx,v_nxx,v_bf,v_bff);
						if(v_nx!=null) var rn1=move_interpol({x: exx,y: eyy},v_bf,v_nx,v_nxx);
						if(v_bf!=null) var rn2=move_interpol({x: exx,y: eyy},v_nx,v_bf,v_bff);
						drawingPoints[drag.id_num]={x: exx,y: eyy};
						var path_p=path_cube;
console.log('open move_inter result=',rn1,rn2,'path_p=',path_p);
						if(!reshape_path) {	//tempoなreshape_pathがなければpath_pから作る
							reshape_path=createCubicBezier_B(path_p,drawingPtype,drag.c_para)
							Object.assign(reshape_path.style, tempoPathStyle);
							container.appendChild(reshape_path);
							Drag_elem.children[0].removeAttribute("d");
							}

						n_rn1_1=3*pn+1;
						path_p[3*pn]={x: exx,y: eyy};
						if(v_nx!=null) path_p[n_rn1_1]={x:rn1[0][0],y:rn1[0][1]};

						if(v_nxx!=null) path_p[n_rn1_1+1]={x:rn1[1][0],y:rn1[1][1]};
						if(v_nxx!=null) path_p[n_rn1_1+3]={x:rn1[2][0],y:rn1[2][1]};
						
						n_rn2_1=3*bf+1;					
						if(v_bf!=null) path_p[n_rn2_1+1]={x:rn2[0][0],y:rn2[0][1]};
						if(v_bff!=null) path_p[n_rn2_1]={x:rn2[1][0],y:rn2[1][1]};
						if(v_bff!=null) path_p[n_rn2_1-2]={x:rn2[2][0],y:rn2[2][1]};
						
						if(reshape_path) {	//mouse操作後のreshape_pathを書き直す
							container.removeChild(reshape_path);
//							reshape_path=null;
							}
						reshape_path=createCubicBezier_B(path_p,drawingPtype,drag.c_para)
						Object.assign(reshape_path.style, tempoPathStyle);
						container.appendChild(reshape_path);
console.log('path=',reshape_path);
						}

					}
				else {
console.log('at move inter length=',drawingPoints.length);
console.log('id_num,points=',drag.id_num,drawingPoints,drawingPoints[drag.id_num-1],{x: exx,y: eyy},drawingPoints[drag.id_num+1]);
					var bf_num=drag.id_num-1;
					if(drag.id_num==0) bf_num=drawingPoints.length-2;
					var nx_num=drag.id_num+1;
					if(drag.id_num==drawingPoints.length-1) nx_num=1
console.log('id_num,bf,nx=',drag.id_num,bf_num,nx_num);
					if(drag.c_para=="close" && drag.id_num==0) {
							drawingPoints[drawingPoints.length-1]={x: exx,y: eyy};
							}

					if(mv_line0) container.removeChild(mv_line0);
					mv_line0=createPath([drawingPoints[bf_num],{x: exx,y: eyy}],0,null,null);
	        			Object.assign(mv_line0.style, tempoPathStyle);

					if(mv_line1) container.removeChild(mv_line1);
					mv_line1=createPath([drawingPoints[nx_num],{x: exx,y: eyy}],0,null,null);
	        			Object.assign(mv_line1.style, tempoPathStyle);

     					container.appendChild(mv_line0);
	       				container.appendChild(mv_line1);
					drawingPoints[drag.id_num]={x: exx,y: eyy};
					}
				}
		}
		break;
      case 'Text':
        	if (drag.isMouseDown == true) {
console.log('**Image drag');
  			var x = e.clientX;
  			var y = e.clientY;
			if(conv_cord) {
//console.log('convert indiv',x,y,off_indivx,off_indivy);
				x=x-off_indivx;
				y=y-off_indivy;
				}
  			var width = drag.target.offsetWidth;
  			var height = drag.target.offsetHeight;
  			drag.target.style.top = (y-height/2) + "px";
  			drag.target.style.left = (x-width/2) + "px";
		}
		break;
      case 'Basic':
      case 'Path':
      case 'Draw':
console.log('mousemove Draw line=',control.value);
		draw_move(e);
		break;
       default:
console.log('Area catch');
		draw_move(e);
		break;
	}
//console.log('off moving inter3 tobi=',tobi);
   }
}//mousemove end

//mouseup時の処理
//    var hand_up=org_container.addEventListener('mouseup', draw_up,false);
document.onmouseup = function (e) {
console.log('mouse up');
		var range=window.getSelection();
		if(range!='') {
console.log('selection=',range);
			}
　　　　	++Up_count;
		drag.isMouseDown = false;
　　　　	if(mouse_Error) {
　　　　　　		mouse_Error=false;
　　　　　　		Up_count=0;
　　　　　　		}
　　　　	if(Move_mode) {
console.log('canceled Move_mode');
    			switch (Draw_mode){
      		 	   case 'Aux':
console.log('** element drag stop');
				drag.isMouseDown = false;
				draw_op.aux_pos=e.clientX;
				break;
      			   case 'Basic':
	  		    default:
console.log('** element draw stop');
				draw_up(e);
				break;
				}
			Move_mode=0;
			Up_count=0;
console.log('After basic_moveup=',Up_count);
   			}
//	disp_yn_check();
    }//mouseup end

//Singleクリック時(Step 0)の処理を入れる
var add_del_P=false;
var click_func=function(e){
console.log('Single Click(Step 0) Step=',Step,'Svg_mode=',Svg_mode,'Draw_mode=',Draw_mode);
    switch (e.which) {
        case 1:
		add_del_P=false;
console.log('Svg_mode=',Svg_mode,'svg_step=',svg_step_flag)
		if(Svg_mode=='Svg_updown' && svg_step_flag==0) {
			//図形の反転処理
			var xp = e.clientX;
			var yp = e.clientY;
			if(conv_cord) {
console.log('convert indiv',xp,yp,off_indivx,off_indivy);
				xp=xp-off_indivx;
				yp=yp-off_indivy;
				}
			drag.offsetx = xp;
			drag.offsety = yp;
			svg_step_flag=1;
			document.getElementById("fig_updown").click();
			}
		else if(Draw_mode=="Aux") draw_basic(e);
/*
		else if(!Drag_elem　&& Draw_mode!="Text") {     //他の条件あるかもだが、ここでtext入力モードに入る。
			document.getElementById("oper_01").click();
			draw_basic(e);
			var fig_id=Drag_elem.getAttribute('id');
			Drag_elem = document.getElementById(fig_id);
console.log('selected drag target=',Drag_elem);
			getrect_shape(Drag_elem)
			Drag_elem.setAttribute('class', 'draggable');
console.log('**Drag_elem= ',Drag_elem.nodeName,'id= ',fig_id);
			Draw_mode='Drag';
			drag.break=false;
			draggable(Drag_elem);
			Svg_mode="Svg_drag_pending";
			container.removeChild(draw_op.target);
			draw_op.target=null;
			Draw_mode="Text";
			my_basic_draw_dialog=0;
			//getrect_shape(Drag_elem);
			svg_text_edit(Drag_elem,e);
			}
*/

//shift無しのclickで処理する	if(key_shift && Svg_mode=='Selected') {
//console.log('cancel point from selected points');
//			}
//            alert('Left Mouse button pressed.');
            break;
        case 2:
		add_del_P=false;
//            alert('Middle Mouse button pressed.');
            break;
        case 3:
console.log('**Right mouse button pressed Svg mode=',Svg_mode,key_shift);
		add_del_P=true;
//            alert('Right Mouse button pressed.');
		if(Svg_mode=="Svg_reshape_pending") {
console.log('Point add or del stage start');
			var xp=e.clientX;
			var yp=e.clientY;
			catch_adddel_point(Drag_elem,xp,yp);
			}
		if((Svg_mode=="Svg_drag")||(Svg_mode=="Svg_drag_pending")) {
console.log('SVG text edit stage start');
			svg_text_edit(Drag_elem,e);
			return;
			}
		if(Svg_mode=="Selected" ||  Svg_mode=="Svg_drag_pending" || already_copyed ) {
console.log('Simplify Tags or Redraw Tags=',drag.group);

             		document.getElementById('contextmenu_a').style.left=e.clientX+"px";
                	document.getElementById('contextmenu_a').style.top=e.clientY+"px";
		        document.getElementById('contextmenu_a').style.display="block";
/*
       			var wgroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
			var fig_id='g'+(Date.now()).toString();
			wgroup.setAttribute('id', fig_id);
			wgroup.setAttribute('fig', 'group');
			var g_temp=drag.target.appendChild(wgroup);
			var error=plane_simple_fig(g_temp,drag.target,drag.group);
			if(error==0) {
				for(let i=0;i<drag.group.length;i++) {
//					drag.target.removeChild(drag.group[i]);
//					remove(drag.group[i]);
					}
				}
			else {
//				drag.target.removeChild(g_temp);
				}
			drag.target=null;
			drag.group=null;
			Svg_mode=="";
			return;
*/
			}
		if(Svg_mode=="") {
			document.getElementById('contextmenu_a').style.left=e.clientX+"px";
                	document.getElementById('contextmenu_a').style.top=e.clientY+"px";
		        document.getElementById('contextmenu_a').style.display="block";
			}
            break;
		add_del_P=false;
        default:
//            alert('You have a strange Mouse!');
    }
	if(Draw_mode){
		if(Draw_mode=='Basic'){
console.log("Draw Basic mode");
			draw_op.posy=e.clientY;
			draw_basic(e);
			}
		if(Draw_mode=='Draw'){
			click_func3(e);
			}
		if(Draw_mode=='Drag') click_func2(e);
		}
	else if(Svg_mode=='Selected') {
console.log('cancel one from selected tags');
		var xp=e.clientX;
		var yp=e.clientY;
/*
		if(conv_cord) {
console.log('convert indiv',xp,yp,off_indivx,off_indivy);
			xp=xp-off_indivx;
			yp=yp-off_indivy;
			}
*/
    		var leng=drag.group.length;      	//  drag.group=g_list;
console.log('g_list leng= ',drag.group.length,drag.group);
    		for (var i=0 ;i<leng ;i++){
			tagn=drag.group[i].rect01;
			var result=catch_figure(tagn,xp,yp);
			if(result){
console.log('cancel tag=',drag.group[i]);
				container.removeChild(drag.group[i].rect01);
				drag.group.splice(i,1);
				break;
				}
			}
		}
	else click_func2(e);
	} //Single Click(Step 0) End

function svg_text_edit(Drag_elem,e) {
	var fig_class=Drag_elem.getAttribute('fig');
	if(fig_class=='text') {
		text_dialog();
		}
	else {
             		document.getElementById('contextmenu_a').style.left=e.clientX+"px";
                	document.getElementById('contextmenu_a').style.top=e.clientY+"px";
		        document.getElementById('contextmenu_a').style.display="block";
/*
		var len=Drag_elem.children.length;
		for(let n=0;n<len;n++) {
			var tagn=Drag_elem.children[n];
console.log('child n=',n,tagn);
			if(tagn.nodeName=='path') {
				Object.assign(tagn.style, defaultPathStyle);
console.log('再描画');
				}
			}
*/
		}
   	}

function make_group(fig){
	var group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
	var fig_id='g'+(Date.now()).toString();
	group.setAttribute('id', fig_id);
	group.setAttribute('fig', fig);
	group.setAttribute('class', 'group');
	group.setAttribute('opacity', '0.6');
	elem=container.appendChild(group);
console.log('make_group=',group,fig_id);
	var result=check_hist(container,elem,'add');
	return {group:group,fig_id:fig_id};
   }

var svg_hist_max=5;
var svg_hist_maxlen=10000;
var svg_hist=[];
var svg_undo=[];
var hist_parent=document.getElementById("wClone");

function check_hist(cont,group,flag) {
	return;
	var hist_leng=svg_hist.length;
	var undo_leng=svg_undo.length;
console.log('Enter Svg hist_leng=',hist_leng,' hist=',svg_hist,' undo_leng=',undo_leng);
	for(let k=0;k<undo_leng;k++) {
		if(svg_undo[k].flag=='add') {
			var dtag=document.getElementById(svg_undo[k].group);
			hist_parent.removeChild(dtag);
			}
		}
	svg_undo=[];
	
	var cont_id=container.getAttribute('id');
	var g_id=group.getAttribute('id');
console.log('new_history flag=',flag,cont_id,g_id);
	var leng=0;
	if(flag=='del') {
		temp_delete(group);
		var tagn=group.cloneNode(true);
		var tag_char = new XMLSerializer().serializeToString(tagn);
		leng=tag_char.length;
		}
	var tot_leng=leng;
	for(let k=0;k<svg_hist.length;k++) tot_leng=tot_leng+svg_hist[k].leng;
	if(svg_hist.length>svg_hist_max) tot_leng=tot_leng-svg_hist[0].leng;
	var result;
	var result2=2;
console.log('Total leng=',tot_leng,leng);
	if(tot_leng>svg_hist_maxlen) {
		var result2 = window.confirm('元に戻せません。本当に削除しますか？');
		}
	if(result2==1) {
			svg_hist=[];
			result=1;
			while( hist_parent.firstChild ){
  				hist_parent.removeChild( hist_parent.firstChild );
				}
		}
	if(result2==2) {
		result=1;
		svg_hist.push({flag:flag,cont:cont_id,group:g_id,leng:leng});
		if(flag=='del') hist_parent.appendChild(tagn);
		if(svg_hist.length>svg_hist_max) {
			if(svg_hist[0].flag=='del') {
				var dtag=document.getElementById(svg_hist[0].group);
console.log('dtag id=',svg_hist[0].group,dtag);
				hist_parent.removeChild(dtag);
				}
			svg_hist.shift();
			}
		}
	if(result2==0) result=0;
console.log('hist=',svg_hist);
	return result;
	} //End check_hist

   $("#svg_undo").on("click", function() {
	if(svg_hist.length>0) {
		var list=svg_hist.pop();
console.log('list=',list);
		if(list.flag=='add') {
			var dtag=document.getElementById(list.group);
			var tagn=dtag.cloneNode(true);
			container.removeChild(dtag);
			hist_parent.appendChild(tagn);
			}
		else {
			var dtag=document.getElementById(list.group);
			var tagn=dtag.cloneNode(true);
			hist_parent.removeChild(dtag);
			container.appendChild(tagn);
			}
		svg_undo.push(list);
		}
console.log('hist=',svg_hist,svg_undo);
	});

   $("#svg_redo").on("click", function() {
	if(svg_undo.length>0) {
		var list=svg_undo.pop();
		if(list.flag=='add') {
			var dtag=document.getElementById(list.group);
			var tagn=dtag.cloneNode(true);
			hist_parent.removeChild(dtag);
			container.appendChild(tagn);
			}
		else {
			var dtag=document.getElementById(list.group);
			var tagn=dtag.cloneNode(true);
			container.removeChild(dtag);
			hist_parent.appendChild(tagn);
			}
		svg_hist.push(list);
		}
console.log('undo=',svg_undo,svg_hist);
	});

function set_html_hist_id(tag) {
	var flag=0;
	var step=0;
	var idr=tag.getAttribute('id');
	if(idr==null) {
		var idr='r'+(Date.now()).toString();
		tag.setAttribute('id', idr);
//		tag.setAttribute('class', 'work');
		flag=1;
//console.log('not origin id=',idr);
		}
	else {
		for(let i=html_hist.length-1;i>=0;i--) {
			if(html_hist[i].tag_id==idr) {
				step=html_hist[i].step+1;
//console.log('set id match tag step=',step);
				break;
				}
			}
		}
	return {id:idr,st:step,fg:flag};
	/// 複数返り値を受け取り var rt = set_html_hist_id(tag); var id = rt['id']; var step = rt['st']; var flag=rt['fg'];
	}

    function remove_levelid(dom) {  // tempのidをremoveする
	var n_child=dom.children.length;

	if(n_child>0) {
		for (let k = 0; k < n_child; k++) {
			var tag_id=dom.children[k].getAttribute('id');
			if(tag_id && tag_id[0]=="r") dom.children[k].removeAttribute('id');
			if(dom.children[k].children.length>0)remove_tempid(dom.children[k]);
			}
		}
	} //End function


var html_hist_max=10;
var html_hist_maxlen=50000;
var html_hist_leng=0;
var html_hist=[];
var html_undo=[];
var text_edit_mend_flag=0;
var html_text_tag=null;
var after_addOrdel=0;

function check_html_hist(tag,tag_tree,level,type) {
	return;
//	if(!undo_hist_onoff) return;
console.log('EEEE*Enter to html_hist tag=',tag,'level=',level,'type=',type,'tree=',tag_tree,'hist=',html_hist);
	var hist_leng=html_hist.length;
	var undo_leng=html_undo.length;
console.log('hist_leng=',hist_leng,' hist=',html_hist,' undo_leng=',undo_leng);
	if(html_hist_leng<0) {       //範囲が大きすぎてhist破綻の場合はleng=-100となっている
		while( hist_parent.firstChild ){
  			hist_parent.removeChild( hist_parent.firstChild );
			}
/*
		for(let k=0;k<hist_leng;k++) {
			var wid='w'+String(html_hist[k].step)+html_hist[k].tag_id;
			var dtag=document.getElementById(wid);
			if(dtag) hist_parent.removeChild(dtag);
			}
*/
		html_hist_leng=0;
		html_hist=[];
		html_undo=[];
		hist_leng=html_hist.length;
		undo_leng=html_undo.length;
console.log('Clear hist logs hist_leng=',html_hist_leng,html_hist,html_undo);
		}

	for(let k=0;k<undo_leng;k++) {
		var wid='w'+String(html_undo[k].step)+html_undo[k].tag_id;
		var dtag=document.getElementById(wid);
		if(dtag) hist_parent.removeChild(dtag);
		}
	html_undo=[];
	undo_leng=html_undo.length;

	var id_flag=0;
	var leng=0;
	var result=0;
	var next=0;

	var obj = set_html_hist_id(tag);
	var idr=obj['id']; var step=obj['st']; var id_flag=obj['fg'];
console.log('html_hist input set id=',idr,'step=',step,'flag=',id_flag);

	if(type=='add' || type=='add_d' || type=='del' || type=='del_d' || type=='del_F' ) {
		if(type=='add' || type=='del' || type=='del_F' ) {
			if(type=='del' || type=='del_F') {    //del_Fはfirst tagを削除した場合
				cancel_green_line();
				var after_tag=doc_edit_node.previousSibling;;
				if(type=='del_F')　after_tag=doc_edit_node.parentNode;
				var next=5;
				var leng=check_hist_leng(tag);
				var tagn=hist_parent.appendChild(tag.cloneNode(true));
				remove_levelid(tagn);
				var wid='w'+String(step)+idr;
				tagn.setAttribute('id', wid);
				//if(tag) tag.remove();  実際のremoveは関数の外でやる
				}
			else {
				next=5;
				leng=0;
				wid=null;
				}
			html_hist.push({type:type,next:next,level:level,id_flag:id_flag,tag_id:idr,step:step,other:0,leng:leng,tree:tag_tree});
console.log('@@@@@html_hist add/del no1 no=',html_hist.length,'hist=',html_hist[html_hist.length - 1],'wid=',wid);
			if(type=='add') {
				var tag=doc_edit_node;
				var rt = set_html_hist_id(tag);
				var idr0=rt['id']; var step0=rt['st']; var id_flag0=rt['fg'];
				leng=check_hist_leng(tag);
				var tagn=hist_parent.appendChild(tag.cloneNode(true));
				remove_levelid(tagn);
				flag0='text';
				next=2;
				var wid='w'+String(step0)+idr0;
				tagn.setAttribute('id', wid);
				}
			else { //type= 'del' and 'del_F' 
				var rt = set_html_hist_id(after_tag);
				var idr0=rt['id']; var step0=rt['st']; var id_flag0=rt['fg'];
				leng=0;
				flag0='text';
				next=2;
				wid=null;
				}
			html_hist.push({type:flag0,next:next,level:level,id_flag:id_flag0,tag_id:idr0,step:step0,other:0,leng:leng});
console.log('@@@@@html_hist add/del no2 no=',html_hist.length,'hist=',html_hist[html_hist.length - 1],'wid=',wid);
			text_edit_mend_flag=0;
			}
		else if(type=='add_d' || type=='del_d') {
			next=5;
			leng=0;
			wid=null;
			html_hist.push({type:type,next:next,level:level,id_flag:id_flag,tag_id:idr,step:step,other:0,leng:leng,tree:tag_tree});
console.log('@@@@@html_hist add/del no1 no=',html_hist.length,'hist=',html_hist[html_hist.length - 1],'wid=',wid);
//			var tag=doc_edit_node;
			var rt = set_html_hist_id(tag);
			var idr0=rt['id']; var step0=rt['st']; var id_flag0=rt['fg'];
			leng=check_hist_leng(tag);
			var tagn=hist_parent.appendChild(tag.cloneNode(true));
			remove_levelid(tagn);
			flag0='text';
			next=2;
			var wid='w'+String(step0)+idr0;
			tagn.setAttribute('id', wid);
			html_hist.push({type:flag0,next:next,level:level,id_flag:id_flag0,tag_id:idr0,step:step0,other:0,leng:leng});
console.log('@@@@@html_hist add/del no2 no=',html_hist.length,'hist=',html_hist[html_hist.length - 1],'wid=',wid);
			text_edit_mend_flag=0;
			}
		}

	else if(hist_leng>0 && html_hist[html_hist.length - 1].next==0 && type!='text') {  //現状ここは通らない（文字転移のhistoryで検討
console.log('type=',type,'old id=',html_hist[html_hist.length - 1].tag_id,'new id=',idr);
		if(idr==html_hist[html_hist.length - 1].tag_id) {      //delキー＆bsキーによるtag合体もEnterキーによる分離もここに入る
console.log('同一Tag');
    var sel = window.getSelection();
    var range = sel.getRangeAt(0);
console.log('selection=',sel);
			if(type=='sp_text') {
				//split tagは同じidで生成されているので特別に後半部tagのidを変更する
				tag.removeAttribute('id');
				var idn='r'+(Date.now()).toString();
				tag.setAttribute('id', idn);

				//split tagの前半部のtagのwidに元データを入れて保存
				var bf_tag=tag.previousSibling;
				var rt = set_html_hist_id(bf_tag);
				var idr0=rt['id']; var step0=rt['st']; var id_flag0=rt['fg'];
				var cn_tag=hist_parent.appendChild(bf_tag.cloneNode(true));
				remove_levelid(cn_tagn);
				var wid='w'+String(step0)+idr0;
				cn_tag.setAttribute('id', wid);
				leng=check_hist_leng(cn_tag);
				next=1;
				flag0='sp_text';
console.log('sp_text step1 wid=',step0,wid,cn_tag);
				html_hist.push({type:flag0,next:next,level:level,id_flag:id_flag0,tag_id:idr0,step:step0,other:0,leng:leng});
console.log('@@@@@html_hist sp_text no1 no=',html_hist.length,'hist=',html_hist[html_hist.length - 1],'wid=',wid);
				id_flag=1;
				text_edit_mend_flag=0;
				next=2;
				flag0='text';
				var rt = set_html_hist_id(tag);
				var idr0=rt['id']; var step0=rt['st']; var id_flag0=rt['fg'];
				var leng=check_hist_leng(tag);
				var tagn=hist_parent.appendChild(tag.cloneNode(true));
				remove_levelid(tagn);
				var wid='w'+String(step0)+idr0;
				tagn.setAttribute('id', wid);
				var html_str=tag.previousSibling.innerHTML+tag.innerHTML;
				html_hist.push({type:flag0,next:next,level:level,id_flag:id_flag,tag_id:idr0,step:step0,other:0,leng:leng});
console.log('@@@@@html_hist sp_text no0 no=',html_hist.length,'hist=',html_hist[html_hist.length - 1],'wid=',wid);
//console.log('FFFFFF step wid=',step,wid,html_hist[html_hist.length - 1]);
console.log('sp_text  now=',tag,'prev=',tag.previousSibling,'next=',tag.nextSibling);
console.log('combined=',combined_sib_prev);    //combined_sib_prevは直前のprev_tagのlength
				}
			if(type=='dl_del') {   //now_tagにnext_tagが合体
console.log('dl_del  now=',tag,'next=',tag.nextSibling,'prev=',tag.previousSibling);
console.log('combined=',combined_sib_next);
//DEL_delのhistの順番①合体直前の現tag（要logic)＝不要②合体前next③合体後現tag
				var html_str=tag.innerHTML+tag.nextSibling.innerHTML;
				html_str=from_nbsp(html_str);
				var partlen=combined_sib_next;
				var leng=html_str.length;
console.log('srting=', html_str,'leng=',partlen,leng);
				var list=html_hist[html_hist.length - 1];
/*
//①tag　合体直前の現tag
				var rt = set_html_hist_id(tag);
				var idr0=rt['id']; var step0=rt['st']; var id_flag0=rt['fg'];
console.log('list=',list,'tag=',tag);
				next=1;
				var flag0='dl_del';
				var leng0=check_hist_leng(tag);
				var cn_tag=hist_parent.appendChild(tag.cloneNode(true));
				cn_tag.innerHTML=html_str.substring(leng-partlen,leng);
				remove_levelid(cn_tagn);
				var wid='w'+String(step0)+idr0;
				cn_tag.setAttribute('id', wid);
				var now_tag=tag;
console.log('bs_del step wid=',step,wid,cn_tag,'inner=',cn_tag,innerHTML);
				var other0=combined_sib_next;
				html_hist.push({type:flag0,next:next,level:list.level,id_flag:id_flag0,tag_id:idr0,step:step0,other:other0,leng:leng0});
console.log('@@@@@html_hist dl_del no1 no=',html_hist.length,'hist=',html_hist[html_hist.length - 1],'wid=',wid);
*/
//②tag　合体前のnext　tag
				var ptag=tag.nextSibling;
				var rt = set_html_hist_id(ptag);
				var idr0=rt['id']; var step0=rt['st']; var id_flag0=rt['fg'];
console.log('LLLLL list=',list,'tag=',ptag,'del prev=',idr0,step0,id_flag0);
				var cn_tag=hist_parent.appendChild(ptag.cloneNode(true));
				cn_tag.innerHTML=html_str.substring(leng-partlen,leng);
				remove_levelid(cn_tagn);
console.log('str=',html_str,'sub=',html_str.substring(leng-partlen,leng));
				var wid='w'+String(step0)+idr0;
				cn_tag.setAttribute('id', wid);
				next=2;
				var flag0='dl_del';
				html_hist.push({type:flag0,next:next,level:list.level,id_flag:id_flag0,tag_id:idr0,step:step0,other:0,leng:0});
console.log('@@@@@html_hist dl_del no2 no=',html_hist.length,'hist=',html_hist[html_hist.length - 1],'wid=',wid);
//③tag　合体後の現在タグなのだがredo用としてwcloneにcloneする
				var nlen=tag.childNodes.length-1;
				var clen=tag.childNodes[nlen].length;
console.log('node and pos=',nlen,clen);
				tag.innerHTML=html_str;
				var rt = set_html_hist_id(tag);
				var idr0=rt['id']; var step0=rt['st']; var id_flag0=rt['fg'];
				flag0='text';
				var cn_tag=hist_parent.appendChild(tag.cloneNode(true));
				remove_levelid(cn_tagn);
				var wid='w'+String(step0)+idr0;
				cn_tag.setAttribute('id', wid);
				tag.nextSibling.remove();
				leng=check_hist_leng(cn_tag);
				next=2;

				reset_cursor(tag,nlen,clen);
console.log('dl_del step wid=',step0,wid,tag);
				html_hist.push({type:flag0,next:next,level:level,id_flag:id_flag0,tag_id:idr0,step:step0,other:0,leng:leng});
console.log('@@@@@html_hist dl_del no3 no=',html_hist.length,'hist=',html_hist[html_hist.length - 1],'wid=',wid);
				text_edit_mend_flag=0;
				}
			if(type=='bs_del') {   //prev_tagにnow_tagが合体
console.log('bs_del  now=',tag,'prev=',tag.previousSibling,'next=',tag.nextSibling);
console.log('combined=',combined_sib_prev);    //combined_sib_prevは直前のprev_tagのlength
//BS_delのhistの順番①合体直前の現tag（要logic)②合体前prev③合体後prev
				var html_str=tag.previousSibling.innerHTML+tag.innerHTML;
				html_str=from_nbsp(html_str);
				var partlen=combined_sib_prev;
				var leng=html_str.length;
console.log('srting=', html_str,'leng=',partlen,leng);
				var list=html_hist[html_hist.length - 1];
/*
//①tag　合体直前の現tag
				var rt = set_html_hist_id(tag);
				var idr0=rt['id']; var step0=rt['st']; var id_flag0=rt['fg'];
console.log('list=',list,'tag=',ptag);
				next=1;
				var flag0='bs_del';
				var leng0=check_hist_leng(ptag);
				var cn_tag=hist_parent.appendChild(tag.cloneNode(true));
				cn_tag.innerHTML=html_str.substring(leng-partlen,leng);
				remove_levelid(cn_tagn);
				var wid='w'+String(step0)+idr0;
				cn_tag.setAttribute('id', wid);
				var now_tag=ptag;
console.log('bs_del step wid=',step,wid,cn_tag,'inner=',cn_tag,innerHTML);
				var other0=combined_sib_prev;
				html_hist.push({type:flag0,next:next,level:list.level,id_flag:id_flag0,tag_id:idr0,step:step0,other:other0,leng:leng0});
console.log('@@@@@html_hist bs_del no1 no=',html_hist.length,'hist=',html_hist[html_hist.length - 1],'wid=',wid);
*/
//②tag　合体前のprev　tag
				var ptag=tag.previousSibling;
				var nlen=ptag.childNodes.length-1;
				var clen=ptag.childNodes[nlen].length+1;
console.log('node and pos=',nlen,clen);
				var rt = set_html_hist_id(ptag);
				var idr0=rt['id']; var step0=rt['st']; var id_flag0=rt['fg'];
console.log('LLLLL list=',list,'tag=',ptag,'del prev=',idr0,step0,id_flag0);
				var cn_tag=hist_parent.appendChild(ptag.cloneNode(true));
				cn_tag.innerHTML=html_str.substring(0,partlen);
				remove_levelid(cn_tagn);
console.log('str=',html_str,'sub=',html_str.substring(0,partlen));
				var wid='w'+String(step0)+idr0;
				cn_tag.setAttribute('id', wid);
				next=2;
				var flag0='bs_del';
				html_hist.push({type:flag0,next:next,level:list.level,id_flag:id_flag0,tag_id:idr0,step:step0,other:0,leng:0});
console.log('@@@@@html_hist bs_del no2 no=',html_hist.length,'hist=',html_hist[html_hist.length - 1],'wid=',wid);
//③tag　合体後のprev_tag　現在タグなのだがredo用としてwcloneにcloneする
				var now_tag=tag.previousSibling;
				now_tag.innerHTML=html_str;
				var rt = set_html_hist_id(now_tag);
				var idr0=rt['id']; var step0=rt['st']; var id_flag0=rt['fg'];
				leng=check_hist_leng(now_tag);
				flag0='text';
				var cn_tag=hist_parent.appendChild(now_tag.cloneNode(true));
				remove_levelid(cn_tagn);
				var wid='w'+String(step0)+idr0;
				cn_tag.setAttribute('id', wid);
				next=2;
				now_tag.nextSibling.remove();
console.log('str=',html_str,'now_tag=',now_tag,'inner=',now_tag.innerHTML,'pos=',partlen,'leng=',html_str.length);
console.log('bs_del step wid=',step0,wid);

				reset_cursor(now_tag,nlen,clen);
console.log('now_tag=',now_tag,'inner=',now_tag.innerText);
				html_hist.push({type:flag0,next:next,level:level,id_flag:id_flag0,tag_id:idr0,step:step0,other:0,leng:leng});
console.log('@@@@@html_hist bs_del no3 no=',html_hist.length,'hist=',html_hist[html_hist.length - 1],'wid=',wid);
				text_edit_mend_flag=0;
				}
			}
		else　{
console.log('別のTag & mend=',text_edit_mend_flag);
			var list=html_hist[html_hist.length - 1];
console.log('list=',list);
			if(text_edit_mend_flag>0) {   //直前のhtml_histと同じ名前で現在状態をlist化clone化する
				var flag0='text';
				next=1;
				var ttag=document.getElementById(list.tag_id);
				var tagn=hist_parent.appendChild(ttag.cloneNode(true));
				remove_levelid(tagn);
				var rt = set_html_hist_id(ttag);
				var idr0=rt['id']; var step0=rt['st']; var id_flag0=rt['fg'];
				var leng0=check_hist_leng(tag);
console.log('idr step flag=',idr0,step0,id_flag0);
				var wid='w'+String(step0)+list.tag_id;
console.log('MMMMM mend step wid=',step0,wid,ttag);
				tagn.setAttribute('id', wid);
				html_hist.push({type:flag0,next:next,level:list.level,id_flag:list.id_flag,tag_id:idr0,step:step0,other:0,leng:leng0});
console.log('@@@@@html_hist else_mend_on no=',html_hist.length,'hist=',html_hist[html_hist.length - 1],'wid=',wid);
				}
			else {
				var step0=list.step;
				var wid='w'+String(step0)+list.tag_id;
console.log('step wid=',step0,wid,'mend=',text_edit_mend_flag);				
				var dtag=document.getElementById(wid);
console.log('cloned del=',dtag);
				if(dtag) dtag.remove();                  //cloneしていたtagを削除する
				html_hist.pop();
				}
			//新たなtagをhist化し、text処理に入る直前のtagをwcloneにcloneするclone_idは
			//この関数最初の入力tagとstepを受けてhist化　cloneは　w+step+idr　としている
			next=0;
			var leng=check_hist_leng(tag);
			var tagn=hist_parent.appendChild(tag.cloneNode(true));
			remove_levelid(tagn);
			var wid='w'+String(step)+idr;
			tagn.setAttribute('id', wid);
			html_hist.push({type:'text',next:next,level:level,id_flag:id_flag,tag_id:idr,step:step,other:0,leng:leng});
console.log('@@@@@html_hist else_end no=',html_hist.length,'hist=',html_hist[html_hist.length - 1],'wid=',wid);
			text_edit_mend_flag=0;
			}
		}
	else {
console.log('初期のTag');
		var ttag=search_pnode(tag);
		if(!ttag) ttag=tag;
		var rt = set_html_hist_id(ttag);
		var idr=rt['id']; var step=rt['st']; var id_flag=rt['fg'];
console.log('idr step flag=',idr,step,id_flag);
console.log('start tag=',ttag);
		var h_len=html_hist.length;
		if(h_len>=1) {
			var list=html_hist[html_hist.length - 1];
			if(list.type=='text' && list.next==0) {
				var wid='w'+String(list.step)+list.tag_id;
				var dtag=document.getElementById(wid);
				if(dtag) dtag.remove();
				html_hist.pop();				
				}
			}
		text_edit_mend_flag=0;
		next=0;
//text処理に入る直前のtagをwcloneにcloneするclone_idは　w+idrとする
		var leng=check_hist_leng(ttag);
		var tagn=hist_parent.appendChild(ttag.cloneNode(true));
		remove_levelid(tagn);
		var wid='w'+String(step)+idr;
		tagn.setAttribute('id', wid);
		html_hist.push({type:'text',next:next,level:level,id_flag:id_flag,tag_id:idr,step:step,other:0,leng:leng});
console.log('@@@@@初期hist no0 no=',html_hist.length,'hist=',html_hist[html_hist.length - 1],'wid=',wid);
//console.log('FFFFFF step wid=',step,wid,html_hist[html_hist.length - 1]);
		}

	if(html_hist_leng>=0) {
		var tot_leng=0;
		for(let k=0;k<html_hist.length;k++) tot_leng=tot_leng+html_hist[k].leng;
		html_hist_leng=tot_leng;
		}

//add or del の直後に更なるadd/delがあった場合はtextが出来ない場合があるのでdumyのtexthistを入れておく
	if(html_hist.length>2) {
		var list=html_hist[html_hist.length - 2];
		if((list.type=='add' || list.type=='del' || list.type=='del_F') && list.next!=0) {
			var tag_id=html_hist[html_hist.length - 1].tag_id;
			html_hist.push({type:'text',next:0,level:list.level,id_flag:0,tag_id:tag_id,step:0,other:0,leng:0});
console.log('after add/del text hist'); 
			}
		}
console.log('html hist=',html_hist,'hist leng=',html_hist_leng);
	set_undoredo_color();

	return result;
	} //End check_html_hist

function set_undoredo_color() {
	if(html_hist.length>0) document.querySelector('#html_undo').style.backgroundColor="#337ab7";
	else document.querySelector('#html_undo').style.backgroundColor="#b0c4de";
	if(html_undo.length>0) document.querySelector('#html_redo').style.backgroundColor="#337ab7";
	else document.querySelector('#html_redo').style.backgroundColor="#b0c4de";
	}

function reset_cursor(elem,cn,offset) {
  	const selection = window.getSelection();
  	const range = document.createRange();
console.log('set cursor=',elem,cn,offset)

	range.setStart(elem.childNodes[cn], offset);
  	range.setEnd(elem.childNodes[cn], offset);

  	selection.removeAllRanges();
  	selection.addRange(range);
console.log('range=',selection,range);
	}

function from_nbsp(elemtext) {
const regex = /&nbsp;/ig;
console.log('text=',elemtext);
	if(elemtext=='') return elemtext;
    	const testReplace = elemtext.replaceAll(regex,' ');
	return testReplace;
	}

function check_hist_leng(tag,next) {
	var leng=0;
	var tag_char = new XMLSerializer().serializeToString(tag);
	leng=tag_char.length;
	html_hist_leng=html_hist_leng+leng;
	if(html_hist.length>html_hist_max) {
		var wid='w'+String(html_hist[0].step)+html_hist[0].tag_id;
		var dtag=document.getElementById(wid);
		if(dtag) hist_parent.removeChild(dtag);
console.log('first hist overflow=',wid,html_hist[0]);
		html_hist.shift();
		if(html_hist[0].next==2) {
			var wid='w'+String(html_hist[0].step)+html_hist[0].tag_id;
			var dtag=document.getElementById(wid);
			if(dtag) hist_parent.removeChild(dtag);
			html_hist.shift();
console.log('second hist overflow=',wid,html_hist[0]);
			}
		}
	if(html_hist_leng>html_hist_maxlen && next!=2) {
console.log('hist length over'+String(html_hist_leng)+' newly='+String(leng));
		alert('範囲が大きく元には戻せません。large size pointed ,so can not undo');
		html_hist_leng=-100;
		}
console.log('CCCCCC check hist leng=',html_hist_leng,'newly=',leng);
	return leng;
	}  //End check_hist_leng

   $("#html_undo").on("click", function() {
console.log('Enter to Undo html_list=',html_hist,'leng=',html_hist.length,html_undo);
	var loop=false;
      	if(html_hist.length>0) {
	  	var list=html_hist.pop();
		if(list.next!=0) loop=true;
console.log('popup list=',list);
		}

	  while(loop){
		if(list.type=='add' || list.type=='del' || list.type=='del_F') {
			if(list.type=='add') {   //addの場合はstep番号付きのidを付けてhist領域にcloneし、本番領域を削除する
//				var tag=get_from_tag_tree(list.type,list.level,list.tree);
				var tag=document.getElementById(list.tag_id);
				//dtag=tag.nextSibling;
				//dtag=tag.nextElementSibling;
				var wid='w'+String(list.step)+list.tag_id;
				var tagn=document.getElementById(wid);
				if(!tagn) {
					tagn=hist_parent.appendChild(tag.cloneNode(true));
					tagn.setAttribute('id', wid);
					}
				tag.remove();
				html_undo.push(list);
				list=html_hist.pop();
console.log('remove added tag=',wid,tagn);
				}
			else {     //delの場合はhist_parent領域にcloneしていたものを取り出して本番領域に戻す
				var wid='w'+String(list.step)+list.tag_id;			
				var dtag=document.getElementById(wid);
console.log('deleted tag=',wid,dtag,list);
				var tagn=dtag.cloneNode(true);
				//if(list.id_flag==1) tagn.removeAttribute('id');
				tagn.setAttribute('id',list.tag_id);
				if(list.type=='del_F') now_tag.insertBefore(tagn, now_tag.firstChild);
				else $(tagn).insertAfter(now_tag)
				//hist_parent.removeChild(dtag);
				//set_tag_to_tree(list.flag,list.level,list.tree,tagn);
				html_undo.push(list);
				list=html_hist.pop();
console.log('recover delete tag=',wid,tagn);
				}
			}
		else if(list.type=='add_d' || list.type=='del_d') {
				var tag=document.getElementById(list.tag_id);
console.log('undo add_d/del_d target node=',tag);
				//dtag=tag.nextSibling;
				//dtag=tag.nextElementSibling;
				html_undo.push(list);
				list=html_hist.pop();
console.log('add_d step list=',list)
				var wid='w'+String(list.step)+list.tag_id;
				var tagn=document.getElementById(wid);
console.log('replace added tag=',wid,tagn,tag);
				var ctagn=tagn.cloneNode(tagn);
//				tag.innerHTML=tagn.innerHTML;
				$(ctagn).insertAfter(tag);
				tag.remove();
				ctagn.setAttribute('id',list.tag_id);
			}
		else if(list.type=='sp_text') {
			var now_tag=document.getElementById(list.tag_id);
			html_undo.push(list);
			list=html_hist.pop();
			var old_tagid='w'+String(list.step)+list.tag_id;
			var old_tag=document.getElementById(old_tagid);
console.log('sp_text Enter now=',now_tag,'old=',old_tag);
			now_tag.innerHTML=old_tag.innerHTML;
			var del_tag=now_tag.nextSibling;
console.log('sp_text now_tag=',now_tag,'del tag=',del_tag);
			del_tag.remove();
			}
		else if(list.type=='dl_del'|| list.type=='bs_del') {
			if(list.type=='dl_del') {
				var old_tagid='w'+String(list.step)+list.tag_id;
				var old_tag=document.getElementById(old_tagid);
				var nx_tag=old_tag.cloneNode(true);
				nx_tag.setAttribute('id',list.tag_id);
				nx_tag.innerHTML=old_tag.innerHTML;
			
console.log('flag=',list.type,'tag=',old_tagid);
				html_undo.push(list);
				list=html_hist.pop();
				var old_tagid='w'+String(list.step)+list.tag_id;
				var old_tag=document.getElementById(old_tagid);
				now_tag.innerHTML=old_tag.innerHTML

				$(nx_tag).insertAfter(now_tag);
console.log('bs_del now=',now_tag,'before_tag=',nx_tag);
				}
			else {		//bs_delの場合
				var old_tagid='w'+String(list.step)+list.tag_id;
				var old_tag=document.getElementById(old_tagid);
				now_tag.innerHTML=old_tag.innerHTML;
console.log('flag=',list.type,'tag=',old_tagid);
				html_undo.push(list);
				list=html_hist.pop();
				var old_tagid='w'+String(list.step)+list.tag_id;
				var old_tag=document.getElementById(old_tagid);

				var nx_tag=old_tag.cloneNode(true);
				nx_tag.setAttribute('id',list.tag_id);

				$(nx_tag).insertAfter(now_tag);
console.log('bs_del now=',now_tag,'before_tag=',nx_tag);
				}
			}
		else {
			var now_tag=document.getElementById(list.tag_id);
	var bbb=now_tag.innerHTML;
console.log('now_tag=',bbb);
			}
		html_undo.push(list);
		loop=false;
		if(html_hist.length>0) {
			if(list.next!=0) {
				list=html_hist.pop();
				loop=true
				}
console.log('popup list=',list);
			}
	}
	set_undoredo_color();
console.log('html hist=',html_hist,'redo hist=',html_undo,'redo leng=',html_undo.length);
    });

   $("#html_redo").on("click", function() {
console.log('Enter Redo html_hist=',html_hist,html_undo,'undo leng=',html_undo.length);
	var loop=false;
	if(html_undo.length>0) {
		var list=html_undo.pop();
		loop=true;
console.log('first popup list=',list);
	}
	else return;

	  while(loop){
		loop=false;
		if(list.type=='add' || list.type=='del' || list.type=='del_F') {
			if(list.type=='add') {   //addの場合はhist領域にcloneしていたものを本番領域に戻す
				html_hist.push(list);
				list=html_undo.pop();
console.log('redo add step list=',list)
				var wid='w'+String(list.step)+list.tag_id;
				var dtag=document.getElementById(wid);
				var tagn=dtag.cloneNode(true);
console.log('redo add tag=',wid,tagn);
				//if(dtag) hist_parent.removeChild(dtag);
				//if(list.id_flag==1) tagn.removeAttribute('id');
				tagn.setAttribute('id',list.tag_id);
				$(tagn).insertAfter(now_tag);
				//set_tag_to_tree(list.type,list.level,list.tree,tagn)
				}
			else {     //delの場合は本番領域に戻していたものを再度hist領域にcloneする
console.log('redo del step list=',list)
//				var dtag=get_from_tag_tree(list.type,list.level,list.tree);
				var dtag=document.getElementById(list.tag_id);
//				hist_parent.appendChild(dtag.cloneNode(true));
				if(dtag) dtag.remove();
console.log('cancel tag=',tagn);
				html_hist.push(list);
				list=html_undo.pop();
				}
			}
		else if(list.type=='add_d' || list.type=='del_d') {
				var tag=document.getElementById(list.tag_id);

console.log('target node=',tag);
				//dtag=tag.nextSibling;
				//dtag=tag.nextElementSibling;
				html_hist.push(list);
				list=html_undo.pop();
console.log('add_d step list=',list)
				var wid='w'+String(list.step)+list.tag_id;
				var tagn=document.getElementById(wid);
				var ctagn=tagn.cloneNode(tagn);
console.log('replace added tag=',wid,tagn,tag);
//				tag.innerHTML=tagn.innerHTML;
				$(ctagn).insertAfter(tag);
				tag.remove();
				ctagn.setAttribute('id',list.tag_id);
console.log('redo add tag=',wid,tagn);
			}
		else if(list.type=='sp_text') {
//最初のhistはsplitの後半部のsplit直後
			var now_tag=document.getElementById(list.tag_id);
			var wid='w'+String(list.step)+list.tag_id;			
			var dtag=document.getElementById(wid);
			now_tag.innerHTML=dtag.innerHTML;
//２番目はsplitの前半部
			html_hist.push(list);
			list=html_undo.pop();
			var old_tagid='w'+String(list.step)+list.tag_id;
			var old_tag=document.getElementById(old_tagid);
			var tagn=old_tag.cloneNode(true);
			tagn.setAttribute('id',list.tag_id);
console.log('first tag=',tagn,'2bd=',old_tag);
			$(tagn).insertAfter(now_tag);
			}
		else if(list.type=='dl_del'|| list.type=='bs_del') {
			if(list.type=='dl_del') {
				html_hist.push(list);
				list=html_undo.pop();
console.log('list 0=',list);
				var now_tag=document.getElementById(list.tag_id);
				var old_tagid='w'+String(list.step)+list.tag_id;
				var old_tag=document.getElementById(old_tagid);
				now_tag.innerHTML=old_tag.innerHTML;
console.log('dl_del now=',now_tag);
				now_tag.nextElementSibling.remove();
				}
			else {
				html_hist.push(list);
				list=html_undo.pop();
console.log('list 0=',list);
				var now_tag=document.getElementById(list.tag_id);
				var old_tagid='w'+String(list.step)+list.tag_id;
				var old_tag=document.getElementById(old_tagid);
				now_tag.innerHTML=old_tag.innerHTML;
console.log('bs_del now=',now_tag);
				now_tag.nextElementSibling.remove();
				}
			}
		else {
			var now_tag=document.getElementById(list.tag_id);
			loop=true;
			html_hist.push(list);
			list=html_undo.pop();
//	var bbb=now_tag.innerHTML;
//console.log('now_tag=',bbb);
			}

/*
		if(html_undo.length>0 && list.next!=0) {
			list=html_undo.pop();
			loop=true;
			}
		else loop=false;
*/
console.log('popup list=',list,'loop=',loop);
	}
	html_hist.push(list);
	set_undoredo_color();
console.log('html undo=',html_undo,html_hist,'hist leng=',html_hist.length);
    });

function get_from_tag_tree(flag,level,tree) {
console.log('Get tag from tree Top node=',tree[tree.length-1].node,tree);
	var t_node=document.getElementById(tree[tree.length-1].node);
    	for(let i=tree.length-1;i>=0;i--) {
		nn=tree[i].ind;
		if(level==tree[i].level) {
			if(level==0) {
				if(flag=="add") new_node=t_node.children[0];
				else new_node=t_node.children[0];
				}
			else {
				if(flag=="add") new_node=t_node.children[nn+1];
			        else new_node=t_node.children[nn];
				}
			t_node=new_node;
console.log('match tag=',t_node,tree[i],'level=',level);
			break;
			}
		else {
			if(i<tree.length-1) {
				new_node=t_node.children[nn];
				t_node=new_node;
				}
console.log('chidren i=',i,tree[i],tree[i+1],t_node.children);
			}
		}
	return t_node;
}

function set_tag_to_tree(flag,level,tree,tag) {
console.log('Set tag to tree Top node=',tree[tree.length-1].node,tree);
	var t_node=document.getElementById(tree[tree.length-1].node);
    	for(let i=tree.length-1;i>=0;i--) {
		nn=tree[i].ind;
		if(level==tree[i].level) {
console.log('set tag=',t_node,tree[i],'level=',level);
			cancel_green_line();
			if(level==0) {
				if(flag=="add") t_node.insertBefore(tag, t_node.firstChild);
				else t_node.insertBefore(tag, t_node.firstChild);
				}
			else {
				t_node=t_node.children[nn];
				if(flag=="add") $(tag).insertAfter(t_node);
			     	else $(tag).insertBefore(t_node);
				}
			break;
			}
		else {
			if(i<tree.length-1) {
				new_node=t_node.children[nn];
console.log('chidren i=',i,tree[i],tree[i+1],t_node.children);
				t_node=new_node;
				}
			}
	}
}
</script>
<script class="minify" id="smain_02">
var ch_check_flag=0;
var export_disp_flag=0;

//Click+Shiftキーが押された時は水平又は垂直のLineを描く
function mend_points() {
	let leng=drawingPoints.length;
	if(Math.abs(drawingPoints[leng-1].x-drawingPoints[leng-2].x)>Math.abs(drawingPoints[leng-1].y-drawingPoints[leng-2].y)){
		drawingPoints[leng-1].y=drawingPoints[leng-2].y;
		}
	else {
		drawingPoints[leng-1].x=drawingPoints[leng-2].x;
		}
//console.log(drawingPoints[leng-1],drawingPoints[leng-2]);
   }

//④HTML　edit
//
//DisplayモードとEditモードの切り替え
//
//Tvis（only displayモード）、Edit(visual edit)  Html（Html表示モード）、SVG（SVG　editモード）の切り替え
//
function chng_mode(){
console.log('**Enter change mode from**',Editmode);
    if(pallet_dialog_flag) {
		$('#pallet').dialog("close");
//console.log('pallet dialog close flag=',pallet_dialog_flag);
		}
    //選択したf_editによって分岐
    switch (fgedit.selectedIndex){
      case 0:               //     Visual mode
		document.getElementById("fig_sel_end").click();
		if(my_html_design_dialog) 	$('#my_html_design').dialog("close");
   		if(my_draw_fig_dialog)		$('#draw-svg').dialog("close");
   		if(my_basic_draw_dialog)	$('#basic-draw').dialog("close");
		my_basic_draw_dialog=0;
　　　　　　	document.getElementById("texh").contentEditable = false;
　　　　　　	document.getElementById("texx").contentEditable = false;
		document.getElementById( "texx" ).style.zIndex ='40';
		document.getElementById( "texh" ).style.zIndex ='20';
		if(Editmode=="Thtm"){
			var last=document.getElementById("texh").value.lastIndexOf('</div>')
			var slic=document.getElementById("texh").value.length-1-(last+6);
			document.getElementById("texh").value=document.getElementById("texh").value.slice(0,-slic);
			document.getElementById("texx").innerHTML=document.getElementById("texh").value;
			}
		document.getElementById("texx").contentEditable = false;
    		var hand_down=first_container.addEventListener( 'mousedown', draw_down,false);

		nodisp=document.getElementById('tab2');
       		nodisp.style.display='none';
       		disp=document.getElementById('tab1');
       		disp.style.display='block';
		document.getElementById(svg_now).style.display="block";

		if(conv_cord) {
			org_container.setAttribute('class','canv2 point_none select_auto');
			conv_cord=false;
			}

		Editmode="Tvis";
		//document.getElementById("texx").focus();
		return_scroll();
		document.oncontextmenu = function () {return true;}  //contextmenu 表示の禁止解除
console.log('**Enter change mode To**',Editmode)
		break;
      case 1:               //     Edit mode
		document.getElementById("fig_sel_end").click();
		if(my_html_design_dialog) 	$('#my_html_design').dialog("close");
   		if(my_draw_fig_dialog)		$('#draw-svg').dialog("close");
   		if(my_basic_draw_dialog)	$('#basic-draw').dialog("close");
		my_basic_draw_dialog=0;
　　　　　　	document.getElementById("texh").contentEditable = false;
　　　　　　	document.getElementById("texx").contentEditable = false;
		document.getElementById( "texx" ).style.zIndex ='40';
		document.getElementById( "texh" ).style.zIndex ='20';
		if(Editmode=="Thtm"){
//			unescape_text();
//			document.getElementById("texx").innerHTML=document.getElementById("texh").innerHTML;
//			document.getElementById("texx").innerHTML=unescapeHtml(document.getElementById("texh").value);
			var last=document.getElementById("texh").value.lastIndexOf('</div>')
			var slic=document.getElementById("texh").value.length-1-(last+6);
			document.getElementById("texh").value=document.getElementById("texh").value.slice(0,-slic);
			document.getElementById("texx").innerHTML=document.getElementById("texh").value;
			}
		document.getElementById("texx").contentEditable = true;
    		var hand_down=first_container.addEventListener( 'mousedown', draw_down,false);
/*
		var ed_tags=document.querySelectorAll('div.divsvg');
console.log('divsvg tags=',ed_tags);
		ed_tags.forEach(function (element) {
			element.setAttribute('contentEditable','true');
			element.setAttribute('class','divsvg point_none select_auto');
console.log('element=',element);
		});
*/		
		nodisp=document.getElementById('tab2');
       		nodisp.style.display='none';
       		disp=document.getElementById('tab1');
       		disp.style.display='block';
		document.getElementById(svg_now).style.display="block";

		if(conv_cord) {
			org_container.setAttribute('class','canv2 point_none select_auto');
			conv_cord=false;
			}

		Editmode="Edit";
		return_scroll();
    		Svg_mode=""
    		Draw_mode="";

		set_undoredo_color();


		//document.getElementById("texx").focus();
		document.oncontextmenu = function () {return false;}  //contextmenu 表示の禁止
//		document.oncontextmenu = function () {return true;}  //contextmenu 表示の禁止解除
console.log('**Enter change mode To**',Editmode,'svg_now=',svg_now)
		break;
      case 2: 
		if(my_html_design_dialog) 	$('#my_html_design').dialog("close");
　　　　　　	document.getElementById("texh").contentEditable = false;
　　　　　　	document.getElementById("texx").contentEditable = false;
		document.getElementById( "texh" ).style.zIndex ='10';
		document.getElementById( "texx" ).style.zIndex ='40';
		//document.getElementById( "texx" ).style.zIndex ='10';
    		var hand_down=first_container.addEventListener( 'mousedown', draw_down,false);
//    		var hand_down=org_container.addEventListener( 'mousedown', draw_down,false);
		if(Editmode=="Thtm"){
//			document.getElementById("texx").innerHTML=unescapeHtml(document.getElementById("texh").value);
			var last=document.getElementById("texh").value.lastIndexOf('</div>')
			var slic=document.getElementById("texh").value.length-1-(last+6);
			document.getElementById("texh").value=document.getElementById("texh").value.slice(0,-slic);
			document.getElementById("texx").innerHTML=document.getElementById("texh").value;
			}

		nodisp=document.getElementById('tab2');
       		nodisp.style.display='none';
       		disp=document.getElementById('tab1');
       		disp.style.display='block';

		if(from_svg=='indiv') {
console.log('Enter to inSvg mode');
			from_svg='';
			conv_cord=true;
			}
		else {
console.log('Enter to normal Svg mode');
			set_svg(svg_now);
			document.getElementById(svg_now).style.display="block";
			chang_svg();
			conv_cord=false;
			}

		Editmode="Svg";
		Svg_mode="Svg_drag";
		//no_scroll();
	document.oncontextmenu = function () {return false;}  //contextmenu 表示の禁止
//	document.oncontextmenu = function () {return true;}  //contextmenu 表示の禁止解除
console.log('**Enter change mode To**',Editmode,'svg_now=',svg_now)
		break;
      case 3: 
		document.getElementById("fig_sel_end").click();
		if(my_html_design_dialog) 	$('#my_html_design').dialog("close");
   		if(my_draw_fig_dialog)		$('#draw-svg').dialog("close");
   		if(my_basic_draw_dialog)	$('#basic-draw').dialog("close");
		my_basic_draw_dialog=0;

　　　　　　	document.getElementById("texh").contentEditable = false;
　　　　　　	document.getElementById("texx").contentEditable = false;
		document.getElementById( "texh" ).style.zIndex ='40';
		document.getElementById( "texx" ).style.zIndex ='20';
		//escape_text();
		document.getElementById("texh").value=document.getElementById("texx").innerHTML;
		document.getElementById("texh").contentEditable = true;
		document.getElementById("texh").value=document.getElementById("texh").value+'\n\n\n\n';

//		var leng=document.getElementById("texh").value.length;
//		var last=document.getElementById("texh").value.lastIndexOf('</div>')
//		var text=document.getElementById("texh").value.substring(last , leng-1);
//		var hex=string2hex(text);
//console.log('html text=',last,leng,text,'hex=',hex);
//		const newStr = document.getElementById("texh").value.substring(last+6, leng - 1);
//		var slic=document.getElementById("texh").value.length-1-(last+6);
//console.log('cancel=',string2hex(newStr),'leng=',newStr.length,slic);
//		document.getElementById("texh").value=document.getElementById("texh").value.slice(0,-slic);

		if(conv_cord) {
			org_container.setAttribute('class','canv2 point_none select_auto');
			conv_cord=false;
			}

		nodisp=document.getElementById('tab1');
        	nodisp.style.display='none';
        	disp=document.getElementById('tab2');
        	disp.style.display='block';
		document.getElementById(svg_now).style.display="none";

		Editmode="Thtm";
		return_scroll();

console.log('**Enter change mode To**',Editmode,'svg_now=',svg_now)
		break;
    }
    cancel_green_line();
    change_css(Editmode);
    chng_menu(Editmode);
}


function string2hex(s) {
  var result="";
  for(var i=0;i<s.length;++i){
    var h = ("0"+s.charCodeAt(i).toString(16)).substr(-2);
    result += h;
  }
  return result;
}

function chng_menu(Editmode){        /*   取り敢えずのメニュー切り替え　*/
    switch (Editmode){
      case 'Tvis':               //     Visual mode
		menu00=document.getElementById('menu00');
       		menu00.style.display='block';
		menu01=document.getElementById('menu01');
       		menu01.style.display='none';
		menu02=document.getElementById('menu02');
       		menu02.style.display='none';
		menu03=document.getElementById('menu03');
       		menu03.style.display='none';
		let langSelect = document.getElementById('chan_title');
//console.log('lang len=',langSelect.length);
		var sel_num=0;
		for(let i=0;i<langSelect.length;i++) {
			if(sys_set_menu==langSelect.options[i].value) {
			sel_num=i;
			break;
			}
		}
		langSelect.options[sel_num].selected = true;
		break;
      case 'Edit':               //     Visual edit mode
		menu00=document.getElementById('menu00');
       		menu00.style.display='none';
		menu01=document.getElementById('menu01');
       		menu01.style.display='block';
		menu02=document.getElementById('menu02');
       		menu02.style.display='none';
		menu03=document.getElementById('menu03');
       		menu03.style.display='none';
		//document.getElementById("fig_sel_end").click();
		break;
      case 'Svg':               //     SVG mode
		menu00=document.getElementById('menu00');
       		menu00.style.display='none';
		menu01=document.getElementById('menu01');
       		menu01.style.display='none';
		menu02=document.getElementById('menu02');
       		menu02.style.display='block';
		menu03=document.getElementById('menu03');
       		menu03.style.display='none';
		break;
      case 'Thtm':               //     Html mode
		menu00=document.getElementById('menu00');
       		menu00.style.display='none';
		menu01=document.getElementById('menu01');
       		menu01.style.display='none';
		menu02=document.getElementById('menu02');
       		menu02.style.display='none';
		menu03=document.getElementById('menu03');
       		menu03.style.display='block';
		document.getElementById("fig_sel_end").click();
		break;
	}
}

function change_css(Editmode) {

	if(Editmode=="Svg"){
      		document.getElementById('svg_00').classList.remove('point_none');
		document.getElementById('svg_00').classList.add('point_auto');
console.log('pointable');
		window.getSelection().removeAllRanges();
		user_select('none');
		}
	else {
		document.getElementById('svg_00').classList.remove('point_auto');
      		document.getElementById('svg_00').classList.add('point_none');
console.log('point none');
		user_select('auto');
		}

	for(var i=0;i<cnsvg_tags.length;i++){
		var svg_tag=cnsvg_tags[i].name;
		if(Editmode=="Svg"){
      			document.getElementById(svg_tag).classList.remove('point_none');
			document.getElementById(svg_tag).classList.add('point_auto');
console.log('pointable');
			window.getSelection().removeAllRanges();
			user_select('none');
			}
		else {
			document.getElementById(svg_tag).classList.remove('point_auto');
      			document.getElementById(svg_tag).classList.add('point_none');
console.log('point none');
			user_select('auto');
			}
		}

	var mark = document.getElementsByClassName('chain_svg_mark');
	for(var i=0;i<mark.length;i++){
		if(Editmode=='Svg' || Editmode=='Edit'){
			mark[i].setAttribute('style', 'display:block;');
			mark[i].setAttribute('opacity', '0.6');
console.log('svg_mark');
			}
		else {
			mark[i].setAttribute('style', 'display:none;');
			}
		}
	var mark = document.getElementsByClassName('indiv_svg_mark');
	for(var i=0;i<mark.length;i++){
		if(Editmode=='Svg' || Editmode=='Edit'){
			mark[i].setAttribute('style', 'display:block;');
			mark[i].setAttribute('stroke', 'lightblue');
			mark[i].setAttribute('fill', 'lightblue');
			mark[i].setAttribute('opacity', '0.6');
console.log('indiv_svg_mark');
			}
		else {
			mark[i].setAttribute('style', 'display:none;');
			}
		}

   } //End of change_css

function user_select(mode) {

	if(mode=="none"){
		document.getElementById('svg_00').classList.remove('select_auto');
      		document.getElementById('svg_00').classList.add('select_none');
console.log('select none');
		}
	else {
	      	document.getElementById('svg_00').classList.remove('select_none');
		document.getElementById('svg_00').classList.add('select_auto');
console.log('selectable');
		}

	for(var i=0;i<cnsvg_tags.length;i++){
		var svg_tag=cnsvg_tags[i].name;
		if(mode=="none"){
			document.getElementById(svg_tag).classList.remove('select_auto');
      			document.getElementById(svg_tag).classList.add('select_none');
console.log('select none');
			}
		else {
      			document.getElementById(svg_tag).classList.remove('select_none');
			document.getElementById(svg_tag).classList.add('select_auto');
console.log('selectable');
			}
		}
   } //End of select_none

function expand_svg(svtex,svg_tagn) {
　　　const svg = document.getElementById(svg_tagn);
      if(svtex!=''){
	  	var n_s=0;
	  	var i=0;
	  	var n_last=svtex.length;
	  	do {
             		i = i + 1;
      	     		n_e = svtex.indexOf('|<=>|',n_s );
	     		if(n_e<0) {
				n_e=n_last;
				}	     
console.log('num=',i,' n_start and n_last=',n_s,n_e,n_last);
	     		text_n=svtex.substring(n_s , n_e);
console.log('num= ',i,' tex= ',text_n)
	     		n_s=n_e+5;
             		const domParser = new DOMParser();
　　	     		parsedSVGDoc = domParser.parseFromString(text_n, 'image/svg+xml');
   	    		 parsedSVG = parsedSVGDoc.childNodes[0];
　　	     		svg.appendChild(parsedSVG);
	     		svg.lastChild.outerHTML=text_n
	     		Svg_fig_count+=1;
console.log('***SVG fig count= ',Svg_fig_count)
	     		} while (n_s < n_last);
	     	//first childをcontainerとする
console.log('***open g01 group as container');
	     	container=svg.children[1];
console.log('**parent= ',svg,'container=',container);
		var fig_id=container.getAttribute('id');
console.log('container id=',fig_id);
	  	}
	else {　//読み込むsvgデータがない場合はid=g01の<g>タグを作成してcontainerとする。
console.log('***make g01 group as container');
		container=svg;
		var {group,fig_id}=make_group('top');
		group.setAttribute('class', 'top');
		group.removeAttribute('opacity');
		container=group;
		}
    }//End of expand_svg

    function escape_text(){
//document text部(divsvgタグの取得）とescape処理

	var k=svg_tag_menu.length;
console.log(svg_tag_menu,svg_tag_menu.options[0].value,'leng=',k);

	for(let i=0;i<k ;i++) {
		var div_tag='div'+svg_tag_menu.options[i].value;
		var tag=document.getElementById(div_tag);
//		var tagn=tag.cloneNode(true);
//console.log('tag=',tagn,'new=',newdiv);
		tags_escape_text(tag);
console.log('escaped=',tag);
		}
	} //End of escape_text

    function tags_escape_text(tag) {
//console.log('tag=',tag);
	var len=tag.childNodes.length;
	if(len>0) {
//console.log('tag node=',tag.nodeName);
		for(var k=0 ;k<len ;k++){
			var tagn=tag.childNodes[k];
			tags_escape_text(tagn);
			}
console.log('tags escaped=',tag);
		}
	else {
//console.log('last node=',tag.nodeName);
		if(typeof(tag)=='string') {
			tag=escapeHtml(tag);
			}
		else {
			tag.textContent=escapeHtml(tag.textContent);
			}
console.log('simple tag escaped=',tag);
		}
	}

    function chng_shift() {
    const selectedText = window.getSelection().toString();
console.log(selectedText);
    var align_tx;

    var sel = window.getSelection();
    if(!sel.rangeCount) return; //範囲選択されている箇所がない場合は何もせず終了

    var range = sel.getRangeAt(0);　　　　　　　　　　　//　OK!!

    switch (Shift.selectedIndex){
      case 0:               
		align_tx='text-align: left;';
		break;
      case 1:               
		align_tx='text-align: center;';
		break;
      case 2:               
		align_tx='text-align: right;';
		break;
		}

    var newNode = document.createElement('p');
    newNode.setAttribute('style', align_tx);
    newNode.setAttribute('fig', '段落');
    newNode.innerHTML =  sel.toString();   //選択文字列をnewNodeとして設定
    range.deleteContents();    // 範囲選択箇所を一旦削除
    range.insertNode(newNode); // 前後に<b>と</b>を入れる。
    }

    function chng_list() {
var range = window.getSelection().getRangeAt(0);
var  content = range.extractContents();
//console.log(content);

span = document.createElement('SPAN');
span.setAttribute('fig', '強調');
span.appendChild(content);
var contenthtml = span.innerHTML;
//console.log(contenthtml);
    var newNode;

var string = (contenthtml.replace(/(<([^>]+)>)/ig,'|<=>|')).split('|<=>|');
console.log(string.length,string);

    if(!contenthtml) return; //範囲選択されている箇所がない場合は何もせず終了

    switch (List.selectedIndex){
      case 0:               
		break;
      case 1:               
		newNode = document.createElement('ul');
		break;
      case 2:               
		newNode = document.createElement('ol');
		break;
		}
//console.log(newNode);
	for (var i=0; i<string.length; i++){
	if(string[i]!="") {
        	var li=document.createElement('li');
//console.log(li,newNode);
        	newNode.appendChild(li);
        	li.innerHTML=li.innerHTML + string[i];
		}
	}

    	//newNode.innerHTML =  sel.toString();   //選択文字列をnewNodeとして設定
    	range.deleteContents();    // 範囲選択箇所を一旦削除
    	range.insertNode(newNode); // 前後に<ul>と</ul>を入れる。

    }

    link.onclick = function() { 
    const selectedText = window.getSelection().toString();
console.log('link sel=',selectedText);

    var sel = window.getSelection();
    if(!sel.rangeCount) return; //範囲選択されている箇所がない場合は何もせず終了
    var range = sel.getRangeAt(0);　　　　　　　　　　　//　OK!!

    var newNode =document.createElement('a');
    newNode.setAttribute('fig', 'リンク');
    var user = window.prompt("link先を入力してください", "");
    newNode.href = user;
    newNode.innerHTML = selectedText;   //tag部分に<>を含むと変更出来ない。
console.log('sel_chara=',selectedText,'link=',user);
    newNode.setAttribute('target', '_blank');
    newNode.setAttribute('rel', 'noopener');
    range.deleteContents();    // 範囲選択箇所を一旦削除
    range.insertNode(newNode);
//    window.getSelection().removeAllRanges();
    }

    Spec_chars.onclick = function() { 
    const selectedText = window.getSelection().toString();
console.log('link sel=',selectedText);

    var sel = window.getSelection();
    if(!sel.rangeCount) return; //範囲選択されている箇所がない場合は何もせず終了
    var range = sel.getRangeAt(0);　　　　　　　　　　　//　OK!!
console.log('range=',range)

	var user_init=selectedText;

   	var user = window.prompt("escape文字列入力", user_init);
//	user=escapeHtml(user);
console.log('user input=',user);

	range.startContainer.textContent = range.startContainer.textContent.substring(0, range.startOffset)
					+ user 
					+ range.startContainer.textContent.substring(range.startOffset);

    window.getSelection().removeAllRanges();
    }

    Google_chars.onclick = function() { 
 	navigator.permissions.query({ name: 'clipboard-read' }).then(result => {
            // If permission to read the clipboard is granted or if the user will
            // be prompted to allow it, we proceed.

            if (result.state === 'granted' || result.state === 'prompt') {
		getClipboardContents();
		after_clipboard_google();
		}
	   });
    }

function Google_chars2() {
		document.getElementById("Google_chars").click();
	}

/*
function set_image(){
//move_image_func(e)と連動して画像配置を決める
	document.oncontextmenu = function () {return false;}  //contextmenu 表示の禁止
//	document.oncontextmenu = function () {return true;}  //contextmenu 表示の禁止解除
    switch (image_set.selectedIndex){
      case 0:               
		break;
      case 1:               
console.log('from Local');
		//image_pos=catch_caret();
//console.log('image_pos=',image_pos);
//		if(image_pos=='') break;
		local_image();
		//image_set.value='s001';
		break;
      case 2:               
console.log('from My_DB');
//		image_pos=catch_caret();
//console.log('image_pos=',image_pos);
//console.log('image_pos_common=',image_pos.commonAncestorContainer.parentNode);
//var position=image_pos.commonAncestorContainer.parentNode;
//var image_width=position.clientWidth;
//console.log('width=',position.clientWidth);
//		if(image_pos=='') break;
		db_image();
		//image_set.value='s001';
		break;
      case 3:               
console.log('Space placement');
		image_pos=catch_caret();
		if(image_pos=='') break;
		space_set();
		//image_set.value='s001';
		break;
      case 4:               
console.log('image placement');
		Svg_mode='image';
		image_root='fixed';		
		break;
      case 5:               
console.log('delete image');
		Svg_mode='image';
		image_root='fixed';
		break;
	}
   }
*/

function image_first_set(param){
console.log('Enter to image_first_set');
	if(photo_type=='flex') {
		var a_fig=doc_edit_node.parentNode;
		var afig_sty=a_fig.getAttribute('style');
console.log('photo_type flex node=',a_fig,'style=',afig_sty);
//		a_fig.innerHTML='';
		a_fig.setAttribute('fig', 'figure');
//		var fig_id='g'+(Date.now()).toString();
//		a_fig.setAttribute('id', fig_id);
		var a_imag = document.createElement('img');
//		var title='写真の説明';
		var alt='';
		if(document.getElementById('im_pam5').value) title=document.getElementById('im_pam5').value;
//		var figcap = document.createElement('figcaption');
//		figcap.innerHTML=title;
		if(document.getElementById('im_pam4').value) alt=document.getElementById('im_pam4').value;
		if(alt) a_imag.setAttribute('alt', alt);
//		figcap.setAttribute('align', 'center');
		a_imag.setAttribute('fig', 'img');
		a_imag.setAttribute('draggable', 'false');

		a_imag.src=param;

		parms="width: 100%;height: auto;";
		a_imag.setAttribute('style', parms);
		a_fig.appendChild(a_imag);
//		a_fig.appendChild(figcap);
		var figcap2 = document.createElement('p');
		figcap2.innerHTML='写真の説明';
		if(title) figcap2.innerHTML=title;
		figcap2.setAttribute('align', 'center');
		a_fig.appendChild(figcap2);
//		doc_edit_node=a_fig;
    		tag_trees=[];
    		tag_trees=get_tagStruct(doc_edit_node,0);
    		if(tag_trees.length>0) doc_deep_level=0;
		cancel_green_line();
		setto_current_tag(doc_edit_node);
		set_parms();
//		display_current_tag(doc_edit_node);
		}
	else {
		// figureタグを生成
//alert('絵写真の配置は小枠内のみです。');
//		return;
		var a_fig=doc_edit_node;
console.log('photo_type new node=',a_fig);
		var a_imag = document.createElement('img');
		a_imag.src=param;
console.log(a_imag.src);
		//if(document.getElementById('im_pam1').value) width=document.getElementById('im_pam1').value;
		//if(document.getElementById('im_pam2').value) height=document.getElementById('im_pam2').value;
		var width='200px';
		a_imag.setAttribute('fig', 'img');
		a_imag.setAttribute('draggable', 'false');
		//a_imag.setAttribute('width', width);
		//a_imag.setAttribute('align', 'left');
		parms='width:'+width+';'+'float:left; margin-right:20px;'
		//if(height) a_imag.setAttribute('height', height);
		a_imag.setAttribute('style', parms)
		a_fig.appendChild(a_imag);
		figcap.setAttribute('style', 'text-align:center;');
		var title='写真の説明';
		var alt='';
		if(document.getElementById('im_pam5').value) title=document.getElementById('im_pam5').value;
		var figcap = document.createElement('figcaption');
		figcap.innerHTML=title;
		if(document.getElementById('im_pam4').value) alt=document.getElementById('im_pam4').value;
		a_img.appendChild(figcap);
		if(alt) a_imag.setAttribute('alt', alt);		
		var figcap2 = document.createElement('p');
		figcap2.innerHTML='更なる説明';
		a_fig.appendChild(figcap2);
console.log('not found in flex_box');
    		tag_trees=[];
    		tag_trees=get_tagStruct(doc_edit_node,0);
    		if(tag_trees.length>0) doc_deep_level=0;
		cancel_green_line();
		setto_current_tag(doc_edit_node);
		set_parms();
//		display_current_tag(doc_edit_node);
		}
   }

function search_imgtag(tag) {
//console.log('Enter search_imgtag tag=',tag);
	var flex_tag='';
	src_flg=1;
	var dmtag=tag;
	do {
		var flex=dmtag.getAttribute('class');
//console.log('flex=',flex,' tag=',dmtag);
		if(flex=='flex') {
			flex_tag=dmtag;
			src_flg=0;
			}
		else {
			if(flex=='svg') src_flg=0
			else dmtag=dmtag.parentNode;
			}
	} while (src_flg);
	return flex_tag;
	}

function space_set(){

	var range=catch_caret();

	// figureタグを生成
	var a_fig= document.createElement('div');
	a_fig.setAttribute('style', 'float:left;');
	a_fig.setAttribute('fig', 'image');
	var fig_id='g'+(Date.now()).toString();
	a_fig.setAttribute('id', fig_id);

	var a_imag = document.createElement('img');
	a_imag.setAttribute('width', '100px');
	a_imag.setAttribute('height', '50px');

	a_fig.appendChild(a_imag);
//	$(a_fig).insertAfter('#svg_00');
	range.insertNode(a_fig);

	let rgbColor = document.getElementById(fig_id).style.backgroundColor;
	let color = new RGBColor(rgbColor);
	let hexColor = color.toHex();

//	var dummy='border:solid 1px '+hexColor+';';
	var dummy='border:0px none;';
console.log('border=',dummy,'color=',rgbColor,hexColor);
	a_imag.setAttribute('style', dummy);

   }

function catch_caret() {

    const selectedText = window.getSelection().toString();
//console.log('**Image position at text=',selectedText);
    if(Editmode!='Edit') {
		alert('編集モードでしか使えません。Only Edit mode');
		return;
		}
    var sel = window.getSelection();
	try {
		    var range = sel.getRangeAt(0);　　　　　　　　　　　//　OK!!
//console.log('sel=',sel,' range=',range);
		} catch (error) {
//  	alert('not specifyed cursor position');
	var range = document.createRange();
	var node = document.getElementById("texx").childNodes[1];
console.log('node=',node);
	range.setStart(node, 0);
	range.setEnd(node, 3);
	}
    return range;
}

//function jump to url test
function  jump_to_url() {
console.log('jump to URL test');

	make_url(String(25));

	const flag = true;
	try {
	    if (flag) {
        	throw new Error('終了します');
    		}
    	console.log('実行されないコード');

	} catch (e) {
    		console.log(e.message);
if (window === window.top) {
console.log('It is a top-level browsing context and history=',history.length);
			}
		window.close();
		}
   }

/*
//function chara start
    Tochara.onclick = function() {
	const selectedText = window.getSelection().toString();
	fw_colval=document.querySelector('#trig1').style.backgroundColor;
	bk_colval=document.querySelector('#trig2').style.backgroundColor;
	bd_colval=document.querySelector('#trig3').style.backgroundColor;
console.log('Sel_text=',selectedText,'color=',fw_colval);

	var sel = window.getSelection();
  	if(!sel.rangeCount) return; 

  	var range = sel.getRangeAt(0);　　　　　　　　　　　//OK!!　<font>でも下記の<span>でもOK
  	var font = document.createElement("span");
  	font.style.color = fw_colval;
  	font.style.backgroundColor=bk_colval;
  	range.surroundContents(font);

	//  var span = document.createElement("span");     //OK
	//  span.style.color = colval;
	//  range.surroundContents(span);

	}  //function chara end
*/

  $("#trig1").on("click", function(){
	document.getElementById('hm_parm1').value=fw_colval;
	document.getElementById('hm_parm11').value=fw_colval;
	});

  $("#trig2").on("click", function(){
	document.getElementById('hm_parm2').value=bk_colval;
	document.getElementById('hm_parm12').value=bk_colval;
	document.getElementById('tit_mar0').value=bk_colval;
//	var moji=blackOrWhite(bk_colval);
//	var styl="color:"+moji+";"+" opacity:0.8;";
//	document.getElementById('trig2').setAttribute('style', styl);
//console.log('back=',bk_colval,'moji=',moji);
	});

  $("#trig3").on("click", function(){
	document.getElementById('hm_parm5').value='1px solid '+bd_colval;
//	var moji=blackOrWhite(bd_colval);
//	var styl="color:"+moji+";"+" opacity:0.8;";
//	document.getElementById('trig3').setAttribute('style', styl);
//console.log('back=',bd_colval,'moji=',moji);
	});

  $("#svgtrig1").on("click", function(){
	document.getElementById('fill_color').value=svg_bd_color;
	});

  $("#svgtrig3").on("click", function(){
	document.getElementById('font_color').value=svg_moji_color;
	});

function blackOrWhite ( hexcolor ) {
	var r = parseInt( hexcolor.substr( 1, 2 ), 16 ) ;
	var g = parseInt( hexcolor.substr( 3, 2 ), 16 ) ;
	var b = parseInt( hexcolor.substr( 5, 2 ), 16 ) ;

	return ( ( ( (r * 299) + (g * 587) + (b * 114) ) / 1000 ) < 128 ) ? "white" : "black" ;
}

    function cut_tags(dom) {  //dom中にある装飾的tagを取り除いてsimple化する
	var n_child=dom.childNodes.length;
	var ntag='';
console.log('dom=',dom,'child node leng=',n_child);
	if(n_child>0) {
		for (var k = 0; k < n_child; k++) {
			var tag=dom.childNodes[k];
console.log('child k=',k,tag);
			if(tag.nodeName=='A') ntag=ntag+tag.outerHTML+'<br>';
			//else if(tag.nodeName=='FONT') ntag=ntag;
			else ntag=ntag+cut_tags(tag);
console.log('k=',k,' new tag=',ntag);
			}
		}
	else {
		ntag=ntag+dom.textContent+'<br>';
		}
	return ntag;
	} //End function

var Popcheck=0;

function doc_print() {
	window.print();
		} 

//ソース隠蔽部
window.addEventListener('beforeunload', function(e){
//Editor終了のprompt
        e.preventDefault();
        e.returnValue = 'Check';
});
//ソース隠蔽部終了

//function doc_save start  /*  編集中のレコードの保存　　　　*/
function doc_save() {
	cancel_green_line();
	if(for_cloud=='yes') {
		alert('保存できません。save is not allowed this version but can download to your PC.');
		return;
		}
//	pallet_mend_flag=false;
console.log('****pre Save overview=',overview_term,'Popcheck=',Popcheck);
	if(Popcheck>0 || overview_term[0]==''){
		pop_inp_search();
		Popcheck=0;
		}
	else {
		remove_tempid(first_container);
		my_confirm(6);
console.log('**doc saved at origin save');
		}
   }  //function doc_save end

    function remove_tempid(dom) {  // tempのidをremoveする
	var n_child=dom.children.length;
	var tag_id=dom.getAttribute('id');
	if(tag_id && tag_id[0]=="r") dom.removeAttribute('id');

	if(n_child>0) {
		for (let k = 0; k < n_child; k++) {
			remove_tempid(dom.children[k]);
			}
		}
	} //End function

function fold_svg(tagn){
	var svg_tags=document.getElementById(tagn);    //document.querySelector('#svg_00');
console.log('**Svg_tag length=',svg_tags.childElementCount,svg_tags);
	svg_tag='';
	for (nn = 0; nn < svg_tags.childElementCount; nn++) {
		var fig_grp=svg_tags.children[nn].getAttribute('fig');
		if( fig_grp=='top'){
			var tagnn=svg_tags.children[nn];
			var len=tagnn.childElementCount;
console.log('Top node=',tagnn.nodeName,'len=',len);
			for(var k=len-1; k>0 ;k--) {
				var childtag=tagnn.children[k];
console.log('nodeName=',childtag.nodeName);
				if(childtag.nodeName!='g') {
console.log('deleted nodeName=',childtag.nodeName);
					tagnn.removeChild(childtag);
					}
				}
console.log('saved nodeName=',svg_tags.children[nn].nodeName);
			svg_tag=svg_tag+svg_tags.children[nn].outerHTML+'|<=>|';
			}
console.log('***list n =',nn,' length = ', svg_tag.length);
		}
	return svg_tag;

	}//End fold_svg
/*
function fold_cnsvg(tagn){
	var svg_tags=document.getElementById(tagn);    //document.querySelector('#svg_00');
console.log('**Svg_tag=',svg_tags,'children=',svg_tags.childElementCount);
	return svg_tags.outerHTML;
	}//End fold_cnsvg
*/
/*  新規レコードの作成　　　　*/
    doc_new.onclick = function() {
	if(for_cloud=='yes') {
		alert('新規save is not allowed this version');
		return;
		}
    var div_parent=document.getElementById("wClone");
    div_parent.innerHTML="";
    var svg_div = document.createElement('div');
    var newtag='svg_00';
    var divtag='div'+newtag;
    svg_div.setAttribute('id', divtag);
    svg_div.setAttribute('class', 'svg');
    svg_div.setAttribute('level', '0');
    svg_div.setAttribute('fig', '基本枠');
    var marginLR='margin-left:'+sys_marginL+'; margin-right:'+sys_marginR+';';
    svg_div.setAttribute('style', marginLR);
    var first_node = document.createElement('p');
    first_node.setAttribute('fig', '段落');
    first_node.innerHTML='新規の段落です。';
    svg_div.appendChild(first_node);
console.log('*** newRecord　Entered  *** margin=',marginLR);
    div_parent.appendChild(svg_div);
    var bare_text=div_parent.innerHTML;
console.log('text=',bare_text);

	var svg_tag='';
	var overview=newdoc_compose();
console.log('new overview1=',overview);
	overview[8]=set_doc_parms();
console.log('new overview2=',overview);
	new_overview=compose_overview(overview[0],overview[1],overview[2],overview[3],overview);
console.log('new overview3=',new_overview);
//	var tex_to_serv=escapeHtml(escape(bare_text));
//	svg_tag=escapeHtml(escape(svg_tag));
	var tex_to_serv=escape(bare_text);
	svg_tag=escape(svg_tag);

        $.ajax({
            url: "/db_serv/newrec/",
            async:true,
            data: {
		"description":tex_to_serv,
		"svg":svg_tag,
		"my_overview":new_overview,
		},
            dataType: 'json'
        })
        .done((data) => {
            //結果が帰ってきたら、表示します。
		var rec_num=data['rec_numb'];
console.log('**Ajax Returned result=',data,'rec_numb=',rec_num);
		make_url(rec_num);
	Popcheck=2;
//        svg_now='svg_00';
//        set_svg(svg_now);
        });
   }

/*  Copy新規レコードの作成　　　　*/
    copy_new.onclick = function() {
	if(for_cloud=='yes') {
		alert('Copy新規 is not allowed this version but can download to your PC.');
		return;
		}
console.log('*** Copy newrecord to server ***');
	
	my_confirm(8);

	var dat=formatDate(new Date());
	overview_term[5]=dat;
//	overview_term[7]=overview_term[7];
	overview_term[8]=set_doc_parms();
	my_overview=compose_overview(overview_term[0],overview_term[1],overview_term[2],overview_term[3],overview_term);

        $.ajax({
            url: "/db_serv/copynew/",
            async:true,
	    type: "POST",
            data: {
		"description":tex_to_serv,
		"my_header":my_header,
		"my_overview":my_overview,
		"svg":svg_tag,
		},
            dataType: 'json'
        })
        .done((data) => {
            //結果が帰ってきたら、表示します。
		var rec_num=data['rec_numb'];
console.log('**Ajax Returned result=',data,'rec_numb=',rec_num);
		make_url(rec_num);
	Popcheck=1;
//        svg_now='svg_00';
//        set_svg(svg_now);
        });
   }
//doc_parmの設定値を設定
function set_doc_parms() {
	var tag_n=document.getElementById('divsvg_00');
	var marginL=sys_marginL;
	if(tag_n.style.marginLeft) marginL=tag_n.style.marginLeft;
	var marginR=sys_marginR;
	if(tag_n.style.marginRight) marginR=tag_n.style.marginRight;
	var parms='doc_parm;'+sys_max_width+','+marginL+','+marginR+';|<=>|';
	return parms;
	}
//
//Text Edit モードでのSingleクリック時の処理（Imageの移動など）
function move_image_func(e){
console.log('**Single clicked ');
console.log('Image　Selectモード');
		var xp=e.clientX;
		var yp=e.clientY;

		var area = document.getElementById('texx');
		//var text_area=area.querySelectorAll('div');
		var text_area=area.querySelectorAll('img');

console.log('text_area=',text_area);
		var leng=text_area.length;
console.log('****Catch_image of Tvis area child_leng=',leng);
		var result=false;
    		for (var i=0 ;i<leng ;i++){
			tagn=text_area[i];
			var fig_id=tagn.getAttribute('id');
			var fig=tagn.getAttribute('fig');
console.log('**nodename= ',tagn.nodeName,'fig=',fig,' id= ',fig_id);
			if(fig=='img'){
				result=catch_image(tagn,xp,yp);
				}
			if(result==true) break;
			}
		if(result==true) {
			//Draggerbleの設定
//			Drag_elem = document.getElementById(fig_id);
			Drag_elem = tagn;
			drag.target=Drag_elem;
//			Drag_elem.setAttribute('class', 'draggable');
console.log('**Drag_elem= ',Drag_elem.nodeName,'id= ',fig_id);
//			document.getElementById('image_dsgn').click();
/*
			//Draggerbleの設定
			Drag_elem = document.getElementById(fig_id);
			Drag_elem.style.position = "absolute";
			drag.target=Drag_elem;
			Drag_elem.setAttribute('class', 'draggable');
console.log('**Drag_elem= ',Drag_elem.nodeName,'id= ',fig_id);
			Draw_mode='Text';
			drag.break=false;
			draggable(Drag_elem);
*/
			return;
			}
	}　//End of move_image_func

    E_clear.onclick = function() {
	var result = window.confirm('HTML文書全体を本当に削除しますか？');
	if(result==true){
		len=first_container.childNodes.length;
console.log('Enter E_clear child_len=',len,first_container);
		//firstChild=top_svgを残してすべての要素を削除する
		for(var k=len-1;k>0;k--){
			var tagn=first_container.childNodes[k];
console.log('k= ',k,tagn,' Node=',tagn.nodeName,'class=',tagn.className);
			if(tagn.nodeName=='svg'){
				}
			else if(tagn.nodeName=='DIV'){
				var tag_id=tagn.getAttribute('id');
				if(tag_id.slice(0,6)=='divsvg') {
					while( tagn.firstChild ){
  						tagn.removeChild( tagn.firstChild );
						}
    					var first_node = document.createElement('p');
    					first_node.setAttribute('fig', '段落');
    					first_node.innerHTML='新規の段落です。     ';
    					tagn.appendChild(first_node);
					}
				else {
					first_container.removeChild(tagn);
					}
				}
			else {
				first_container.removeChild(tagn);
				}
			}

        	svg_now='svg_00';
        	set_svg(svg_now);
		}
	}
//
//⑤SVG　drawing　
//Draw_mode=""の場合のSingleクリック時(Step 2)の処理を入れる
//
function click_func2(e){
console.log('**Single clicked Svg_mode=',Svg_mode,'Draw_mode=',Draw_mode);
	if((Svg_mode!="")&&(Svg_mode!="Draw")){
		if(Svg_mode=='Svg_drag' || Svg_mode=='Svg_drag_pending' || Svg_mode=='Selected' || (Svg_mode=='Svg_updown' && svg_step_flag==0)) {       //SVG図形の選択mode
console.log('SVG　Selectモード');
			var xp=e.clientX;
			var yp=e.clientY;
/*
			if(conv_cord) {
console.log('convert indiv',xp,yp,off_indivx,off_indivy);
				xp=xp-off_indivx;
				yp=yp-off_indivy;
				}
*/
    			var leng=container.children.length;
console.log('child leng= ',container.children.length,container);
    			for (var i=0 ;i<leng ;i++){
				var tagn=container.children[i];
				var fig_id=tagn.getAttribute('id');
console.log('@@@@@@@@numb=',i+1,' **nodename= ',tagn.nodeName,'id= ',fig_id);
//				if(tagn.childElementCount<=0) tagn.remove();
//				else {
					var result=catch_figure(tagn,xp,yp);
/*
if(result==true) {
result=false;
console.log('GGGGGGGGGGGGGGot chatch figure But');
}
*/
					if(result==true) {
//						if(tagn==Drag_elem) return;   //前と同じ要素でも認める＝下記でOK
						if(tagn==Drag_elem) ;
						else {
							quit_drag_elem();
console.log('deleted Drag element');
							break;
							}
						}
					}
//				}
			if(result==true) {
				//Draggerbleの設定
				Drag_elem = document.getElementById(fig_id);
console.log('Drag elem offset=',drag.offsetx,drag.offsety,'halfxy=',drag.hf_width,drag.hf_height,'center=',drag.center_x,drag.center_y); 
				drag.target=Drag_elem;
				if(Svg_mode=='Svg_updown') {
					svg_step_flag=1;
					return;
					}
				Drag_elem.setAttribute('class', 'draggable');
console.log('**Drag_elem= ',Drag_elem.nodeName,'id= ',fig_id);
				Draw_mode='Drag';
				drag.break=false;
				draggable(Drag_elem);
				/*
				var tag_elem=[];
				tag_elem.push(Drag_elem);
				DraggableItem.create('', tag_elem,'group');
				*/
				return;
				}
			}  //End SVG Selectモード
		if(Svg_mode=='Svg_reshape') {       //SVG図形の選択mode
console.log('SVG　Reshapeモード');
			var xp=e.clientX;
			var yp=e.clientY;
			if(conv_cord) {
console.log('convert indiv',xp,yp,off_indivx,off_indivy);
				xp=xp-off_indivx;
				yp=yp-off_indivy;
				}
			var leng=container.children.length;
console.log('child leng= ',container.children.length,container);
    			for (var i=0 ;i<leng ;i++){
				tagn=container.children[i];
				var fig_id=tagn.getAttribute('id');
console.log('**nodename= ',tagn.nodeName,'id= ',fig_id);
				result=catch_reshape(tagn,xp,yp);
				if(result==1) {
						break;
						}
					else {
						if(result>10) return;
						}
				}
			if(result==1) {
				//矩形の描画とDraggerbleの設定
				//createRectFig(x,y,w,h)
				Drag_elem = document.getElementById(fig_id);
console.log('**reshape fig= ',Drag_elem,'id= ',fig_id);
				drag.s_para=Drag_elem.getAttribute('smooth');
				drag.c_para=Drag_elem.getAttribute('close');
				Svg_mode='Svg_reshape_pending';
				//var reshape = document.getElementById(fig_id)
				Drag_elem.addEventListener('click',elem_callback,false);
				return;
				}
			}  //End SVG Reshapeモード
		if(Svg_mode=='Svg_scale' || Svg_mode=='Svg_rotate') {       //SVG図形の選択mode
console.log('SVG　Scaleモード');
			var xp=e.clientX;
			var yp=e.clientY;
			if(conv_cord) {
console.log('convert indiv',xp,yp,off_indivx,off_indivy);
				xp=xp-off_indivx;
				yp=yp-off_indivy;
				}
			var leng=container.children.length;
console.log('child leng= ',container.children.length,container);
    			for (var i=0 ;i<leng ;i++){
				tagn=container.children[i];
				var fig_id=tagn.getAttribute('id');
console.log('**nodename= ',tagn.nodeName,'id= ',fig_id);
				result=catch_scale(tagn,xp,yp);
console.log('result=',result);
				if(result!=false) break;
				}
			if(result!=false) {
console.log('**scale rotate mode');
				catch_scale_fig(result);
				//矩形の描画とDraggerbleの設定
				//createRectFig(x,y,w,h)
				Drag_elem = document.getElementById(fig_id);
				Svg_mode='Svg_scale_pending';
				//var reshape = document.getElementById(fig_id)
				Drag_elem.addEventListener('click',scale_callback,false);
				return;
				}
			}  //End SVG scaleモード
		}  //End Svg_mode!=Draw モード
	}

function click_add_del_func(e){
console.log('**Single clicked Svg_mode=',Svg_mode,'Draw_mode=',Draw_mode);
console.log('SVG　Selectモード');
			var xp=e.clientX;
			var yp=e.clientY;
/*
			if(conv_cord) {
console.log('convert indiv',xp,yp,off_indivx,off_indivy);
				xp=xp-off_indivx;
				yp=yp-off_indivy;
				}
*/
//最初はg_list以外のtagをcheckする
    			var leng=container.children.length;
			var g_listid=g_list.getAttribute('id');
//console.log('child leng= ',container.children.length,container);
    			for (var i=0 ;i<leng ;i++){
				var tagn=container.children[i];
				var fig_id=tagn.getAttribute('id');
console.log('@@@@@@@@numb=',i+1,' **nodename= ',tagn.nodeName,'id= ',fig_id);
				result=false;
				if(g_listid!=fig_id) {
					var result=catch_figure(tagn,xp,yp);
					}
				if(result==true) {
//g_listに加える
					g_list.appendChild(tagn);
console.log('catch fugure=',Drag_elem);
					break;
					}
				}
			if(!result) {
				var leng=g_list.children.length;
    				for (var i=0 ;i<leng ;i++){
					var tagn=g_list.children[i];
					var fig_id=tagn.getAttribute('id');
console.log('@@@@@@@@numb=',i+1,' **nodename= ',tagn.nodeName,'id= ',fig_id);
					var result=catch_figure(tagn,xp,yp);
					if(result==true) {
//g_listから除去する
						container.appendChild(tagn);
						temp_delete(tagn);
console.log('catch fugure=',Drag_elem);
						break;
						}
					}
				}
	}


//
//⑤SVG　drawing　
//Draw_mode="Draw"（描画）の場合のSingleクリック時(Step 2)の処理を入れる
//
function click_func3(e) {
     if((Svg_mode=="Draw")){
console.log('Singleクリック',control.value,'Step=',Step);
	Oper=3;
	if (Step==0) {
		//free lineなどの残骸を消して開始する
		isDrawing=0;
		if (drawingPath) {
			drawingPath=null;
			}
        	drawingPoints = [];
		first_point=null;
console.log("****Initialized");
		}
	Step+=1;
	var x0=e.clientX;
	var y0=e.clientY;
//	var x0=e.pageX;
//	var y0=e.pageY;
	if(conv_cord) {
console.log('convert indiv',x0,y0,off_indivx,off_indivy);
		x0=x0-off_indivx;
		y0=y0-off_indivy;
		}
	if(mesh_draw && mesh_integer) {
		x0=Math.round(x0/10)*10;
		y0=Math.round(y0/10)*10;
		}
	else {
		x0=Math.round(x0*10)/10;
		y0=Math.round(y0*10)/10;
		}
        drawingPoints.push({x: x0,y: y0});
	if((key_shift)&&(drawingPoints.length>1)) {
console.log('x0,y0,key_shift=',x0,y0,key_shift);
		mend_points();
		}
	if ((control.value== 'simp_line')||(control.value== 'seri_line')||(control.value== 'close_line')||(control.value== 'smooth')||(control.value== 'close_smooth')){
		line_seq();
		}
	if (control.value== 'quad_bezier'){
		quad_bezier_seq(Step);
		}
	if (control.value== 'cubic_bezier'){
		cubic_bezier_seq(Step);
		}
	if(temp_snap_flag==1) temp_snap_fix();
	if(Step==0) temp_snap_flag=0;
console.log('temp_snap Step=',Step);

	}
    }

function elem_callback(e) {
	//e.stopPropagation();
	Draw_mode='Drag';
	drag.break=false;
	if(drag.target) {
console.log('prev tag=',drag.target.id,' tag_no=',drag.id_num);
		drag.target.setAttribute('class', 'movable');
		}
	var tag = e.target;
//console.log('mouseover:' + tag.id);
	drag.id_num=Number(tag.id.slice( -2 ))-1;
console.log('new tag=' + tag.id,' tag_no=',drag.id_num);
	drag.target = document.getElementById(tag.id);
	drag.target.setAttribute('class', 'draggable');
console.log('drag target=',drag);
	draggableB(drag.target);
	}

function scale_callback(e) {
	//e.stopPropagation();
	Draw_mode='Drag';
	drag.break=false;
	if(drag.target) {
console.log('prev tag=',drag.target.id,' tag_no=',drag.id_num);
		drag.target.setAttribute('class', 'movable');
		}
	var tag = e.target;
//console.log('mouseover:' + tag.id);
	drag.id_num=Number(tag.id.slice( -2 ));
console.log('new tag=' + tag.id,' tag_no=',drag.id_num);
	drag.target = document.getElementById(tag.id);
    	switch (drag.id_num){
      		case 1:
			drag.fixpnt='pn03';
			drag.target.setAttribute('class', 'wecross');
			break;			
      		case 3:
			drag.fixpnt='pn01';
			drag.target.setAttribute('class', 'wecross');
			break;
      		case 2:
			drag.fixpnt='pn04';
			drag.target.setAttribute('class', 'ewcross');
			break;
      		case 4:
			drag.fixpnt='pn02';
			drag.target.setAttribute('class', 'ewcross');
			break;
      		case 5:
			drag.fixpnt='pn07';
			drag.target.setAttribute('class', 'height');
			break;
      		case 7:
			drag.fixpnt='pn05';
			drag.target.setAttribute('class', 'height');
			break;
      		case 6:
			drag.fixpnt='pn08';
			drag.target.setAttribute('class', 'wide');
			break;
      		case 8:
			drag.fixpnt='pn06';
			drag.target.setAttribute('class', 'wide');
			break;
      		case 10:
			drag.fixpnt='pn10';
			drag.target.setAttribute('class', 'wide');
			break;
      		case 11:
			drag.fixpnt='pn11';
			drag.target.setAttribute('class', 'height');
			break;
　　　		default:
			return;
			break;
		}	
	draggable(drag.target);
	}

function draw_basic(e){
console.log('**draw_basic clicked');
/* 注意：拡大縮小の変換は左上の座標値が倍率の値に変換されるので基本図は（0,0)のものが必要　*/
	var sx,sy,scx,scy;
	var rect_a=draw_op.target.getBoundingClientRect();
console.log('**rect_a=',rect_a);
	if(conv_cord) {
console.log('offset xy=',off_indivx,off_indivy);
		var rect_left=rect_a.left-off_indivx;
		var rect_top=rect_a.top-off_indivy;
		}
/*
	first_point=createFirstPoint([{x:rect_a.left,y:rect_a.top}]);
	Object.assign(first_point.style, defaultPointStyle);
        container.appendChild(first_point);
*/
/*
	scx=1;
	scy=1;
	scx=draw_op.scx;
	scy=draw_op.scy;
	var parm=`${scx},${scy}`;
//		dumy.setAttribute("transform", "translate("+tr_parm+")");
console.log('Posxy=',draw_op.posx,draw_op.posy);
	first_point=createFirstPoint([{x:draw_op.posx-off_indivx,y:draw_op.posy-off_indivy}]);
	Object.assign(first_point.style, defaultPointStyle);
        container.appendChild(first_point);
*/

	scx=draw_op.scx;
	scy=draw_op.scy;
console.log('scalexy=',scx,scy);
	if(draw_op.aux_line) {
		draw_op.posx=draw_op.aux_pos;
		}
console.log('trans posx=',draw_op.posx);
    switch (draw_op.align){
      case 'right':
		sx= draw_op.posx;
//		sy= draw_op.posy;
		sy=e.clientY;
		if(conv_cord) {
			sx=sx-off_indivx;
			sy=sy-off_indivy;
//console.log('reshape point conv_cord');
			}
		break;
      case 'center':
//		sx= draw_op.posx-Math.ceil((rect_a['right']-rect_a['left'])*scx/2);Math.round(Number(width*10/10));
		sx= draw_op.posx-(rect_a['right']-rect_a['left'])*scx/2;
//		sy= draw_op.posy;
		sy=e.clientY;
		if(conv_cord) {
			sx=sx-off_indivx;
			sy=sy-off_indivy;
//console.log('reshape point conv_cord');
			}
		break;
      case 'left':
		sx= draw_op.posx-Math.ceil((rect_a['right']-rect_a['left'])*scx);
//		sy= draw_op.posy;
		sy=e.clientY;
		if(conv_cord) {
			sx=sx-off_indivx;
			sy=sy-off_indivy;
//console.log('reshape point conv_cord');
			}
		break;
　　　default:
		sx=e.clientX;
		sy=e.clientY;
		if(conv_cord) {
			sx=sx-off_indivx;
			sy=sy-off_indivy;
//console.log('reshape point conv_cord');
			}
		break;
	}
console.log('align=',draw_op.align,' old=',draw_op.old_align,'  scale=',scx,scy,' translate=',sx,sy,' target=',draw_op.target);

	var parm=`${scx},${scy}`;
        var tr_parm=`${sx},${sy}`;
	var dumy=(draw_op.target).cloneNode(true);
	if(draw_op.fig=='text')	{
//		var sxx=sx-30;
		tr_parm=`${sx},${sy}`;
		dumy.setAttribute("transform", "translate("+tr_parm+")");
		dumy.setAttribute('fill',defaultCharStyle.fill);
		}
	else {
		dumy.setAttribute("transform", "translate("+tr_parm+")"+"scale("+parm+")");
		//dumy.setAttribute('stroke',defaultPathStyle.stroke);
		}
console.log('**basic fig=',draw_op.fig);

	if(draw_op.fig=='basic'){

		var fig_id='b'+(Date.now()).toString();
		dumy.setAttribute('id', fig_id);
		dumy.setAttribute('fig', 'basic');

        			var g_temp = document.createElementNS('http://www.w3.org/2000/svg', 'g');
				var fig_id2='g'+(Date.now()).toString();
				g_temp.setAttribute('id', fig_id2);
				g_temp.setAttribute('fig', 'group');
			simple_fig(g_temp,dumy);              //transform matrixを適用して図形simple化
			var close=dumy.getAttribute('close');
			if(close) g_temp.setAttribute('close', close);
			var smooth=dumy.getAttribute('smooth');
			if(smooth) g_temp.setAttribute('smooth', smooth);
			g_temp.setAttribute('opacity', '0.6');
			container.appendChild(g_temp);
console.log('basic darw gtemp=',g_temp);
		dumy.remove();
		}
	else {
		if(draw_op.fig=='text'){
			var fig_id='t'+(Date.now()).toString();
			dumy.setAttribute('id', fig_id);
			dumy.setAttribute('fig', 'text');
			container.appendChild(dumy);
//			Drag_elem=dumy;   //2022.10.11 for text
			}
	     	else {
			var fig_id='g'+(Date.now()).toString();
			dumy.setAttribute('id', fig_id);
			dumy.setAttribute('fig', 'group');
			container.appendChild(dumy);
//			Drag_elem=dumy;   //2022.10.11
			}
		}
//	container.removeChild(basic_rect.rect);
//	basic_rect.rect=null;
	}  //end of draw_basic

function getAbsPosition(x,y){
  const {left: bleft, top: btop} = document.body.getBoundingClientRect();
  return {
    x: x - bleft,y: y - btop
  };
}

function line_seq(){
	if (first_point){
		container.removeChild(first_point);
		first_point=null;
		}
	first_point=createFirstPoint([drawingPoints[drawingPoints.length-1]])
	Object.assign(first_point.style, defaultPointStyle);
        container.appendChild(first_point)
console.log('Firstpont=',container,'point=',[drawingPoints[drawingPoints.length-1]]);

       if (drawingPath) {
       		container.removeChild(drawingPath);
                drawingPath=null;
            	}
	if(drawingPoints.length>1){
        	drawingPath = createPath(drawingPoints,0,null,null);
        	Object.assign(drawingPath.style, defaultPathStyle);
        	container.appendChild(drawingPath);
		if(control.value=='simp_line'){
			if (first_point){
				container.removeChild(first_point);
				first_point=null;
				}
			var {group,fig_id}=make_group('line');
			drawingPoints = [];
			Step=0;
			remake_group(group,drawingPath,tempArrowStyle);
/*
			if(tempArrowStyle || defaultArrowStyle) {
				if(defaultArrowStyle) tempArrowStyle=defaultArrowStyle;
console.log('arrowstyle=',tempArrowStyle);
				remake_group(group,drawingPath,tempArrowStyle);
				tempArrowStyle='';
				}
*/
			group.appendChild(drawingPath);
console.log('make_group=',group,fig_id,'Step=',Step);
			}
		}
//console.log('Path=',drawingPath);
	}  //end of line_seq

function remake_group(group,path,arrow) {       //groupもpathと同じものを指定して使う
console.log('Enter remake_group arrow_style=',arrow,'path_style=',defaultPathStyle);


	var v_color=defaultPathStyle.stroke;
console.log('path=',path,'color=',v_color);
	group.setAttribute('color', v_color);
	Object.assign(path.style, defaultPathStyle);

    	switch (defaultLineStyle){
      		case '':               
			break;
      		case 'none':
			path.removeAttribute('stroke-dasharray');
			break;
      		case 'dash':               
        		path.setAttribute('stroke-dasharray', "4 4");
			break;
      		case '1_dash':  
        		path.setAttribute('stroke-dasharray', "24 3 2 3");             
			break;
      		case '2_dash':
        		path.setAttribute('stroke-dasharray', "24 3 2 3 2 3");
			break;
		}

	var now_mark=path.getAttribute('marker');
console.log('marker=',now_mark);
	if(now_mark==null) now_mark='';

	if(!arrow) {
console.log('arrow=',arrow,'so !arrow= true and return');
		return;
		}
	if(arrow==now_mark) return;

	if(arrow) path.setAttribute('marker', arrow);
	else path.removeAttribute('marker');
//一旦は現在の<marker>を消して、以下で指示に従った<marker>を作り直す
	for(let k=group.children.length-1;k>=0;k--) {
			if(group.children[k].nodeName=='marker') group.removeChild(group.children[k]);
			}

	var st_en=arrow.split('/');
console.log('arrow=',defaultArrowStyle,' start=',st_en[0],'end=',st_en[1]);

	var fig_num=(Date.now()).toString();
	var fw_arw=document.getElementById('fowd_arw').cloneNode(true);
	var fw_figid='fw_'+fig_num;
	fw_arw.setAttribute('id', fw_figid);
	var bw_arw=document.getElementById('bkwd_arw').cloneNode(true);
	var bw_figid='bw_'+fig_num;
	bw_arw.setAttribute('id', bw_figid);
	group.appendChild(fw_arw);
	group.appendChild(bw_arw);
	
	if(arrow) path.setAttribute('marker', arrow);

    switch (st_en[0]){
      case 'fw':
		fw_arw.setAttribute('fill', 'currentColor');
		var url_id='url('+'#'+fw_figid+')';
        	path.setAttribute('marker-start', url_id);
		defaultPathStyle.stroke='currentColor';
        	Object.assign(path.style, defaultPathStyle);
		//group.appendChild(fw_arw);
        	//group.setAttribute('color', v_color);
		break;
      case 'bw':
		bw_arw.setAttribute('fill', 'currentColor');
		var url_id='url('+'#'+bw_figid+')';
        	path.setAttribute('marker-start', url_id);
		defaultPathStyle.stroke='currentColor';
        	Object.assign(path.style, defaultPathStyle);
		//group.appendChild(bw_arw);
        	//group.setAttribute('color', v_color);		              
		break;
      case 'none':
      case '':
        	path.removeAttribute('marker-start');
		break;
		}

    switch (st_en[1]){
      case 'fw':
		fw_arw.setAttribute('fill', 'currentColor');
		var url_id='url('+'#'+fw_figid+')';
        	path.setAttribute('marker-end', url_id);
		defaultPathStyle.stroke='currentColor';
        	Object.assign(path.style, defaultPathStyle);
		//group.appendChild(fw_arw);
        	//group.setAttribute('color', v_color);
		break;
      case 'bw':
		bw_arw.setAttribute('fill', 'currentColor');
		var url_id='url('+'#'+bw_figid+')';
        	path.setAttribute('marker-end', url_id);
		defaultPathStyle.stroke='currentColor';
        	Object.assign(path.style, defaultPathStyle);
		//group.appendChild(bw_arw);
        	//group.setAttribute('color', v_color);		              
		break;
      case 'none':
      case '':
        	path.removeAttribute('marker-end');
		break;
		}

	if(arrow=='none/none') path.removeAttribute('marker');

	defaultPathStyle.stroke=v_color;
console.log('old_style=',defaultPathStyle);
	}

function quad_bezier_seq(Step){
console.log('Step=',Step);
	mStep=Step%3;
	if(mStep==1){	
		first_point=createFirstPoint([drawingPoints[drawingPoints.length-1]]);
	        Object.assign(first_point.style, defaultPointStyle);
        	container.appendChild(first_point)
		}
console.log('Bezier',Step,'length=',drawingPoints.length);
	if (mStep==2) {
//console.log(' last line= ',drawingPoints,[drawingPoints[drawingPoints.length-2],drawingPoints[drawingPoints.length-1]]);
		bezier_line=createPath([drawingPoints[drawingPoints.length-2],drawingPoints[drawingPoints.length-1]],0,null,null)
	        Object.assign(bezier_line.style, tempoPathStyle);
        	container.appendChild(bezier_line);

		if (first_point){
			container.removeChild(first_point);
			first_point=null;
			}
		}
	if(mStep==0) {
		if (drawingPath) {
       			container.removeChild(drawingPath);
                	drawingPath=null;
            		}
                drawingPath = createQuadBezier(drawingPoints);
            	Object.assign(drawingPath.style, defaultPathStyle);
            	container.appendChild(drawingPath);

		if (bezier_line){
			container.removeChild(bezier_line);
			bezier_line=null;
console.log('cubic bezier dummy removed length=',drawingPoints.length);
			}
		}
console.log('append bezier');
	}  //End of quad_bezier_seq

function cubic_bezier_seq(Step){
console.log('Step=',Step);
	mStep=Step%4;
	if(mStep==1){	
		first_point=createFirstPoint([drawingPoints[drawingPoints.length-1]]);
	        Object.assign(first_point.style, defaultPointStyle);
        	container.appendChild(first_point)
		}
//console.log('Cubic Bezier',Step,'length=',drawingPoints.length);
	if(mStep==2){
console.log('Cubic Bezier line');
		bezier_line=createPath([drawingPoints[drawingPoints.length-2],drawingPoints[drawingPoints.length-1]],0,null,null)
	        Object.assign(bezier_line.style, tempoPathStyle);
       		container.appendChild(bezier_line)

		if (first_point){
			container.removeChild(first_point);
			first_point=null;
			}
		}
	if(mStep==3){
console.log('Cubic Bezier line');
		bezier_line1=createPath([drawingPoints[drawingPoints.length-2],drawingPoints[drawingPoints.length-1]],0,null,null)
	        Object.assign(bezier_line1.style, tempoPathStyle);
       		container.appendChild(bezier_line1)
		}
	if(mStep==0) {
		if (drawingPath) {
       			container.removeChild(drawingPath);
                	drawingPath=null;
            		}
                drawingPath = createCubicBezier(drawingPoints,0);
            	Object.assign(drawingPath.style, defaultPathStyle);
            	container.appendChild(drawingPath);

		if (bezier_line){
			container.removeChild(bezier_line);
			bezier_line=null;
			}
		if (bezier_line1){
			container.removeChild(bezier_line1);
			bezier_line1=null;
			}
		}
console.log('Cubic Bezier line',drawingPoints);
	}//End of cubic_bezier_seq


//
//⑦Utility
//

//
//⑥SVG　edit
//
    clear.onclick = function() {
	var area=svg_now;
	var result = window.confirm(svg_now+'元に戻せません。本当に削除しますか？');
	if(result==true){
		if(svg_now=='svg_00') {
        		while (container.lastElementChild) {
console.log('**lastChild nodename= ',container.lastElementChild.nodeName);
				if(container.lastElementChild.nodeName!='defs'){
            				container.removeChild(container.lastElementChild);
					}
				}
			}
		else {
//chain_SVG図形関連の削除　svgの次の要素（<div>）と<svg>とを削除する	
console.log('svg=',org_container,'div_elem=',org_container.nextElementSibling);
			org_container.nextElementSibling.remove();
			org_container.remove();
//メニュー部svg_tag_menuのoptionの削除
			var menu_elem = $('select[name=svg_tag_menu]');
//console.log('select=',menu_elem);
			var param='option[value='+svg_now+']';
			menu_elem.children(param).remove();
//タグを削除する場合はchain_svgのデータ側(レコード構造とchain_svgデータ）の削除も必要
console.log('cnsvg tags=',cnsvg_tags);
			cnsvg_tags = cnsvg_tags.filter((cnsvg_tags) => {
				return (cnsvg_tags.name != svg_now);
				});
			cnsvg_nums=cnsvg_nums-1;
console.log('result=',cnsvg_tags);
			}
        	svg_now='svg_00';
        	set_svg(svg_now);
    		}
	}

    function clear_allchild(parent) {
        while (parent.firstChild) {
            parent.removeChild(parent.firstChild);
        }
    }
////
   function resolv_figure_B(tagn){
//console.log('Svg text=',tagn.nodeName,tagn.outerHTML);
		attr_char=tagn.getAttribute("d"); 
		var path_p=[];
console.log('**attr= ',attr_char);
		if(attr_char){
			replaced = attr_char.replace(/-/g, ',-');
//console.log(replaced);
//			var result = replaced.split(/,|M|T|Q|q|S|s|C|c|L|l|Z/);     // '-'を分割文字にするとマイナス符号と見做さないのでまずい
			var replace2 = replaced.replace(/,|M|m|T|t|Q|q|S|s|C|c|L|l|Z|z/g,' ');    //円弧のAとaはここには入れない
			var c_type = replaced.split(/(?=[MmTtAaQqSsCcLlVvHhZz])/);
console.log('c_type=',c_type);
			var result = replace2.split(' ');
//set Type of point  
			var p_type=[];
			for(var i=1;i<c_type.length;i++) {        //最初のMは無視最後のZは？
				if(c_type[i].includes('C')||c_type[i].includes('c')) p_type.push(0);
				else if(c_type[i].includes('L')||c_type[i].includes('l')) p_type.push(1);
				else p_type.push(2);
				}
			if(p_type[p_type.length-1]==2) p_type[p_type.length-1]=0;
			else p_type.push(0);
//console.log('leng=',result.length,result);
//(x,y)のペアを作りさらに形式を変えて（作図用）保存
			r_val=[];
			for ( var i = 0 ; i < result.length ; i++ ){
				if (result[i]!="") {
					val=result[i];
					r_val.push(val);
					}
				}
console.log('r_val=',r_val);
			path_p=[];
			result=splitArray(r_val,2);
			var k=0;
			var j=0;
			while(k<result.length) {
				path_p.push({x: result[k][0],y: result[k][1]});
				if(p_type[j]==0) k=k+3;
				else if(p_type[j]==1) k=k+1;
				else k=k+3;
				j=j+1;
				}

			var tot_path=[];
			for ( var i = 0 ; i < result.length ; i++ ){
				tot_path.push({x: result[i][0],y: result[i][1]});
				}
/*
			var k=0;
			while(k<r_val.length){
				if(r_val[k]=='A' || r_val[k]=='a') {
					path_p.push({rx: r_val[k+1],ry: r_val[k+2],r:r_val[k+3],a:r_val[k+4],s:r_val[k+5],x:r_val[k+6],y:r_val[k+7]});
					k=k+7;
					} 
				else if(r_val[k]=='H' || r_val[k]=='h' || r_val[k]=='V' || r_val[k]=='v') {
					path_p.push({vh: r_val[k],xy: r_val[k+1]});
					k=k+1;
					}
				else if(r_val[k]!="") {
					path_p.push({x: r_val[k],y: r_val[k+1]});
					k=k+1;
					}
				k=k+1;
				}
*/
console.log('p_type=',p_type, 'path_p= ',path_p,'tot_path=',tot_path);
			}    //end if(attr_char)
		return {path_p:path_p,p_type:p_type,tot_path:tot_path};
	}  // end function

function path_to_circle(tagn,path_p,p_type) {
console.log('Enter path_to_circle_B tag=',tagn,'parent=',tagn.parentNode);
	var c_para=tagn.parentNode.getAttribute("close"); 

	var id=0;
	for(var k=0; k<path_p.length;k+=1){
		if(c_para=="close" && k==path_p.length-1) ;
		else {
			id=id+1;
			first_point=createFirstPoint([path_p[k]]);
			if(p_type[k]==0)　Object.assign(first_point.style, defaultPointStyle);
			else 　Object.assign(first_point.style, tempoPathStyle2);
			var fig_id='pn'+("00" + (id)).slice( -2 );
			first_point.setAttributeNS(null,'id', fig_id);
			first_point.setAttributeNS(null,'class', 'movable');
			first_point.setAttribute('fig', 'temp');
			tagn.parentNode.appendChild(first_point);
			}
		}
/*
	if(close=='close') {
		len=tagn.parentNode.children.length;
		let tag=tagn.parentNode.children[len-1];
		tagn.parentNode.removeChild(tag);
		}
*/
	return 1;
	}  // end function

    function createCubicBezier_B(points,p_type,close) {
console.log('cubic bezier','length=',points.length,p_type);
        var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        var attribute = 'M';
	var nx=2;
	var n_p=-1;
        points.forEach((point, index) => {
	    nx=nx+1;
	    mod3_nx=nx % 3;
console.log('nx=',nx,' mod3=',mod3_nx);
            if (mod3_nx== 0) {
		n_p=n_p+1;
		if(p_type[n_p]==0) attribute += `${point.x}, ${point.y}C`;
		else attribute += `${point.x}, ${point.y}L`;
            	}
            else if (mod3_nx== 1) {
		if(p_type[n_p]==0) attribute += `${point.x}, ${point.y}`;
		} 
	    else {
		if(p_type[n_p]==0) attribute += ` ${point.x}, ${point.y} `;
		}
        });
	if(attribute.slice(-1)=='C' || attribute.slice(-1)=='L') attribute=attribute.substring(0,attribute.length-1);
	if(close=="close"){
		attribute += ` Z`;
		}
        path.setAttributeNS(null, 'd', attribute);
console.log(path)
        return path;
    }

   function resolv_figure(tagn){
//console.log('Svg text=',tagn.nodeName,tagn.outerHTML);
		attr_char=tagn.getAttribute("d"); 
		var path_p=[];
//console.log('**attr= ',attr_char);
		if(attr_char){
			replaced = attr_char.replace(/-/g, ',-');
//console.log(replaced);
//			var result = replaced.split(/,|M|T|Q|q|S|s|C|c|L|l|Z/);     // '-'を分割文字にするとマイナス符号と見做さないのでまずい
			var replace2 = replaced.replace(/,|M|m|T|t|Q|q|S|s|C|c|L|l|Z|z/g,' ');    //円弧のAとaはここには入れない
//	var replace3 = replaced.split(/(?=[MmTtAaQqSsCcLlVvHhZz])/);
			var result = replace2.split(' ');
//console.log('leng=',result.length,result);
//(x,y)のペアを作りさらに形式を変えて（作図用）保存
			r_val=[];
			for ( var i = 0 ; i < result.length ; i++ ){
				if (result[i]!="") {
//					val=Number(result[i]);
					val=result[i];
					r_val.push(val);
					}
				}
//console.log('r_val=',r_val);
			path_p=[];
//			result=splitArray(r_val,2);
//console.log('Result=',result,'r_val=',r_val);
//			for(var k=0; k<result.length;k++){
//				path_p.push({x: result[k][0],y: result[k][1]});
//				}
			var k=0;
			while(k<r_val.length){
				if(r_val[k]=='A' || r_val[k]=='a') {
					path_p.push({rx: r_val[k+1],ry: r_val[k+2],r:r_val[k+3],a:r_val[k+4],s:r_val[k+5],x:r_val[k+6],y:r_val[k+7]});
					k=k+7;
					} 
				else if(r_val[k]=='H' || r_val[k]=='h' || r_val[k]=='V' || r_val[k]=='v') {
					path_p.push({vh: r_val[k],xy: r_val[k+1]});
					k=k+1;
					}
				else if(r_val[k]!="") {
					path_p.push({x: r_val[k],y: r_val[k+1]});
					k=k+1;
					}
				k=k+1;
				}
//console.log('path_p= ',path_p);
			}    //end if(attr_char)
		return path_p;
	}  // end function

//新規Chain_SVGレコードの作成
function save_cnsvg(cn_header,svg_tag) {
console.log('*** Chain_Svg Save Entered  ***');
console.log('header=',cn_header,'svg=',svg_tag);

//	var svg_tag=escapeHtml(escape(svg_tag));
	var svg_tag=escape(svg_tag);

console.log('svg_tag',svg_tag);
        $.ajax({
            url: "/db_serv/save_cnsvg/",
            type: "POST",
            async:false,
            data: {
		"cn_header":cn_header,
		"svg":svg_tag,
		},
            dataType: 'json'
        })
        .done((data) => {
		wfcn_header=data['header'];
		var cnsvg_header=data['header'].split(',');
		cnsvg_new_pk=cnsvg_header[0];
            //結果が帰ってきたら、表示します。
console.log('**Ajax Returned result =',cnsvg_header,data);
        });
   }

//My_DataレコードのChain_SVG関連フィールドの変更
/*
function update_head(my_data_pk,cn_nums,cn_header) {
console.log('*** Update Chain_Svg part Entered  ***');
console.log('data_pk=',my_data_pk,'cnsvg_nums=',cn_nums,'cn_header=',cn_header);

        $.ajax({
            url: "/db_serv/update_head/",
            async:false,
            data: {
		"my_data_pk":my_data_pk,
		"cnsvg_nums":cnsvg_nums,
		"cnsvg_header":cn_header,
		},
            dataType: 'json'
        })
        .done((data) => {
            //結果が帰ってきたら、表示します。
		my_cnsheader=data['header'];
console.log('**Ajax Returned result=',data,my_cnsheader);
        });
   }
*/

//My_CnSvgレコードのget
function get_cnsvg(cnsvg_pk) {
console.log('*** Get Chain_Svg part Entered  ***');
console.log('cnsvg_pk=',cnsvg_pk);

        $.ajax({
            url: "/db_serv/get_cnsvg/",
            async:false,
            data: {
		"rec_number":cnsvg_pk,
		},
            dataType: 'json'
        })
        .done((data) => {
            //結果が帰ってきたら、表示します。
		wfcn_header=data['header'];
		cnsvg_field=data['svg_field'];
console.log('**Ajax Returned result=',data);
        });
   }
</script>
<script class="minify" id="smain_03">
//外部SVGfileの読み込み
　　var svg_read = document.getElementById("svgfile");
　　//ダイアログでファイルが選択された時
　　svg_read.addEventListener('change',function(evt){

        var file = evt.target.files;
　　	//FileReaderの作成
  　	var reader = new FileReader();
  　	//テキスト形式で読み込む
  　	reader.readAsText(file[0]);
//console.log('file=',file[0]);

  　	//読込終了後の処理
  　	reader.onload = function(ev){
　　		svgText = reader.result;
//console.log('load text=',svgText)
　　		const domParser = new DOMParser();
　　		var testSVGDoc = domParser.parseFromString(svgText, 'image/svg+xml');
　　		var testparsedSVG = testSVGDoc.childNodes[0];
console.log('length=',testparsedSVG.children.length,testparsedSVG,' Node=',testparsedSVG.nodeName);

		if(testparsedSVG.nodeName!='svg') {
			svgText = '<svg version="1.1" id="_x32_" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" style="width: 256px; height: 256px; opacity: 1;" xml:space="preserve">'
			+svgText+'</svg>';
			}

　　		const parsedSVGDoc = domParser.parseFromString(svgText, 'image/svg+xml');
　　		var parsedSVG = parsedSVGDoc.childNodes[0];   //解釈svgはすべてchildNodes[0]にある
		var gname=parsedSVG.getAttribute('class');
		if(gname='') {
    			var group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    			var fig_id='g'+(Date.now()).toString();
    			group.setAttribute('id', fig_id);
    			group.setAttribute('class', 'outgroup');
    			container.appendChild(group);
    			for (nn = 0; nn < parsedSVG.children.length; nn++) {
console.log('**nodename= ',parsedSVG.children[nn].nodeName,parsedSVG.children[nn]);
　　				group.appendChild(parsedSVG.children[nn].cloneNode(true));
				}
			}
		else {
console.log('length=',parsedSVG.children.length,parsedSVG,' Node=',parsedSVG.nodeName);
			var fig_num=Number(Date.now());
			for (var nn = 0; nn < parsedSVG.children.length; nn++) {
console.log('**nodename nn=',nn,parsedSVG.children[nn].nodeName,parsedSVG.children[nn]);
//				parsedSVG.children[nn].removeAttribute('id');
	    			var fig_id='g'+(fig_num+nn).toString();
	    			parsedSVG.children[nn].setAttribute('id', fig_id);
　　				container.appendChild(parsedSVG.children[nn].cloneNode(true));
				}
			}
  　　  	}
　　	}  ,false);　//外部SVGfileの読み込み終了

//外部htmlfileの読み込み
　　var html_read = document.getElementById("htmlfile");
　　//ダイアログでファイルが選択された時
　　html_read.addEventListener('change',function(evt){

        var file = evt.target.files;
　　	//FileReaderの作成
  　	var reader = new FileReader();
  　	//テキスト形式で読み込む
  　	reader.readAsText(file[0]);
console.log('file=',file[0],file[0].name);

  　	//読込終了後の処理
  　	reader.onload = function(ev){
　　		htmlText = reader.result;
//console.log('load text=',htmlText)
　　		const domParser = new DOMParser();
　　		var testDoc = domParser.parseFromString(htmlText, 'text/html');
console.log('testDoc=',testDoc);
		var tags=testDoc.querySelector('#texx')
console.log('texx=',tags);
		var set_tag=document.getElementById('tab1');
		var del_tag=document.getElementById('texx');
		set_tag.removeChild(del_tag);
		set_tag.appendChild(tags);
console.log('set_tag=',set_tag);

		svg_tag_del();
		first_container = document.getElementById('texx');
		confirm_last2line();
console.log('first_container=',first_container);
		var svg_tags=first_container.querySelectorAll('svg.canv');
//		var svg_tags2=first_container.querySelectorAll('svg');
console.log('main svg=',svg_tags);
//console.log('include indiv=',svg_tags2);
		var rect=createRectFig(0,0,20,20);
		rect.setAttribute('class', 'chain_svg_mark');
		rect.setAttribute('stroke', 'blue');
		rect.setAttribute('stroke-width', '1');
		rect.setAttribute('fill', 'blue');
		svg_tags[0].prepend(rect);
		for(var k=1; k<svg_tags.length;k+=1){
//console.log(svg_tags[k]);
			var name=svg_tags[k].id;
			svg_tag_add(name);
//console.log('chain svg=',name);
			var rect=createRectFig(0,0,20,20);
			rect.setAttribute('class', 'chain_svg_mark');
			rect.setAttribute('stroke', 'blue');
			rect.setAttribute('stroke-width', '1');
			rect.setAttribute('fill', 'blue');
			svg_tags[k].prepend(rect);
			}
//		fgedit.selectedIndex=2;
//		chng_mode();
		org_container = document.getElementById('svg_00');
		svg_now='svg_00';
		set_svg(svg_now);
		save_from="html";
		}
	});

////
   function catch_image(tagn,xp,yp){
	var result=false;
console.log('xy=',xp,yp);
	var rect_a=tagn.getBoundingClientRect();
console.log('**rect_a=',rect_a);
	let w=rect_a.right-rect_a.left;
	let h=rect_a.bottom-rect_a.top;			

//	var pnt2=svgPoint(tagn, rect_a.left, rect_a.top);

	if(((rect_a.left-xp)*(rect_a.left+w-xp)<0) && ((rect_a.top-yp)*(rect_a.top+h-yp)<0)) {
console.log('Catch Image');

		result=true;
		}
	return result;
	}

////
   function catch_figure(tagn,xp,yp){
console.log('@@@@@@@@@@try Catch_fig=',tagn.nodeName);

	var fig_grp=tagn.getAttribute('fig');
console.log('type=',fig_grp);
	if(fig_grp=='hybrid') {
console.log('###catch hybrid');
		var nwtag=hybrid_to_simp(tagn);
		copy_svgtag(tagn,nwtag);
		}

				var pnt=svgPoint(tagn, xp, yp);   //大元の<svg>タグ上(viewport)の座標を<g>要素local座標に戻す
console.log('tag=',tagn,'xy=',xp,yp,' point=',pnt);

			
//				var rect_a=tagn.children[0].getBoundingClientRect();
				var rect_a=tagn.getBoundingClientRect();
//				var rect_a=tagn.getClientRects();  //getBoundingClientRectと同じ値を返す
//				var rect_a=tagn.getBBox();   getBBoxはオリジナル図形の（x,y,w,h)を返す
console.log('**rect_a=',rect_a);

				let w=rect_a.right-rect_a.left;
				var rect_left=rect_a.left;
				var rect_top=rect_a.top;
				if(w<3) {
					rect_left=rect_a.left-2;
					w=w+4;
					}
				let h=rect_a.bottom-rect_a.top;		
				if(h<3) {
					rect_top=rect_a.top-2;
					h=h+4;
					}
				var pnt2=svgPoint(tagn, rect_left, rect_top);
console.log('**rect L&T=',rect_left,rect_top,'pnt2=',pnt2,'w&h=',w,h);
console.log('**inwidth&height=',(pnt2.x-pnt.x)*(pnt2.x+w-pnt.x),(pnt2.y-pnt.y)*(pnt2.y+h-pnt.y));
				if(((pnt2.x-pnt.x)*(pnt2.x+w-pnt.x)<=0) && ((pnt2.y-pnt.y)*(pnt2.y+h-pnt.y)<=0)) {
console.log('Got Catch Figure');
					if(Svg_mode!='Selected' && Svg_mode!='Svg_updown') Svg_mode="Svg_drag_pending";
/*
					first_point=createFirstPoint([pnt]);
	        			Object.assign(first_point.style, defaultPointStyle);
					tagn.appendChild(first_point);
*/
					var rect01=tagn.querySelector('#rect01');
					if(rect01) {
console.log('rect01 alraedy exists');
						rect01.remove();
//						tagn.removeChild(rect01);
						}
					rect01=createRectFig(pnt2.x,pnt2.y,w,h);
					rect01.setAttribute('id', 'rect01');
					rect01.setAttribute('fig', 'temp');
					//var dumy=rect01.cloneNode(true);
					rect01.setAttribute('class', 'draggable');
					tagn.appendChild(rect01);

					//tagn.parentNode.appendChild(dumy);
					drag.center_x=pnt2.x+w/2;
					drag.center_y=pnt2.y+h/2;
					drag.hf_width=w/2;
					drag.hf_height=h/2;
console.log('*** *** ***rect01 at catch');
//					if(svgtext_dialog) $('#text_draw').dialog("close");
					return true;
					}
//			}
	}

function hybrid_to_simp(tagn) {
console.log('@@@@@Enter to Hybrid to simp');
		var old_transf=tagn.getAttributeNS(null,'transform');
		leng=tagn.children.length;
		var {group,fig_id}=make_group('group');
		for (let k = leng-1;k>=0; k--) {
			var tag=tagn.children[k];
console.log('child k=',k,tag);
			var add_transf="";
			if(tag.transform.baseVal.numberOfItems>0) add_transf=tag.getAttributeNS(null, "transform");
			var transf=old_transf+add_transf;
			tag.setAttribute("transform",transf);
			group.appendChild(tag);
			}
		group.setAttribute('fig','hy_group');
		return group;
	}

function getrect_shape(tagn) {
	var rect_a=tagn.getBoundingClientRect();
console.log('**rect_a=',rect_a);
	let w=rect_a.right-rect_a.left;
	var rect_left=rect_a.left;
	var rect_top=rect_a.top;
	if(w<3) {
		rect_left=rect_a.left-2;
		w=w+4;
		}
	let h=rect_a.bottom-rect_a.top;		
	if(h<3) {
		rect_top=rect_a.top-2;
		h=h+4;
		}
	var pnt2=svgPoint(tagn, rect_left, rect_top);

		rect01=createRectFig(pnt2.x,pnt2.y,w,h);
		rect01.setAttribute('id', 'rect02');
		rect01.setAttribute('fig', 'temp');
		//rect01.setAttribute('class', 'draggable');
		tagn.appendChild(rect01);

		drag.center_x=pnt2.x+w/2;
		drag.center_y=pnt2.y+h/2;
		drag.hf_width=w/2;
		drag.hf_height=h/2;
console.log('*** *** ***rect01 at getrect_shape');
	}

var path_cube;

   function reshape_figure(tagn){
console.log('Reshape_fig=',tagn);
	var error=0;
console.log('reshape child_len=',tagn.children.length,'child_node=',tagn.children);
	var fig_flag=0;
	for(let k=0;k<tagn.children.length;k++) {
		if(tagn.children[k].nodeName=='path') fig_flag+=1;
		else if(tagn.children[k].nodeName=='marker') fig_flag+=10;
			else fig_flag+=100;
		}
console.log('fig_flag=',fig_flag);		
	if(fig_flag>=100) {
		error=100;
		return error;
		}
	if(fig_flag>=10) {
		fig_flag=fig_flag-10*Math.round(fig_flag/10);
console.log('fig_flag=',fig_flag);
		if(fig_flag>1) {
			error=10;
			return error;
			}
		}
console.log('fig_flag=',fig_flag);
	if((tagn.nodeName=='g') && (fig_flag==1)) {
console.log('tagn=',tagn.nodeName,tagn,'child_len=',tagn.children.length);

		var {path_p,p_type,tot_path}=resolv_figure_B(tagn.children[0]);		//reshape前のpath座標の取り出し
console.log('before reshape path_p=',path_p,p_type);
		drawingPoints=path_p;
		drawingPtype=p_type;
		path_cube=tot_path;
console.log('path_cube=',path_cube);
		error=path_to_circle(tagn.children[0],path_p,p_type);		//path座標に赤丸を描画
//console.log('after path_to_circle=',tagn.children[0].outerHTML);
		if(error>10) {
console.log('path_to_circle error occured');
			}
		}
console.log('reshape result=',error);
	return error;
	}

/*
////
   function catch_scale(tagn,xp,yp){
console.log('Catch_fig=',tagn.outerHTML);
	result=false;
	if((tagn.nodeName=='g') && (tagn.children.length==1)) {
console.log('tagn=',tagn.nodeName,'child_len=',tagn.children.length,'child_node=',tagn.children[0].nodeName);
		if(tagn.children[0].nodeName=='path') {
				var pnt=svgPoint(tagn, xp, yp);   //大元の<svg>タグ上(viewport)の座標を<g>要素local座標に戻す
console.log('xy=',xp,yp,' point=',pnt);
//				var rect_a=tagn.children[0].getBoundingClientRect();
				var rect_a=tagn.getBoundingClientRect();
//				let w=rect_a.right-rect_a.left;
//				let h=rect_a.bottom-rect_a.top;
console.log('**rect_a=',rect_a);

				let bboxRect = tagn.getBBox();
console.log('**bbox=',bboxRect);
				let w=bboxRect.width;
				let h=bboxRect.height;				

				var pnt2=svgPoint(tagn, rect_a.left, rect_a.top);
				if(((pnt2.x-pnt.x)*(pnt2.x+w-pnt.x)<0) && ((pnt2.y-pnt.y)*(pnt2.y+h-pnt.y)<0)) {
console.log('Catch scale Figure');
//選択SVGのtransformをcheckし、既にtransformがあればtransform　matrixを適用してsimple図形に変換する
					console.log('baseVal number=',tagn.transform.baseVal.numberOfItems)
					if(tagn.transform.baseVal.numberOfItems>0) {
						console.log('To simple SVG');
						var dumy=tagn.cloneNode(true);
						simple_fig(dumy);                // simple_figの使い方間違い要検討
						dumy.setAttribute("transform", "translate(0,0)");
						container.appendChild(dumy);
						container.removeChild(tagn);
						result=dumy;
						}
					else {
						result=tagn;
						}

					return result;
					}
			}
		}
		return result;
	} //End of catch_scale
*/

   function catch_scale_fig(tagn) {

	temp_delete(tagn);
	var fig_grp=tagn.getAttribute('fig');
console.log('type=',fig_grp);
	if(fig_grp=='hybrid') {
		var nwtag=hybrid_to_simp(tagn);
		copy_svgtag(tagn,nwtag);
		tagn.setAttribute('fig','hy_group');
		}

//	simple_fig(dumy_group,tagn);              //transform matrixを適用して図形simple化
//        org_container.appendChild(dumy_group);    //2023.5.20復活　2022.12.22　拡縮、回転及び反転ではSimple化は止めた
//	copy_svgtag(tagn,dumy_group);　　　　　　 //2023.5.20復活　Svg文字の拡縮、回転及び反転はシステムに任せる
console.log('After simple=',tagn);

	var rect_a=tagn.getBoundingClientRect();
console.log('**rect_a=',rect_a,tagn);
	let w=rect_a.width;
	let h=rect_a.height;		

	var pnt2=svgPoint(tagn, rect_a.left, rect_a.top);

	rect01=createRectFig(pnt2.x,pnt2.y,w,h);
	rect01.setAttribute('id', 'rect01');
	rect01.setAttribute('fig', 'temp');
	tagn.appendChild(rect01);
console.log('*** *** ***rect01 at catch scale');

	if(fig_scale_witch=="scale"){
console.log('witch scale=',fig_scale_witch);
		k=1
		first_point=createFirstPoint([{x:pnt2.x,y:pnt2.y}]);
	        Object.assign(first_point.style, defaultPointStyle);
		var fig_id='pn'+("00" + (k)).slice( -2 );
		first_point.setAttributeNS(null,'id', fig_id);
		first_point.setAttribute('fig', 'temp');
		first_point.setAttributeNS(null,'class', 'movable');
		tagn.appendChild(first_point);
		k=2
		first_point=createFirstPoint([{x:pnt2.x+w,y:pnt2.y}]);
	        Object.assign(first_point.style, defaultPointStyle);
		var fig_id='pn'+("00" + (k)).slice( -2 );
		first_point.setAttributeNS(null,'id', fig_id);
		first_point.setAttribute('fig', 'temp');
		first_point.setAttributeNS(null,'class', 'movable');
		tagn.appendChild(first_point);
		k=3
		first_point=createFirstPoint([{x:pnt2.x+w,y:pnt2.y+h}]);
	        Object.assign(first_point.style, defaultPointStyle);
		var fig_id='pn'+("00" + (k)).slice( -2 );
		first_point.setAttributeNS(null,'id', fig_id);
		first_point.setAttribute('fig', 'temp');
		first_point.setAttributeNS(null,'class', 'movable');
		tagn.appendChild(first_point);
		k=4
		first_point=createFirstPoint([{x:pnt2.x,y:pnt2.y+h}]);
	        Object.assign(first_point.style, defaultPointStyle);
		var fig_id='pn'+("00" + (k)).slice( -2 );
		first_point.setAttributeNS(null,'id', fig_id);
		first_point.setAttribute('fig', 'temp');
		first_point.setAttributeNS(null,'class', 'movable');
		tagn.appendChild(first_point);
		k=5
		first_point=createFirstPoint([{x:pnt2.x+w/2,y:pnt2.y}]);
	        Object.assign(first_point.style, defaultPointStyle);
		var fig_id='pn'+("00" + (k)).slice( -2 );
		first_point.setAttributeNS(null,'id', fig_id);
		first_point.setAttribute('fig', 'temp');
		first_point.setAttributeNS(null,'class', 'movable');
		tagn.appendChild(first_point);
		k=6
		first_point=createFirstPoint([{x:pnt2.x+w,y:pnt2.y+h/2}]);
	        Object.assign(first_point.style, defaultPointStyle);
		var fig_id='pn'+("00" + (k)).slice( -2 );
		first_point.setAttributeNS(null,'id', fig_id);
		first_point.setAttribute('fig', 'temp');
		first_point.setAttributeNS(null,'class', 'movable');
		tagn.appendChild(first_point);
		k=7
		first_point=createFirstPoint([{x:pnt2.x+w/2,y:pnt2.y+h}]);
	        Object.assign(first_point.style, defaultPointStyle);
		var fig_id='pn'+("00" + (k)).slice( -2 );
		first_point.setAttributeNS(null,'id', fig_id);
		first_point.setAttribute('fig', 'temp');
		first_point.setAttributeNS(null,'class', 'movable');
		tagn.appendChild(first_point);
		k=8
		first_point=createFirstPoint([{x:pnt2.x,y:pnt2.y+h/2}]);
	        Object.assign(first_point.style, defaultPointStyle);
		var fig_id='pn'+("00" + (k)).slice( -2 );
		first_point.setAttributeNS(null,'id', fig_id);
		first_point.setAttribute('fig', 'temp');
		first_point.setAttributeNS(null,'class', 'movable');
		tagn.appendChild(first_point);

		}

	if(fig_scale_witch=="rotate"){
console.log('witch rotate=',fig_scale_witch);
		var drawPoint=[];
		drawPoint.push({x:pnt2.x+w/2,y:pnt2.y+h/2});
		drawPoint.push({x:pnt2.x+w/2,y:pnt2.y-h/4});
		bezier_line=createPath(drawPoint,0);
		Object.assign(bezier_line.style, tempoPathStyle);
		bezier_line.setAttribute('fig', 'temp');
		tagn.appendChild(bezier_line);
					
		k=10
		first_point=createFirstPoint([{x:pnt2.x+w/2,y:pnt2.y-h/4}]);
	        Object.assign(first_point.style, defaultPointStyle);
		var fig_id='pn'+("00" + (k)).slice( -2 );
		first_point.setAttributeNS(null,'id', fig_id);
		first_point.setAttribute('fig', 'temp');
		first_point.setAttributeNS(null,'class', 'movable');
		tagn.appendChild(first_point);

		var drawPoint=[];
		drawPoint.push({x:pnt2.x+w/2,y:pnt2.y+h/2});
		drawPoint.push({x:pnt2.x+w+w/4,y:pnt2.y+h/2});
		bezier_line=createPath(drawPoint,0);
		Object.assign(bezier_line.style, tempoPathStyle);
		bezier_line.setAttribute('fig', 'temp');
		tagn.appendChild(bezier_line);

		k=11
		first_point=createFirstPoint([{x:pnt2.x+w+w/4,y:pnt2.y+h/2}]);
	        Object.assign(first_point.style, defaultPointStyle);
		var fig_id='pn'+("00" + (k)).slice( -2 );
		first_point.setAttributeNS(null,'id', fig_id);
		first_point.setAttribute('fig', 'temp');
		first_point.setAttributeNS(null,'class', 'movable');
		tagn.appendChild(first_point);
		}

		drag.center_x=pnt2.x+w/2;
		drag.center_y=pnt2.y+h/2;
		drag.hf_width=w/2;
		drag.hf_height=h/2;
	} //End of function

   function rotate_with_degree() {
	var rote_scale=[];
	if(Drag_elem && Drag_elem.nodeName=='g') ;
	else {
		alert('proper figure not selectted');
		return;
		}
   	var desg_degree = window.prompt("designate rotate degree?");
	if(desg_degree==null) rote_scale=[];
	else {
		rote_scale.push('rotate');
		desg_degree=desg_degree.replace(/,/g, ' ');
		var sca=desg_degree.split(' ');
		rote_scale.push(sca[0]);
console.log('sesignate value=',sca,rote_scale);
		}
console.log('input degree=',desg_degree);

	var target_group=Drag_elem;
	var old_transf="";
	if(target_group.transform.baseVal.numberOfItems>0) old_transf=target_group.getAttributeNS(null, "transform")

	var angle = rote_scale[1];
	var cntx=drag.center_x;
	var cnty=drag.center_y;
console.log('****angle cntx cnty=',angle,cntx,cnty);
	var rol_parm=`${angle},${cntx},${cnty}`;
console.log('rotate transform=',rol_parm);
	var transf="rotate("+rol_parm+")"+old_transf;
	target_group.setAttribute('transform',transf);
	target_group.setAttribute('fig','hybrid');
	document.getElementById("fig_sel_end").click();
	}

   function scale_with_scale() {
	var rote_scale=[];
	if(Drag_elem && Drag_elem.nodeName=='g') ;
	else {
		alert('proper figure not selectted');
		return;
		}
   	var desg_scale = window.prompt("designate scale of x and y?");
	if(desg_scale==null) rote_scale=[];
	else {
		rote_scale.push('scale');
		desg_scale=desg_scale.replace(/,/g, ' ');
		var sca=desg_scale.split(' ');
		if(sca.length>=2) {
			rote_scale.push(sca[0]);
			rote_scale.push(sca[1]);
			}
		else {
			rote_scale.push(sca[0]);
			rote_scale.push(sca[0]);
			}
console.log('sesignate value=',sca,rote_scale);
		}
console.log('input scale=',desg_scale);
	var target_group=Drag_elem;
	var old_transf="";
	if(target_group.transform.baseVal.numberOfItems>0) old_transf=target_group.getAttributeNS(null, "transform")
	var cntx=drag.center_x;
	var cnty=drag.center_y;
	var parm1=`${cntx},${cnty}`;
	var parm2=`${-cntx},${-cnty}`;
	var sc_parm=`${rote_scale[1]},${rote_scale[2]}`;
	var transf="translate("+parm1+")"+"scale("+sc_parm+")"+"translate("+parm2+")";
console.log('transform=',transf);
	transf=transf+old_transf;
	target_group.setAttribute('transform', transf);
	target_group.setAttribute('fig','hybrid');
	document.getElementById("fig_sel_end").click();
	}

////
   function catch_updown_fig(tagn) {

	temp_delete(tagn);
	var px1=drag.center_x-drag.hf_width-20;
	var px2=drag.center_x+drag.hf_width+20;
console.log('first_line point=',drag.center_x,drag.center_y,drag.hf_width,drag.hf_height,px1,px2);
	var drawPoint=[];
	drawPoint.push({x:px1,y:drag.center_y});
	drawPoint.push({x:px2,y:drag.center_y});;
	bezier_line=createPath(drawPoint,0);
	Object.assign(bezier_line.style, tempoPathStyle);
	bezier_line.setAttribute('fig', 'temp');
	tagn.appendChild(bezier_line);

	var pnty1=drag.center_y-drag.hf_height-20;
	var pnty2=drag.center_y+drag.hf_height+20;
console.log('second_line');
	var drawPoint=[];
	drawPoint.push({x:drag.center_x,y:pnty1});
	drawPoint.push({x:drag.center_x,y:pnty2});;
	bezier_line=createPath(drawPoint,0);
	Object.assign(bezier_line.style, tempoPathStyle);
	bezier_line.setAttribute('fig', 'temp');
	tagn.appendChild(bezier_line);
					
	} //End of function
////

   function catch_adddel_point(tagn,xp,yp){
console.log('Add or Delete Point ');

	var pnt=svgPoint(tagn, xp, yp);   //大元の<svg>タグ上(viewport)の座標を<g>要素local座標に戻す
console.log('xy=',xp,yp,' point=',pnt);

	var near;
	len=drawingPoints.length;

	result=false;
	for(var k=0; k<len-1;k+=1){
		near=Math.pow(drawingPoints[k].x-pnt.x,2)+Math.pow(drawingPoints[k].y-pnt.y,2);
		near=Math.sqrt(near);
console.log('point near=',near);
		if(near<5) {
			var tag_id='pn'+("00" + (k+1)).slice( -2 );
			var del_target = document.getElementById(tag_id);
			del_target.setAttribute('style', style="stroke-width: 1px; stroke: red; fill: pink;");
console.log('shift_key=',key_shift);
			if(key_shift) {
				var result = window.confirm('Pointを固定点に変更しますか？');
				if(result==true){
					drawingPtype[k]=1;
					var c_para=tagn.getAttribute("close"); 
					if(c_para=='close'){
						nlen=drawingPoints.length;
						drawingPoints[nlen-1]=drawingPoints[0];
						}
					var s_para=tagn.getAttribute("smooth");
					if(s_para!="mix") tagn.setAttribute("smooth","mix");

					len=tagn.children.length;
					for(var k=len-1;k>0;k--){
						if(tagn.children[k].nodeName=='path') ;
						else if(tagn.children[k].nodeName=='marker') ;
						else tagn.removeChild(tagn.children[k]);
						}
					tagn.firstChild.removeAttribute('d');
console.log('before set_line c_para,s_para=',c_para,s_para);
					var new_path = set_line_group(tagn,drawingPtype,c_para,s_para);
console.log('after set_line at fixpoint new_path=',new_path);
					var path_d=new_path.getAttribute('d');
					tagn.firstChild.setAttribute('d',path_d);
console.log('after tagn=',tagn);
					remake_group(tagn,tagn.firstChild,defaultArrowStyle);

					error=path_to_circle(tagn.children[0],drawingPoints,drawingPtype);		//path座標に赤丸を描画					
console.log('**after draw circle');
					}
				}
			else {
				var result = window.confirm('Pointを削除しますか？');
				if((result==true)&&(len>=4)){
					drawingPoints.splice(k, 1);
					drawingPtype.splice(k, 1);
					tagn.removeChild(del_target);
					var c_para=tagn.getAttribute("close"); 
					if(c_para=='close'){
						nlen=drawingPoints.length;
						drawingPoints[nlen-1]=drawingPoints[0];
						}
					var s_para=tagn.getAttribute("smooth"); 
console.log('s_para,c_para=',s_para,c_para);
					len=tagn.children.length;
					for(var k=len-1;k>0;k--){
						if(tagn.children[k].nodeName=='path') ;
						else if(tagn.children[k].nodeName=='marker') ;
						else tagn.removeChild(tagn.children[k]);
						}
					tagn.firstChild.removeAttribute('d');
console.log('before set_line c_para,s_para=',c_para,s_para);
					var new_path = set_line_group(tagn,drawingPtype,c_para,s_para);
console.log('after set_line at fixpoint new_path=',new_path);
					var path_d=new_path.getAttribute('d');
					tagn.firstChild.setAttribute('d',path_d);
console.log('after tagn=',tagn);
					remake_group(tagn,tagn.firstChild,defaultArrowStyle);

					error=path_to_circle(tagn.children[0],drawingPoints,drawingPtype);		//path座標に赤丸を描画					
console.log('**after draw circle');
					}
				}
			break;
			}
		}
	if(result==false) {
		for(var k=0; k<len-1;k+=1){
			var bunbo=Math.sqrt(Math.pow(drawingPoints[k].x-drawingPoints[k+1].x,2)+Math.pow(drawingPoints[k].y-drawingPoints[k+1].y,2));
			var bunsh=Math.abs((drawingPoints[k+1].y-drawingPoints[k].y)*pnt.x-(drawingPoints[k+1].x-drawingPoints[k].x)*pnt.y+drawingPoints[k+1].x*drawingPoints[k].y-drawingPoints[k+1].y*drawingPoints[k].x);
			var near=bunsh/bunbo;
			var flag=1.0;
			if((Math.abs(drawingPoints[k+1].x-pnt.x)+Math.abs(drawingPoints[k].x-pnt.x))<10) flag=0.;
			var naib_x=flag*(drawingPoints[k+1].x-pnt.x)*(drawingPoints[k].x-pnt.x);
			flag=1.0;
			if((Math.abs(drawingPoints[k+1].y-pnt.y)+Math.abs(drawingPoints[k].y-pnt.y))<10) flag=0.;
			var naib_y=flag*(drawingPoints[k+1].y-pnt.y)*(drawingPoints[k].y-pnt.y);
console.log('p1,p2,line near=',drawingPoints[k],drawingPoints[k+1],pnt,near,'naib=',naib_x,naib_y);
			if(near<40 && naib_x<=0 && naib_y<=0) {
				nn=k+1;
				first_point=createFirstPoint([{x:pnt.x,y:pnt.y}]);
	        		Object.assign(first_point.style, defaultPointStyle);
				//var fig_id='pn'+("00" + (id)).slice( -2 );
				//first_point.setAttributeNS(null,'id', fig_id);
				//first_point.setAttributeNS(null,'class', 'movable');
				first_point.setAttribute('style', style="stroke-width: 1px; stroke: red; fill: pink;");
				first_point.setAttribute('fig', 'temp');
				tagn.appendChild(first_point);
				var result = window.confirm('Pointを追加しますか？');
				if(result==true){
					drawingPoints.splice(k+1, 0,{x:pnt.x,y:pnt.y});
					drawingPtype.splice(k+1, 0,0);
					var c_para=tagn.getAttribute("close"); 
					var s_para=tagn.getAttribute("smooth"); 
console.log('s_para,c_para=',s_para,c_para);
console.log('**02 before=',tagn.firstChild.outerHTML);
					len=tagn.children.length;
					for(var k=len-1;k>0;k--){
						if(tagn.children[k].nodeName=='path') ;
						else if(tagn.children[k].nodeName=='marker') ;
						else tagn.removeChild(tagn.children[k]);
						}
					tagn.firstChild.removeAttribute('d');
console.log('before set_line c_para,s_para=',c_para,s_para);
					var new_path = set_line_group(tagn,drawingPtype,c_para,s_para);
console.log('after set_line at fixpoint new_path=',new_path);
					var path_d=new_path.getAttribute('d');
					tagn.firstChild.setAttribute('d',path_d);
console.log('after tagn=',tagn);
					remake_group(tagn,tagn.firstChild,defaultArrowStyle);

					error=path_to_circle(tagn.children[0],drawingPoints,drawingPtype);		//path座標に赤丸を描画					
console.log('**after draw circle');
					}
				break;
				}
			}
		}
console.log(drawingPoints);
	}

// translate page to SVG co-ordinate
function svgPoint(element, x, y) {
  var pt = org_container.createSVGPoint();

  pt.x = x;
  pt.y = y;

  return pt.matrixTransform(element.getScreenCTM().inverse());
}


    function draw_move(e) {
	if(Move_mode){
console.log('Svg_mode=',Svg_mode,'Draw_mode=',Draw_mode,'line=',control.value);
		if(Svg_mode=='Svg_drag_pending') {
			//startDrag(e);
			Svg_mode='Svg_drag';
			return;
			}
		if(Svg_mode=='Svg_drag'){
			//handleMove(e);
			draw_basic_moving(e);
			return;
			}
		if(Draw_mode=="Basic") {
			draw_basic_moving(e);
			return;
			}
		if(Draw_mode=="Draw") {
			draw_origin_move(e);
			return;
			}
		}
	} //End of function draw_move

function draw_origin_move(e) {
	var xp=e.clientX;
	var yp=e.clientY;
	if(conv_cord) {
		xp=xp-off_indivx;
		yp=yp-off_indivy;
		}
console.log('convert indiv',xp,yp,off_indivx,off_indivy);
	if(!isDrawing && Svg_mode!="") {
console.log('mouse move',control.value,'Step=',Step,'line=',control.value);
		if ((control.value== 'free_line') || (control.value== 'free_smooth') ){
			isDrawing=true;
			mv_flag=0;
			drawingPoints=[];
			Step=1;
			if(control.value== 'free_line') near1=30;
			else near1=200;
console.log('Free_line Reset isDraw Step:1')
			}
		if ((control.value== 'quad_bezier') &&(Step==2)){
			isDrawing=true;
			mv_flag=1;
console.log('quad_bezier Step:',Step)
			}
		if ((control.value== 'cubic_bezier') &&(Step==3)){
			isDrawing=true;
			mv_flag=2;
console.log('cubic_bezier Step:',Step)
			}
console.log('move_flag=',mv_flag,'Oper=',Oper);
		}
	switch(mv_flag){
		case 0:
//console.log('free line');
			var len=drawingPoints.length;
			var near=20;
			if(len>=1){
			near=Math.pow(drawingPoints[len-1].x-xp,2)+Math.pow(drawingPoints[len-1].y-yp,2);
console.log('len=',len,' near=',near);
				}
			else {
				drawingPoints.push({x: xp,y: yp});
				}
			if(near>near1) {
            			drawingPoints.push({x: xp,y: yp});
            			if (drawingPath) {
                			container.removeChild(drawingPath);
					drawingPath=null;
console.log('remove old');
            				}
                		drawingPath = createPath(drawingPoints,0,null,null);
            			Object.assign(drawingPath.style, defaultPathStyle);
            			container.appendChild(drawingPath);
console.log('free line append point leng=',drawingPoints.length);
				}
			break;
		case 1:
			if(drawingPoints.length==3) {
				drawingPoints.pop();
				}
            		drawingPoints.push({x: xp,y: yp});
            		if (drawingPath) {
                		container.removeChild(drawingPath);
				drawingPath=null;
            			}
                	drawingPath = createQuadBezier(drawingPoints);
            		Object.assign(drawingPath.style, defaultPathStyle);
            		container.appendChild(drawingPath);
console.log('append bezier');
			break;
		case 2:
			if(drawingPoints.length==4) {
				drawingPoints.pop();
				}
            		drawingPoints.push({x: xp,y: yp});
            		if (drawingPath) {
                		container.removeChild(drawingPath);
				drawingPath=null;
            			}
                	drawingPath = createCubicBezier(drawingPoints,0);
            		Object.assign(drawingPath.style, defaultPathStyle);
            		container.appendChild(drawingPath);
console.log('append cubic bezier');
			break;
		}
    }  //End of function draw_origin_move

var basic_rect= {
	rect:null,
	x0:0,
	y0:0,
	w:10,
	h:10,
	}

function draw_basic_moving(e){
console.log('**draw_basic moving Step=',Step);
	var xp=e.clientX;
	var yp=e.clientY;
/*
	if(conv_cord) {
console.log('convert indiv',xp,yp,off_indivx,off_indivy);
		xp=xp-off_indivx;
		yp=yp-off_indivy;
		}
*/
	if(Step==0) {
		basic_rect.x0=xp;
		basic_rect.y0=yp;
		if(conv_cord) {
			basic_rect.x0=basic_rect.x0-off_indivx;
			basic_rect.y0=basic_rect.y0-off_indivy;
			}
		Step=1;
		}
	else {
		basic_rect.w=Math.abs(xp-basic_rect.x0);
		basic_rect.h=Math.abs(yp-basic_rect.y0);
		if(conv_cord) {
			basic_rect.w=Math.abs(xp-off_indivx-basic_rect.x0);
			basic_rect.h=Math.abs(yp-off_indivy-basic_rect.y0);
			}
		if(basic_rect.rect) {
			basic_rect.rect.remove();
			}
		basic_rect.rect=createRectFig(basic_rect.x0,basic_rect.y0,basic_rect.w,basic_rect.h);
		//rect01.setAttribute('id', 'rect01');
		container.appendChild(basic_rect.rect);
		}
	}  //end of draw_basic_moving

/*
function draw_basic_moving(e){
console.log('**draw_basic moving Step=',Step);

	if(Step==0) {
		basic_rect.x0=e.clientX;
		basic_rect.y0=e.clientY;
		if(conv_cord) {
			basic_rect.x0=basic_rect.x0-off_indivx;
			basic_rect.y0=basic_rect.y0-off_indivy;
			}
		Step=1;
		}
	else {
		basic_rect.w=Math.abs(e.clientX-basic_rect.x0);
		basic_rect.h=Math.abs(e.clientY-basic_rect.y0);
		if(conv_cord) {
			basic_rect.w=Math.abs(e.clientX-off_indivx-basic_rect.x0);
			basic_rect.h=Math.abs(e.clientY-off_indivy-basic_rect.y0);
			}
		if(basic_rect.rect) {
			container.removeChild(basic_rect.rect);
			basic_rect.rect=null;
			}
		basic_rect.rect=createRectFig(basic_rect.x0,basic_rect.y0,basic_rect.w,basic_rect.h);
		//rect01.setAttribute('id', 'rect01');
		container.appendChild(basic_rect.rect);
		}
	}  //end of draw_basic_moving
*/

    function createPath(points,close,rect,def_points) {
        var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        var attribute = '';
        points.forEach((point, index) => {
            if (index === 0) {
                attribute += `M${point.x}, ${point.y}`;
            } else {
                attribute += `L${point.x}, ${point.y}`;
            }
        });
	if(close=="close"){
		attribute += ` Z`;
		}
        path.setAttributeNS(null, 'd', attribute);
	if(tempArrowStyle || defaultArrowStyle) {
		if(defaultArrowStyle) tempArrowStyle=defaultArrowStyle;
		}
/*
	var sten=tempArrowStyle.split('/');
console.log('**path arrow=',tempArrowStyle,sten[0],sten[1]);
    switch (sten[0]){
      case 'fw':
        	path.setAttribute('marker-start', "url(#fowd_arw)");
		break;
      case 'bw':		              
        	path.setAttribute('marker-start', "url(#bkwd_arw)");
		break;
	}
    switch (sten[1]){
      case 'fw':
        	path.setAttribute('marker-end', "url(#fowd_arw)");
		break;
      case 'bw':		              
        	path.setAttribute('marker-end', "url(#bkwd_arw)");
		break;
	}
//console.log('**path Lstyle=',defaultLineStyle);
    switch (defaultLineStyle){
      case 'none':               
		break;
      case 'dash':               
        	path.setAttribute('stroke-dasharray', "4 4");
		break;
      case '1_dash':  
        	path.setAttribute('stroke-dasharray', "24 3 2 3");             
		defaultLineStyle="1_dash";
		break;
      case '2_dash':
        	path.setAttribute('stroke-dasharray', "24 3 2 3 2 3");
		break;
		}
*/
//console.log('**createPath=',path);
        return path;
    }

    function createQuadBezier(points) {
console.log('quad bezier','length=',points.length);
        var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        var attribute = '';
	var nx=2;
        points.forEach((point, index) => {
	    nx=nx+1;
	    mod3_nx=nx % 3;
console.log('nx=',nx,' mod3=',mod3_nx);
            if (mod3_nx== 0) {
		if(nx<4){
                	attribute += `M${point.x}, ${point.y}`;
            		} 
		else {
			attribute += `T${point.x}, ${point.y}`;
			}
		}
	    else if (mod3_nx==1) {
                attribute += `Q${point.x}, ${point.y}`;
            	}
	    else {
		attribute += ` ${point.x}, ${point.y}`;
		}
        });
        path.setAttributeNS(null, 'd', attribute);
/*
//console.log('**path arrow=',defaultArrowStyle);
    switch (defaultArrowStyle){
      case 'none':               
		break;
      case 'start':
        	path.setAttribute('marker-start', "url(#start_arw)");
		break;
      case 'end':		              
        	path.setAttribute('marker-end', "url(#end_arw)");
		break;
      case 'both':               
        	path.setAttribute('marker-start', "url(#start_arw)");
        	path.setAttribute('marker-end', "url(#end_arw)");
		break;
		}
//console.log('**path Lstyle=',defaultLineStyle);
    switch (defaultLineStyle){
      case 'none':               
		break;
      case 'dash':               
        	path.setAttribute('stroke-dasharray', "4 4");
		break;
      case '1_dash':  
        	path.setAttribute('stroke-dasharray', "24 3 2 3");             
		defaultLineStyle="1_dash";
		break;
      case '2_dash':
        	path.setAttribute('stroke-dasharray', "24 3 2 3 2 3");
		break;
		}
*/
console.log(path)
        return path;
    }

    function createCubicBezier(points,close) {
console.log('cubic bezier','length=',points.length);
        var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        var attribute = '';
	var nx=2;
        points.forEach((point, index) => {
	    nx=nx+1;
	    mod3_nx=nx % 3;
console.log('nx=',nx,' mod3=',mod3_nx);
            if (mod3_nx== 0) {
		if(nx<4){
                	attribute += `M${point.x}, ${point.y}`;
            		} 
		else {
			attribute += ` ${point.x}, ${point.y}`;
			}
		}
	    else if (mod3_nx==1) {
                attribute += `C${point.x}, ${point.y}`;
            	}
	    else {
		attribute += ` ${point.x}, ${point.y}`;
		}
        });
	if(close=="close"){
		attribute += ` Z`;
		}
        path.setAttributeNS(null, 'd', attribute);
/*
//console.log('**path arrow=',defaultArrowStyle);
    switch (defaultArrowStyle){
      case 'none':               
		break;
      case 'start':
        	path.setAttribute('marker-start', "url(#start_arw)");
		break;
      case 'end':		              
        	path.setAttribute('marker-end', "url(#end_arw)");
		break;
      case 'both':               
        	path.setAttribute('marker-start', "url(#start_arw)");
        	path.setAttribute('marker-end', "url(#end_arw)");
		break;
		}
//console.log('**path Lstyle=',defaultLineStyle);
    switch (defaultLineStyle){
      case 'none':               
		break;
      case 'dash':               
        	path.setAttribute('stroke-dasharray', "4 4");
		break;
      case '1_dash':  
        	path.setAttribute('stroke-dasharray', "24 3 2 3");             
		defaultLineStyle="1_dash";
		break;
      case '2_dash':
        	path.setAttribute('stroke-dasharray', "24 3 2 3 2 3");
		break;
		}
*/
//console.log(path)
        return path;
    }

    function draw_up(e) {
	if(mouse_Error) {
		mouse_Error=false;
		Up_count=0;
		}
	else if (Move_mode) {
console.log('canceled Move_mode');
		if(Draw_mode=="Basic") {
			draw_op.posx=e.clientX;
			draw_basic_moveup();
			}
		else if(Svg_mode=="Svg_drag") {   //領域選択の場合 この条件は不備
			tagn=container;
			var fig_id=tagn.getAttribute('id');
console.log('**nodename= ',tagn.nodeName,'id= ',fig_id);
			area_catch_figure(tagn);
console.log('select tags=',g_list);
			}
		else if(Draw_mode=="Drag") {
console.log('***Move or Reshape drag end Svg_mode=',Svg_mode);
	    		if(Svg_mode=="Svg_reshape_pending") {      //Path変形の場合  move interを加えた時点で殆どを省く
//moving reshapeをdraw upで修正するにはdrawingPointsの再設定が必要
				if(drag.c_para=='close') {
					drawingPoints[drawingPoints.length-1]=drawingPoints[0];
					}
console.log('******c_para,s_para,length=',drag.c_para,drag.s_para,drawingPoints.length,drawingPoints);

					tagn=Drag_elem;
					len=tagn.children.length;
					for(var k=len-1;k>0;k--){
						if(tagn.children[k].nodeName=='path') ;
						else if(tagn.children[k].nodeName=='marker') ;
						else tagn.removeChild(tagn.children[k]);
						}
					tagn.firstChild.removeAttribute('d');
console.log('before set_line c_para,s_para=',drag.c_para,drag.s_para);
					var new_path = set_line_group(tagn,drawingPtype,drag.c_para,drag.s_para);
console.log('after set_line at fixpoint new_path=',new_path);
					var path_d=new_path.getAttribute('d');
					tagn.firstChild.setAttribute('d',path_d);
console.log('after tagn=',tagn);
					remake_group(tagn,tagn.firstChild,defaultArrowStyle);

					error=path_to_circle(tagn.children[0],drawingPoints,drawingPtype);		//path座標に赤丸を描画					
console.log('**after draw circle');
/*
					var new_path = set_line_group(Drag_elem,drawingPtype,drag.c_para,drag.s_para);
					remake_group(Drag_elem,Drag_elem.firstChild,defaultArrowStyle);
					var path_d=new_path.getAttribute('d');
					Drag_elem.firstChild.setAttribute('d',path_d);
*/
				if(reshape_path) {
					container.removeChild(reshape_path);
					reshape_path=null;
					}
				if(mv_line0) {
					container.removeChild(mv_line0);
					mv_line0=null;
					}
				if(mv_line1) {
					container.removeChild(mv_line1);
					mv_line1=null;
					}
				Svg_mode=="Svg_reshape_pending";
				}
	    		if(Svg_mode=="Svg_scale_pending") {      //拡大縮小の場合
//拡大縮小の基準点はDrag点とは反対側の点とする。　scale_callback関数で決めている。
				var offx=Number(drag.target.getAttributeNS(null, "cx"));
				var offy=Number(drag.target.getAttributeNS(null, "cy"));

				var point = org_container.createSVGPoint();
				point.x=offx;
				point.y=offy;
				if(conv_cord) {
					point.x=point.x+off_indivx;
					point.y=point.y+off_indivy;
//console.log('scale point conv_cord');
					}
				var localMatrix = drag.target.getCTM();
				var localPoint = point.matrixTransform(localMatrix); 

				var point=svgPoint(drag.target.parentNode, localPoint.x, localPoint.y);

console.log('center=',drag.center_x,drag.center_y,' width height=',drag.hf_width,drag.hf_height);
console.log('point=',offx,offy,'group point=',point.x,point.y);
				var sx=0;
				var sy=0;
				var angle=vMove=hMove=0;
				//	svgにSVGTransformを生成する
				var Transform = org_container.createSVGTransform();
console.log(Transform);
				//	生成されたTransform内のmatrixオブジェクトをMatrixに参照
				var Matrix = Transform.matrix;
				var target_group=drag.target.parentNode;
				var tyfig=target_group.firstChild.nodeName;
console.log('tagname=',tyfig);



console.log('target=',drag.target,'parent=',drag.target.parentNode,'tag=',document.getElementById(drag.fixpnt));
				var old_transf="";
				if(target_group.transform.baseVal.numberOfItems>0) old_transf=target_group.getAttributeNS(null, "transform")
    				switch (drag.id_num){
      					case 1:
					case 2:
      					case 3:
					case 4:
						var tag=document.getElementById(drag.fixpnt);
						var x0=Number(tag.getAttributeNS(null, "cx"));
						var y0=Number(tag.getAttributeNS(null, "cy"));
						if(tyfig=='#text') {
						var rect=target_group.getBoundingClientRect();
console.log('**rect=',rect);
							x0=rect.left;
							y0=rect.bottom;
							}
						var parm1=`${x0},${y0}`;
						var parm2=`${-x0},${-y0}`;
						sx=Math.abs(point.x-drag.center_x)/drag.hf_width;
						sy=Math.abs(point.y-drag.center_y)/drag.hf_height;
						sx=sy=Math.max(sx,sy);
						var sc_parm=`${sx},${sy}`;
						var transf="translate("+parm1+")"+"scale("+sc_parm+")"+"translate("+parm2+")";
console.log('transform=',transf);
						transf=transf+old_transf;
						target_group.setAttribute('transform', transf);
						break;
					case 5:
					case 6:
					case 7:
					case 8:
						var tag=document.getElementById(drag.fixpnt);
						var x0=Number(tag.getAttributeNS(null, "cx"));
						var y0=Number(tag.getAttributeNS(null, "cy"));
						if(tyfig=='#text') {
						var rect=target_group.getBoundingClientRect();
console.log('**rect=',rect);
							x0=rect.left;
							y0=rect.bottom;
							}
						var parm1=`${x0},${y0}`;
						var parm2=`${-x0},${-y0}`;
						sx=Math.abs(point.x-drag.center_x)/drag.hf_width;
						sy=Math.abs(point.y-drag.center_y)/drag.hf_height;
						if(sx>sy) sy=1;
						else sx=1;
						var sc_parm=`${sx},${sy}`;
						transf="translate("+parm1+")"+"scale("+sc_parm+")"+"translate("+parm2+")";
console.log('transform=',transf);
						transf=transf+old_transf;
						drag.target.parentNode.setAttribute('transform', transf);
						break;
      					case 10:   //rotateの場合　angle　0～360
					case 11:   //a=cos(angle) b=sin(angle) c=-sin(angle) d=cos(angle)
console.log('rotate');
						var tag=document.getElementById(drag.fixpnt);
						var p1 = org_container.createSVGPoint();
						p1.x=Number(tag.getAttributeNS(null, "cx"));
						p1.y=Number(tag.getAttributeNS(null, "cy"));
						var cnt = org_container.createSVGPoint();
						cnt.x=drag.center_x;
						cnt.y=drag.center_y;
						angle = angle_between_points(p1, cnt,point);
console.log('****angle=',angle);
						var rol_parm=`${angle},${cnt.x},${cnt.y}`;
console.log('rotate transform=',rol_parm);
						var transf="rotate("+rol_parm+")"+old_transf;
						drag.target.parentNode.setAttribute('transform',transf);
						break;
　　　					default:
						return;
						break;
					}
				drag.target.parentNode.setAttribute('fig','hybrid');
console.log('redraw');
//				catch_scale_fig(drag.target.parentNode);
//console.log('scalexy=',scalex,scaley,'rotate=',angle);
			}
		}
	else {
//free_line及びCubic lineなどの場合
		draw_up_origin(e);
		}
	Move_mode=0;
	temp_snap_flag=0;
	} //End of function draw_up

// p1 is the center point; result is in degrees
function angle_between_points( p0, p1, p2 ) {
  var a = p2.x-p0.x;
  var b = p2.y-p0.y;
  if(Math.abs(a)>Math.abs(b)) {
	var dx=a/Math.sqrt((p1.x-p0.x)**2 + (p1.y-p0.y)**2)
	var ang=Math.asin(dx)
	}
   else {
	var dy=b/Math.sqrt((p1.x-p0.x)**2 + (p1.y-p0.y)**2)
	var ang=Math.asin(dy)
	}
  return ang*180/Math.PI;
  }

    function draw_up_origin(e) {
        if ((control.value === 'quad_bezier') && (Step==2)){
console.log('bezier mouseup');
            	if (bezier_line){
			container.removeChild(bezier_line);
			bezier_line=null;
			}
		if (drawingPath) {
                	container.removeChild(drawingPath);
			drawingPath=null;
            		}
            	var path = createQuadBezier(drawingPoints);
	        Object.assign(path.style, defaultPathStyle);
	        container.appendChild(path);
		var {group,fig_id}=make_group('quad');
		group.appendChild(path);
//		remake_group(group,drawingPath,tempArrowStyle);
		remake_group(group,path,tempArrowStyle);
/*
		if(tempArrowStyle || defaultArrowStyle) {
			if(defaultArrowStyle) tempArrowStyle=defaultArrowStyle;
console.log('arrowstyle=',tempArrowStyle);
				remake_group(group,path,tempArrowStyle);
				tempArrowStyle='';
				}
*/
		Step=3;
console.log('quad line=',group);
		}
        else if ((control.value === 'cubic_bezier') && (Step==3)){
console.log('cubic bezier mouseup');
            	if (bezier_line){
			container.removeChild(bezier_line);
			bezier_line=null;
			}
		if (bezier_line1){
			container.removeChild(bezier_line1);
			bezier_line1=null;
			}
		if (drawingPath) {
                	container.removeChild(drawingPath);
			drawingPath=null;
            		}
            	var path = createCubicBezier(drawingPoints,0);
	        Object.assign(path.style, defaultPathStyle);
	        container.appendChild(path);
		var {group,fig_id}=make_group('cubic');
		group.appendChild(path);
//		remake_group(group,drawingPath,tempArrowStyle);
		remake_group(group,path,tempArrowStyle);
/*
		if(tempArrowStyle) {
console.log('arrowstyle=',tempArrowStyle);
			remake_group(group,path,tempArrowStyle);
			tempArrowStyle='';
			}
*/
		Step=4;
console.log('cubic line=',group);
		}
	else {     //free_lineの場合
		var len=drawingPoints.length;
console.log('**** **** ****free line leng=',len);
		if(Step==1 && len >0 ) {
			if (drawingPath) {
				container.removeChild(drawingPath);
				drawingPath=null;
            			}
            		var path = createPath(drawingPoints,0,null,null);
	        	Object.assign(path.style, defaultPathStyle);
	        	container.appendChild(path);
			var {group,fig_id}=make_group('free');
			group.appendChild(path);
			if(control.value=='free_line') {
				tempArrowStyle='';
				remake_group(group,path,tempArrowStyle);
				}
			else {   //free_smoothの場合
				var s_para='smooth';
				var c_para='else';
				group.setAttributeNS(null,'smooth', s_para);
				group.setAttributeNS(null,'close', c_para);
				drawingPtype=Array(drawingPoints.length);
				drawingPtype.fill(0);
				var path=set_line_group(group,drawingPtype,c_para,s_para);
				group.insertBefore(path, group.firstChild);
				group.removeChild(group.lastChild);
				remake_group(group,path,defaultArrowStyle);
				}
console.log('**** **** ****free line=',control.value,group);
			}
        	}
         if (bezier_line){
		container.removeChild(bezier_line);
		bezier_line=null;
		}
	isDrawing=false;
	Oper=0;
	mv_flag=10;
	Step=0;
	first_point='';
	drawingPoints = [];
	}
    }  //End of function draw_up_origin

function draw_basic_moveup(){
console.log('**draw_basic move end');
/* 注意：拡大縮小の変換は左上の座標値が倍率の値に変換されるので基本図は（0,0)のものが必要　*/
	var rect_a=draw_op.target.getBoundingClientRect();
console.log('**rect_a=',rect_a);
	if(!basic_rect.rect) return;
	var rect_b=basic_rect.rect.getBoundingClientRect();
console.log('**rect_b=',rect_b);

        var scx=Math.ceil(100*(rect_b['right']-rect_b['left'])/(rect_a['right']-rect_a['left']))/100;
        var scy=Math.ceil(100*(rect_b['bottom']-rect_b['top'])/(rect_a['bottom']-rect_a['top']))/100;
	var parm=`${scx},${scy}`;

	var sx= Math.ceil(rect_b['left']-rect_a['left']);
	var sy= Math.ceil(rect_b['top']-rect_a['top']);
        var tr_parm=`${sx},${sy}`;
	var dumy=(draw_op.target).cloneNode(true);
	var dumy_tx=(draw_op.target).cloneNode(true);
	dumy.setAttribute("transform", "translate("+tr_parm+")"+"scale("+parm+")");      //線幅が太く細くなる？

console.log('**basic fig=',draw_op.fig);
	if(draw_op.fig=='basic'){
		var fig_id='b'+(Date.now()).toString();
		dumy.setAttribute('id', fig_id);
		dumy.setAttribute('fig', 'basic');

        			var wgroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
				var fig_id2='g'+(Date.now()).toString();
				wgroup.setAttribute('id', fig_id2);
				wgroup.setAttribute('fig', 'group');
				wgroup.setAttribute('opacity', '0.6');
				var smth=dumy.getAttribute('smooth');
				if(smth) wgroup.setAttribute('smooth', smth);
				var clos=dumy.getAttribute('close');
				if(clos) wgroup.setAttribute('close', clos);
				var g_temp=container.appendChild(wgroup);
			simple_fig(g_temp,dumy);              //transform matrixを適用して図形simple化

//		container.removeChild(dumy);
		dumy.remove();
		}
	else {
		if(draw_op.fig=='text'){
			var fig_id='t'+(Date.now()).toString();
			dumy_tx.setAttribute('id', fig_id);
			dumy_tx.setAttribute('fig', 'text');
			dumy_tx.setAttribute("transform", "translate("+tr_parm+")"); 
			container.appendChild(dumy_tx);
			}
	     	else {
			var fig_id='g'+(Date.now()).toString();
			dumy.setAttribute('id', fig_id);
			dumy.setAttribute('fig', 'group');
			container.appendChild(dumy);
			}
		}

	container.removeChild(basic_rect.rect);
	basic_rect.rect=null;
console.log('scale=',scx,scy,' translate=',sx,sy);
	Step=0;
	}  //end of draw_basic_moveup

function move_interpol(pn,bf,nx,nxx){

   var sn=[];
   var vn=[];
   var wn=[];
   var xn=[];
//slopeの算出
	if(pn!=null) {
		pn.x=Number(pn.x);
		pn.y=Number(pn.y);
		}
	if(bf!=null) {
		bf.x=Number(bf.x);
		bf.y=Number(bf.y);
		}
	if(nx!=null) {
		nx.x=Number(nx.x);
		nx.y=Number(nx.y);
		}
	if(nxx!=null) {
		nxx.x=Number(nxx.x);
		nxx.y=Number(nxx.y);
		}
	
console.log('Enter move_interpol pn,bf,nx=',pn,bf,nx);

    if(bf==null) {
	sn[0]=pn.x+nx.x-pn.x;				//at　Start　ポイント
	sn[1]=pn.y+nx.y-pn.y;
	}
    else if(nx==null) {
	sn[0]=pn.x+bf.x-pn.x;				//at　Start　ポイント
	sn[1]=pn.y+bf.y-pn.y;
	}
    else {
	sn[0]=pn.x+nx.x-bf.x;
	sn[1]=pn.y+nx.y-bf.y;
	}
    if(nxx!=null) {
		sn[2]=nx.x+nxx.x-pn.x;
		sn[3]=nx.y+nxx.y-pn.y;
		}

//
	var vn0x=(2*pn.x+nx.x)/3;
	var vn0y=(2*pn.y+nx.y)/3;
	var vnx=vn0x-(nx.y-pn.y);
	var vny=vn0y+(nx.x-pn.x);
console.log('sn=',sn,'vn=',vn0x,vn0y,vnx,vny);
	var point1 = {
	    start : { x : pn.x, y : pn.y }, // 始点
	    end   : { x : sn[0], y : sn[1] }    // 終点
	};
	var point2 = {
	    start : { x : vn0x, y : vn0y }, // 始点
	    end   : { x : vnx, y : vny }   // 終点
	};
	var result = Inter_Line(point1, point2);
	vn[0]=result.x;
	vn[1]=result.y;
console.log('first vn=',vn);
//	first_point=createFirstPoint([{x:vn[0],y:vn[1]}]);
//	Object.assign(first_point.style, defaultPointStyle);
//      container.appendChild(first_point);

	var vn0x=(pn.x+2*nx.x)/3;
	var vn0y=(pn.y+2*nx.y)/3;
	var vnx=vn0x-(nx.y-pn.y);
	var vny=vn0y+(nx.x-pn.x);

	var point1 = {
	    start : { x : nx.x, y : nx.y }, // 始点
	    end   : { x : sn[2], y : sn[3] }    // 終点
		};
	var point2 = {
	    start : { x : vn0x, y : vn0y }, // 始点
	    end   : { x : vnx, y : vny }   // 終点
		};
	var result = Inter_Line(point1, point2);
	wn[0]=result.x;
	wn[1]=result.y;
console.log('second wn=',wn);

//	first_point=createFirstPoint([{x:wn[0],y:wn[1]}]);
//	Object.assign(first_point.style, defaultPointStyle);
//      container.appendChild(first_point);

	xn[0]=0;
	xn[1]=0;
	if(nxx!=null) {
	var vn0x=(2*nx.x+nxx.x)/3;
	var vn0y=(2*nx.y+nxx.y)/3;
	var vnx=vn0x-(nxx.y-nx.y);
	var vny=vn0y+(nxx.x-nx.x);

	var point1 = {
	    start : { x : nx.x, y : nx.y }, // 始点
	    end   : { x : sn[2], y : sn[3] }    // 終点
	};
	var point2 = {
	    start : { x : vn0x, y : vn0y }, // 始点
	    end   : { x : vnx, y : vny }   // 終点
	};
	var result = Inter_Line(point1, point2);
	xn[0]=result.x;
	xn[1]=result.y;
console.log('third xn vn=',vn);

//	first_point=createFirstPoint([{x:xn[0],y:xn[1]}]);
//	Object.assign(first_point.style, defaultPointStyle);
//      container.appendChild(first_point);
	}

	return [vn,wn,xn];
	}

var tempo_group=0;

function area_catch_figure(tagn){
console.log('**area_catch figure start area=',tagn);
/* tagn 領域内で指定区画内にあるg要素を探す　*/
	var rect_a=basic_rect.rect.getBoundingClientRect();
console.log('**rect_a=',rect_a);

	let w=rect_a.right-rect_a.left;
	let h=rect_a.bottom-rect_a.top;			
	var pnt1=svgPoint(tagn, rect_a.left, rect_a.top);   //大元の<svg>タグ上(viewport)の座標を<g>要素local座標に戻す

       	g_list = document.createElementNS('http://www.w3.org/2000/svg', 'g');
	var fig_num=Number(Date.now());
	var fig_id='g'+fig_num.toString();
	g_list.setAttribute('id', fig_id);
	g_list.setAttribute('fig', 'group_group');
	g_list.setAttribute('class', 'draggable');

	var len=tagn.children.length;
	for(let i=len-1;i>=0;i--) {
		fig_num=fig_num+1;
		var temp=tagn.children[i];
console.log('area tag no= ',i,temp.nodeName,temp);
		if(temp.nodeName=='g') {
			var rect_b=temp.getBoundingClientRect();
			var yes=temp_include(tagn,rect_b,pnt1,w,h);
			var rect_left=rect_b.left;
			var rect_right=rect_b.right;
			var rect_top=rect_b.top;
			var rect_bottom=rect_b.bottom;
			if(conv_cord) {
console.log('Enter conv_code in area_ctach xy=',off_indivx,off_indivy);
				rect_left=rect_b.left-off_indivx;
				rect_right=rect_b.right-off_indivx;
				rect_top=rect_b.top-off_indivy;
				rect_bottom=rect_b.bottom-off_indivy;
				}
			if(yes) {
				var pnt2=svgPoint(temp, rect_left, rect_top);

				let w2=rect_right-rect_left;
				let h2=rect_bottom-rect_top;
				if(w2<3) {
					rect_left=rect_left-2;
					w2=w2+4;
					}
				if(h2<3) {
					rect_top=rect_top-2;
					h2=h2+4;
					}
				rect01=createRectFig(pnt2.x,pnt2.y,w2,h2);
				rect01.setAttribute('fig', 'temp');
				temp.appendChild(rect01);
				g_list.appendChild(temp);
				}
			}
		}
	tempo_group=1;
	tagn.append(g_list);

	Drag_elem = document.getElementById(fig_id);
	Svg_mode="Selected";
console.log('tempo_group=',g_list);
	Draw_mode='Drag';
	drag.break=false;
	draggable(Drag_elem);

	if(!basic_rect.rect) return;
	container.removeChild(basic_rect.rect);
	basic_rect.rect=null;
//	if(g_list.length==1) g_list=g_list[0];
	return;
	}  //end of area_catch_figure

function temp_include(tagn,rect_a,pnt,w,h) {
console.log('Enter temp_include pnt,w,h=',pnt,w,h);
	let w2=rect_a.right-rect_a.left;
	let h2=rect_a.bottom-rect_a.top;			
	var pnt2=svgPoint(tagn, rect_a.left, rect_a.top);

	var ptary=[];
	ptary.push({x: pnt2.x,y: pnt2.y});
	ptary.push({x: pnt2.x+w2,y: pnt2.y});
	ptary.push({x: pnt2.x+w2,y: pnt2.y+h2});
	ptary.push({x: pnt2.x,y: pnt2.y+h2});
console.log('each pont=',ptary);
	result=false;
	for(let k=0;k<ptary.length;k++) {
		if(((ptary[k].x-pnt.x)*(ptary[k].x-pnt.x-w)<0) && ((ptary[k].y-pnt.y)*(ptary[k].y-pnt.y-h)<0)) {
console.log('Catch Figure');
			result=true;
			break;
			}
		}
	return result;
   }

function getAbsoluteRectPosition(elm){
  const {left, top,width,height} = elm.getBoundingClientRect();
  const {left: bleft, top: btop} = document.body.getBoundingClientRect();
  return {
    left: left - bleft,top: top - btop,right:left-bleft+width,bottom:top-btop+height
  };
}

  var RAD2DEG = 180 / Math.PI;

  function angleBetweenPoints(p1, p2) {
    var angle = null;
    if (p1.x == p2.x && p1.y == p2.y)
      angle = Math.PI / 2;
    else
      angle = Math.atan2(p2.y - p1.y, p2.x - p1.x);
    return (angle * RAD2DEG) + -90;
  }

   function chng_arrow()　{
console.log('**Enter change arrow start/end**',Editmode);
	defaultArrowStyle=document.getElementById('arrow').value;
	var st_en=defaultArrowStyle.split('/');
console.log('arrow=',defaultArrowStyle,' start=',st_en[0],'end=',st_en[1]);
	}

   function chng_Lstyle()　{
console.log('**Enter change Line style**',Editmode);
　　let select = document.getElementById('Lstyle');
    //選択したf_editによって分岐
    switch (select.selectedIndex){
      case 0:               
		defaultLineStyle="";
		break;
      case 1:               
		defaultLineStyle="none";
		break;
      case 2:               
		defaultLineStyle="dash";
		break;
      case 3:               
		defaultLineStyle="1_dash";
		break;
      case 4:               
		defaultLineStyle="2_dash";
		break;
		}
	}

    fig_copy.onclick = function(){
console.log("Enter fig_copy　Editmode=",Editmode);
//	if((Svg_mode=="Svg_drag")||(Svg_mode=="Svg_drag_pending")){
	if(Drag_elem){
		// 選択要素の複製
		var old_transf=Drag_elem.getAttribute('transform');
		if(old_transf===null) old_transf="";
		var leng=Drag_elem.children.length;
//2023.0501 text figureの場合はgroup_group化しない
		var ftype=Drag_elem.getAttribute('fig');
		if(leng>2 && ftype!='text') {
console.log('Copy tag has children size=',leng,'fig_type=',ftype);
       			group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
			var fig_num=Number(Date.now());
			var gfig_id='g'+fig_num.toString();
			group.setAttribute('id', gfig_id);
			group.setAttribute('fig', 'group_group');
console.log('group gen=',group);
			for(let i=0;i<leng;i++) {
				fig_num=fig_num+1;
				var temp=Drag_elem.children[i];
console.log('area tag no= ',i,temp.nodeName,temp);
				if(temp.nodeName!='rect') {
					var new_sub=temp.cloneNode(true);
					fig_num=fig_num+1;
					fig_id='g'+fig_num.toString();
					new_sub.setAttribute('id', fig_id);
					group.appendChild(new_sub);
					}
				}
			}
		else {
console.log('Copy tag has not any children or text  size=',leng,'fig_type=',ftype);
			var group = Drag_elem.cloneNode(true);
			var gfig_id='g'+(Date.now()).toString();
			group.setAttribute('id', gfig_id);
			}

		container.appendChild(group);
		Drag_elem.copy=group;

		//選択要素の選択解除
		document.getElementById("fig_sel_end").click();
		//複製要素のX成分の10px移動
		//複製要素の選択
		Drag_elem = document.getElementById(gfig_id);
		drag.target=Drag_elem;
		var random = String(Math.floor( Math.random() * 20 ) + 5);   //最大値50から最小値5を引いた「45」を使う

		var transf="translate("+random+",10)"+old_transf;
		group.setAttribute("transform", transf);
		Drag_elem.setAttribute('class', 'draggable');
		getrect_shape(Drag_elem);
		Draw_mode='Drag';
		drag.break=false;
		draggable(Drag_elem);
		Svg_mode='Svg_drag_pending';
console.log('Drag_elem and target=',Drag_elem,drag.target);
		}
    }

    fig_updown.onclick = function(){
	if(Svg_mode!='Svg_updown') {
		if(!Drag_elem) {
alert('figure not selected');
			return;
			}
	var f_check=check_fig_pos(Drag_elem);
	if(f_check) {
alert('figure is out of range');
		return;
		}
	window.scrollTo(0,off_page.top);
		prev_Draw_mode=Draw_mode;
		pre_Svg_mode=Svg_mode;
		Draw_mode="";
		Svg_mode="Svg_updown";
		svg_step_flag=0;
		document.oncontextmenu = function () {return false;}  //contextmenu 表示の禁止
console.log("Updown figure=",Drag_elem);
		catch_updown_fig(Drag_elem);
		return;
		}
	else {	//Svg_updownの2step目ならば以下の処理を実施する
		if(svg_step_flag<1) return;
		var pnt=svgPoint(Drag_elem, drag.offsetx, drag.offsety);
		pnt.x=drag.offsetx;
		pnt.y=drag.offsety;
		}

	temp_delete(Drag_elem);
//	simple_fig_top(dumy_group,Drag_elem,Drag_elem);              //transform matrixを適用して図形simple化
//	simple_fig(dumy_group,Drag_elem);              //transform matrixを適用して図形simple化
//	copy_svgtag(Drag_elem,dumy_group);
console.log('After simple=',tagn);

	var rect_a=Drag_elem.getBoundingClientRect();
console.log('**rect_a=',rect_a);
	let w=rect_a.right-rect_a.left;
	let h=rect_a.bottom-rect_a.top;
	drag.center_x=rect_a.left+w/2;
	drag.center_y=rect_a.top+h/2;

	if(conv_cord) {
		drag.center_x=drag.center_x-off_indivx;
		drag.center_y=drag.center_y-off_indivy;
		}

//	first_point=createFirstPoint([{x:drag.center_x,y:drag.center_y}]);
//	Object.assign(first_point.style, defaultPointStyle);
//        org_container.appendChild(first_point);
	var old_trans="";
	if(Drag_elem.transform.baseVal.numberOfItems>0) old_trans=Drag_elem.getAttribute("transform");
console.log('Upside down canter=',drag.center_x,drag.center_y,'old_trans=',old_trans);
	if(old_trans===null) old_trans='';
	if(Math.abs(drag.center_x-pnt.x)>Math.abs(drag.center_y-pnt.y)) {
		var parm1=`${0},${drag.center_y}`;
		parm1="translate("+parm1+")";
//		Drag_elem.setAttribute("transform", "translate("+parm+")");
		var parm2=`${0},${-drag.center_y}`;
		parm2="translate("+parm2+")";
//		Drag_elem.setAttribute("transform", "translate("+parm+")");
		var transf=parm1+"scale(1,-1)"+parm2+old_trans;
console.log('transform=',transf)
		Drag_elem.setAttribute("transform", transf);
//		upsidedown_fig(dumy_group,Drag_elem,drag.center_x,'y');
		}
	else {
		var parm1=`${drag.center_x},${0}`;
		parm1="translate("+parm1+")";
//		Drag_elem.setAttribute("transform", "translate("+parm+")");
		var parm2=`${-drag.center_x},${0}`;
		parm2="translate("+parm2+")";
//		Drag_elem.setAttribute("transform", "translate("+parm+")");
		var transf=parm1+"scale(-1,1)"+parm2+old_trans;
console.log('transform=',transf)
		Drag_elem.setAttribute("transform", transf);
//		upsidedown_fig(dumy_group,Drag_elem,drag.center_y,'x');
		}
	Drag_elem.setAttribute('fig','hybrid');
//	copy_svgtag(Drag_elem,dumy_group);
	document.getElementById("fig_sel_end").click();
	Svg_mode="";
	svg_step_flag=0;
    }

    function upsidedown_fig(g_temp,g_group,cnt_xy,xory) {  //g_groupのpathを上下又は左右に反転し、g_tempに作成する
console.log('**simple fig Node=',g_group.nodeName);
	if(g_group.nodeName!='g' || g_temp.nodeName!='g') {
//		console.log('cant simplify this element');
alert('cant upsidedown');
		return;
		}
//console.log('child node leng=',g_group.childElementCount);
	for (var k = 0; k < g_group.childElementCount; k++) {
		tag=g_group.children[k];
//console.log('child k=',k,tag);
		if(tag.nodeName=="path") {
			var target=tag.cloneNode(true);
			var path_p=resolv_figure(target);
//console.log(path_p);
			var path_nw=cord_upside(path_p,cnt_xy,xory);
console.log('new_path=',path_nw);
			var new_pathd=set_phrase(target,path_nw,0,1);
        		target.setAttributeNS(null,'d', new_pathd);
			Object.assign(target.style, defaultPathStyle);   //Basic図を指定のカラーで描画
			g_temp.appendChild(target);
			}
		else if(tag.nodeName=="g") {
			var target=tag.children[0].cloneNode(true);
			var path_p=resolv_figure(target);
//console.log(path_p);
			var path_nw=cord_upside(path_p,cnt_xy,xory);
//console.log(path_nw);
			var new_pathd=set_phrase(target,path_nw,0,1);
        		target.setAttributeNS(null,'d', new_pathd);
			g_temp.appendChild(target);
			}
		else if(tag.nodeName=="marker") {
			var target=tag.cloneNode(true);
			g_temp.appendChild(target);
			}
		}
	} //End function

function cord_upside(path_p,cnt_xy,xory) {
console.log('Points=',path_p);
	var pnx,pny;
	var nw_path=[];
	for ( var i = 0;  i < path_p.length ; i++ ){
		var pt=path_p[i];
		if(xory=='y') {
			pnx=2*cnt_xy-pt.x;
			pny=pt.y;
			}
		else {
			pnx=pt.x
			pny=2*cnt_xy-pt.y;
			}
		nw_path.push({x:pnx,y:pny});
		}
	return nw_path;
	} //End of function


    fig_delete.onclick = function() {
console.log("Enter fig_delete at Svg_mode=",Svg_mode);

	if(g_list) {
		g_list.remove();
		tempo_group=0;
		}

	if(Drag_elem) {
		Drag_elem.remove();
		Drag_elem='';
		}
	drag.target=null;
	drag.group=null;
	Svg_mode=="";

	document.getElementById("fig_sel_end").click();
	document.getElementById('contextmenu_a').style.display="none";

    }

function export_mode() {

    switch (Exp.selectedIndex){
      case 0:               
		break;
      case 1:               //onlty svg
		export_svg();
		break;
      case 2:               //To html
		my_confirm(9);
		break;
      case 3:               //To html
	if(for_cloud=='yes') {
		alert('dump is under construction');
		return;
		}
		my_confirm(12);
		break;
	}
    }

function To_your_Pc() {
console.log('Tp your Pc selected');
	my_confirm(9);
	}

function From_your_Pc() {
//下は本来の機能
console.log('From your Pc selected');
		document.getElementById("htmlfile").click();
	}

//    export_svg.onclick = function(){
function export_svg() {
console.log("***Enter export");
	mesh_draw=false;
	svg_tag='<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">'
console.log('outerHTML=',svg_tag);
console.log('**container nodename= ',container.nodeName,'id= ',fig_id);
console.log('**container child length=',container.childElementCount);
	for (nn = 0; nn < container.childElementCount; nn++) {
		if(container.children[nn].nodeName!='defs'){
			svg_tag=svg_tag+container.children[nn].outerHTML;
			}
console.log('***list n =',nn,' length = ', svg_tag.length);
		}
	svg_tag=svg_tag+'</svg>';

let blob = new Blob([svg_tag],{type:"svg"});
let link = document.createElement('a');
link.href = URL.createObjectURL(blob);
link.download = 'testfile.svg';
link.click();
	}

    function createFirstPoint(points) {
	var svg = document.getElementById(svg_now),
  	NS = svg.getAttribute('xmlns');
	circ1=document.createElementNS(NS,'circle');
	circ1.setAttributeNS(null,'cx',points[0].x);
	circ1.setAttributeNS(null,'cy',points[0].y);
	circ1.setAttributeNS(null,'r',5);
//	circ1.setAttributeNS(null,'fill','red');
//	circ1.setAttributeNS(null,'stroke','black');
//	svg.appendChild(circ1);
//console.log(circ1)
        return circ1;
    }

    function createRectFig(x,y,w,h) {
	rect1=document.createElementNS('http://www.w3.org/2000/svg','rect');
	rect1.setAttribute('x',x);
	rect1.setAttribute('y',y);
	rect1.setAttribute('width',w);
	rect1.setAttribute('height',h);
	rect1.setAttribute('stroke','blue');
	rect1.setAttribute('fill','none');
        rect1.setAttribute('strokeWidth','1px');
//	container.appendChild(rect1);
//console.log(rect1)
        return rect1;
    }

// ビジーwaitを使う方法
function sleep(waitMsec) {
  var startMsec = new Date();
 
  // 指定ミリ秒間だけループさせる（CPUは常にビジー状態）
  while (new Date() - startMsec < waitMsec);
}

function escapeHtml(convertString) {
    if (typeof convertString !== 'string') return convertString;
 
    var patterns = {
        '<'  : '&lt;',
        '>'  : '&gt;',
        '&'  : '&amp;',
        '"'  : '&quot;',
        '\'' : '&#x27;',
        '`'  : '&#x60;'
    };
 
    return convertString.replace(/[<>&"'`]/g, function(match) {
        return patterns[match];
    });
};
function unescapeHtml(target) {
    if (typeof target !== 'string') return target;
 
    var patterns = {
        '&lt;'   : '<',
        '&gt;'   : '>',
        '&amp;'  : '&',
        '&quot;' : '"',
        '&#x27;' : '\'',
        '&#x60;' : '`'
    };
 
    return target.replace(/&(lt|gt|amp|quot|#x27|#x60);/g, function(match) {
        return patterns[match];
    });
};

function cutescape(target) {
    if (typeof target !== 'string') return target;

    return target.replace(/[|<|>|&|(/)|"|'|`|\|,|]/g,' ');
   }; 

function omit_escape(target) {
    if (typeof target !== 'string') return target;

    return target.replace(/[|<|>|&|(/)|"|'|`|\|,|]/g,' ');
   };
/*
function catmullRom2bezier(pts){
    var cubics = [];
    for ( var i = 0, iLen = pts.length; i < iLen ; i++ ){
        var p = [
            pts[i - 1],
            pts[i],
            pts[i + 1],
            pts[i + 2]
        ];
        if( i === 0 ){
            p[0] = {
                x: pts[ 0 ].x,
                y: pts[ 0 ].y
            }
        }
        if( i === iLen - 2 ){
            p[3] = {
                x: pts[iLen - 2].x,
                y: pts[iLen - 2].y
            };
        }
        if ( i === iLen - 1 ) {
            p[2] = {
                x: pts[iLen - 1].x, 
                y: pts[iLen - 1].y
            };
            p[3] = {
                x: pts[iLen - 1].x, 
                y: pts[iLen - 1].y
            };
        }
      const val = 6;
        cubics.push([
            (-p[0].x + val * p[1].x + p[2].x) / val,
            (-p[0].y + val * p[1].y + p[2].y) / val,
            (p[1].x + val * p[2].x - p[3].x) / val,
            (p[1].y + val * p[2].y - p[3].y) / val,
            p[2].x,
            p[2].y
        ]);
    }
    return cubics;
}
*/


function splitArray(array, part) {
    var tmp = [];
    for(var i = 0; i < array.length; i += part) {
        tmp.push(array.slice(i, i + part));
    }
    return tmp;
}

var Inter_Line = function(line1, line2) {
    var x0 = Number(line1.start.x),
        y0 = Number(line1.start.y),
        x1 = Number(line1.end.x),
        y1 = Number(line1.end.y),
        x2 = Number(line2.start.x),
        y2 = Number(line2.start.y),
        x3 = Number(line2.end.x),
        y3 = Number(line2.end.y);
//console.log(line1,line2);
    var at = (x1-x0)*(y3-y2)-(x3-x2)*(y1-y0),
        as = -(y1-y0)*(x3-x2)+(y3-y2)*(x1-x0);

console.log(' at,as=',at,as);
	if (at==0 || as==0) return false;
//	if(Math.abs(at)<0.001) at=0.01;
//	if(Math.abs(as)<0.001) as=0.01;
 
    var t = ((x2-x0)*(y3-y2)-(y2-y0)*(x3-x2))/at,
        s = ((x2-x0)*(y1-y0)-(y2-y0)*(x1-x0))/as;

    var x = x0+(x1-x0)*t,
        y = y0+(y1-y0)*t;
 
    return { x : x, y : y };
};

/*
    image_sel.onclick = function(){
	Svg_mode="Text_drag";
console.log("Enter Image_Select_start　Editmode=",Editmode,' Svg_mode=',Svg_mode);
	document.oncontextmenu = function () {return false;}  //contextmenu 表示の禁止
//	document.oncontextmenu = function () {return true;}  //contextmenu 表示の禁止解除
    }
*/

    fig_sel_st.onclick = function(){
	prev_Draw_mode=Draw_mode;
	pre_Svg_mode=Svg_mode;
	Draw_mode="";
	Svg_mode="Svg_drag";
	control.value="none";

	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
	if(draw_op.target) {
		container.removeChild(draw_op.target);
		draw_op.target=null;
		}

//	change_css("Svg");
//	stop(false,false);
//	finish();
console.log("Enter fig_sel start　SVG_mode=",Svg_mode,'Draw_mode=',Draw_mode);
	document.oncontextmenu = function () {return false;}  //contextmenu 表示の禁止
//	document.oncontextmenu = function () {return true;}  //contextmenu 表示の禁止解除
//alert('fig_sel start');
    }

    fig_sel_end.onclick = function(){
console.log('enter sel end Svg_mode=',Svg_mode);
	if((Svg_mode=="Svg_drag")||(Svg_mode=="Svg_drag_pending")||(Svg_mode=="Svg_reshape")||(Svg_mode=="Svg_reshape_pending")
		||(Svg_mode=="Svg_scale")||(Svg_mode=="Svg_scale_pending")||(Svg_mode=="Draw"))
	{
//		quit_drag_elem();
		}
		quit_drag_elem();
		if(svgtext_dialog) $('#text_draw').dialog("close");

//Quit draw
	var tagnn=container;
	var fig_grp=tagnn.getAttribute('fig');
	if( fig_grp=='top'){
		var len=tagnn.childElementCount;
		for(var k=len-1; k>=0 ;k--) {
			var childtag=tagnn.children[k];
//console.log('nodeName=',childtag.nodeName);
			if(childtag.nodeName!='g') {
//console.log('deleted nodeName=',childtag.nodeName);
				tagnn.removeChild(childtag);
				}
			}
		}

    Step=0;
    //container.addEventListener( 'mousedown', draw_down,false);
    //container.addEventListener('mouseup', draw_up,false);
    drag.target=null;
    document.getElementById('contextmenu_a').style.display="none";

//    Svg_mode=pre_Svg_mode;
//    Draw_mode=prev_Draw_mode;
    Svg_mode="Svg_drag";
    Draw_mode="";
    Move_mode=0;
    temp_snap_flag=0;
console.log('mode Reset Svg_mode=',Svg_mode,' Draw_mde=',Draw_mode);
    } //End of fig_sel_end

function quit_drag_elem(){
console.log('enter to quit drag_element');
	var all_temps=document.querySelectorAll('temp');
console.log('all temps=',all_temps);
           //SVG 補助図形の削除
console.log('g_list=',g_list);
		if(g_list) {
			gtemp_delete(g_list);
			cont_a_degroup();
			g_list=null;
//			g_list.remove();
			tempo_group=0;
			}

		if(Drag_elem) {
console.log('SVG　Quitモード tag= ',Drag_elem,'len=',Drag_elem.children.length);
			len=Drag_elem.children.length;
			//firstChildを残して補助用として追加した要素を削除する

			for(var k=len-1;k>=0;k--){
				var tagn=Drag_elem.children[k];
console.log('k= ',k,tagn);
				var fig=tagn.getAttribute('fig');
				if(fig=='temp' || fig=='text_conv') {
console.log('delete temp tag k= ',k,tagn);
					Drag_elem.removeChild(tagn);
					}
				Drag_elem.setAttribute('class', 'none');
				}


			if(Svg_mode=="Svg_drag_pending") {
//onmousemoveを無効にする
	    			document.documentElement.setAttributeNS(null, "onmousemove",null)
				}
    			Drag_elem.removeEventListener('click', elem_callback ,false);
    			Drag_elem.removeEventListener('click', scale_callback ,false);
    			Drag_elem=null;
			}
	text_To_path=0;
   }

function gtemp_delete(elem) {
	if(elem) {
//console.log('elem= ',elem,'len=',elem.children.length);
		var len=elem.children.length;
		//firstChildを残して補助用として追加した要素を削除する
		for(var k=0;k<len;k++){
//console.log('del temp=',k,len,elem.children[k]);
			temp_delete(elem.children[k]);
			}
		}
	}

function temp_delete(elem) {
	if(elem) {
//console.log('elem= ',elem,'len=',elem.children.length);
		len=elem.children.length;
		//firstChildを残して補助用として追加した要素を削除する
		for(var k=len-1;k>0;k--){
			var tagn=elem.children[k];
//console.log('k= ',k,tagn);
			var fig=tagn.getAttribute('fig');
			if(fig=='temp') {
				elem.removeChild(tagn);
				}
			}
		if(bezier_line){
			bezier_line=null;
			}
		}
	}
function temp_fixed(elem) {
	if(elem) {
//console.log('elem= ',elem,'len=',elem.children.length);
		len=elem.children.length;
		//firstChildを残して補助用として追加した要素を削除する
		for(var k=len-1;k>0;k--){
			var tagn=elem.children[k];
//console.log('k= ',k,tagn);
			var fig=tagn.getAttribute('fig');
			if(fig=='temp') {
				tagn.setAttribute('fig','fixed');
				tagn.removeAttribute('id');
				}
			}
		if(bezier_line){
			bezier_line=null;
			}
		}
	}

function temp_snap_fix() {
console.log('snap fix called');
	var {group,fig_id}=make_group('fixed');
	var rects=container.querySelectorAll('rect');
	var lines=container.querySelectorAll('line');

	if(drawingPath) {
		var paths=drawingPath.cloneNode(true);
		group.appendChild(paths);
		}
/*
	var lines=container.querySelectorAll('line');
	if(lines) {
console.log('line cloneed');
		var dm_lines=lines.cloneNode(true);
		group.appendChild(dm_lines);
		}
*/
	if(first_point) {
		var dm_points=first_point.cloneNode(true);
		group.appendChild(dm_points);
		}

	if(bezier_line) {
		var bez=bezier_line.cloneNode(true);
		group.appendChild(bez);
		}
	if(bezier_line1) {
		var bez1=bezier_line1.cloneNode(true);
		group.appendChild(bez1);
		}
	var randx = String(Math.floor( Math.random() * 45 ) + 5);   //最大値50から最小値5を引いた「45」を使う
	var randy = String(Math.floor( Math.random() * 45 ) + 5);
	group.setAttribute("transform", "translate("+randx+","+randy+")");
	

console.log('path=',paths,'rect=',rects,'line=',lines);
	}

    fig_reshape.onclick = function(){
//	document.getElementById("fig_sel_end").click();
	prev_Draw_mode=Draw_mode;
	pre_Svg_mode=Svg_mode;
	Draw_mode="";
	Svg_mode="Svg_reshape";
	document.oncontextmenu = function () {return false;}  //contextmenu 表示の禁止
//	document.oncontextmenu = function () {return true;}  //contextmenu 表示の禁止解除
console.log('reshape figure=',Drag_elem)
	if(!Drag_elem) {
alert('figure not selected');
		return;
		}
//	var off_tag='#'+Drag_elem.getAttribute('id');
//	var drag_pos=$(off_tag).offset();
//console.log('Reshape fig posXY=',drag_pos,drag_pos.left,drag_pos.top);
// 要素の位置座標を取得
//	var clientRect = Drag_elem.getBoundingClientRect() ;
//console.log('Reshape clientposXY=',clientRect,clientRect.left,clientRect.top);
//console.log('Scroll valueXY=',window.pageXOffset,window.pageYOffset);
	var f_check=check_fig_pos(Drag_elem);
	if(f_check) {
alert('figure is out of range');
		return;
		}
	window.scrollTo(0,off_page.top);

	temp_delete(Drag_elem);
	drag.s_para=Drag_elem.getAttribute('smooth');
	drag.c_para=Drag_elem.getAttribute('close');
	error=reshape_figure(Drag_elem);
	if(error==1) {

		Svg_mode='Svg_reshape_pending';
		//var reshape = document.getElementById(fig_id)
		Drag_elem.addEventListener('click',elem_callback,false);
		}
	else {
		Svg_mode="";
alert('this figure can not reshape');
		}
console.log("Enter Figure Reshape End Mode Svg_mode=",Svg_mode);
    }

function check_fig_pos(elem) {
	error=0;
console.log('scrollXY=',window.pageXOffset,window.pageYOffset);
console.log('Svg area offsetXY=',off_page.left,off_page.top);

	var clientRect = elem.getBoundingClientRect();
console.log('Reshape clientposXY=',clientRect,clientRect.right,clientRect.bottom);
	var x_pos=window.pageXOffset+clientRect.right;
	var y_pos=window.pageYOffset+clientRect.bottom;
	var x_off=x_pos-(org_window_w-20);
	var y_off=y_pos-(off_page.top-20)-(org_window_h-30);
console.log('max_posXY=',x_pos,y_pos,'offsetXY=',x_off,y_off);
/*
	first_point=createFirstPoint([{x:20,y:20}]);
	Object.assign(first_point.style, defaultPointStyle);
        container.appendChild(first_point);

	first_point=createFirstPoint([{x:x_pos,y:y_pos-(off_page.top-20)}]);
	Object.assign(first_point.style, defaultPointStyle);
        container.appendChild(first_point);
*/
	if(x_off>0 || y_off>0) error=1;
	return error;
	}

var fig_scale_witch;

    fig_scale.onclick = function(){
	fig_scale_witch="scale";
	fig_scale_rotate();
    }

    fig_rotate.onclick = function(){
	fig_scale_witch="rotate";
	fig_scale_rotate();
    }

    function fig_scale_rotate() {
	prev_Draw_mode=Draw_mode;
	pre_Svg_mode=Svg_mode;
	Draw_mode="";
	Svg_mode="Svg_scale";
//	document.getElementById("fig_sel_end").click();
	document.oncontextmenu = function () {return false;}  //contextmenu 表示の禁止
//	document.oncontextmenu = function () {return true;}  //contextmenu 表示の禁止解除
	if(!Drag_elem) {
alert('figure not selected');
		return;
		}
console.log("Scale figure=",Drag_elem);
	var f_check=check_fig_pos(Drag_elem);
	if(f_check) {
alert('figure is out of range');
		return;
		}
	window.scrollTo(0,off_page.top);

	catch_scale_fig(Drag_elem);
	//矩形の描画とDraggerbleの設定
	//createRectFig(x,y,w,h)
	//Drag_elem = document.getElementById(fig_id);
	Svg_mode='Svg_scale_pending';
	Drag_elem.addEventListener('click',scale_callback,false);
    }

/*
document.onmouseup = function () {
console.log('** element drag stop');
	drag.isMouseDown = false;
}
document.onmousemove = function( e ) {
console.log('** element drag moving');
        if (drag.isMouseDown == true) {
		var exx=e.clientX;
		var eyy=e.clientY;
		if(conv_cord) {
			exx=exx-off_indivx;
			eyy=eyy-off_indivy;
			}
		drag.target.transform.baseVal[0].matrix.e=drag.target.transform.baseVal[0].matrix.e+exx - drag.offsetx;
		drag.target.transform.baseVal[0].matrix.f=drag.target.transform.baseVal[0].matrix.f+eyy - drag.offsety;
		drag.offsetx = exx; 
		drag.offsety = eyy; 
	}
}
*/
function draggable( element ) {
console.log('** draggable enter element=',element);
	//if(conv_cord) element=container.element;
	drag.target=element;

	element.addEventListener('mousedown', function( e ) {
console.log('** element drag start Svg_mode=',Svg_mode,'Draw_mode=',Draw_mode);
//		Draw_mode='Aux';
//		e.stopPropagation();
		e.preventDefault();
		var transform = element.getAttributeNS(null, "transform");
		if(transform==null) {
			element.setAttributeNS(null,'transform', 'translate(0,0)');
			}
    		drag.offsetx = e.clientX; 
    		drag.offsety = e.clientY; 
		if(conv_cord) {
console.log('convert indiv',drag.offsetx,drag.offsety,off_indivx,off_indivy);
			drag.offsetx=drag.offsetx-off_indivx;
			drag.offsety=drag.offsety-off_indivy;
			}
//console.log('trans_matrix=',element.transform.baseVal[0].matrix);
		drag.isMouseDown = true;
		return false;
	});
}

function draggableB( element ) {
console.log('** draggable enter element=',element);
	//if(conv_cord) element=container.element;
	drag.target=element;

	element.addEventListener('mousedown', function( e ) {
console.log('** element drag start');
//		Draw_mode='Aux';
//		e.stopPropagation();
//		e.preventDefault();
		var transform = element.getAttributeNS(null, "transform");
		if(transform==null) {
			element.setAttributeNS(null,'transform', 'translate(0,0)');
			}
    		drag.offsetx = e.clientX; 
    		drag.offsety = e.clientY; 
//console.log('trans_matrix=',element.transform.baseVal[0].matrix);
		drag.isMouseDown = true;
		return false;
	});
}


//   $("#image_db").on("click", function(){
function db_image(){
console.log('***image_db');
// db_serv/get_mylist/を使うことでuploadした日付け順（最新日付け）のdownloadが出来る
//	My_editorwind=window.open('/db_serv/image_down/', null, 'top=100,left=200,width=400,height=500');
	My_editorwind=window.open('/db_serv/get_mylist/', null, 'top=100,left=200,width=400,height=500');

	if( My_editorwind ) {
console.log('open My_editorwind');
		}
	else {
alert('Cloud not open window！');
		  My_editorwind.close();
		}
}

//My_editorwindがclose後に呼ばれる
function after_close_pop(param) {
console.log('***Return from My_editorwind param=',param);
	if(param=='error'){
		alert('image not selected');
		return
		}
	if(My_editorwind) My_editorwind.close();
	image_first_set(param);
}

function createhttprequest(){
	var request=null;

	if("XMLHttpRequest" in window){
		request= new XMLHttpRequest();
		}
	else if("ActiveXObject" in window){
		try{
		request=new ActiveXobject("Msxml2.XMLHTTP");
			}catch(e){
				try{
				request=new ActiveXObject("Microsoft.XMLHTTP");
					}catch(e){}
				}
		}
	return request;
	}

var html_responseText;

function sorceget(){
	html_responseText='';
	if (request.readyState == 4 && request.status == 200){
//		document.form1.sorce.value=request.responseText;
//console.log(request.responseText);
		html_responseText=request.responseText;
		}
	else {
alert('request Error');
		}
	}

function requestsource(url){
	request=createhttprequest();
	request.open("GET",url,true);
	request.onreadystatechange=sorceget();
	request.send(null);
	}

function import_mode(){

    switch (Imp.selectedIndex){
      case 0:               
		break;
      case 1:               
console.log('from Net selected');
    var newNode =document.createElement('a');
    var user = window.prompt("link先を入力してください", "");
console.log(user);
	requestsource(user);
console.log('got_html=',html_responseText);

//    newNode.href = user;
//    newNode.innerHTML = sel.toString();   //tag部分に<>を含むと変更出来ない。
		break;
      case 2:               
console.log('from File selected');
		document.getElementById("svgfile").click();
		//read_svg_file();
		break;
      case 3:               
console.log('from .html selected');
		document.getElementById("htmlfile").click();
/*
	$(function(){
	  $("#wClone").load("header.html");
	});
*/
		break;
      case 4:               
console.log('from me selected');
	len=first_container.childNodes.length;
console.log('child_len=',len,first_container);
	var dlist=first_container.querySelectorAll('svg');
console.log('svg tag numbers=',dlist.length);
	dlist.forEach(function (element) {
		element.setAttribute('style','display;block');
console.log(element);
		});
		break;
	}
   }

function doc_read() {
	document.getElementById("").click();
	}

var temp_snap_flag=0;

function Utility(){

    switch (Util.selectedIndex){
      case 0:               
		break;
      case 1:               
console.log('from icon_gen selected');
		document.getElementById("icon_gen").click();
		break;
      case 2:               
//Drag elemをCopyする
//    		document.getElementById("fig_copy").click();
		fig_copy();
console.log('for Fix Copy Drag elem=',Drag_elem);
		temp_fixed(Drag_elem);
		Drag_elem.copy='';
		document.getElementById("fig_sel_end").click();
		break;
      case 3:
console.log('snap fix set');
		temp_snap_flag=1;
		break;
      case 4:               
console.log('from basic selected');
	if(for_cloud=='yes') {
		alert('basic is under construction');
		return;
		}
		document.getElementById("basic_fig").click();
		break;
      case 5:
console.log('from sys_parms selected');
	if(for_cloud=='yes') {
		alert('sys_parms is under construction');
		return;
		}
		document.getElementById("sys_parms").click();
		break;
      case 6:
console.log('from basic2 selected');
		alert('baisc2 is under construction');
		break;
//      case 7:
//console.log('Mail to selected');
//		alert('Mail_To is under construction');
//		break;
	}
   }             

function Utility2(){
    switch (Util2.selectedIndex){
      case 0:               
		break;
      case 1:               
//rotate with degree
		rotate_with_degree();
		break;
      case 2:
//scale with scale
		scale_with_scale();
		break;
      case 3:
	if(for_cloud=='yes') {
		alert('basic is under construction');
		return;
		}
		document.getElementById("check_anime").click();
		break;
	}
   }             


function edit_Utility(){

    switch (edit_Util.selectedIndex){
      case 0:               
		break;
      case 1:               
		document.getElementById("Cr_to_Br").click();
		break;
      case 2:
		document.getElementById("Br_to_Cr").click();
		break;
      case 3:               
		document.getElementById("Spec_chars").click();
		break;
      case 4:               
		document.getElementById("Google_chars").click();
		break;
      case 5:               
		document.getElementById("link").click();
		break;
      case 6:
console.log('from basic1 selected');
	if(for_cloud=='yes') {
		alert('basic is under construction');
		return;
		}
		document.getElementById("sys_parms").click();
		break;
      case 7:
console.log('from basic1 selected');
	if(for_cloud=='yes') {
		alert('basic is under construction');
		return;
		}
		document.getElementById("repair_recipe").click();
		break;
	}
   }             

</script>
<!-- //
//Context menuに関する部分
//    -->
  <div id="contextmenu_a">
    <ul>
      <li onClick="cont_a_redraw()"  class="contex">再描画</li>
      <li onClick="cont_a_group()"  class="contex">group化</li>
      <li onClick="cont_a_degroup()"  class="contex">group解除</li>
      <li onClick="cont_a_svgpaste()"  class="contex">paste</li>
      <li onClick="cont_a_svgcopy()"  class="contex">Copy</li>
      <li onClick="cont_a_animate()"  class="contex">Animation</li>
      <li onClick="cont_a_svgdel()"  class="contex">削除</li>
      <li onClick="cont_a_cancel()"  class="contex">cancel</li>
    </ul>
  </div>
  <div id="contextmenu_c">
    <ul>
      <li onClick="cont_c_fromlocal()"  class="contex">from local</li>
      <li onClick="cont_c_frommynote()"  class="contex">from My_Note</li>
      <li onClick="cont_c_cancel()"  class="contex">cancel</li>
    </ul>
  </div>
  <div id="contextmenu_d" style="display:none;">
    <ul>
      <li onClick="cont_d_copy()"  class="contex">copy</li>
      <li onClick="cont_d_paste()"  class="contex">paste</li>
      <li onClick="enter_to_insvg()"  class="contex">svg_indiv</li>
      <li onClick="cont_d_cancel()"  class="contex">cancel</li>
    </ul>
  </div>
  <div id="contextmenu_e" style="display:none;">
    <ul>
      <li onClick="cont_e_table_menu1()"  class="contex">件数追加</li>
      <li onClick="cont_e_table_menu2()"  class="contex">列数(表題)追加</li>
      <li onClick="cont_e_table_menu3()"  class="contex">セル結合</li>
      <li onClick="cont_e_table_menu4()"  class="contex">セル分解</li>
      <li onClick="cont_e_cancel()"  class="contex">cancel</li>
    </ul>
  </div>
<script class="minify" id="smain_04">
var trim_smooth='';
function cont_a_redraw(){
	S_line_Trim=0;
	var trim=document.getElementById("Ftrim").checked;
	if(trim==true){
		S_line_Trim=Number(document.getElementById( "Trim_R" ).value);
		trim_smooth="trim "+String(S_line_Trim);
		}
	var tagn=Drag_elem;
	re_draw(tagn);
	document.getElementById('contextmenu_a').style.display="none";
	}
function re_draw(tagn) {
console.log('redraw group=',tagn);
	var ftype=tagn.getAttribute('fig');
	if(ftype=='group_group' || ftype=='hybrid' || ftype=='hy_group' || tagn.nodeName=='g') {
		ftype=tagn.getAttribute('stroke');
		if(ftype) tagn.removeAttribute('stroke');
		ftype=tagn.getAttribute('stroke-width');
		if(ftype) tagn.removeAttribute('stroke-width');
		ftype=tagn.getAttribute('fill');
		if(ftype) tagn.removeAttribute('fill');
		ftype=tagn.getAttribute('style');
		if(ftype) tagn.removeAttribute('style');
		var childs=tagn.children;
console.log('childs=',childs);
		for(let i=0;i<childs.length;i++) {
			var itype=childs[i].getAttribute('fig');
console.log('child fig=',itype,childs[i].nodeName);
			if(itype=='group_group' || ftype=='hybrid' || ftype=='hy_group' || childs[i].nodeName=='g') re_draw(childs[i]);
			else if(itype=='path' || childs[i].nodeName=='path') {
console.log('redraw path=',childs[i]);
				remake_group(childs[i],childs[i],defaultArrowStyle);
				}
			else if(itype=='text') {
console.log('redraw text=',childs[i]);
				font.title=decompose_text(childs[i]);
				compose_text(font.title,childs[i]);
				}
			}
		}
	else if(ftype=='path' || tagn.nodeName=='path') {
console.log('redraw path=',tagn);
		//if(trim_smooth) re_draw_trim(tagn,tagn.firstChild);
		remake_group(tagn,tagn,defaultArrowStyle);
		}
	else if(ftype=='text') {
console.log('redraw text=',tagn);
			font.title=decompose_text(tagn);
			compose_text(font.title,tagn);
		}
   }

function cont_a_group(){
	if(!g_list) return;
	gtemp_delete(g_list);
//	var new_group=container.appendChild(g_list.cloneNode(true));
	var new_group=g_list;
//	getrect_shape(new_group);
	g_list=null;
console.log('*****grouping Enter glist=',g_list,new_group);
	
	tempo_group=0;
	document.getElementById('contextmenu_a').style.display="none";
   }

function cont_a_degroup(){
console.log('*****reset grouping Enter catch=',Drag_elem);
	var leng=Drag_elem.children.length;
	var fig=Drag_elem.getAttribute('fig')

	var fig_num=Number(Date.now());

	if(fig=='group_group' || fig=='hy_group') {
console.log('catch fig_group=',fig);
		num_par_trans=Drag_elem.transform.baseVal.numberOfItems;
		for(let i=0;i<leng;i++) {
			var tagn=Drag_elem.children[i];
			if(tagn.nodeName!='rect') {
				var chil_n=container.appendChild(tagn.cloneNode(true));
				var num_chil_trans=chil_n.transform.baseVal.numberOfItems;
				if(!num_chil_trans) {
					chil_n.setAttribute("transform", "translate(0,0)");
					}
				for(let j=0;j<num_par_trans;j++) {
					chil_n.transform.baseVal.appendItem(Drag_elem.transform.baseVal[j]);
					}
				fig_num=fig_num+1;
				var fig_id='g'+fig_num.toString();
				chil_n.setAttribute('id',fig_id);
console.log('chil_n=',i,chil_n);
				}
			}
		Drag_elem.remove();
		}
/*
var add_transf="";
			if(tag.transform.baseVal.numberOfItems>0) add_transf=tag.getAttributeNS(null, "transform");
			var transf=old_transf+add_transf;
			tag.setAttribute("transform",transf);
*/

	drag.target=null;
	drag.group=null;
	Svg_mode=="";

	document.getElementById('contextmenu_a').style.display="none";
   }

/*
function cont_a_degroup(){
console.log('*****reset grouping Enter catch=',Drag_elem);
	var leng=Drag_elem.children.length;
	var fig=Drag_elem.getAttribute('fig')

	var fig_num=Number(Date.now());

	if(fig=='group_group') {
console.log('catch group_group');
		num_par_trans=Drag_elem.transform.baseVal.numberOfItems;
		for(let i=0;i<leng;i++) {
			var tagn=Drag_elem.children[i];
			if(tagn.nodeName!='rect') {
				var chil_n=container.appendChild(tagn.cloneNode(true));
				var num_chil_trans=chil_n.transform.baseVal.numberOfItems;
				if(!num_chil_trans) {
					chil_n.setAttribute("transform", "translate(0,0)");
					}
				for(let j=0;j<num_par_trans;j++) {
					chil_n.transform.baseVal.appendItem(Drag_elem.transform.baseVal[j]);
					}
				fig_num=fig_num+1;
				var fig_id='g'+fig_num.toString();
				chil_n.setAttribute('id',fig_id);
console.log('child_n=',i,chil_n);
				}
			}
		Drag_elem.remove();
		}

	drag.target=null;
	drag.group=null;
	Svg_mode=="";

	document.getElementById('contextmenu_a').style.display="none";
   }
*/
function cont_a_svgdel(){
console.log('Enter to delete area catch tags=',g_list);

	if(g_list) {
		g_list.remove();
		tempo_group=0;
		}

	if(Drag_elem) {
		Drag_elem.remove();
		Drag_elem='';
		}
	drag.target=null;
	drag.group=null;
	Svg_mode=="";

	document.getElementById("fig_sel_end").click();
	document.getElementById('contextmenu_a').style.display="none";
   }
function cont_a_cancel(){
	document.getElementById('contextmenu_a').style.display="none";
	return;
   }

function cont_a_svgpaste(){
//	alert('Not implement');

 navigator.permissions.query({ name: 'clipboard-read' }).then(result => {
            // If permission to read the clipboard is granted or if the user will
            // be prompted to allow it, we proceed.

            if (result.state === 'granted' || result.state === 'prompt') {
                navigator.clipboard.readText()
                    .then(text => {
console.log('clipbaard text=',text);
                        //my code to handle paste
			elem_from_clip(text);
                    })
                    .catch(err => {
                        console.error('Failed to read clipboard contents: ', err);
                    });
		}
	   });
/*
	if(navigator.clipboard){
    		navigator.clipboard.readText()
    		.then(function(text){
			setTimeout(function(){
    				elem_from_clip(text); }, 100);
    			});
		}
*/
/*
	var pasteArea = document.getElementById("area_To");
	if(navigator.clipboard){
    		navigator.clipboard.readText()
    		.then(function(text){
    	    		pasteArea.textContent = text;
    			});
		}
console.log('pasted=',pasteArea);
*/
	document.getElementById('contextmenu_a').style.display="none";
   }

function cont_a_svgcopy(){
//	alert('select Svg to Clipboard called');
console.log('copy Drag_elem=',Drag_elem);
	var group = Drag_elem.cloneNode(true);
	var fig_id='g'+(Date.now()).toString();
	group.setAttribute('id', fig_id);
	container.appendChild(group);
	del_add_fig(group);
	copyTextToClipboard(group.outerHTML);
	document.execCommand("copy");
	container.removeChild(group);
	already_copyed=1;

	document.getElementById('contextmenu_a').style.display="none";
   }

function cont_a_animate(){
//	alert('Amimation called');
	figure_anime();
	document.getElementById('contextmenu_a').style.display="none";
   }

function cont_c_fromlocal(){
//	alert('context c1 called');
	if(for_cloud=='yes') {
		alert('このデモでは出来ません。Not allowed in this version');
		return;
		}
	local_image();
	document.getElementById('contextmenu_c').style.display="none";
	return;
   }
function cont_c_frommynote(){
//	alert('context c2 called');
	db_image();
	document.getElementById('contextmenu_c').style.display="none";
	return;
   }
function cont_c_cancel(){
	document.getElementById('contextmenu_c').style.display="none";
	return;
   }

function cont_e_table_menu1(){
console.log('Enter to cont_e_menu1 called');
	var tabl_div=document.getElementById(catch_table);
	var tab_tag=tabl_div.firstChild;
console.log('catch table=',tabl_div,tab_tag);

    // 行を行末に追加
    var row = tab_tag.insertRow(-1);
    //列数を取得
    var cols = tab_tag.rows[0].cells.length;
    var styl=tab_tag.rows[0].cells[0].getAttribute('style');

    // 各列末尾にセルを追加
    for ( var i = 0; i < cols; i++) {
        var cell = row.insertCell(-1);
	cell.innerHTML='項追加';
	cell.setAttribute('style',styl);
	}
	document.getElementById('contextmenu_e').style.display="none";
	return;
   }

function cont_e_table_menu2(){
console.log('Enter to cont_e_menu2 called');
	var tabl_div=document.getElementById(catch_table);
	var tab_tag=tabl_div.firstChild;
console.log('catch table=',tabl_div,tab_tag);
   	// 行数取得
    	var rows = tab_tag.rows.length;
	var styl=tab_tag.rows[0].cells[0].getAttribute('style');
     
    // 各行末尾にセルを追加
    for ( var i = 0; i < rows; i++) {
//var th = document.createElement( 'th' );
//row.appendChild( th );
	var samp=tab_tag.rows[i].cells[0];
console.log('samp=',samp,samp.nodeName);
	if(samp.nodeName=='TH') {
		var th_n=document.createElement( 'th' );
		th_n.innerHTML="題追加";
		th_n.setAttribute('style',styl);
		tab_tag.rows[i].append(th_n);
		}
	else {
        	var cell = tab_tag.rows[i].insertCell(-1);
		cell.innerHTML='項追加';
		cell.setAttribute('style',styl);
		}
	}
	document.getElementById('contextmenu_e').style.display="none";
	return;
   }

/*
//列cellの合体（rowspan）のテスト OK
console.log('tbody=',tbody_tag);
console.log('rows=',tbody_tag.rows);
console.log('tr=',tbody_tag.rows[0].cells);
console.log('td=',tbody_tag.rows[0].cells[0]);
tbody_tag.rows[1].cells[1].setAttribute('rowspan','2');
tbody_tag.rows[2].cells[1].remove();
//行列の追加
var row = tabl_tag.insertRow( -1 );
//tabl_tag.appendChild(row);
var td = row.insertCell( -1 );
td.innerHTML='追加';
//row.appendChild(td);
var col = tabl_tag.insertCol( -1 );
//tabl_tag.appendChild(row);
var tr = col.insertCell( -1 );
tr.innerHTML='追加';
*/

function cont_e_table_menu3(){
//	alert('context e3 called');
console.log('Enter to cont_e_menu3 called');
	var tabl_div=document.getElementById(catch_table);
	var tab_tag=tabl_div.firstChild;
console.log('catch table=',tabl_div,tab_tag);

   	// 行数、列数の取得
    	var row_n = tab_tag.rows.length;
    	var col_n = tab_tag.rows[0].cells.length;
	var ky_bf;
	var ky_af;

	for(let k=col_n-1;k>=0;k--) {
		ky_bf=tab_tag.rows[0].cells[k];
		for(let i=0;i<row_n-1;i++) {
			ky_af=tab_tag.rows[i+1].cells[k];
console.log('next=',ky_af)
			if(ky_af==null) break;
			else {
console.log(i,ky_bf,ky_af);
				if(ky_bf.innerHTML==ky_af.innerHTML) {
					var span=ky_bf.getAttribute('rowspan');
console.log('span=',span);
					if(span==null) span=1;
					else span=Number(span);
					var span=String(span+1);
					ky_bf.setAttribute('rowspan',span);
					ky_af.remove();
					}
				else ky_bf=ky_af;
				}
			}
		}

	for(let k=0;k<row_n;k++) {
		ky_bf=tab_tag.rows[k].cells[0];
		for(let i=0;i<col_n-1;i++) {
			ky_af=ky_bf.nextSibling;
console.log('next=',ky_af)
			if(ky_af==null) break;
			else {
console.log(i,ky_bf,ky_af);
				var span_bf=ky_bf.getAttribute('rowspan');
				var span_af=ky_af.getAttribute('rowspan');
				if(ky_bf.innerHTML==ky_af.innerHTML && span_bf==span_af) {
					var span=ky_bf.getAttribute('colspan');
console.log('span=',span);
					if(span==null) span=1;
					else span=Number(span);
					var span=String(span+1);
					ky_bf.setAttribute('colspan',span);
					ky_af.remove();
					}
				else ky_bf=ky_af;
				}
			}
		}

	document.getElementById('contextmenu_e').style.display="none";
	return;
   }
function cont_e_table_menu4(){
//	alert('context e4 called');
console.log('Enter to cont_e_menu4 called');
	var tabl_div=document.getElementById(catch_table);
	var tab_tag=tabl_div.firstChild;
console.log('catch table=',tabl_div,tab_tag);

   	// 行数、列数の取得
    	var row_n = tab_tag.rows.length;
	var ky_bf;
	var ky_af;

	for(let k=0;k<row_n;k++) {
    		var col_n = tab_tag.rows[k].cells.length;
		for(let i=col_n-1;i>=0;i--) {
			ky_af=tab_tag.rows[k].cells[i];
			span=ky_af.getAttribute('colspan');
			if(span==null) ;
			else {
				span=Number(span);
				ky_af.removeAttribute('colspan');
				for(let j=0;j<span-1;j++) {
					var cln=ky_af.cloneNode(true);
					$(cln).insertAfter(ky_af);
					}
				}
			}
		}

console.log('firststep table=',tab_tag.innerHTML);
	col_n=tab_tag.rows[0].cells.length;
	for(let k=0;k<col_n;k++) {
		for(let i=0;i<row_n;i++) {
			ky_af=tab_tag.rows[i].cells[k];
			if(ky_af==null) break;
			span=ky_af.getAttribute('rowspan');
			ky_af.removeAttribute('rowspan');
//console.log('next=',ky_af,'span=',span,'k=',k);
			if(span==null) ;
			else {
				span=Number(span);
				for(let j=0;j<span-1;j++) {
					var cln=ky_af.cloneNode(true);
					i=i+1;
					if(k<col_n-1 && tab_tag.rows[i].cells[k]) {
//console.log('before=',tab_tag.rows[i].cells[k],'insert=',cln);
						$(tab_tag.rows[i].cells[k]).before(cln);
						}
					else {
//console.log('after=',tab_tag.rows[i].cells[k-1],'insert=',cln);
						$(tab_tag.rows[i].cells[k-1]).after(cln);
						}
					}
				}
			}
		}

	document.getElementById('contextmenu_e').style.display="none";
	return;
   }
function cont_e_cancel(){
//	alert('context e5 called');
console.log('Enter to cont_e_cancel called');

	document.getElementById('contextmenu_e').style.display="none";
	return;
   }

function elem_from_clip(text) {
console.log('text=',text);
　　		svgText = '<svg version="1.1" id="_x32_" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" style="width: 256px; height: 256px; opacity: 1;" xml:space="preserve">'
			  +text+'</svg>';
　　		const domParser = new DOMParser();
　　		const parsedSVGDoc = domParser.parseFromString(svgText, 'image/svg+xml');
　　		const parsedSVG = parsedSVGDoc.childNodes[0];
console.log('length=',parsedSVG.children.length,parsedSVG);
/*
    		var group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    		var fig_id='g'+(Date.now()).toString();
    		group.setAttribute('id', fig_id);
    		group.setAttribute('class', 'group');
    		container.appendChild(group);
*/
    		for (nn = 0; nn < parsedSVG.children.length; nn++) {
console.log('**nodename= ',parsedSVG.children[nn].nodeName,parsedSVG.children[nn]);
　　			var tagn=container.appendChild(parsedSVG.children[nn].cloneNode(true));
			var fig_id='g'+(Date.now()).toString();
			tagn.setAttribute('id', fig_id);
			tagn.setAttribute("transform", "translate(10,10)");
console.log('paste tag=',tagn);
			}
  　　  }

function del_add_fig(Drag_elem) {
           //SVG 補助図形の削除
		if(Drag_elem) {
//console.log('SVG　Quitモード tag= ',Drag_elem,'len=',Drag_elem.children.length);
			len=Drag_elem.children.length;
			//firstChildを残して補助用として追加した要素を削除する

			for(var k=len-1;k>0;k--){
				var tagn=Drag_elem.children[k];
//console.log('k= ',k,tagn);
				var fig=tagn.getAttribute('fig');
				if(fig=='temp') {
					Drag_elem.removeChild(tagn);
					}
				Drag_elem.setAttribute('class', 'none');
				}
		}
	}

function copyTextToClipboard(textVal){
  // テキストエリアを用意する
  var copyFrom = document.createElement("textarea");
  // テキストエリアへ値をセット
  copyFrom.textContent = textVal;
 
  // bodyタグの要素を取得
  var bodyElm = document.getElementsByTagName("body")[0];
  // 子要素にテキストエリアを配置
  bodyElm.appendChild(copyFrom);
 
  // テキストエリアの値を選択
  copyFrom.select();
  // コピーコマンド発行
  var retVal = document.execCommand('copy');
  // 追加テキストエリアを削除
  bodyElm.removeChild(copyFrom);
  // 処理結果を返却
  return retVal;
}
/*
      function menu1(){
        open( "https://www.google.com/", "_blank" ) ;
      }
      function menu2(){
        open( "https://www.yahoo.co.jp/", "_blank" ) ;
      }
      function menu3(){
        open( "https://www.amazon.co.jp/", "_blank" ) ;
      }
*/
// スクロール禁止
function no_scroll() {
    // PCでのスクロール禁止
    document.addEventListener("mousewheel", scroll_control, { passive: false });
    // スマホでのタッチ操作でのスクロール禁止
    document.addEventListener("touchmove", scroll_control, { passive: false });
　　document.body.style.overflow = "hidden";
    //var scr_bar = document.getElementById('texx');
    //scr_bar.style.overflow = "hidden";
    //scr_bar.setAttribute( 'style','overflow-y:hidden;');

}
// スクロール禁止解除
function return_scroll() {
    // PCでのスクロール禁止解除
    document.removeEventListener("mousewheel", scroll_control, { passive: false });
    // スマホでのタッチ操作でのスクロール禁止解除
    document.removeEventListener('touchmove', scroll_control, { passive: false });
    document.body.style.overflow = "auto";
    //var scr_bar = document.getElementById('texx');
    //scr_bar.style.overflow = "auto";
    //scr_bar.setAttribute( 'style','overflow-y:auto;');
}

// スクロール関連メソッド
function scroll_control(event) {
    event.preventDefault();
}
</script>
<!-- ポップアップウィンドウ用ベースHTML（テンプレート）Figure Animation -->
<div class="dialog" id="fig_anime" title="Animation">
  <div class="dialog-content">
	<div class="popwindow-content"></div>
	<label>animation type:</label>
   	<select id="anime_tp" onchange="animation_type()" style="width:180px; height:25px;" >
    		<option value="go_path" selected>go along the path</option>
    		<option value="one_stroke">one-stroke writing</option>
    		<option value="draw_hide">draw and hide</option>
    		<option value="deform">path deformation</option>
   	</select><br>
   	<button class="btn" id="get_anime_Path">getPath</button><label> id:<input type="text" id="animPath" style="width:150px;"></label><label>　&nbsp;</label><button id="p_disp_on" onclick="p_disp_onoff()" value='disp on' style="height:15px;">disp on</button><br>
	<label>anime時間:<input type="text" id="time_figanime" value="5" style="width:40px;"></label><label>s &nbsp;</label><label>begin:<input type="text" id="time_figbegin" value="0" style="width:40px;"></label><label>s &nbsp;</label><label>角度:<input type="text" id="path_angle" value="0" style="width:40px;"></label><br>
	<label>timing:<input type="text" id="key_time" value="0;1" style="width:200px;"></label><br>
	<label> value:<input type="text" id="key_value" value="0;1" style="width:200px;"></label>
	<label>position:
   	<select id="move_pos" onchange="moving_position()" style="width:60px; height:25px;" >
    		<option value="s000">top</option>
    		<option value="s001">center</option>
    		<option value="s002" selected>bottom</option>
   	</select></label>
	<label>pare:
   	<select id="pare_obj" onchange="pare_object()" style="width:60px; height:25px;" >
    		<option value="s000" selected>none</option>
    		<option value="s001">same</option>
    		<option value="s002">revers</option>
   	</select>
	</label>
	<label>&nbsp;</label><button class="btn" id="setset_animation">set anime</button><br>
	<br>
   	<button class="btn" id="start_anime">開始</button><label>&nbsp;　　　&nbsp;</label><button class="btn" id="to_mend_anime">mend Anime</button><label>　&nbsp;</label><button class="btn" id="add_more">add more</button>
  </div>
</div>
<div class="dialog" id="more_anime" title="add more">
  <div class="dialog-content">
	<div class="popwindow-content"></div>
	<label>add anime type:
   	<select id="more_tp" onchange="add_more_type()" style="width:180px; height:25px;" >
    		<option value="s000" selected>translate</option>
    		<option value="s001">rotate</option>
    		<option value="s002">gradation</option>
   	</select><br>
	<label>anime時間:<input type="text" id="time_more" value="5" style="width:40px;"></label><label>sec &nbsp;</label><label>begin時間:<input type="text" id="time_morebegin" value="0" style="width:40px;"></label><label>sec &nbsp;</label><br>
	<label>timing:<input type="text" id="more_key_time" value="0;1" style="width:200px;">
	<label> value:<input type="text" id="more_key_value" value="0;1" style="width:200px;"><br><br>
        <!-- button id="c_add_palt01" style="color:#fff;width:50px;height:25px;background-color:#ff0000;">ff0000</button> <button id="c_add_palt02" style="color:#fff;width:50px; height:25px;background-color:#ff8000;">ff8000</button>
<button id="c_add_palt03" style="color:#fff;width:50px; height:25px;background-color:#ffff00;">ffff00</button> <button id="c_add_palt04" style="color:#fff;width:50px; height:25px;background-color:#80ff00;">80ff00</button>
<button id="c_add_palt05" style="color:#fff;width:50px; height:25px;background-color:#00ff00;">00ff00</button> <button id="c_add_palt06" style="color:#fff;width:50px; height:25px;background-color:#00ff80;">00ff80</button><br>
        <button id="c_add_palt07" style="color:#fff;width:50px;height:25px;background-color:#00ffff;">00ffff</button> <button id="c_add_palt08" style="color:#fff;width:50px; height:25px;background-color:#0080ff;">0080ff</button>
<button id="c_add_palt09" style="color:#fff;width:50px; height:25px;background-color:#0000ff;">0000ff</button> <button id="c_add_palt10" style="color:#fff;width:50px; height:25px;background-color:#8000ff;">8000ff</button>
<button id="c_add_palt11" style="color:#fff;width:50px; height:25px;background-color:#ff00ff;">ff00ff</button> <button id="c_add_palt12" style="color:#fff;width:50px; height:25px;background-color:#ff0080;">ff0080</button><br>
<br -->
        <button id="c_add_palt01" style="color:#fff;width:55px;height:25px;background-color:#E60012;">E60012</button> <button id="c_add_palt02" style="color:#fff;width:55px; height:25px;background-color:#F39800;">F39800</button>
<button id="c_add_palt03" style="color:#fff;width:55px; height:25px;background-color:#FFF100;">FFF100</button> <button id="c_add_palt04" style="color:#fff;width:55px; height:25px;background-color:#8FC31F;">8FC31F</button>
<button id="c_add_palt05" style="color:#fff;width:55px; height:25px;background-color:#009944;">009944</button> <button id="c_add_palt06" style="color:#fff;width:55px; height:25px;background-color:#009E96;">009E96</button><br>
        <button id="c_add_palt07" style="color:#fff;width:55px;height:25px;background-color:#00A0E9;">00A0E9</button> <button id="c_add_palt08" style="color:#fff;width:55px; height:25px;background-color:#0068B7;">0068B7</button>
<button id="c_add_palt09" style="color:#fff;width:55px; height:25px;background-color:#1D2088;">1D2088</button> <button id="c_add_palt10" style="color:#fff;width:55px; height:25px;background-color:#920783;">920783</button>
<button id="c_add_palt11" style="color:#fff;width:55px; height:25px;background-color:#E4007F;">E4007F</button> <button id="c_add_palt12" style="color:#fff;width:55px; height:25px;background-color:#E5004F;">E5004F</button><br>
<br>
	<button class="btn" id="more_animation">set anime</button><br>
</div>
<div class="dialog" id="anime_mend" title="mend_Animation">
  <div class="dialog-content">
	<div class="popwindow-content"></div>
	  <label>animation type:&nbsp;</label><input type="text" id="mend_anime_type" value="" style="width:180px;" ><!-- label>Tag:&nbsp;</label><input type="text" id="anim_tag" value="" style="width:100px;" --><br>
	  <label>tags:&nbsp;</label><input type="text" id="anim_tag_max" value="" style="width:30px;" ><label>now:&nbsp;</label><input type="text" id="anim_tag_num" value="" style="width:30px;" >　<button class="btn" id="svg_tag_back"> ← </btn>&nbsp;<button class="btn" id="svg_tag_next"> → </button><br>
	<label>anime時間:<input type="text" id="mend_time_figanime" value="5" style="width:40px;"></label><label>sec &nbsp;</label><label>begin時間:<input type="text" id="mend_time_figbegin" value="0" style="width:40px;"></label><label>sec &nbsp;</label><br>
	<label>timing:<input type="text" id="mend_key_time" value="0;1" style="width:200px;"></label><br>
	<label> value:<input type="text" id="mend_key_value" value="0;1" style="width:200px;"></label><br>

   	<button class="btn" id="modify_parms">modify</button><label>&nbsp;</label><button class="btn" id="remove_one_anime">remove</button><label>&nbsp;</label><button class="btn" id="remove_all_anime">remove All</button>
  </div>
</div>
<script class="minify" id="smain_05">
var animation_dialog=0;
var subanimation_dialog=0;
var anime_type=0;
var more_anime_type=0;
var deform_path=[];
var deform_parms="";
var last_anime_node="";
var former_path_tag="";
var pare_revers=0;
var svg_edit_node="";
var svg_mend_tags="";
var select_mend_node=0;
var origin_select="";
var former_parent="";
var anime_fig_type="";
//var path_disp_on_off=1;

function figure_anime() {
console.log('***figure animation');
	var theDialog=$( '#fig_anime' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:300, width: 400,  position: {my: "right bottom", at: "right bottom", of: window}} );
	//ダイアログを表示する
	font.path='';
	font.old_elem=Drag_elem;
	origin_select=Drag_elem;
	document.getElementById('anime_tp').selectedIndex=0;
	var fig_ty=Drag_elem.getAttribute('fig');
	anime_fig_type=fig_ty;
	if(fig_ty=='anime' || fig_ty=='anime_top') {
		var now_tag=Drag_elem;
		last_anime_node=Drag_elem;
		document.getElementById("fig_sel_end").click();
		Drag_elem=now_tag.firstChild;
console.log('parent=',Drag_elem);
		former_path_tag=Drag_elem;
		font.old_elem=Drag_elem;
		font.path=Drag_elem.firstChild.getAttribute('id');
		document.getElementById('animPath').value=font.path;

console.log('path id=',font.path);
		var target=last_anime_node.querySelector('animate,animateMotion,animateTransform');
console.log('target=',target);
		if(target.nodeName=='animateMotion') document.getElementById('anime_tp').selectedIndex=0;
		else {
			var href=(target.getAttribute('xlink:href'));
			if(href){
				href=href.substr(0,2);
				if(href=='#p') document.getElementById('anime_tp').selectedIndex=1;
				if(href=='#q') document.getElementById('anime_tp').selectedIndex=2;
				}
			var xml=target.getAttribute('attributeType');
			if(xml=='XML') document.getElementById('anime_tp').selectedIndex=3;
			if(document.getElementById('anime_tp').selectedIndex==0) {
				font.path='';
				Drag_elem=origin_select;
				font.old_elem=Drag_elem;
				}
			}
		}
	animation_dialog=1;
	my_confirm_open(16);
	theDialog.dialog("open");
	}

   $('#fig_anime').on('dialogclose', function(event) {
console.log('Animation Dialog closed');
	document.getElementById("start_anime").click();
	document.getElementById("fig_sel_end").click();
	animation_dialog=0;
	my_confirm_close(16);
	});

to_mend_anime.onclick = function(){
	font.path='';
	Drag_elem=origin_select;
	font.old_elem=Drag_elem;
	anime_mend();
	}

function anime_mend() {
console.log('***mend figure animation');
	Drag_elem=origin_select;
	var mendDialog=$( '#anime_mend' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
	height:300, width: 400,  position: {my: "right bottom", at: "right bottom", of: window}} );
	//ダイアログを表示する
	mend_animation_dialog=1;
	svg_edit_node=Drag_elem;
console.log('svg_edit_node=',svg_edit_node);
//	var fig_ty=Drag_elem.getAttribute('fig');
//	if(fig_ty=='anime' || fig_ty=='anime_top') {
		svg_mend_tags=Drag_elem.querySelectorAll('animate,animateMotion,animateTransform');
console.log('animate tags=',svg_mend_tags);
		var mend_nums=svg_mend_tags.length;
		select_mend_node=0;
		document.getElementById('anim_tag_max').value=String(mend_nums);
		select_anime_tag();
	mendDialog.dialog("open");
	}

   $('#anime_mend').on('dialogclose', function(event) {
console.log('mend Animation Dialog closed');
	mend_animation_dialog=0;
	var rect=former_parent.querySelector('rect');
	if(rect) rect.remove();
	});
</script>
<!-- ポップアップウィンドウ用ベースHTML（テンプレート） -->
<div class="dialog" id="image_upload" title="写真をアップロード">
        <div class="card shadow rounded">
            <div class="card-header"></div>
            <div class="card-body" style="background-color:slategrey;">
		<div class="canvas-container text-center" style="vertical-align: middle;">
		<!-- img id="preview" width="200px" height="200px" -->
		<canvas id="preview" width="200px" height="200px"></canvas -->
		</div>
	    </div>
		<!-- ファイル選択ボタン -->
		<input type="file" id="myImage" accept="image/*">
		   <!-- form id="send_image" method="post" enctype="multipart/form-data">
            		{% csrf_token %}
                     <input class="form-control btn btn-default" type="file" name="from_client_file" id="myImage" accept="image/*"><br>
                    </form -->
        	<!-- form method="post" id="send_image" enctype="multipart/form-data">
            		{% csrf_token %}
            	<button type="submit">Upload</button>
        	</form -->
            <div class="text-center">
                <button id="getURLResult" value="認識" class="btn btn-primary">確認</button>
            </div>
        </div>
</div>
<script class="minify" id="smain_06">
//   $("#image_place").on("click", function(){
function local_image() {
console.log('***image_place');
	Draw_mode="";
	var theDialog=$( '#image_upload' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:380, width: 250,  position: {my: "right bottom", at: "right bottom", of: window}} );
	//ダイアログを表示する
	theDialog.dialog("open");
	}

var To_formfile;
var To_formname;
const THUMBNAIL_MAX_WIDTH = 300; // 画像がヨコ長の場合、横サイズがこの値になるように縮小される
const THUMBNAIL_MAX_HEIGHT = 300; // 画像がタテ長の場合、縦サイズがこの値になるように縮小される

$('#myImage').on('change', function (e) {
    var image = new Image();
    var reader = new FileReader();
    reader.onload = function (e) {
        //$("#preview").attr('src', e.target.result);
//image縮小の為の修正挿入（はじめ）
      image.onload = function() {

        // 縮小後のサイズを計算する
console.log('onload image=',image.width, image.height);
//console.log('image=',image.name,file.name);
        var width, height;
        if(image.width > image.height){
          // ヨコ長の画像は横サイズを定数にあわせる
          var ratio = image.height/image.width;
          width = THUMBNAIL_MAX_WIDTH;
          height = THUMBNAIL_MAX_WIDTH * ratio;
        } else {
          // タテ長の画像は縦のサイズを定数にあわせる
          var ratio = image.width/image.height;
          width = THUMBNAIL_MAX_HEIGHT * ratio;
          height = THUMBNAIL_MAX_HEIGHT;
        }
console.log('new size=',width,height,' ratio=',ratio);
        // 縮小画像を描画するcanvasのサイズを上で算出した値に変更する
        var canvas = $('#preview')
                     .attr('width', width)
                     .attr('height', height);

        var ctx = canvas[0].getContext('2d');

        // canvasに既に描画されている画像があればそれを消す
        ctx.clearRect(0,0,width,height);

        // canvasに縮小画像を描画する
        ctx.drawImage(image,
          0, 0, image.width, image.height,
          0, 0, width, height
        );

        // canvasから画像をbase64として取得する
        var base64 = canvas.get(0).toDataURL('image/jpeg');
	To_formfile=createJpegFile4Base64(base64,To_formname);
console.log('base64=',base64.length);
console.log('To_formfile=',To_formfile);
      }
      image.src = e.target.result;
console.log('get image=',image.src.length);
//image縮小の為の修正挿入（おわり）
    }
    reader.readAsDataURL(e.target.files[0]);
    To_formname=e.target.files[0].name;
console.log('file=',e.target.files[0],To_formname)
});

$('#getURLResult').on('click', function(){
console.log('*** Direct to server ***');

    var fd = new FormData();
//    var filetype = e.target.files[0].type;

//console.log(To_formfile);
    fd.append('photo', To_formfile);
//    fd.append('image_data', To_formfile);
console.log('file data=',fd);

        $.ajax({
            url: "/db_serv/imageupload/",
            type: "POST",
            data: fd,
            processData: false,
            contentType: false,
            dataType: 'json'
        })
        .done((data) => {
            //結果が帰ってきたら、表示します。
console.log('URL=',data);
	image_first_set(data.url);
	});
});  //End function getURLResult


//引数はbase64形式の文字列と作成するファイルオブジェクトのファイル名
var createJpegFile4Base64 = function (base64, name) {
    // base64のデコード
    var bin = atob(base64.replace(/^.*,/, ''));
    // バイナリデータ化
    var buffer = new Uint8Array(bin.length);
    for (var i = 0; i < bin.length; i++) {
        buffer[i] = bin.charCodeAt(i);
    }
    // ファイルオブジェクト生成(この例ではjpegファイル)
    return new File([buffer.buffer], name, {type: "image/jpeg"});
};

function getCookie(name) {
    var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
        	var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    	}
        	    }
    		}
    return cookieValue;
    }

var csrftoken = getCookie('csrftoken');

function csrfSafeMethod(method) {
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

$.ajaxSetup({
    beforeSend: function (xhr, settings) {
         if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
               xhr.setRequestHeader("X-CSRFToken", csrftoken);
               }
        }
    });

/*
html_outer.onclick= function() {
console.log('Copy Entered');

//	html_from_clipboard();
	text=get_all_text();
	document.getElementById("divsvg_00").innerHTML='';
	document.getElementById("divsvg_00").innerHTML=add_html_from_outer(text);
   }
*/

function get_all_text() {
	var html_str=document.getElementById("divsvg_00").innerHTML;
console.log('html_str=',html_str);
	return html_str;
    }

</script>

<!-- ポップアップウィンドウ用ベースHTML（テンプレート）SVG文字 -->
<div class="dialog" id="text_draw" title="SVG文字">
  <div class="dialog-content">
	<div class="popwindow-content"></div>
	<label>表示文字： <br><textarea id="text_title" cols="32" rows=5 maxlength="150" style="line-height: 1em"></textarea></label>
	<br>
	<label>font-size:<input type="text" id="font_size" value="20" style="width:60px;"></label><label>  縁取-size:<input type="text" id="stroke_wd" value="0" style="width:60px;"></label>
	<label>font-color:<input type="text" id="font_color" value="" style="width:60px;"></label><label>  縁取-color:<input type="text" id="fill_color" value="" style="width:60px;"></label>
	<br>
	<label>font-weight:
   	<select id="font_wt" onchange="font_weight()" style="width:80px; height:25px;" >
    		<option value="s000">normal</option>
    		<option value="s001" selected>bold</option>
    		<option value="s002">bolder</option>
		<option value="s003">lighter</option>
   	</select>
	<br>
        <label>rotate:<input type="text" id="svg_rotate" value="0" style="width:40px;"></label>
	<label>font-family:
   	<select id="font_fm" onchange="font_family()" style="width:100px; height:25px;" >
    		<option value="s000" selected>default</option>
    		<option value="s001">Noto+Sans+JP</option>
    		<option value="s002">Noto+Serif+JP</option>
		<option value="s003">Kaisei+Opti</option>
		<option value="s004">Reggae+One</option>
		<option value="s005">Kaushan+Script</option>
   	</select>
	</label>
	<br>
	<label>anchor:
   	<select id="anchor" onchange="set_anchor()" style="width:60px; height:25px;" >
    		<option value="s000">middle</option>
    		<option value="s001">start</option>
    		<option value="s002">end</option>
   	</select>
	</label>
	<br>
   	<button class="btn" id="set_text">OK</button>
  </div>
</div>
<script class="minify" id="smain_07">
var svgtext_dialog=0;
var font= {
	title:'',
	size:14,
	weight:'bold',
	stroke_wd:0,
	font:'sans-serif',
	rotate:0,
	anchor:'start',
	stroke:'',
	fill:'',
	path:'',
	old_elem:'',
	position:2,
	type:'startOffset',
	}

function text_dialog() {
	var theDialog=$( '#text_draw' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:300, width: 400,  position: {my: "right bottom", at: "right bottom", of: window}} );
	//ダイアログを表示する
	document.oncontextmenu = function () {return false;}  //contextmenu 表示の禁止
//	document.oncontextmenu = function () {return true;}  //contextmenu 表示の禁止解除
	
	font.old_elem=Drag_elem;
	var atex=decompose_text(Drag_elem);
	set_fonts(Drag_elem);
	document.getElementById('text_title').value=atex;
	document.getElementById('font_size').value=String(font.size);
	document.getElementById('stroke_wd').value=String(font.stroke_wd);
	document.getElementById('svg_rotate').value=String(font.rotate);
//	document.getElementById('textPath').value=font.path;
	document.getElementById('font_color').value=font.fill;
	document.getElementById('fill_color').value=font.stroke;
	svgtext_dialog=1;
	theDialog.dialog("open");
   }

   $('#text_draw').on('dialogclose', function(event) {
console.log('Svg_text Dialog closed');
	svgtext_dialog=0;
	});

    function set_fonts(tag) {
	var tagn=tag.querySelector('text');
	if(tagn) {
		font.anchor=tagn.getAttribute('text-anchor');
		font.size=tagn.getAttribute('font-size');
		font.font=tagn.getAttribute('font-family');
		font.stroke_wd=tagn.getAttribute('stroke-width');
		if(font.stroke_wd==null) font.stroke_wd="0";
		font.rotate=tagn.getAttribute('rotate');
		if(font.rotate==null) font.rotate="0";
		font.stroke=tagn.getAttribute('stroke');
		font.fill=tagn.getAttribute('fill');
		font.weight=tagn.getAttribute('font-weight');
		if(font.weight==null) font.weight='bold';
		}
	}

    function font_weight() {
//	let select = document.getElementById('font');
	let defaultweight;
    	//選択したfontによって分岐
console.log('font-weight selected num=',font_wt.selectedIndex);
    	switch (font_wt.selectedIndex){
      		case 0:               
			defaultweight="normal";
			break;
      		case 1:               
			defaultweight="bold";
			break;
      		case 2:               
			defaultweight="bolder";
			break;
      		case 3:               
			defaultweight="lighter";
			break;
		}
	font.weight=defaultweight;
	}

    function font_family() {
//	let select = document.getElementById('font');
	let defaultfont;
    	//選択したfontによって分岐
console.log('font-family selected num=',font_fm.selectedIndex);
    	switch (font_fm.selectedIndex){
      		case 0:               
			defaultfont="";
			break;
      		case 1:               
			defaultfont="Noto Sans JP";
			break;
      		case 2:               
			defaultfont="Noto Serif JP";
			break;
      		case 3:               
			defaultfont="Kaisei Opti";
			break;
      		case 4:               
			defaultfont="Reggae One";
			break;
      		case 5:
			defaultfont="Kaushan Script";
			break;
		}
	font.font=defaultfont;
	}

    function set_anchor() {
	let select = document.getElementById('anchor');
	let anchor;
    	//選択したfontによって分岐
    	switch (select.selectedIndex){
      		case 0:               
			anchor="middle";
			break;
      		case 1:               
			anchor="start";
			break;
      		case 2:               
			anchor="end";
			break;
		}
	font.anchor=anchor;
	}

    $(document).on('click', '#set_text', function(){
console.log('set_textが押されました');
	font.title=$("#text_title").val();
	var size=$("#font_size").val();
	font.stroke_wd=$("#stroke_wd").val();
	font.rotate=$("#svg_rotate").val();
	font.fill=$("#font_color").val();
	font.stroke=$("#font_fill").val();
	font.size=Math.min(150,Math.max(5,Math.round(Number(size)*10)/10));
	Drag_elem=font.old_elem;
	// 入力内容があった場合
	if(font.title != "" && font.title != null){
		compose_text(font.title,Drag_elem);
		}
//	if(font.path) {
//		set_animation();
//		}
//Dialogを強制的に消す
	if(svgtext_dialog) $('#text_draw').dialog("close");
	});

    function compose_text(atext,tagn) {
console.log('**compose_text atext,tagn ',atext,tagn);
	var txpath='';
	var text_tag='';
	for(i=0;i<tagn.children.length;i++) {
		if(tagn.children[i].nodeName=='text') {
			text_tag=tagn.children[i];
console.log('text_tag_0=',text_tag);
			if(text_tag.childNodes[0].nodeName=='textPath') {
				txpath=text_tag.children[0];
				text_tag=text_tag.children[0];
console.log('text_tag_1=',text_tag);
				}
			break;
			}
		}
console.log('text tag=',text_tag);
	if(text_tag) {
		clear_allchild(text_tag);

		var vtext=atext.split('<br>');
		text_tag.setAttributeNS(null,'gyou', String(vtext.length-1));
		for (let i = 0; i < vtext.length ; i++) {
			let tm_tex=vtext[i].replace("|<","|=|").replace(">|","|=|").split('|=|');
console.log('temp val=',tm_tex);
			}
/*
		textpathNode=txpath;
		if(font.path&&(!txpath)) {
			var textpathNode = document.createElementNS('http://www.w3.org/2000/svg', 'textPath');
			textpathNode.setAttributeNS(null,'href', '#'+font.path);
			textpathNode.setAttributeNS(null,'startOffset', '10%');		
console.log(textpathNode);
			my_anime.appendChild(textpathNode);
			}
*/
console.log('vtext=',vtext);
		var setsz=Math.min(80,Math.max(4,Math.round(Number(font.size)*12)/10));

		for (nn = 0; nn < vtext.length ; nn++) {
			if(vtext[nn]!=''){
				var newNode = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');
				newNode.innerHTML =  vtext[nn];
console.log('text_node=',newNode);
/*
				if(font.path) {
					newNode.setAttributeNS(null,'x', '0');
					newNode.setAttributeNS(null,'y', '0');		
					textpathNode.appendChild(newNode);
					}
*/
//				else {
					newNode.setAttributeNS(null,'x', '0');
					var yp=String(setsz*nn);
					newNode.setAttributeNS(null,'y', yp);		
    					text_tag.appendChild(newNode);
//					}
				}
			}
//	if(font.path) {
//		text_tag.appendChild(textpathNode);
//		}
console.log('Svg text size=',font.size,' font=',font.font,' weight=',font.weight);
		text_tag.setAttribute('font-size',font.size);
		if(font.font) {
			text_tag.setAttribute('font-family',font.font);
			}
		if(font.anchor) {
			text_tag.setAttribute('text-anchor',font.anchor);
			}
		if(font.weight) {
			text_tag.setAttribute('font-weight',font.weight);
			}
console.log('fill color default=',defaultCharStyle.fill,'font.fill=',font.fill);
		text_tag.setAttribute('fill',defaultCharStyle.fill);
//		text_tag.setAttribute('fill',defaultPathStyle.fill);
		if(font.fill) {
			text_tag.setAttribute('fill',font.fill);
			}
var att=text_tag.getAttribute('fill');
console.log('setted fill=',att);
//		text_tag.setAttribute('stroke',defaultCharStyle.stroke);
		text_tag.setAttribute('stroke',defaultPathStyle.stroke);
		if(font.stroke) {
			text_tag.setAttribute('stroke',font.stroke);
			}
		if(font.stroke_wd) {
			text_tag.setAttribute('stroke-width',String(font.stroke_wd));
			}
		if(font.rotate) {
			text_tag.setAttribute('rotate',String(font.rotate));
			}
		text_tag.setAttribute('paint-order','stroke');
		text_tag.setAttribute('stroke-linejoin','round');
		}
/*
	if(font.path) {
		let oya = text_tag.parentNode; // 親要素を取得
		oya.setAttribute("transform", "");
		var rect=Drag_elem.querySelector('rect');
		if(rect) {
			rect.remove();
			}
//console.log(oya.transform);
		}
*/
   	}

    function decompose_text(tagn) {
console.log('decompose tag=',tagn);
	var text_tag='';
	var atext='';
	for(i=0;i<tagn.children.length;i++) {
		if(tagn.children[i].nodeName=='text') {
			text_tag=tagn.children[i];
			if(text_tag.childNodes[0].nodeName=='textPath') {
				font.path=text_tag.childNodes[0].getAttribute('href');
				font.path=font.path.slice( 1 ) ;
				text_tag=text_tag.children[0];
				$("#textPath").value=font.path;
console.log('text_tag=',text_tag,' path=',font.path);
				}
			break;
			}
		}
	if(text_tag) {
		for (nn = 0; nn < text_tag.children.length ; nn++) {
			var tx=text_tag.children[nn].innerHTML;
			if(tx!='') {
				atext=atext+tx+'<br>';
				}

			}
		}
	return atext;
   }

</script>
<!-- ポップアップウィンドウ用ベースHTML（テンプレート）順次選択用 -->
<div class="dialog" id="select_next" title="順次選択">
  <!-- div class="dialog-content" -->
	<p id="select_next_val" val=""></p>
	<br>
   	<button class="btn" id="select_next_ok">OK</button><label>&nbsp;　　&nbsp;</label><button class="btn" id="select_next_back">Back</button><label>&nbsp;　　&nbsp;</label><button class="btn" id="select_next_next">Next</button><br>
  <!-- /div -->
</div>
<script class="minify" id="smain_08">
   var select_pointer=0;
   var select_target;
   $("#check_anime").on("click", function(){
	var theDialog=$( '#select_next' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:150, width: 400,  position: {my: "right bottom", at: "right bottom-60", of: window}});
	
	select_yes_no();

	//ダイアログを表示する
	theDialog.dialog("open");
	});

   function select_yes_no(){
console.log('Check tags Tags No.=',select_pointer);
	var tags=container.children;
	var max_num=tags.length;
	var nn=select_pointer;
console.log('tgs num=',max_num,tags);
	select_target=tags[nn];
console.log('target=',select_target);
	node=select_target.getAttribute('id');
//	if(select_target && !(node=='my_animation')) {
	if(select_target) {
		Drag_elem=select_target;
		var rect_a=select_target.getBoundingClientRect();
		let w=rect_a.right-rect_a.left;
		let h=rect_a.bottom-rect_a.top;

		var pnt2=svgPoint(select_target, rect_a.left, rect_a.top);
		rect01=createRectFig(pnt2.x,pnt2.y,w,h);
		rect01.setAttribute('id', 'rect01');
		rect01.setAttribute('fig', 'temp');
		select_target.appendChild(rect01);
			
		fig=select_target.getAttribute('fig');
		var val=select_target.nodeName+' fig='+fig+' No.'+String(select_pointer);
console.log('val=',val);
		document.getElementById('select_next_val').innerHTML='選択しますか？ node='+val;
//		document.getElementById('select_next_val').val='これを選択しますか？ node='+val;
		}
	}

    select_next_next.onclick = function(){
console.log('Nextが押されました');
	var tags=container.children;
	var max_num=tags.length;

	var nn=select_pointer+1;
	if(nn<max_num) {
		node=tags[nn].getAttribute('id');
		if(node=='my_animation'){
			if((nn+1)<max_num) nn=nn+1;
			else nn-1;
			}
		select_pointer=nn;
		}
	var rect01=select_target.querySelector('rect');
console.log('next rect=',rect01);
	if(rect01) {
		select_target.removeChild(rect01);
		}
	select_yes_no();
	}

    select_next_back.onclick = function(){
console.log('Backが押されました');
	var tags=container.children;
	var max_num=tags.length;

	var nn=select_pointer-1;
	if(nn>=0) {
		node=tags[nn].getAttribute('id');
		if(node=='my_animation') {
			if((nn-1)>=0) nn=nn-11;
			else nn+1;
			}
		select_pointer=nn;
		}
	var rect01=select_target.querySelector('rect');
console.log('back rect=',rect01);
	if(rect01) {
		select_target.removeChild(rect01);
		}
	select_yes_no();
	}

    select_next_ok.onclick = function(){
console.log('OKが押されました');
	var tags=container.children;
	var max_num=tags.length;
	
	var rect01=select_target.querySelector('rect');
console.log('ok rect=',rect01);
	if(rect01) {
		select_target.removeChild(rect01);
		}
	select_yes_no();
	Drag_elem = select_target;
	drag.target=Drag_elem;
	Drag_elem.setAttribute('class', 'draggable');
console.log('**Drag_elem= ',Drag_elem.nodeName,'id= ',fig_id);
	Draw_mode='Drag';
	drag.break=false;
	Svg_mode="Svg_drag_pending";
	draggable(Drag_elem);

//Dialogを強制的に消す
	$('#select_next').dialog("close");
	}

</script>
<!-- ポップアップウィンドウ用make_navi（テンプレート） Texx領域先頭位置に配置　-->
<!-- div class="dialog" id="make-navi" title="Navi設置">
  <div class="dialog-content">
	<label>&nbsp;start-X:&nbsp;<input type="text" id="nav_size1" value="50" style="width:40px;"></label><label>px&nbsp;</label>
	<label>&nbsp;start-Y:&nbsp;<input type="text" id="nav_size2" value="50" style="width:40px;"></label><label>px&nbsp;</label></br>
	<label>&nbsp;width:&nbsp;<input type="text" id="nav_size3" value="100" style="width:40px;"></label><label>px&nbsp;</label>
        <label>&nbsp;Navi個数:&nbsp;<input type="text" id="nav_size4" value="0" style="width:40px;"></label><br>
	<button class="btn" id="nav_add">追加</button>&nbsp;<button class="btn" id="nav_del">削除</button></br>
    　　<p>  -------------------------------------  </p>
	<label>&nbsp;No.&nbsp;<input type="text" id="nav_param3" value="" style="width:40px;"></label>
	<label>&nbsp;&nbsp;</label><button class="btn" id="nav_next"> → </button>&nbsp;<button class="btn" id="nav_back"> ← </button><button class="btn" id="nav_set">set</button></br>
	<label>&nbsp;Title:&nbsp;<input type="text" id="nav_param4" value="Google" style="width:100px;"></label></br>
	<label>&nbsp;href:&nbsp;<input type="text" id="nav_param5" value="http://abc" style="width:200px;"></label></br>
	</br>
	<button class="btn" id="make_navigation">Set Navi</button></br>
  </div>
</div -->
<script class="minify" id="smain_09">
/*
   var nav_pointer=0;
   $("#set_navi").on("click", function(){
	Editmode="Edit";
	Draw_mode='';
	var theDialog=$( '#make-navi' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:340, width: 360,  position: {my: "right bottom", at: "right bottom", of: window}} );
	set_navnow();
	//ダイアログを表示する
	theDialog.dialog("open");
	});

  function set_navnow() {
*/
/*
	var hd=document.querySelector('#navheader');
console.log('header=',hd);
	if(hd) {
		var sty=hd.getAttribute('style');
		var elem=sty.split(';');
		var value=elem[1].split(':');
console.log('style=',sty,'height=',value[1]);
		var h=value[1].slice(0,-2);
		document.getElementById('nav_param1').value=String(h);
//		first_container.removeChild(hd);
		}
*/
/*
	var nv=document.querySelector('#navheader');
	if(nv) {
		var nv_a=nv.querySelectorAll('a');
console.log('a tag=',nv_a);
		nav_links=[];
		var len=nv_a.length;
		for(var i=0;i<len;i++){
			let ta = {title:"google", link:"https://www.google.com/"};
			nav_links.push(ta);
    			nav_links[i].title=nv_a[i].children[0].innerHTML
			nav_links[i].link=nv_a[i].href;
			}
		document.getElementById('nav_size4').value=String(len);
console.log('nav=',nav_links);
		}
    }

    make_navigation.onclick = function(){
console.log("***Make navigation start");
	var hd=document.querySelector('#navheader');
	if(hd) {
		first_container.removeChild(hd);
		}
*/
/*
	var nv=document.querySelector('div.navheader');
	if(nv) {
		first_container.removeChild(nv);
		}
*/
/*
	var left=Number($("#nav_size1").val());
	var top=Number($("#nav_size2").val());
	var width=Number($("#nav_size3").val());
	set_header(left,top,width);
//		set_links(left,top);
	}

  function set_header(left,top,width) {
	var len=nav_links.length;
	if(len>0) {

		//var nv_hd= document.createElement('div');
		//nv_hd.setAttribute('class','navheader');
		//nv_hd.setAttribute('id', 'header');
		//$(nv_hd).insertAfter('#svg_00');
		//var str= ' left:'+String(left)+'px;'+' top:'+String(top)+'px;';
		//nv_hd.setAttribute('style', style=str);

    		var pNode = document.createElement('p');
		pNode.setAttribute('id', 'navheader');
		$(pNode).insertAfter('#svg_00');

    		var newNode = document.createElement('span');
    		newNode.setAttribute('style','font-size:'+' 14px;');
    		newNode.innerHTML =  '<br><br>&nbsp; &nbsp;';
    		pNode.appendChild(newNode);

		for(var i=0;i<len;i++){
//<a>タグを作成場合
    			var newNode =document.createElement('a');
//Titleはbutton側に書く    			newNode.innerHTML = nav_links[i].title;
			newNode.href= nav_links[i].link;
			//newNode.setAttribute('onclick', "location.href="+" '"+nav_links[i].link+"' ");
			//newNode.setAttribute('class', 'my_button');
			newNode.setAttribute('target', '_blank');
//			var str= ' left:'+String(left)+'px;'+' top:'+String(top)+'px;';
//			newNode.setAttribute('style', style=str);
			pNode.appendChild(newNode);

//<button>タグの場合
    			var btnNode =document.createElement('button');
    			btnNode.innerHTML = nav_links[i].title;
			//btnNode.setAttribute('onclick', "location.href="+" '"+nav_links[i].link+"' ");
			btnNode.setAttribute('class', 'my_button');
			var str='';
			if(width>0) {
				str= str+' width:'+String(width)+'px;';
				}
			if(i==0) {
				str= str+' margin-left:'+String(left)+'px;';
				}
			btnNode.setAttribute('style', str);
			newNode.appendChild(btnNode);
			}
		}
*/
/*
		var hd=document.querySelector('div#header');
console.log('nav=',nv_hd,'header=',hd)
		if(hd){
			$(nv_hd).insertAfter(hd);
			}
		else {
			$(nv_hd).insertAfter('#svg_00');
			}
*/
/*
	change_css(Editmode);
    }

  $("#nav_add").on("click", function(){
	let ta = {title:"google", link:"https://www.google.com/"};
	nav_links.push(ta);
	var len=nav_links.length;
	document.getElementById('nav_size4').value=String(len);
console.log(nav_links);
    });

  $("#nav_del").on("click", function(){
    	nav_links.pop();
	var len=nav_links.length;
	document.getElementById('nav_size4').value=String(len);
console.log(nav_links);
    });

  $("#nav_next").on("click", function(){
	len=nav_links.length;
	if(nav_pointer<len) {
		nav_pointer=nav_pointer+1;
		}
	document.getElementById('nav_param3').value=String(nav_pointer);
	document.getElementById('nav_param4').value=nav_links[nav_pointer-1].title;
	document.getElementById('nav_param5').value=nav_links[nav_pointer-1].link;
    });

  $("#nav_back").on("click", function(){
	len=nav_links.length;
	if(nav_pointer>1) {
		nav_pointer=nav_pointer-1;
		}
	document.getElementById('nav_param3').value=String(nav_pointer);
	document.getElementById('nav_param4').value=nav_links[nav_pointer-1].title;
	document.getElementById('nav_param5').value=nav_links[nav_pointer-1].link;
    });

  $("#nav_set").on("click", function(){
	var nv=document.querySelector('#navheader');
	var nv_a=nv.querySelectorAll('a');
console.log('a tag=',nv_a);
	nav_links[nav_pointer-1].title=document.getElementById('nav_param4').value;
	nv_a[nav_pointer-1].children[0].innerHTML=nav_links[nav_pointer-1].title;
	nav_links[nav_pointer-1].link=document.getElementById('nav_param5').value;
	nv_a[nav_pointer-1].href= nav_links[nav_pointer-1].link;
    });
*/
</script>

<!-- ポップアップウィンドウ用 design html（テンプレート） -->
<div class="dialog" id="my_html_design" title="Html_Design">
  <div class="dialog-content">
	<label id="dsin_lb01">Tag:&nbsp;</label><input type="text" id="hm_tag" value="" style="width:60px;" ><label id="dsin_lb02">&nbsp;Level:&nbsp;</label><input type="text" id="hm_level" value="" style="width:30px;"><label id="dsin_lb03">&nbsp;fig:&nbsp;</label><input type="text" id="hm_fig" value="" style="width:50px;"><label>&nbsp;　</label><button id="green_off" onclick="green_off()" value='green off' style="height:15px;">green off</button></br>
        <label>&nbsp;</label><button class="btn" id="copy_tag">copy</button><label>&nbsp;</label><button class="btn" id="paste_tag">paste</button><label>&nbsp;</label><button class="btn" id="makeSvg_indiv">svg_indiv</button><label>&nbsp;　</label><button class="btn" id="del_tag">削除</button><label>&nbsp;　</label><button class="btn" onclick="Google_chars2()">Google検取得</button></br>
	<label id="dsin_lb04">挿入tag:</label>
    	  <select id="sel_add_tag" onchange="tag_change()" style="width:100px;">
        	<option value="none"  selected="selected"></option>
        	<option value="div">大枠 div</option>
        	<option value="flex">横小枠 flex</option>
        	<option value="colm_flex">縦小枠 colmn</option>
        	<option value="ul">箇条書 ul_li</option>
        	<option value="ol">数列挙 ol_li</option>
        	<option value="title">見出し Hx</option>
        	<option value="photo">絵写真 img</option>
        	<option value="p_tag">段落 p</option>
        	<option value="table">テーブル tbl</option>
        	<option value="span">強調 span</option>
        	<option value="svg_indiv">div_Svg</option>
        	<!-- option value="header">大表題</option -->
        	<option value="nav_menu">メニュー navi</option>
        	<option value="button">ボタン a</option>
        	<option value="link">リンク a</option>
		<option value="I_con">Icon i</option>
		<option value="recipe">レシピ</option>
    	  </select><!-- label id='Label_01'>&nbsp;分割数:&nbsp;<input type="text" id="hm_numb" value="3" style="width:30px;"></label><label>&nbsp;左右margin:<input type="text" id="lr_margin" value="0px 0px" style="width:50px;"></label><br -->
	　<label id='Label_01'></label><br>
	　　　<button class="btn"  onclick="register_recipe()" id="recipe_add">S登録</button>　<label id="dsin_lb05">Sレシピ</label>
    	  <select id="style_recipe_tag" onchange="recipe_sel()" style="width:120px;">
        	<option value="none"  selected="selected"></option>
	  </select><br>
	  <label>&nbsp;</label><button class="btn" id="tag_up"> ↑ </button>&nbsp;<button class="btn" id="tag_back"> ← </btn>&nbsp;<button class="btn" id="tag_next"> → </button>&nbsp;<button class="btn" id="tag_down"> ↓ </button>　  <button class="btn" id="add_tag" >追加</button><label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label><button class="btn" id="styl_disp" onclick="typ_next()">style表示</button><br>
  </div>
</div>
<!-- ポップアップウィンドウ用 styles（テンプレート） -->
<div class="dialog" id="my_style_design" title="Style_Design">
  <div class="dialog-content">
        <div class="submenu">
           <div id="submenu01" style="display:block;">
		<label id="st1_lb_01">margin-L:&nbsp;</label><input type="text" id="hm_mar1" value="" style="width:40px;"><label id="st1_lb_02">&nbsp;margin-R:&nbsp;</label><input type="text" id="hm_mar2" value="" style="width:40px;">
		<label id="st1_lb_03">&nbsp;indent:&nbsp;</label><input type="text" id="hm_parm7" value="" style="width:40px;"><br>
		<label id="st1_lb_04">margin:&nbsp;</label><input type="text" id="hm_parm3" value="" style="width:60px;"><label id="st1_lb_05">&nbsp;padding:&nbsp;</label><input type="text" id="hm_parm4" value="" style="width:60px;"><br>
		<label id="st1_lb_06">color:&nbsp;</label><input type="text" id="hm_parm1" value="" style="width:60px;">  	<label id="st1_lb_07">&nbsp;float:&nbsp;</label>
    	  		<select id="hm_parm2" class="input">
			<option value="none" selected="selected"></option>
			<option value="left">left</option>
        		<option value="right">right</option>
    	  		</select>
  		<br>
		<label id="st1_lb_08">width:&nbsp;</label><input type="text" id="hm_parm8" value="" style="width:60px;"><label id="st1_lb_09">&nbsp;height:&nbsp;</label><input type="text" id="hm_parm9" value="" style="width:60px;"><br>
		<label id="st1_lb_10">border:&nbsp;</label><input type="text" id="hm_parm5" value="" style="width:140px;"><label id="st1_lb_11">&nbsp;border-radius:&nbsp;</label><input type="text" id="hm_parm6" value="" style="width:30px;"><br>
		<label id="st1_lb_12">&nbsp;others:&nbsp;</label><input type="text" id="hm_parm10" value="" style="width:220px;"><br>
	   	<button class="btn" id="submenu_01" onclick="set_hm_parms1()">Set</button></br>
	   </div>
           <div id="submenu02" style="display:none;">
		<label id="st2_lb_01">&nbsp;color:</label><input type="text" id="hm_parm11" value="" style="width:45px;"><label id="st2_lb_02">&nbsp;back-color:</label><input type="text" id="hm_parm12" value="" style="width:45px;">
		<label id="st2_lb_03">&nbsp;font_size:</label><input type="text" id="hm_parm13" value="" style="width:40px;"><br>
	 	<label id="st2_lb_04">font-style:</label>
    	  		<select id="hm_parm14" class="input">
			<option value="none" selected="selected"></option>
        		<option value="bold">bold</option>
        		<option value="italic">italic</option>
        		<option value="underline">underline</option>
    	  		</select>
		　　<label id="st2_lb_07">&nbsp;line_height:&nbsp;</label><input type="text" id="hm_parm17" value="" style="width:40px;"><br>
		<label id="st2_lb_05">font-family:</label>
    	  		<select id="hm_parm15" class="input">
			<option value="none" selected="selected"></option>
    			<option value="Noto+Sans+JP">Noto+Sans+JP</option>
    			<option value="Noto+Serif+JP">Noto+Serif+JP</option>
			<option value="Kaisei+Opti">Kaisei+Opti</option>
			<option value="Reggae+One">Reggae+One</option>
			<option value="Kaushan+Script">Kaushan+Script</option>
        		<option value="Times New Roman">Times New Roman</option>
        		<option value="Arial">Arial</option>
        		<option value="georgia">HGS創英角ﾎﾟｯﾌﾟ体</option>
    	  		</select><br>
		<label id="st2_lb_06">others:&nbsp;</label><input type="text" id="hm_parm16" value="" style="width:220px;"><br>
		<button class="btn" id="submenu_02" onclick="set_hm_parms2()">Set</button></br>
	   </div>
           <div id="submenu03" style="display:none;">
		<label id="st3_lb_01">タグ選択:</label><select id="tit_size" style="width:40px;" >
    		<option value="none" selected="selected"></option>
    		<option value="H1">h1</option>
    		<option value="H2">h2</option>
		<option value="H3">h3</option>
    		<option value="H4">h4</option>
    		<option value="H5">h5</option>
		<option value="H6">h6</option>
		</select>
		<label id="st3_lb_02">&nbsp;id:</label><input type="text" id="tit_id" value="" style="width:60px;">
		<label id="st3_lb_05">padding:</label><input type="text" id="tit_mar5" value="" style="width:60px;"><br>
		<label id="st3_lb_03">justify:</label><select id="flex_just" style="width:50px;" >
    				<option value="none"  selected="selected"></option>
    				<option value="center">center</option>
    				<option value="space-around">around</option>
				<option value="space-between">between</option>
    				<option value="flex-start">start</option>
    				<option value="flex-end">end</option>
				</select>
		<label id="st3_lb_04">align:</label><select id="flex_align" style="width:50px;" >
    				<option value="none"  selected="selected"></option>
    				<option value="strech">stretch</option>
    				<option value="flex-start">start</option>
				<option value="flex-end">end</option>
    				<option value="center">center</option>
				</select><br>
		<label id="st3_lb_06">back-color:</label><input type="text" id="tit_mar0" value="" style="width:50px;">
		<label id="st3_lb_07">title:</label><input type="text" id="tit_title" value="" style="width:160px;"><br>
		<label id="st3_lb_08">top:&nbsp;</label><input type="text" id="tit_mar1" value="" style="width:220px;"><br>
		<label id="st3_lb_09">bottom:&nbsp;</label><input type="text" id="tit_mar2" value="" style="width:220px;"><br>
		<label id="st3_lb_10">left:&nbsp;</label><input type="text" id="tit_mar3" value="" style="width:220px;"><br>
		<label id="st3_lb_11">right:&nbsp;</label><input type="text" id="tit_mar4" value="" style="width:220px;"><br>
		<label id="st3_lb_12">&nbsp;others:&nbsp;</label><input type="text" id="tit_mar6" value="" style="width:220px;"><br>
		<button class="btn" id="submenu_03" onclick="set_hm_parms3()" style="display:none;">Set</button></br>
	   </div>
  	   <div id="submenu04"  style="display:none;">
		<!-- label>width:<input type="text" id="im_pam1" value="100" style="width:40px;"></label><label>&nbsp;&nbsp;height:<input type="text" id="im_pam2" value="100" style="width:40px;"></label></br -->
		<label id="st4_lb_01">padding:</label><input type="text" id="im_pam3" value="10px" style="width:180px;"><br>
		<label id="st4_lb_02">&nbsp;リンク/Font:&nbsp;</label><input type="text" id="link_targ" value="" style="width:220px;"><br>
		<label id="st4_lb_03">Title:</label><input type="text" id="im_pam5" value="" style="width:220px;"><br>
        	<label id="st4_lb_04">Title位置 :</label>
   		<select id="im_pos" style="width:80px;" >
			<option value="none" selected></option>
    			<option value="bottom">bottom</option>
    			<option value="top">top</option>
   		</select>
		<!-- label>position pos_x:<input type="text" id="im_pam11" value="100" style="width:40px;">px</label><label>&nbsp;&nbsp;pos_y:<input type="text" id="im_pam12" value="100" style="width:40px;">px</label></br -->
        	<label id="st4_lb_05">画像配置:</label>
   		<select id="im_float" style="width:80px;" >
    			<option value="none"></option>
    			<option value="left" selected>left</option>
			<option value="right">right</option>
			<option value="overflow">overflow</option>
   		</select><br>
		<label id="st4_lb_06">画像alt:</label><input type="text" id="im_pam4" value="" style="width:220px;"><br>
		<label id="st4_lb_07">others:&nbsp;</label><input type="text" id="im_pam6" value="" style="width:220px;"><br>
		<label id="st4_lb_08">テーブルborder:&nbsp;</label><input type="text" id="tabl_parm01" value="" style="width:150px;">
		<button class="btn" id="submenu_04" onclick="set_hm_parms4()" style="display:none;">Set</button></br>
  	   </div>
	</div>
    　　<p id="style_design_title" style="display:none;">style画面--<label id='lb_styl_num'></label>------<label id='lb_styl_for'></label></p>
  </div>
</div>
<script class="minify" id="smain_10">
var my_html_design_dialog=0;
var my_style_design_dialog=0;
var doc_deep_level=-1;
var doc_edit_node='';
var prev_doc_edit_node='';
var prev_doc_edit_style=null;
var doc_origin_node;
var doc_top_node='';
var doc_origin_level;
var tag_trees=[];
var doc_prev_parms;
var doc_add_first=false;
var default_margin_L;
var default_margin_R;
var typ_chng_flg=0;
var tag_change_mode=1;
var photo_type;
var temp_style='';
var green_on_off=0;
var recp_list=[];
var recipe_selection=0;

   $("#design_html").on("click", function(){
console.log('Enter design_html');
	if(Editmode!="Edit") {
		alert('HTML design only allowed at Edit mode');
		return;
		}

	Draw_mode='';

	var theDialog=$( '#my_html_design' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:220, width: 480,  } );
	place_to_tag();
	if(doc_deep_level<0) {       //直前のplace_to_tagで選択されていない場合
		document.getElementById('hm_level').value=String(0);
		doc_edit_node=document.getElementById('divsvg_00');
		document.getElementById('hm_tag').value=doc_edit_node.nodeName;
		//document.getElementById('hm_id').value='divsvg_00'
		document.getElementById('hm_fig').value=''
alert('text not selected');
		return;
		}
	display_current_tag(doc_edit_node);
	//ダイアログを表示する
	my_html_design_dialog=1;
	typ_chng();
	tag_change();
//	var myevent = document.getElementById('my_html_design');
//    	myevent.addEventListener( 'keydown', my_html_click,false);
//    	myevent.addEventListener( 'mousedown', my_html_click,false);
//console.log('******html design EventListener set****');
	if(html_design_title) set_html_design_title();
	theDialog.dialog("open");
	if(style_design_title) set_style_design_title();
	});

function set_html_design_title() {
console.log('menu=',set_menu,'title=',html_design_title);
	if(set_menu>=0) {
   		document.getElementById('dsin_lb01').innerHTML=html_design_title[1][set_menu]+':&nbsp;';
   		document.getElementById('dsin_lb02').innerHTML='　'+html_design_title[2][set_menu]+':&nbsp;';
   		document.getElementById('dsin_lb03').innerHTML='　'+html_design_title[3][set_menu]+':&nbsp;';
		document.getElementById('copy_tag').innerHTML=html_design_title[4][set_menu];
		document.getElementById('paste_tag').innerHTML=html_design_title[5][set_menu];
		document.getElementById('makeSvg_indiv').innerHTML=html_design_title[6][set_menu];
		document.getElementById('del_tag').innerHTML=html_design_title[7][set_menu];
   		document.getElementById('dsin_lb04').innerHTML=html_design_title[8][set_menu]+':&nbsp;';
   		document.getElementById('add_tag').innerHTML=html_design_title[10][set_menu];
   		document.getElementById('styl_disp').innerHTML=html_design_title[9][set_menu];
   		document.getElementById('dsin_lb05').innerHTML=html_design_title[11][set_menu];
   		document.getElementById('recipe_add').innerHTML=html_design_title[12][set_menu];

		//次のfor文以下はadd_tagのドロップダウンリストに対応
		for(let k=0;k<15;k++)　document.getElementById('sel_add_tag').children[k+1].innerHTML=html_design_title[k+13][set_menu];
		document.getElementById('sel_add_tag').children[16].innerHTML=html_design_title[11][set_menu];
		}
	}

function set_style_design_title() {
console.log('menu=',set_menu,'title=',style_design_title);
	if(set_menu>=0) {
   		document.getElementById('st1_lb_01').innerHTML=style_design_title[2][set_menu]+':&nbsp;';
   		document.getElementById('st1_lb_02').innerHTML='　'+style_design_title[3][set_menu]+':&nbsp;';
   		document.getElementById('st1_lb_03').innerHTML='　'+style_design_title[4][set_menu]+':&nbsp;';
   		document.getElementById('st1_lb_04').innerHTML=style_design_title[1][set_menu]+':&nbsp;';
   		document.getElementById('st1_lb_05').innerHTML='　'+style_design_title[5][set_menu]+':&nbsp;';
   		document.getElementById('st1_lb_06').innerHTML=style_design_title[6][set_menu]+':&nbsp;';
   		document.getElementById('st1_lb_07').innerHTML='　'+style_design_title[7][set_menu]+':&nbsp;';
   		document.getElementById('st1_lb_08').innerHTML=style_design_title[8][set_menu]+':&nbsp;';
   		document.getElementById('st1_lb_09').innerHTML='　'+style_design_title[9][set_menu]+':&nbsp;';
   		document.getElementById('st1_lb_10').innerHTML=style_design_title[10][set_menu]+':&nbsp;';
   		document.getElementById('st1_lb_11').innerHTML='　'+style_design_title[11][set_menu]+':&nbsp;';
   		document.getElementById('st1_lb_12').innerHTML=style_design_title[12][set_menu]+':&nbsp;';
		document.getElementById('submenu_01').innerHTML=style_design_title[32][set_menu];

   		document.getElementById('st2_lb_01').innerHTML=style_design_title[6][set_menu]+':&nbsp;';
   		document.getElementById('st2_lb_02').innerHTML='　'+style_design_title[13][set_menu]+':&nbsp;';
   		document.getElementById('st2_lb_03').innerHTML='　'+style_design_title[14][set_menu]+':&nbsp;';
   		document.getElementById('st2_lb_04').innerHTML=style_design_title[15][set_menu]+':&nbsp;';
   		document.getElementById('st2_lb_05').innerHTML=style_design_title[16][set_menu]+':&nbsp;';
   		document.getElementById('st2_lb_06').innerHTML=style_design_title[12][set_menu]+':&nbsp;';
   		document.getElementById('st2_lb_07').innerHTML=style_design_title[17][set_menu]+':&nbsp;';
		document.getElementById('submenu_02').innerHTML=style_design_title[32][set_menu];

   		document.getElementById('st3_lb_01').innerHTML=style_design_title[33][set_menu]+':&nbsp;';
   		document.getElementById('st3_lb_02').innerHTML='　'+style_design_title[18][set_menu]+':&nbsp;';
   		document.getElementById('st3_lb_03').innerHTML=style_design_title[19][set_menu]+':&nbsp;';
   		document.getElementById('st3_lb_04').innerHTML=style_design_title[20][set_menu]+':&nbsp;';
   		document.getElementById('st3_lb_05').innerHTML='　'+style_design_title[5][set_menu]+':&nbsp;';
   		document.getElementById('st3_lb_06').innerHTML=style_design_title[13][set_menu]+':&nbsp;';
   		document.getElementById('st3_lb_07').innerHTML=style_design_title[21][set_menu]+':&nbsp;';
   		document.getElementById('st3_lb_08').innerHTML=style_design_title[22][set_menu]+':&nbsp;';
   		document.getElementById('st3_lb_09').innerHTML=style_design_title[23][set_menu]+':&nbsp;';
   		document.getElementById('st3_lb_10').innerHTML=style_design_title[24][set_menu]+':&nbsp;';
   		document.getElementById('st3_lb_11').innerHTML=style_design_title[25][set_menu]+':&nbsp;';
   		document.getElementById('st3_lb_12').innerHTML=style_design_title[12][set_menu]+':&nbsp;';
		document.getElementById('submenu_03').innerHTML=style_design_title[32][set_menu];

   		document.getElementById('st4_lb_01').innerHTML=style_design_title[5][set_menu]+':&nbsp;';
   		document.getElementById('st4_lb_02').innerHTML=style_design_title[26][set_menu]+':&nbsp;';
   		document.getElementById('st4_lb_03').innerHTML=style_design_title[27][set_menu]+':&nbsp;';
   		document.getElementById('st4_lb_04').innerHTML=style_design_title[28][set_menu]+':&nbsp;';
   		document.getElementById('st4_lb_05').innerHTML=style_design_title[29][set_menu]+':&nbsp;';
   		document.getElementById('st4_lb_06').innerHTML=style_design_title[30][set_menu]+':&nbsp;';
   		document.getElementById('st4_lb_07').innerHTML=style_design_title[12][set_menu]+':&nbsp;';
   		document.getElementById('st4_lb_08').innerHTML=style_design_title[31][set_menu]+':&nbsp;';
		document.getElementById('submenu_04').innerHTML=style_design_title[32][set_menu];
		}
	}

   $("#my_html_design").on('dialogclose', function(event) {
	cancel_green_line();
	my_html_design_dialog=0;
	if(my_style_design_dialog)	$('#my_style_design').dialog("close");

//	var myevent = document.getElementById('my_html_design');
//    	myevent.removeEventListener( 'keydown', my_html_click,false);
//    	myevent.removeEventListener( 'mousedown', my_html_click,false);
console.log('Dialog closed');
	});

   $("#my_style_design").on('dialogclose', function(event) {
	my_style_design_dialog=0;
console.log('Dialog closed');
	});

function register_recipe() {
   	var user = window.prompt("styleレシピ名を入力して下さい。");
	if(user==null) return;
console.log('user input=',user);

	cancel_green_line();
	var node=doc_edit_node.cloneNode(true);
	var lv=resolve_tag_to_recipe(node,0);
	make_newnode(node);
console.log('node=',node);
	var dumy=document.createElement('div');
	dumy.appendChild(node);
console.log('new recipe=',dumy);

	var recp_name=user;
	var recp_node=node.nodeName;
	var sv_recipe=recp_node+','+recp_name+'|@|'+dumy.innerHTML+'|<=>|';

	save_new_recipe(sv_recipe,recp_name,recp_node);
alert('new recipe '+recp_name+'added');
//	save_recipe_init();

	var recp_dat=unescape(data).split('|<=>|');
console.log('resolved recipe=',recp_dat);
	var new_recp=recp_dat[recp_dat.length-2].split('|@|');
console.log('new=',new_recp);
　　	const domParser = new DOMParser();
　　	var parsed = domParser.parseFromString(new_recp[1], 'text/html');
console.log('parsed',parsed);
　　	const new_node = parsed.childNodes[0];
console.log('new_node=',new_node);
	makepalce_recipe(new_node);
	$(new_node).insertAfter(doc_edit_node);

	}

function save_recipe_init() {
	var data='|<=>|';
console.log('save recipe initail data=',data);
	//変数palletをDB　My_SysにEditor終了時に書き込む
	update_sysparms(3,data);
	}

function save_new_recipe(recp,name,node) {
	var old_recipes=get_common(3);
	var recp_serv=escape(recp);
	data=old_recipes+recp_serv;
	update_sysparms(3,data);

console.log('saved recipe name and node=',name+'  '+node);
	}

function read_recipe(recp) {
	var data=get_common(3);
	var recp_dat=unescape(data).split('|<=>|');
console.log('resolved recipe=',recp_dat);

	var recp_list=[];
	for(let k=0;k<recp_dat.length;k++) {
		if(recp_dat[k]!='') {
			var new_recp=recp_dat[k].split('|@|');
			var tag_nm=new_recp[0].split(',');
			recp_list.push([tag_nm[0],tag_nm[1],new_recp[1]]);
console.log('new=',recp_list);
			}
		}
	return recp_list;
	}  //End of function read_recipe

  function recipe_sel() {
console.log('**Change recipe selection');

//     id="style_recipe_tag" onchange="recipe_sel()"  <select id="style_recipe_tag" onchange="recipe_sel()" 
    console.log('selectIndex=',style_recipe_tag.selectedIndex);
	recipe_selection=style_recipe_tag.selectedIndex;
console.log('recipe selection=',recipe_selection,style_recipe_tag.options[recipe_selection].value);

    }


    function resolve_tag_to_recipe(tag,level) {
	var len=tag.childNodes.length;
	var rtn=level;
console.log('resolve tag=',tag,' level=',level,'len=',len);
	if(len>0) {
//console.log('tag node=',tag.nodeName);
		var old_tag="";
		for(var k=len-1 ;k>=0 ;k--){
			var tagn=tag.childNodes[k];
			var lv_nx=level+1;
			var rn=resolve_tag_to_recipe(tagn,lv_nx);
console.log('k level=',k,level,'node old new=',old_tag,tagn.nodeName,'return old new=',rtn,rn);
			if(k==len-1) old_tag=tagn.nodeName;
			if(tagn.nodeName==old_tag) {
				if(rn>rtn) {
					rtn=rn;
					if(tagn.nodeName=='A' && tag.nodeName=='LI') {
						tag.insertBefore(document.createTextNode('text-text'), tag.firstChild);
						tagn.remove();
						}
					if(tag.childNodes[k+1] && (tag.childNodes[k+1].nodeName==old_tag)) {
						tag.removeChild(tag.childNodes[k+1]);
console.log('prev tag removed');
						}
				}
				else {
					tag.removeChild(tag.childNodes[k]);
console.log('removed child');
					}
				}
			else {
				if(tagn.nodeName=='A' && tag.nodeName=='LI') {
					tag.insertBefore(document.createTextNode('text-text'), tag.firstChild);
					tagn.remove();
					}
				else old_tag=tagn.nodeName;
				if(rn>rtn) rtn=rn;
				}
console.log('k level=',k,level,'lopp end node old new=',old_tag,tagn.nodeName,'return old new=',rtn,rn);
			}
		return rtn;
		}
	else {
console.log('last node=',tag);
		if(typeof(tag)=='string') {
			tag=escapeHtml(tag);
			}
		else {
			tag.textContent=escapeHtml(tag.textContent);
			}
console.log('simple tag escaped=',tag);
		return level;
		}
	}

    function make_newnode(node) {
console.log('Enter make_newnode');
	if(node.nodeName=='#text') return;
	var newstl=clear_attr(node);
	node.removeAttribute('style');
	node.setAttribute('style',newstl);
	var len=node.childNodes.length;
	for(let k=0;k<len;k++) {
		var tagn=node.childNodes[k];
		if(tagn.childNodes.length>0) make_newnode(tagn);
		else {
			if(node.childNodes[k].nodeName=='#text') return;
			var newstl=clear_attr(node.childNodes[k]);

			node.childNodes[k].removeAttribute('style');
			node.childNodes[k].setAttribute('style',newstl);
console.log('new_node=',node.childNodes[k]);
			}
		}
	}

    function clear_attr(node) {
	var node_style=node.getAttribute('style');
console.log('Enter clear_attr:',node,node_style);
	var sty_char=[];
	var styles=[];
	var new_styl='';
	if(node_style!=null) sty_char=node_style.split(';');
console.log(sty_char);
		if(sty_char.length>0) {
			for(let i=0;i<sty_char.length;i++) {
				if(sty_char[i]) {
					let splt=sty_char[i].split(':');
					if(splt.length!=2) {
						alert('style input error:'+sty_char[i]);
						return;
						}
					splt[0]=splt[0].trim();
					splt[1]=splt[1].trim();
					if(splt[0] && splt[1] && splt[1]!='inherit') {
console.log(splt,splt[0],splt[1]);
						new_styl=new_styl+splt[0]+':'+splt[1]+';';

						}
					}
				}
			}
	return new_styl;
	} //End of clear_attr

function makepalce_recipe(node) {
console.log('Enter makeplace_recipe node=',node);
	var len=node.childNodes.length;
	for(let k=0;k<len;k++) {
		var tagn=node.childNodes[k];
		var nname=tagn.nodeName;
		if('H'==nname[0]) nname='H';
console.log('node=',nname);
		switch (nname){
      			case 'H':
				while(tagn.firstChild){
  					tagn.removeChild(tagn.firstChild);
					}	
				tagn.innerHTML='見出しを入力して下さい';
				break;
      			case 'LI':
				var q3=tagn.querySelector('UL,OL');
console.log('query=',q3);
console.log('li inner=',tagn,tagn.innerHTML,tagn.innerText,tagn.textContent);
				if(q3) makepalce_recipe(tagn);
				var nx=tagn.cloneNode(true);
				$(nx).insertAfter(tagn);
				break;
/*
      			case 'UL':
      			case 'OL':
				makepalce_recipe(tagn);
				break;
*/
			default:
				if(tagn.childNodes.length>0) makepalce_recipe(tagn);
				break;
			}
		}
	}  //End of makepalce_recipe

    function cancel_green_line() {
	if(prev_doc_edit_style==null) prev_doc_edit_style='';
	if(prev_doc_edit_node) {
console.log('prev node =',prev_doc_edit_node.nodeName,prev_doc_edit_style);
		if(prev_doc_edit_style) prev_doc_edit_node.setAttribute('style',prev_doc_edit_style);
			else prev_doc_edit_node.removeAttribute('style');
		}
	document.getElementById('green_off').innerText='green on'
	green_on_off=0;
	}

    function green_off(){
console.log('**green on/off called on/off=',green_on_off);
	if(green_on_off) cancel_green_line();
	else {
		if(prev_doc_edit_style==null) prev_doc_edit_style='';
		styl=prev_doc_edit_style+temp_style;
		prev_doc_edit_node.setAttribute('style',styl);
		document.getElementById('green_off').innerText='green off'
		green_on_off=1;
		}
	}

    function setto_current_tag(edit_node) {
//console.log('setto_current_tag=',edit_node.nodeName);
	doc_deep_level=get_tree_level(edit_node);
console.log('deep_level=',doc_deep_level,'tag_trees=',tag_trees);
console.log('setto_current_tag=',edit_node,'deep level=',doc_deep_level,'level=',tag_trees[doc_deep_level].level);
	document.getElementById('hm_level').value=String(tag_trees[doc_deep_level].level);
	document.getElementById('hm_tag').value=tag_trees[doc_deep_level].tag;
	node_id="";
	if(edit_node.nodeName=='DIV') node_id=edit_node.getAttribute('id');
	//document.getElementById('hm_id').value=node_id;
	var fig=edit_node.getAttribute('fig');
	document.getElementById('hm_fig').value=fig;
	prev_doc_edit_node='';
	} //End of setto_current_tag

    function display_current_tag(edit_node) {
	if(prev_doc_edit_style==null) prev_doc_edit_style='';
	if(prev_doc_edit_node) {
console.log('prev node =',prev_doc_edit_node.nodeName,prev_doc_edit_style);
		if(prev_doc_edit_style) prev_doc_edit_node.setAttribute('style',prev_doc_edit_style);
			else prev_doc_edit_node.removeAttribute('style');
		}
//console.log('display_current_tag=',edit_node.nodeName);
	doc_deep_level=get_tree_level(edit_node);
console.log('deep_level=',doc_deep_level,'tag_trees=',tag_trees);
console.log('display_current_tag=',edit_node,'deep level=',doc_deep_level,'level=',tag_trees[doc_deep_level].level);
	document.getElementById('hm_level').value=String(tag_trees[doc_deep_level].level);
	document.getElementById('hm_tag').value=tag_trees[doc_deep_level].tag;
	node_id="";
	if(edit_node.nodeName=='DIV') node_id=edit_node.getAttribute('id');
	//document.getElementById('hm_id').value=node_id;
	var fig=edit_node.getAttribute('fig');
	document.getElementById('hm_fig').value=fig;
	prev_doc_edit_node='';
	prev_doc_edit_node=edit_node;
	prev_doc_edit_style=edit_node.getAttribute('style');
var tmp_sty = getComputedStyle(edit_node, '');
console.log("@@@ edit_node_styles font-size : " +tmp_sty.fontSize  + " line-height : " + tmp_sty.lineHeight);
	check_attr(edit_node,prev_doc_edit_style,typ_chng_flg);
	green_on_off=1;
	document.getElementById('green_off').innerText='green off'
	if(edit_node.nodeName!='#text') {
console.log('new node =',edit_node.nodeName,'level=',tag_trees[doc_deep_level].level,'deep level=',doc_deep_level,tag_trees);
//		check_attr(edit_node,prev_doc_edit_style,typ_chng_flg);
		var styl;
		if(tag_trees[doc_deep_level].level==0) {
//			temp_style='border-top: solid 4px green;';
			temp_style='border-top: solid 4px green; background-color:#f0f8ff;';
			if(prev_doc_edit_style!=null) styl=prev_doc_edit_style+temp_style;
			else styl=temp_style;
			edit_node.setAttribute('style',styl);
			}
		else {
//			temp_style='border-bottom: solid 4px green;';
			temp_style='border-bottom: solid 4px green; background-color:#f0f8ff;';
			if(prev_doc_edit_style!=null) styl=prev_doc_edit_style+temp_style;
			else styl=temp_style;
			edit_node.setAttribute('style',styl);
			}
		}
	} //End of display_current_tag

    function check_attr(node,node_style,typ_chng_flg) {
console.log('Enter to check_attr type=',typ_chng_flg);
	clear_parms();
	switch (typ_chng_flg){
      		case 1:
			check_attr1(node,node_style);
			break;
      		case 2:
			check_attr2(node,node_style);
			break;
      		case 3:
			check_attr3(node,node_style);
			break;
      		case 4:
			check_attr4(node,node_style);
			break;
		}
	}

    function check_attr1(node,node_style) {
	if(node=='svg') return;
console.log('Enter check attr1:',node,node_style);
	var sty_char=[];
	var styles=[];
	var others='';
	if(node_style!=null) sty_char=node_style.split(';');
console.log(sty_char);
		if(sty_char.length>0) {
			for(let i=0;i<sty_char.length;i++) {
				if(sty_char[i]) {
					let splt=sty_char[i].split(':');
					if(splt.length!=2) {
						alert('style input error:'+sty_char[i]);
						return;
						}
					splt[0]=splt[0].trim();
					splt[1]=splt[1].trim();
					if(splt[0] && splt[1]) {
console.log(splt,splt[0],splt[1]);
						styles.push(splt);
						}
					}
				}
			}
console.log('styles=',styles);
	if(styles.length>0) {
		for(let i=0;i<styles.length;i++) {
			var kind=styles[i][0];
console.log('kind=',kind);
			switch(kind) {
				case 'margin-left':
					document.getElementById('hm_mar1').value=styles[i][1];
					break;
				case 'margin-right':
					document.getElementById('hm_mar2').value=styles[i][1];
					break;
				case 'color':
					document.getElementById('hm_parm1').value=styles[i][1];
					break;
				//case 'background-color':
				//	document.getElementById('hm_parm2').value=styles[i][1];
				//	break;
				case 'margin':
					document.getElementById('hm_parm3').value=styles[i][1];
					break;
				case 'padding':
					document.getElementById('hm_parm4').value=styles[i][1];
					break;
				case 'border':
					document.getElementById('hm_parm5').value=styles[i][1];
					break;
				case 'border-radius':
					document.getElementById('hm_parm6').value=styles[i][1];
					break;
				case 'text-indent':
					document.getElementById('hm_parm7').value=styles[i][1];
					break;
				case 'width':
					document.getElementById('hm_parm8').value=styles[i][1];
					break;
				case 'height':
					document.getElementById('hm_parm9').value=styles[i][1];
					break;
				case 'float':
					let select1=document.getElementById('hm_parm2');
					let kind1=styles[i][1];
console.log('******float=',kind1);
					switch(kind1) {
						case "left":
							select1.selectedIndex=1;
							break;
						case "right":
							select1.selectedIndex=2;
							break;
						}
					break;
				default:
console.log('default occured kind=',kind);
					if(kind) {
						others=others+kind+':'+styles[i][1]+';';
						document.getElementById('hm_parm10').value=others;
						}
					break;
				}
			}
		}
	} //End of check_attr1

    function check_attr2(node,node_style) {
	if(node=='svg') return;
console.log('Enter check attr2:',node,node_style);
	var sty_char=[];
	var styles=[];
	var others='';
	if(node_style!=null) sty_char=node_style.split(';');
console.log(sty_char);
		if(sty_char.length>0) {
			for(let i=0;i<sty_char.length;i++) {
				if(sty_char[i]) {
					let splt=sty_char[i].split(':');
					if(splt.length!=2) {
						alert('style input error:'+sty_char[i]);
						return;
						}
					splt[0]=splt[0].trim();
					splt[1]=splt[1].trim();
					if(splt[0] && splt[1]) {
console.log(splt,splt[0],splt[1]);
						styles.push(splt);
						}
					}
				}
			}
console.log('styles=',styles);
	if(styles.length>0) {
		for(let i=0;i<styles.length;i++) {
			var kind=styles[i][0];
console.log('kind=',kind);
			switch(kind) {
				case 'color':
					document.getElementById('hm_parm11').value=styles[i][1];
					break;
				case 'background-color':
					document.getElementById('hm_parm12').value=styles[i][1];
					break;
				case 'font-size':
					document.getElementById('hm_parm13').value=styles[i][1];
					break;
				case 'font-weight':
					let select1 = document.getElementById('hm_parm14');
					select1.selectedIndex=1;
					break;
				case 'font-style':
					select1 = document.getElementById('hm_parm14');
					select1.selectedIndex=2;
					break;
				case 'text-decoration':
					select1 = document.getElementById('hm_parm14');
					select1.selectedIndex=3;
					break;
				case 'line^height':
					document.getElementById('hm_parm17').value=styles[i][1];
					break;
				case 'font-family':
					let select2 = document.getElementById('hm_parm15');
					let kind2=styles[i][1];
					switch(kind2) {
						case "'Noto+Sans+JP'":
							select2.selectedIndex=1;
							break;
        					case "'Noto+Serif+JP'":
							select2.selectedIndex=2;
							break;
        					case "'Kaisei+Opti'":
							select2.selectedIndex=3;
							break;
        					case "'Reggae+One'":
							select2.selectedIndex=4;
							break;
        					case "'Kaushan+Script'":
							select2.selectedIndex=5;
							break;
        					case "'Times New Roman'":
							select2.selectedIndex=6;
							break;
        					case "'Arial'":
							select2.selectedIndex=7;
							break;
        					case "'HGS創英角ﾎﾟｯﾌﾟ体'":
							select2.selectedIndex=8;
console.log('font-family=',kind2,select2.selectedIndex);
							break;
						}
console.log('font-family=',kind2,select2.selectedIndex);
					break;	
				default:
console.log('default occured kind=',kind);
					if(kind) {
						others=others+kind+':'+styles[i][1]+';';
						document.getElementById('hm_parm16').value=others;
						}
					break;
				}
			}
		}
	} //End of check_attr2

    function check_attr3(node,node_style) {
	if(node=='svg') return;
console.log('Enter check attr3:',node,node_style);
	var sty_char=[];
	var styles=[];
	var others='';
	if(node_style!=null) sty_char=node_style.split(';');
console.log(sty_char);
		if(sty_char.length>0) {
			for(let i=0;i<sty_char.length;i++) {
				if(sty_char[i]) {
					let splt=sty_char[i].split(':');
					if(splt.length!=2) {
						alert('style input error:'+sty_char[i]);
						return;
						}
					splt[0]=splt[0].trim();
					splt[1]=splt[1].trim();
					if(splt[0] && splt[1]) {
console.log(splt,splt[0],splt[1]);
						styles.push(splt);
						}
					}
				}
			}
console.log('styles=',styles);
	if(styles.length>0) {
		for(let i=0;i<styles.length;i++) {
			var kind=styles[i][0];
console.log('kind=',kind,styles[i][1]);
			switch(kind) {
				case 'background-color':
					document.getElementById('tit_mar0').value=styles[i][1];
					break;
				case 'border-top':
					document.getElementById('tit_mar1').value=styles[i][1];
					break;
				case 'border-bottom':
					document.getElementById('tit_mar2').value=styles[i][1];
					break;
				case 'border-left':
					document.getElementById('tit_mar3').value=styles[i][1];
					break;
				case 'border-right':
					document.getElementById('tit_mar4').value=styles[i][1];
					break;
				case 'padding':
					document.getElementById('tit_mar5').value=styles[i][1];
					break;
				case 'justify-content':
					let select1=document.getElementById('flex_just');
					let kind1=styles[i][1];
console.log('justify=',kind1);
					switch(kind1) {
						case "center":
							select1.selectedIndex=1;
							break;
						case "space-around":
							select1.selectedIndex=2;
							break;
						case "space-between":
							select1.selectedIndex=3;
							break;
						case "flex_start":
							select1.selectedIndex=4;
							break;
						case "flex_end":
							select1.selectedIndex=5;
							break;
						}
					break;
				case 'align-items':
					let select2 = document.getElementById('flex_align');
					let kind2=styles[i][1];
console.log('align=',kind2);
					switch(kind2) {
						case "strech":
							select2.selectedIndex=1;
							break;
						case "flex-start":
							select2.selectedIndex=2;
							break;
						case "flex-end":
							select2.selectedIndex=3;
							break;
						case "center":
							select2.selectedIndex=4;
							break;
						}
					break;								
				default:
console.log('default occured kind=',kind);
					if(kind) {
						others=others+kind+':'+styles[i][1]+';';
						document.getElementById('tit_mar6').value=others;
						}
					break;
				
				}
			}
		}
	var nodety=node.nodeName[0];
console.log('node type=',nodety);
	if(nodety=='H') {
console.log('Enter case <H>tag');
		var options=document.getElementById('tit_size').options;
		for(k=0;k<options.length;k++) {
console.log('optin=',options[k].value,k);
			if(node.nodeName==options[k].value) {
				document.getElementById('tit_size').selectedIndex=k;
				break;
				}

			}
		}
	var tit_id=node.getAttribute('id');
console.log('tit_id=',tit_id);
	if(tit_id) {
		document.getElementById('tit_id').value=tit_id;
		}
	if(nodety=='H') {
console.log('enter tit_title=',node.innerHTML);
		document.getElementById('tit_title').value=node.innerHTML;
		}
	} //End of check_attr3

    function check_attr4(node,node_style) {
	if(node=='svg') return;
console.log('Enter check attr4:',node,node_style);
	var sty_char=[];
	var styles=[];
	var others='';
	if(node_style!=null) sty_char=node_style.split(';');
console.log(sty_char);
		if(sty_char.length>0) {
			for(let i=0;i<sty_char.length;i++) {
				if(sty_char[i]) {
					let splt=sty_char[i].split(':');
					if(splt.length!=2) {
						alert('style input error:'+sty_char[i]);
						return;
						}
					splt[0]=splt[0].trim();
					splt[1]=splt[1].trim();
					if(splt[0] && splt[1]) {
console.log(splt,splt[0],splt[1]);
						styles.push(splt);
						}
					}
				}
			}
console.log('styles=',styles);
	if(styles.length>0) {
		for(let i=0;i<styles.length;i++) {
			var kind=styles[i][0];
console.log('kind=',kind);
			switch(kind) {
				case 'padding':
					document.getElementById('im_pam3').value=styles[i][1];
					break;
				case 'im_pos':
					let select1 = document.getElementById('im_pos');
					let kind1=styles[i][1];
					switch(kind1) {
						case "bottom":
							select1.selectedIndex=1;
							break;
						case "top":
							select1.selectedIndex=2;
							break;
						}
					break;
				case 'im_float':
					let select2 = document.getElementById('im_float');
					let kind2=styles[i][1];
					switch(kind2) {
						case "left":
							select2.selectedIndex=1;
							break;
						case "right":
							select2.selectedIndex=2;
							break;
						case "overflow":
							select2.selectedIndex=3;
							break;
						}
					break;						
				default:
console.log('default occured kind=',kind);
					if(kind) {
						others=others+kind+':'+styles[i][1]+';';
						document.getElementById('im_pam6').value=others;
						}
					break;
				
				}
			}
		}
	if(node.nodeName=='A') {
console.log('Enter case <A>tag');
		document.getElementById('link_targ').value=node.href;
		document.getElementById('im_pam5').value=node.innerHTML;
		}
	if(node.nodeName=='I') {
console.log('Enter case <I>tag');
		var font_code=node.getAttribute('class');
		document.getElementById('link_targ').value=font_code;
		}
	if(node.nodeName=='IMG') {
		document.getElementById('link_targ').value=node.src;
		var alt=node.getAttribute('alt');
		document.getElementById('im_pam4').value=node.alt;
		//document.getElementById('im_pam5').value=node.caption.innerHTML;
/*
		var width=node.getAttribute('width');
		if(width) {
			width=width+'px';
			document.getElementById('im_pam1').value=width;
			}
		var height=node.getAttribute('height');
		if(height) {
			height=height+'px';
			document.getElementById('im_pam2').value=height;
			}
*/
		}	
	} //End of check_attr4

    function set_parms() {
console.log('Enter to set_parms type=',typ_chng_flg);
	switch (typ_chng_flg){
      		case 1:
			set_html_parms1();
			break;
      		case 2:
			set_html_parms2();
			break;
      		case 3:
			set_html_parms3();
			break;
      		case 4:
			set_html_parms4();
			break;
		}
	document.getElementById('sel_add_tag').selectedIndex=0;
	tag_change();
	}

    function set_hm_parms1() {
	if(tag_change_mode) return;
	else set_parms();		
	}

    function set_hm_parms2() {
	if(tag_change_mode) return;
	else set_parms();		
	}

    function set_hm_parms3() {
	if(tag_change_mode) return;
	else set_parms();		
	}

    function set_hm_parms4() {
	if(tag_change_mode) return;
	else set_parms();		
	}

    function set_html_parms1() {
console.log('Set parm1');
	var parms='';
	if(document.getElementById('hm_mar1').value) {
		parms=parms+'margin-left:'+document.getElementById('hm_mar1').value+';';
		}
	if(document.getElementById('hm_mar2').value) {
		parms=parms+'margin-right:'+document.getElementById('hm_mar2').value+';';
		}
	if(document.getElementById('hm_parm1').value) {
		parms=parms+'color:'+document.getElementById('hm_parm1').value+';';
		}
//	if(document.getElementById('hm_parm2').value) {
//		parms=parms+'background-color:'+document.getElementById('hm_parm2').value+';';
//		}
	if(document.getElementById('hm_parm3').value) {
		parms=parms+'margin:'+document.getElementById('hm_parm3').value+';';
		}
	if(document.getElementById('hm_parm4').value) {
		parms=parms+'padding:'+document.getElementById('hm_parm4').value+';';
		}
	if(document.getElementById('hm_parm5').value) {
		parms=parms+'border:'+document.getElementById('hm_parm5').value+';';
		}
	if(document.getElementById('hm_parm6').value) {
		parms=parms+'border-radius:'+document.getElementById('hm_parm6').value+';';
		}
	if(document.getElementById('hm_parm7').value) {
		parms=parms+'text-indent:'+document.getElementById('hm_parm7').value+';';
		}
	if(document.getElementById('hm_parm8').value) {
		parms=parms+'width:'+document.getElementById('hm_parm8').value+';';
		//var w_size=document.getElementById('hm_parm8').value;   widthの指定はstyle属性でOK
		//doc_edit_node.setAttribute('width',w_size);
		}
	if(document.getElementById('hm_parm9').value) {
		var h_size=document.getElementById('hm_parm9').value;
		if(doc_edit_node.firstChild) {
console.log('flex first child=',doc_edit_node.firstChild,doc_edit_node);
			if(doc_edit_node.firstChild.nodeName=='svg') doc_edit_node.firstChild.setAttribute('height',h_size);
			}
		else {
			if(h_size=='auto') doc_edit_node.setAttribute('height',h_size);
			else parms=parms+'height:'+h_size+';';         //heightの指定は単独のpropertyでOK
			}
		}
	if(document.getElementById('hm_parm10').value) {
		parms=parms+document.getElementById('hm_parm10').value;
console.log('other parms=',document.getElementById('hm_parm10').value);
		}
console.log('******float at set_parm select=',document.getElementById('hm_parm2').selectedIndex);
	if(document.getElementById('hm_parm2').selectedIndex>0) {
		let kind=document.getElementById('hm_parm2').selectedIndex;
		let left_righ='';
			switch(kind) {
				case 0:
					left_righ='';
					break;
				case 1:
					left_righ='left;';
					break;
        			case 2:
					left_righ='right;';
					break;

				}
		if(left_righ!='') parms=parms+'float:'+left_righ;
		}

	if(parms) {
		doc_edit_node.setAttribute('style',parms);
		prev_doc_edit_style=parms;
		}
	else {
		doc_edit_node.removeAttribute('style');
		prev_doc_edit_style=parms;
		}

//	display_current_tag(doc_edit_node);
	} //End og set_html_parms1

    function set_html_parms2() {
console.log('Set parm2');
	var parms='';
	if(document.getElementById('hm_parm11').value) {
		parms=parms+'color:'+document.getElementById('hm_parm11').value+';';
		}
	if(document.getElementById('hm_parm12').value) {
		parms=parms+'background-color:'+document.getElementById('hm_parm12').value+';';
		}
	if(document.getElementById('hm_parm13').value) {
		parms=parms+'font-size:'+document.getElementById('hm_parm13').value+';';
		}
	if(document.getElementById('hm_parm14').selectedIndex==1) {
		parms=parms+'font-weight:bold;';
		}
	if(document.getElementById('hm_parm14').selectedIndex==2) {
		parms=parms+'font-style:italic;';
		}
	if(document.getElementById('hm_parm14').selectedIndex==3) {
		parms=parms+'text-decoration:underline;';
		}
	if(document.getElementById('hm_parm17').value) {
		parms=parms+'line-height:'+document.getElementById('hm_parm17').value+';';
		}
	if(document.getElementById('hm_parm15').selectedIndex>0) {
		let kind=document.getElementById('hm_parm15').selectedIndex;
		let fname;
			switch(kind) {
        			case 1:
					fname='Noto Sans JP';
					break;
     				case 2:
					fname='Noto Serif JP';
					break;
        			case 3:
					fname='Kaisei Opti';
					break;
      				case 4:
					fname='Reggae One';
					break;
      				case 5:
					fname='Kaushan Script';
					break;
				case 6:
					fname='Times New Roman';
					break;
        			case 7:
					fname='Arial';
					break;
        			case 8:
					fname='HGS創英角ﾎﾟｯﾌﾟ体';
					break;
				}
		parms=parms+'font-family:'+"'"+fname+"';";
		}
	if(document.getElementById('hm_parm16').value) {
		parms=parms+document.getElementById('hm_parm16').value;
console.log('other parms=',document.getElementById('hm_parm16').value);
		}

	if(parms) {
		doc_edit_node.setAttribute('style',parms);
		prev_doc_edit_style=parms;
		}
	else {
		doc_edit_node.removeAttribute('style');
		prev_doc_edit_style=parms;
		}

//	display_current_tag(doc_edit_node);
	} //End og set_html_parms2

    function set_html_parms3() {
console.log('Set parm3');
	var parms='';
	if(document.getElementById('tit_mar0').value) {
		parms=parms+'background-color:'+document.getElementById('tit_mar0').value+';';
		}
	if(document.getElementById('tit_mar1').value) {
		parms=parms+'border-top:'+document.getElementById('tit_mar1').value+';';
		}
	if(document.getElementById('tit_mar2').value) {
		parms=parms+'border-bottom:'+document.getElementById('tit_mar2').value+';';
		}
	if(document.getElementById('tit_mar3').value) {
		parms=parms+'border-left:'+document.getElementById('tit_mar3').value+';';
		}
	if(document.getElementById('tit_mar4').value) {
		parms=parms+'border-right:'+document.getElementById('tit_mar4').value+';';
		}
	if(document.getElementById('tit_mar5').value) {
		parms=parms+'padding:'+document.getElementById('tit_mar5').value+';';
		}
	let just = document.getElementById('flex_just');
console.log('flex_just sel=',flex_just.selectedIndex);
    			switch (flex_just.selectedIndex){
      				case 0:               
					var parm1="";
					break;
      				case 1:               
					var parm1="center;";
					break;
      				case 2:               
					var parm1="space-around;";
					break;
      				case 3:               
					var parm1="space-between;";
					break;
      				case 4:               
					var parm1="flex-start;";
					break;
      				case 5:               
					var parm1="flex-end;";
					break;
				}
	if(parm1!="") parms=parms+'justify-content:'+parm1;
	let align = document.getElementById('flex_align');
console.log('flex_align sel=',flex_align.selectedIndex);
    			switch (flex_align.selectedIndex){
      				case 0:               
					var parm2="";
					break;
      				case 1:               
					var parm2="stretch;";
					break;
      				case 2:               
					var parm2="flex-start;";
					break;
      				case 3:               
					var parm2="flex-end;";
					break;
      				case 4:               
					var parm2="center;";
					break;
				}
	if(parm2!="") {
		if(doc_edit_node.nodeName=='P' || doc_edit_node.nodeName[0]=='H') parms=parms+'text-align:'+parm2;
		else parms=parms+'align-items:'+parm2;
		}
	if(document.getElementById('tit_mar6').value) {
		parms=parms+document.getElementById('tit_mar6').value;
console.log('other parms=',document.getElementById('tit_mar6').value);
		}
	if(document.getElementById('tit_title').value) {
		doc_edit_node.innerHTML=document.getElementById('tit_title').value;
		}
	if(document.getElementById('tit_id').value) {
		doc_edit_node.setAttribute('id', document.getElementById('tit_id').value);
		}
	if(document.getElementById('tit_size').value!='none') {  //nodeNameは変更出来ないので作り直す
		var H_size=document.getElementById('tit_size').value;
		if(doc_edit_node.nodeName!=H_size) {
			//見出しの新規作成
			var par_tag= document.createElement(H_size);
			//par_tag.setAttribute('class', 'title');
			par_tag.setAttribute('fig', '見出し');
			par_tag.innerHTML=document.getElementById('tit_title').value;
			$(par_tag).insertAfter(doc_edit_node);
			doc_edit_node.remove();

			doc_add_first=false;
    			tag_trees=[];
    			tag_trees=get_tagStruct(par_tag,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=par_tag;
			doc_origin_node=par_tag;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
			cancel_green_line();
			setto_current_tag(doc_edit_node);
			set_parms();
			}
		}

	if(parms) {
console.log('at set_parms3 node=',doc_edit_node,'parm=',parms);
		doc_edit_node.setAttribute('style',parms);
		prev_doc_edit_style=parms;
		}
	else {
		doc_edit_node.removeAttribute('style');
		prev_doc_edit_style=parms;
		}

//	display_current_tag(doc_edit_node);
	} //End og set_html_parms3

    function set_html_parms4() {
console.log('Set parm4');
	var parms='';
/*
	if(document.getElementById('im_pam1').value) {
		parms=parms+'width:'+document.getElementById('im_pam1').value+';';
		}
	if(document.getElementById('im_pam2').value) {
		parms=parms+'height:'+document.getElementById('im_pam2').value+';';
		}
*/
	if(document.getElementById('im_pam3').value) {
		parms=parms+'padding:'+document.getElementById('im_pam3').value+';';
		}
	if(document.getElementById('im_pam6').value) {
		parms=parms+document.getElementById('im_pam6').value;
console.log('other parms=',document.getElementById('im_pam6').value);
		}

	if(doc_edit_node.nodeName=='A'){
console.log('Enter set_parm4 <A>tag',document.getElementById('im_pam5').value,doc_edit_node.innerHTML);
		if(document.getElementById('link_targ').value) {
			doc_edit_node.href=document.getElementById('link_targ').value;
			}
		if(document.getElementById('im_pam5').value) {
			doc_edit_node.innerHTML=document.getElementById('im_pam5').value;
			}		
		}
	if(doc_edit_node.nodeName=='IMG'){
console.log('Enter set_parm4 <IMG>tag');
		if(document.getElementById('link_targ').value) {  //src
			doc_edit_node.src=document.getElementById('link_targ').value;
			}
		if(document.getElementById('im_pam4').value) {  //画像alt
			var alt=document.getElementById('im_pam4').value;
			doc_edit_node.setAttribute('alt', alt);
			}
		if(document.getElementById('im_pam5').value) {  //画像説明
			doc_edit_node.caption.innerHTML=document.getElementById('im_pam5').value;
			}		
		}
	if(doc_edit_node.nodeName=='I'){
		if(document.getElementById('link_targ').value) {
			var font_code=document.getElementById('link_targ').value;
			doc_edit_node.setAttribute('class', font_code);
console.log('node=',doc_edit_node);
			doc_edit_node.innerHTML=' ';
			}
		}

	if(parms) {
		doc_edit_node.setAttribute('style',parms);
		prev_doc_edit_style=parms;
		}
	else {
		doc_edit_node.removeAttribute('style');
		prev_doc_edit_style=parms;
		}

//	display_current_tag(doc_edit_node);
	} //End og set_html_parms4

   function clear_parms() {
	document.getElementById('hm_mar1').value="";
	document.getElementById('hm_mar2').value="";
	document.getElementById('hm_parm1').value="";
	document.getElementById('hm_parm2').selectedIndex=0;
	document.getElementById('hm_parm3').value="";
	document.getElementById('hm_parm4').value="";
	document.getElementById('hm_parm5').value="";
	document.getElementById('hm_parm6').value="";
	document.getElementById('hm_parm7').value="";
	document.getElementById('hm_parm8').value="";
	document.getElementById('hm_parm9').value="";
	document.getElementById('hm_parm10').value="";


	document.getElementById('hm_parm11').value="";
	document.getElementById('hm_parm12').value="";
	document.getElementById('hm_parm13').value="";
	document.getElementById('hm_parm14').selectedIndex=0;
	document.getElementById('hm_parm15').selectedIndex=0;
	document.getElementById('hm_parm16').value="";
	document.getElementById('hm_parm17').value="1.5";

	document.getElementById('tit_mar0').value="";
	document.getElementById('tit_mar1').value="";
	document.getElementById('tit_mar2').value="";
	document.getElementById('tit_mar3').value="";
	document.getElementById('tit_mar4').value="";
	document.getElementById('tit_mar5').value="";
	document.getElementById('tit_mar6').value="";
	document.getElementById('tit_title').value="";
	document.getElementById('tit_id').value="";
	document.getElementById('tit_size').selectedIndex=0;
	document.getElementById('flex_just').selectedIndex=0;
	document.getElementById('flex_align').selectedIndex=0;


//	document.getElementById('im_pam1').value="";
//	document.getElementById('im_pam2').value="";
	document.getElementById('im_pam3').value="";
	document.getElementById('im_pam4').value="";
	document.getElementById('im_pam5').value="";
	document.getElementById('im_pam6').value="";
	document.getElementById('link_targ').value="";
	document.getElementById('im_pos').selectedIndex=0;
	document.getElementById('im_float').selectedIndex=0;
console.log('****clear float parm=',document.getElementById('hm_parm2').selectedIndex);
	}

    function place_to_tag(parm) {
    var parm_tx;
    if(parm==undefined) parm_tx='text';
    else parm_tx=parm;
    dl_forbid=false;
console.log('Enter place_to_tag parm=',parm);
//  2022.5.14 常時current_tagを捉えるための変更でコメント化
//  2022.5.19 Image取得後のgreen_line表示には必要なので5.14の変更から戻す
    if(Drag_elem) {
	doc_edit_node=Drag_elem;
	Drag_elem=null;
	}
    else {
    	var selectedText = window.getSelection().toString();
console.log('sel text=',selectedText);
	if(selectedText=='') {
console.log('return place_to_tag');
//			return;
		}

    	var sel = window.getSelection();
	var range = sel.getRangeAt(0);
console.log('selection=',sel,'range=',range);
    	if(!sel.rangeCount) {
		if(doc_deep_level>=0) {
			alert('Any text selection need');
			return; //範囲選択されている箇所がない場合は何もせず終了
			}
		return;
		}
    	if(sel.focusNode.nodeName!='#text') {
//console.log('select Node=',sel.focusNode);
//		alert('selection not text',sel.focusNode.nodeName);
		return;
		}
        cancel_green_line();    //20230123 spanなどのgreenline残留をなくす為に採用
//    	doc_edit_node = sel.focusNode;　　//2022.2.14  tagのindexOfのベース
    	var par_n = sel.focusNode.parentNode;
	doc_edit_node=par_n;     //2022.2.14  tagのindexOfのベース
console.log('sel focus=',sel.focusNode,doc_edit_node,' parent=',par_n);
	}　　//　この１行2022.5.14変更でコメント化　→　2022.5.19元に戻す
//console.log('data=',sel.baseNode.data);
　　//range.startContainer.data.setSelectionRange(1,1);
    //sel.focusNode.focusOffset=sel.anchorNode.anchorOffset;
    //sel.baseNode.baseOffset=sel.anchorNode.anchorOffset;
    //sel.extentNode.extentOffset=sel.anchorNode.anchorOffset;
    present_node=sel.focusNode;
    sel.isCollapsed=true;
    doc_origin_node=doc_edit_node;
    doc_origin_level=0;
    tag_trees=[];
    tag_trees=get_tagStruct(doc_origin_node,0);
    var result=check_html_hist(doc_edit_node,tag_trees,tag_trees[0].level,parm_tx);
    var sib_prev=doc_edit_node.previousSibling;
    var sib_next=doc_edit_node.nextSibling;
    combined_sib_prev=0;
    combined_sib_next=0;
    if(sib_prev!=null && sib_prev.innerHTML!=undefined) {
console.log('nbsp prev in=',sib_prev,sib_prev.innerHTML,'parent=',sib_prev.parentNode);
	sib_prev.innerHTML=from_nbsp(sib_prev.innerHTML);
console.log('combined text prev=',sib_prev);
    	if(sib_prev.innerHTML) combined_sib_prev=sib_prev.innerHTML.length;
console.log('combined leng prev=',combined_sib_prev);
    	}
    if(sib_next!=null && sib_next.innerHTML!=undefined) {
console.log('nbsp next in=',sib_next,sib_next.innerHTML,'parent=',sib_next.parentNode);
	sib_next.innerHTML=from_nbsp(sib_next.innerHTML);
console.log('combined text next=',sib_next);
    	if(sib_next.innerHTML) combined_sib_next=sib_next.innerHTML.length;
console.log('combined leng next=',combined_sib_next);
    	}

    if(tag_trees.length>0) doc_deep_level=0;
console.log('*****tag tree=',tag_trees);
    if(tag_trees[0].tag=='#text') {
	doc_edit_node=par_n;
	doc_deep_level=1;
	doc_origin_node=doc_edit_node;
	doc_origin_level=1;
	}
console.log('set origin node=',doc_origin_node);
    } //End of place_to_tag

var combined_sib_prev;
var combined_sib_next;
var bs_hist_flag=false;
var dl_hist_flag=false;
var bs_prev_node;
var dl_next_node;
var dl_forbid=false;
 
    function check_place_bs() {
console.log('Enter check BS');
   if(Editmode!="Edit") return false;
    else {
	bs_hist_flag=false;
	var del_true=true;
	if(doc_edit_node.nodeName=='P') {    //修正は条件によってこのnodeでは完結せずnodeの合体などに及ぶ
		del_true=bs_node();
		if(!del_true && bs_prev_node==null) {   //P nodeの先頭まで来た時
			if(doc_edit_node.previousSibling==null) {    //div中の単独p
				del_true=false;
				bs_hist_flag=false;
				}
			else if(doc_edit_node.previousSibling.nodeName=='P') {    //prev nodeと合体する
				del_true=false;
				bs_hist_flag=true;
				}
			var check=(encode(doc_edit_node.previousSibling)=='5bobject20htmlbrelement5d');
			if(check) {
				doc_edit_node.previousSibling.remove();
//この時点でprev nodeのcombined_sib_prevを再取得する
    				var sib_prev=doc_edit_node.previousSibling;
    				combined_sib_prev=0;
    				if(sib_prev!=null && sib_prev.innerHTML!=undefined) {
					sib_prev.innerHTML=from_nbsp(sib_prev.innerHTML);
    					if(sib_prev.innerHTML) combined_sib_prev=sib_prev.innerHTML.length;
    					}
console.log('delete <br> node');
				}
console.log('previous=',doc_edit_node.previousSibling);
			}
		else if(!del_true && bs_prev_node!=null) {   //P nodeの先頭まで来た時
			var check=(encode(bs_prev_node)=='5bobject20htmlbrelement5d');
			if(check) {
				bs_prev_node.remove();
console.log('delete <br> node');
				}
console.log('previous in P node=',bs_prev_node);
			}

		}
	else {      //P nodeではない場合修正はこのnodeで完結する
		del_true=bs_node();
		}
	}
    return del_true;
    } //End of check_place_bs

function bs_node() {
	var del_true=true;
		var sel = window.getSelection();
		bs_prev_node=sel.focusNode.previousSibling;
		var wtext=sel.focusNode.wholeText;
		var wleng=sel.focusNode.wholeText.length;
		var woff=sel.focusOffset;
console.log('sel=',sel,sel.focusOffset,'wtext,wleng,woff=',wtext,wleng,woff);
		if(sel.focusOffset<=1) del_true=false;
	return del_true;
	}

    function check_place_del() {
console.log('Enter check Del');
   if(Editmode!="Edit") return false;
    else {
	dl_hist_flag=false;
	dl_forbid=false;
	if(doc_edit_node.nodeName=='P') {    //修正は条件によってこのnodeでは完結せずnodeの合体などに及ぶ
		dl_node();
		if(dl_forbid && dl_next_node==null) {   //P nodeの最後まで来た時
			if(doc_edit_node.nextSibling==null) {    //div中の単独p
				dl_forbid=true;
				dl_hist_flag=false;
				}
			else if(doc_edit_node.nextSibling.nodeName=='P') {    //next nodeと合体する
				dl_forbid=true;
				dl_hist_flag=true;
				}
			var check=(encode(doc_edit_node.nextSibling)=='5bobject20htmlbrelement5d');
			if(check) {
				doc_edit_node.nextSibling.remove();
//この時点でnext nodeのcombined_sib_nextを再取得する
    				var sib_next=doc_edit_node.nextSibling;
    				combined_sib_next=0;
    				if(sib_next!=null && sib_next.innerHTML!=undefined) {
					sib_next.innerHTML=from_nbsp(sib_next.innerHTML);
    					if(sib_next.innerHTML) combined_sib_next=sib_next.innerHTML.length;
    					}

console.log('delete <br> node');
				}
console.log('next=',doc_edit_node.nextSibling);
			}
		else if(dl_forbid && dl_next_node!=null) {   //P nodeの最後まで来た時
			var check=(encode(dl_next_node)=='5bobject20htmlbrelement5d');
			if(check) {
				dl_next_node.remove();
console.log('delete <br> node');
				}
console.log('next in P node=',dl_next_node);
			}
		else if(dl_forbid && sel.focusNode.parentNode.nextSibling==null) {
				dl_hist_flag=false;
				dl_forbid=true;
console.log("@@@@WWWWWWWWW ")
				}
		}
	else {      //P nodeではない場合修正はこのnodeで完結する
		dl_node();
		}
	}
    } //End of check_place_del

function dl_node() {
	dl_forbid=false;
		var sel = window.getSelection();
		dl_next_node=sel.focusNode.nextSibling;
		var wtext=sel.focusNode.wholeText;
		var wleng=sel.focusNode.wholeText.length;
		var woff=sel.focusOffset;
console.log('sel=',sel,sel.focusOffset,'wtext,wleng,woff=',wtext,wleng,woff);
		if(wleng==sel.focusOffset || wleng==1) dl_forbid=true;
	}


/*
    function check_place_bs() {
console.log('Enter check BS');
   if(Editmode!="Edit") return false;
    else {
    	const selectedText = window.getSelection().toString();
console.log('seltext=',selectedText);
    	var sel = window.getSelection();
	bs_prev=sel.focusNode.previousSibling;
	var check=(encode(bs_prev)=='5bobject20htmlbrelement5d');
	if(check) return true;

	var wtext=sel.focusNode.wholeText;
	var wleng=sel.focusNode.wholeText.length;
	var woff=sel.focusOffset;
console.log('sel=',sel,sel.focusOffset,'wtext,wleng,woff=',wtext,wleng,woff)
//after editor_230106_af_bsdlsp
	bs_parent=sel.focusNode.parentNode;
console.log('Node=',sel.focusNode,'prev=',sel.focusNode.previousSibling,'parent=',sel.focusNode.parentNode);
	var del_true=true;
	if(bs_parent.nodeName=='P') {
		if(bs_parent.nodeName!='P') del_true=false;
		if(sel.focusOffset<=0 && bs_parent.nodeName=='P') {
			bs_hist_flag=true;
			del_true=false;
			}
//if(bs_parent!=null) console.log('parent prevNode=',bs_parent.previousSibling.nodeName);
		if(sel.focusOffset<=0 && sel.focusNode.previousSibling==null && (bs_parent.previousSibling!=null && bs_parent.previousSibling.nodeName!='P')) {
console.log('last check');
			bs_hist_flag=false;
			del_true=false;
			}
		}
	else if(sel.focusOffset<=1) del_true=false;
console.log('present=',present_node,'focus=',sel.focusNode);
	}
    return del_true;
    } //End of check_place_bs

    function check_place_del() {
console.log('Enter check Del');
   if(Editmode!="Edit") return false;
    else {
    	const selectedText = window.getSelection().toString();
console.log('seltext=',selectedText);
    	var sel = window.getSelection();
	var wtext=sel.focusNode.wholeText;
	var wleng=sel.focusNode.wholeText.length;
	var woff=sel.focusOffset;
console.log('sel=',sel,sel.focusOffset,'wtext,wleng,woff=',wtext,wleng,woff)
//after editor_230106_af_bsdlsp
	var dl_next=sel.focusNode.nextSibling;
	var dl_parent=sel.focusNode.parentNode;
console.log('Node=',sel.focusNode.nodeName,'next=',dl_next,'parent=',dl_parent);
	dl_forbid=false;
	if(dl_parent.nodeName=='P') {
		if(dl_next==null && dl_parent.nodeName!='P') dl_forbid=true;
console.log('<br>check=',dl_next=='BR',dl_next=='<br>',encode(dl_next)=='5bobject20htmlbrelement5d');
		if(wleng==sel.focusOffset || wleng==1) {
			var check=(encode(dl_next)=='5bobject20htmlbrelement5d');
			if((dl_next!=null && dl_next.nodeName!='P') && !check) dl_forbid=true;
			else {
				dl_hist_flag=true;
				dl_forbid=true;
				}
			}
		}
	else if(wleng==sel.focusOffset || wleng==1) dl_forbid=true;
console.log('present=',present_node,'focus=',sel.focusNode);
	}
    } //End of check_place_del
*/

function encode(str){
    str = encodeURIComponent(str).split('%').join('');
    return str.toLowerCase();
}

  $("#add_tag").on("click", function(){
//	add_tag_func();
	my_confirm(14);
	});

function check_structure_tag(ch_node) {
	var node=ch_node.nodeName;
	ch_struct=0;

	if(node=='P' || node=='TABLE' || node[0]=='H' || node=='OL' || node=='UL' || node=='NAV') ch_struct=1;
	
	if(node=='DIV') {
		var fig_type=ch_node.getAttribute('fig');
		if(fig_type=='大枠' || fig_type=='横小枠' || fig_type=='縦小枠' || fig_type=='table')　ch_struct=(ch_struct || 1);
		}

	return ch_struct;
	}

function typ_next() {
//style画面変更ボタンでstyle画面表示を順番に変更する。
//各style画面では個別の設定ボタンで各画面のstyle属性が変更される
	var style_Dia=$( '#my_style_design' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:260, width: 420} );
	style_Dia.dialog("open");
	
console.log('**Type change on but mode =',tag_change_mode);

	if(tag_change_mode) {
		document.getElementById("ui-id-2").innerHTML="style画面--"+document.getElementById("lb_styl_num").innerHTML+"----"+document.getElementById("lb_styl_for").innerHTML;
		return;
		}
	if(typ_chng_flg==0 || my_style_design_dialog==0) typ_chng_flg=1;
	else typ_chng_flg+=1;
	if(typ_chng_flg>4) typ_chng_flg=1;
	my_style_design_dialog=1;
	typ_chng();
	document.getElementById("ui-id-2").innerHTML="style画面--"+document.getElementById("lb_styl_num").innerHTML+"----"+document.getElementById("lb_styl_for").innerHTML;
	check_attr(doc_edit_node,prev_doc_edit_style,typ_chng_flg);
    }

function typ_chng() {
console.log('**Type change on flag=',typ_chng_flg);
	if(typ_chng_flg==1) {		//基本配置
		document.getElementById("lb_styl_num").innerHTML='1';
		submenu01=document.getElementById('submenu01');
       		submenu01.style.display='block';
		submenu_01=document.getElementById('submenu_01');
		submenu_01.style.display='block';
		submenu02=document.getElementById('submenu02');
       		submenu02.style.display='none';
		submenu_02=document.getElementById('submenu_02');
		submenu_02.style.display='none';
		submenu03=document.getElementById('submenu03');
       		submenu03.style.display='none';
		submenu_03=document.getElementById('submenu_03');
		submenu_03.style.display='none';
		submenu04=document.getElementById('submenu04');
       		submenu04.style.display='none';
		submenu_04=document.getElementById('submenu_04');
		submenu_04.style.display='none';
		}
	if(typ_chng_flg==2) {		//文字書式
		document.getElementById("lb_styl_num").innerHTML='2';
		submenu01=document.getElementById('submenu01');
       		submenu01.style.display='none';
		submenu_01=document.getElementById('submenu_01');
		submenu_01.style.display='none';
		submenu02=document.getElementById('submenu02');
       		submenu02.style.display='block';
		submenu_02=document.getElementById('submenu_02');
		submenu_02.style.display='block';
		submenu03=document.getElementById('submenu03');
       		submenu03.style.display='none';
		submenu_03=document.getElementById('submenu_03');
		submenu_03.style.display='none';
		submenu04=document.getElementById('submenu04');
       		submenu04.style.display='none';
		submenu_04=document.getElementById('submenu_04');
		submenu_04.style.display='none';
		}
	if(typ_chng_flg==3) {		//並び・装飾
		document.getElementById("lb_styl_num").innerHTML='3';
		submenu01=document.getElementById('submenu01');
       		submenu01.style.display='none';
		submenu_01=document.getElementById('submenu_01');
		submenu_01.style.display='none';
		submenu02=document.getElementById('submenu02');
       		submenu02.style.display='none';
		submenu_02=document.getElementById('submenu_02');
		submenu_02.style.display='none';
		submenu03=document.getElementById('submenu03');
       		submenu03.style.display='block';
		submenu_03=document.getElementById('submenu_03');
		submenu_03.style.display='block';
		submenu04=document.getElementById('submenu04');
       		submenu04.style.display='none';
		submenu_04=document.getElementById('submenu_04');
		submenu_04.style.display='none';
		}
	if(typ_chng_flg==4) {		//画像・リンク
		document.getElementById("lb_styl_num").innerHTML='4';
		submenu01=document.getElementById('submenu01');
       		submenu01.style.display='none';
		submenu_01=document.getElementById('submenu_01');
		submenu_01.style.display='none';
		submenu02=document.getElementById('submenu02');
       		submenu02.style.display='none';
		submenu_02=document.getElementById('submenu_02');
		submenu_02.style.display='none';
		submenu03=document.getElementById('submenu03');
       		submenu03.style.display='none';
		submenu_03=document.getElementById('submenu_03');
		submenu_03.style.display='none';
		submenu04=document.getElementById('submenu04');
       		submenu04.style.display='block';
		submenu_04=document.getElementById('submenu_04');
		submenu_04.style.display='block';
		}
	if(tag_change_mode) document.getElementById("lb_styl_for").innerHTML='<span style="color:red;">追加タグ用</span>';
		else document.getElementById("lb_styl_for").innerHTML='現在タグ用';
	document.getElementById("lb_styl_num").innerHTML=String(typ_chng_flg);
    }

function tag_change() {
//sel_var!=0ならばtag_change_mode=n　となってstyleメニューは固定となり、tagの追加でstyle値を変更する
	let sel_var=document.getElementById('sel_add_tag').selectedIndex;
console.log('*****Enter tag change select=',sel_var,'change_mode=',tag_change_mode);

	var tag_name=document.getElementById('sel_add_tag').value;
console.log('**New tag selected tag_name=',tag_name);

	document.getElementById("Label_01").innerHTML='';
	//document.getElementById("Label_02").style.display='none';

	if(sel_var==0) {
		tag_change_mode=0;
		return;
		}
	else tag_change_mode=sel_var;

//挿入Tag用にすべてのparmsをクリアする
	clear_parms();

	    	switch (tag_name){
      		case 'none':
console.log('none');
//			typ_chng_flg=1;		//基本配置  Add後はstyle画面はそのままにする
			break;
      		case 'div':
console.log('DIV');
			typ_chng_flg=1;		//基本配置
			document.getElementById("hm_parm2").selectedIndex = 1;
			document.getElementById('hm_parm9').value='auto';
			document.getElementById('hm_parm8').value='50%';
			document.getElementById('hm_parm5').value='solid 1px #008080';
			document.getElementById('hm_parm6').value='5px';
			document.getElementById('hm_mar2').value='20px';
			break;
      		case 'flex':
console.log('flex');
			typ_chng_flg=3;		//並び・装飾
			document.getElementById("Label_01").innerHTML = ' 分割数:<input type="text" id="hm_numb" value="3" style="width:30px;"></label><label>&nbsp;width%:<input type="text" id="flex_width" value="" style="width:80px;"></label><br>';
			var hm_numb=Number(document.getElementById('hm_numb').value);
			dwidth='';
			if(hm_numb<2) hm_numb=2;
			if(hm_numb>10) hm_numb=10;
			document.getElementById('hm_numb').value=hm_numb;
			var w_parm=document.getElementById('flex_width').value;
			if(w_parm==''){
				var dwidth=Math.round(100/hm_numb*10)/10;
				var parm_w=[String(dwidth)+'%'];
				document.getElementById('flex_width').value=parm_w;
				}
			else {
				var parm_w=w_parm.split(' ');
				}
			leng_wd=parm_w.length;
console.log('width%=',parm_w);
			document.getElementById("flex_just").selectedIndex = 2;
			document.getElementById("flex_align").selectedIndex = 2;
//			document.getElementById("flex_just").value = 'space-around';
//			document.getElementById("flex_align").value = 'start';
			break;
      		case 'colm_flex':
console.log('colm_flex');
			typ_chng_flg=1;		//基本配置
			document.getElementById("Label_01").innerHTML = ' 分割数:<input type="text" id="hm_numb" value="3" style="width:30px;"></label><label>&nbsp;height%:<input type="text" id="flex_width" value="" style="width:80px;"></label><br>';
			var hm_numb=Number(document.getElementById('hm_numb').value);
			dwidth='';
			if(hm_numb<2) hm_numb=2;
			if(hm_numb>10) hm_numb=10;
			document.getElementById('hm_numb').value=hm_numb;
			var w_parm=document.getElementById('flex_width').value;
			if(w_parm==''){
				var dwidth=Math.round(100/hm_numb*10)/10;
				var parm_w=[String(dwidth)+'%'];
				document.getElementById('flex_width').value=parm_w;
				}
			else {
				var parm_w=w_parm.split(' ');
				}
			leng_wd=parm_w.length;
console.log('width%=',parm_w);
			document.getElementById("flex_just").selectedIndex = 2;
			document.getElementById("flex_align").selectedIndex = 2;
			break;
      		case 'ul': 
      		case 'ol': 
console.log('ul or ol');
			typ_chng_flg=1;		//基本配置
			document.getElementById("Label_01").innerHTML = ' 項目数:<input type="text" id="hm_numb" value="3" style="width:30px;">';
			document.getElementById('hm_mar1').value='20px';
			document.getElementById('hm_parm10').value='list-style-position:inside;';
			break;
		case 'nav_menu':
console.log('nav_menu');
			typ_chng_flg=1;		//基本配置
			document.getElementById("Label_01").innerHTML = ' 項目数:<input type="text" id="hm_numb" value="5" style="width:30px;">';
			document.getElementById('hm_mar2').value='200px';
			//document.getElementById('hm_parm10').value='list-style-type: none;';
			document.getElementById('hm_parm1').value='white';
//			document.getElementById('hm_parm2').value='blue';
			document.getElementById('link_targ').value='https://www.google.com/';
			document.getElementById('im_pam5').value='google';
			//document.getElementById('hm_parm14').value='bold';
			document.getElementById('hm_parm14').selectedIndex = 1;
			break;
      		case 'title':               
console.log('title');
			typ_chng_flg=3;		//並び・装飾
			document.getElementById("tit_size").selectedIndex = 4;
			document.getElementById('tit_mar1').value='2px double #ccc';
			document.getElementById('tit_mar2').value='4px solid #ccc';
			document.getElementById('tit_mar3').value='8px solid #ccc';
			document.getElementById('tit_mar4').value='6px double #000';
			document.getElementById('tit_mar5').value='1rem 2rem';
			break;
      		case 'photo':               
console.log('photo');
			typ_chng_flg=4;		//画像・リンク
			break;
      		case 'p_tag':               
console.log('p_tag');
			typ_chng_flg=1;		//基本配置
			break;
      		case 'svg_indiv':               
console.log('svg_indiv tag');
			typ_chng_flg=1;		//make svg tag in div
			var wid=doc_edit_node.style.width;
console.log('now_tag=',doc_edit_node,wid);
			document.getElementById('hm_parm8').value=wid;
			document.getElementById('hm_parm9').value='auto';
			break;
      		case 'table':
console.log('table');
			typ_chng_flg=4;		//並び・装飾
			document.getElementById("Label_01").innerHTML =' 表題:<input type="text" id="ta_head" value="有" style="width:20px;"></label>&nbsp; 列数(表題):<input type="text" id="hm_numb" value="5" style="width:30px;"></label><label>&nbsp;行数:<input type="text" id="tabl_cols" value="3" style="width:30px;"></label><br>';
			var hm_numb=Number(document.getElementById('hm_numb').value);
			if(hm_numb<2) hm_numb=2;
			if(hm_numb>10) hm_numb=10;
			document.getElementById('hm_numb').value=hm_numb;
			var rows=document.getElementById('tabl_cols').value;
			document.getElementById('tabl_parm01').value='1px solid black;';

//text-align: center;        /* セルを中央寄せ */
//  border-collapse: collapse; /* セルの境界線を空けない */
//  border: 1px solid black;   /* テーブル全体を囲う線 */

			break;
      		case 'span':               
console.log('span');
			typ_chng_flg=2;		//文字書式
			break;
      		case 'button': 	//リンク先、Title、width、height、padding             
console.log('button');
			typ_chng_flg=4;		//画像・リンク
			document.getElementById('link_targ').value='https://www.google.com/';
			document.getElementById('im_pam5').value='google';
			//document.getElementById('im_pam1').value='100px';
			//document.getElementById('im_pam2').value='50px';
			document.getElementById('im_pam6').value='width:100px;height:50px;color:white;background-color:blue;font-weight:bold;padding:0.5em 0.5em;  border:blue 1px solid; border-radius:6px;';
			//document.getElementById('hm_parm1').value='white';
			//document.getElementById('hm_parm2').value='black';
			//document.getElementById('hm_parm14').selectedIndex = 1;
			break;
      		case 'I_con': 	//リンク先、Title
console.log('Icon');
			typ_chng_flg=4;		//画像・リンク
			document.getElementById('link_targ').value='fa fa-map-marker fa-lg fa-fw';
			break;
      		case 'link': 	//リンク先、Title
console.log('link');
			typ_chng_flg=4;		//画像・リンク
			document.getElementById('link_targ').value='https://www.google.com/';
			document.getElementById('im_pam5').value='google';
			break;
/*
      		case 'nav_menu': 	//リンク先、Title
console.log('link');
			typ_chng_flg=3;		//並び・装飾
			document.getElementById("Label_01").innerHTML = ' メニュー数:<input type="text" id="hm_numb" value="5" style="width:30px;"></label><label>&nbsp;width%:<input type="text" id="flex_width" value="" style="width:80px;"></label><br>';
			var hm_numb=Number(document.getElementById('hm_numb').value);
			dwidth='';
			if(hm_numb<2) hm_numb=2;
			if(hm_numb>10) hm_numb=10;
			document.getElementById('hm_numb').value=hm_numb;
			var w_parm=document.getElementById('flex_width').value;
			if(w_parm==''){
				var dwidth=Math.round(100/hm_numb*10)/10;
				var parm_w=[String(dwidth)+'%'];
				document.getElementById('flex_width').value=parm_w;
				}
			else {
				var parm_w=w_parm.split(' ');
				}
			leng_wd=parm_w.length;
console.log('width%=',parm_w);
			document.getElementById('tit_mar6').value='text-align:center; background-color:gold; padding:15px 15px;';
			break;
*/
		case 'recipe':
			add_tag="<i>　recipe　　typ_chng_flg=4:  //画像・リンク　";
console.log('Enter recipe選択');
			recp_list=read_recipe();
			var element = document.getElementById( "style_recipe_tag" ) ;
			for(let k=0;k<recp_list.length;k++) {
				var newElement = new Option(recp_list[k][1],recp_list[k][1]) ;	// <option value="newtag">newtag</option>を追加する
				element.add( newElement );
console.log('recipe menu k=',k,recp_list[k][1],recp_list[k][0]);
				}
			break;
		}
	typ_chng();
	if(my_style_design_dialog) typ_next();
      }  //End of tag_change


  $("#copy_tag").on("click", function(){
console.log('copy node=',doc_edit_node);
//選択中のtagをcopyする前に表示用styleから元に戻す
	var node=doc_edit_node.cloneNode(true);
	if(prev_doc_edit_style==null) prev_doc_edit_style='';
	if(prev_doc_edit_node) {
console.log('prev node =',prev_doc_edit_node.nodeName,prev_doc_edit_style);
		if(prev_doc_edit_style) node.setAttribute('style',prev_doc_edit_style);
		else node.removeAttribute('style');
		}
	var node_class=node.getAttribute('class');
	if(node_class=='divsvg') {
		node.removeAttribute('class');
		node.removeAttribute('id');
		node.removeAttribute('level');
		node.removeAttribute('style');
		}
console.log('modify_node=',node);
//先頭にTag情報を入れる
	var dumy=node.nodeName+'|<=>|'+node.outerHTML;
//console.log('dumy=',dumy);
	update_sysparms(2,dumy);
alert('node copied into my cripboard');
	});

  $("#paste_tag").on("click", function(){
	var from_paste=get_common(2);
	var parms=from_paste.split('|<=>|');
//console.log('paste data=',parms[0],parms[1]);
	var current=document.activeElement;
console.log('****** Focus=',current);

　　	const domParser = new DOMParser();
　　	var htmldoc = domParser.parseFromString(parms[1], 'text/html');
//console.log('htmldoc=',htmldoc);
/*
		var w_tags=htmldoc.querySelectorAll('.work');
console.log('work tags=',w_tags);
		for(let k=0;k<w_tags.length;k++) {
			w_tags[k].removeAttribute('id');
			w_tags[k].removeAttribute('class');
			}
*/
	var node = htmldoc.querySelector('html body > *');
	remove_tempid(node);

//	var node=htmlToNode(parms[1]);
console.log('paste node=',node.nodeName,node);
	//<a> <span>　の場合
	if(parms[0]=="A" || parms[0]=="SPAN") {
//alert('click insert paste position');
		var sel = window.getSelection();
  		if(!sel.rangeCount) return; 
  		var range = sel.getRangeAt(0);
    		range.insertNode(node);
		}
	else {
		var level=tag_trees[doc_deep_level].level;
		if(level<=0) {
		var result = window.confirm('先頭への追加となります。追加しますか？');
		if(result==true){
			doc_add_first=true;
			}
			else return;
		}
	if(doc_add_first){
		doc_edit_node.insertBefore(node, doc_edit_node.firstChild);
console.log('add First child');
		}
	else {
		$(node).insertAfter(doc_edit_node);
console.log('not first');
		}
	doc_add_first=false;
	}

    	tag_trees=[];
    	tag_trees=get_tagStruct(node,0);
    	if(tag_trees.length>0) doc_deep_level=0;
	doc_edit_node=node;
	doc_origin_node=node;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
alert('paste node');
	cancel_green_line();
//	setto_current_tag(doc_edit_node);
//	set_parms();
	display_current_tag(doc_edit_node);
	});

function cont_d_copy(){
console.log('html clipboard copy');

	var sel = window.getSelection().toString();
  	if(!sel) {
alert('any text selected!!');
		return;
		}

//	sel=doc_edit_node;
console.log('sel dom=',sel)

	copyTextToClipboard(sel);
	document.execCommand("copy");
	//container.removeChild(group);

	document.getElementById('contextmenu_d').style.display="none";
   }

function copy_shiftleft_mouse(target_id){
console.log('html design column copy');

	var clm_data=document.getElementById(target_id).value;

	copyTextToClipboard(clm_data);
	document.execCommand("copy");
	//container.removeChild(group);
	window.getSelection().removeAllRanges();

	document.getElementById('contextmenu_d').style.display="none";
   }

function cont_d_paste(){
console.log('html clipboard paste');

	document.getElementById('contextmenu_d').style.display="none";

 navigator.permissions.query({ name: 'clipboard-read' }).then(result => {
            // If permission to read the clipboard is granted or if the user will
            // be prompted to allow it, we proceed.

            if (result.state === 'granted' || result.state === 'prompt') {
		getClipboardContents();
		after_clipboard_a();
		}
	   });
    }

function cont_d_menu2_b(range){
console.log('html clipboard paste');

	document.getElementById('contextmenu_d').style.display="none";

 navigator.permissions.query({ name: 'clipboard-read' }).then(result => {
            // If permission to read the clipboard is granted or if the user will
            // be prompted to allow it, we proceed.

            if (result.state === 'granted' || result.state === 'prompt') {
		getClipboard_text();
		after_clipboard_b(range);
		}
	   });
    }

function paste_shiftright_mouse(target_id){
console.log('html clipboard paste');

	document.getElementById('contextmenu_d').style.display="none";

 navigator.permissions.query({ name: 'clipboard-read' }).then(result => {
            // If permission to read the clipboard is granted or if the user will
            // be prompted to allow it, we proceed.

            if (result.state === 'granted' || result.state === 'prompt') {
		getClipboard_text();
		after_clipboard_c(target_id);
		}
	   });
    }

function cont_d_cancel(){
	document.getElementById('contextmenu_d').style.display="none";
	return;
   }

//Clipboardからhtmlテキストとして読み出す場合
async function getClipboardContents() {
// ClipboardItem オブジェクトのリストを取得
  const items = await navigator.clipboard.read();

// ClipboardItem オブジェクトを一つずつ調べる
　　	const domParser = new DOMParser();
console.log('from clipboard items length=',items.length);
  var htmldoc='';
  for (let i = 0; i < items.length; i++) {
    // ClipboardItem オブジェクト
    const item = items[i];
 
    // データタイプが "text/html" のデータが存在するかをチェック
    if (item.types.includes('text/html')) {
      // Blob オブジェクトを取得
      const blob = await item.getType('text/html');
      // Blob オブジェクトから HTML テキストを取得
      const html = await blob.text();
      // HTML テキストを出力
	var htmldoc=await (htmldoc+html);
	}
      }
　　　　global_htmldoc = await domParser.parseFromString(htmldoc, 'text/html');
//console.log('parsed=',global_htmldoc);
}

//Clipboardからプレーンテキストとして読み出す場合
async function getClipboard_text() {
  try {
    const text = await navigator.clipboard.readText();
    console.log('Pasted content: ', text);
//　　	const domParser = new DOMParser();
//　　	global_htmldoc = domParser.parseFromString(text, 'text/html');
	global_htmldoc =text;
  } catch (err) {
    console.error('Failed to read clipboard contents: ', err);
  }
}

var global_htmldoc;

async function after_clipboard_a() {
	const result2 = await getClipboardContents();
console.log('global=',global_htmldoc);
	var node = global_htmldoc.querySelectorAll('html body > *');
console.log('paste_node leng=',node.length,node);

	if(node.length>1) {
		var par_tag=document.createElement('div');
		for(let i=0;i<node.length;i++) {
			par_tag.appendChild(node[i]);
			}
		node=par_tag;
		}

	after_clipboard(node);
   }

async function after_clipboard_google() {
	const result2 = await getClipboardContents();
console.log('global=',global_htmldoc);
	var s_node = global_htmldoc.querySelectorAll('html body > *');
console.log('paste_node leng=',s_node.length,s_node);
//この段階でA>H3の場合もある
	var node=document.createElement('div');
	
	for(k=0;k<s_node.length;k++) {
		var c_name=s_node[k].getAttribute('class');
console.log('s_node[i]=',s_node[k].nodeName,c_name);
console.log('Yes/No=',c_name=='MjjYud');
		if(s_node[k].nodeName=='DIV' && c_name=='MjjYud') {
console.log('only one search');
			one_search(s_node[k],node);
			}
		else {
			var d_node=s_node[k].querySelectorAll('DIV.MjjYud');
console.log('d_node=',d_node,d_node.length);
			for(let l=0;l<d_node.length;l++) {
console.log('batch search l=',l);
				one_search(d_node[l],node);
				}
			}
		}

//	one_search(ss_node,node);
/*
	for(i=0;i<s_node.length;i++) {
		var exst1=s_node[i].querySelectorAll('A>H3');

console.log('extract1=',i,exst1);
		exst1.forEach(function (element) {
			var par_tag=element.parentNode;
console.log('search=',par_tag);//粗これで良いか？

			var title=par_tag.querySelector('H3').innerText;
			var new_title=document.createElement('H4');
			new_title.innerText=title;
			new_title.setAttribute('fig', '見出し');
			var href=par_tag.getAttribute( "href");
    			var newNode =document.createElement('a');
    			newNode.href=href;
    			newNode.setAttribute('fig', 'リンク');
    			newNode.appendChild(new_title);
    			newNode.setAttribute('target', '_blank');
    			newNode.setAttribute('rel', 'noopener');
console.log('newNode=',title,newNode,new_title);
			node.appendChild(newNode);
//.MUxGbd.wuQ4Ob.WZ8Tjf
//OK			var text_a=s_node.querySelector('SPAN');
			var text_b="";

			var node_a=s_node[i].querySelectorAll('SPAN.wuQ4Ob.WZ8Tjf');
			if(node_a.length>0) {
console.log('s_node num=',i,' node_a=',node_a,node_a[0]);
				var grand=node_a[0].parentNode;
				text_b=grand.innerText;
				}
			else {
				var node_b=s_node[i].querySelectorAll('DIV SPAN');
				var text_a="";
				text_b="";
				for(k=0;k<node_b.length;k++) {
					text_a=(node_b[k].parentNode).innerText;
					if(text_a.length>20) text_b=text_b+text_a;
					}
//console.log('cant catch abstract text=',text_b,node_b);
				}
			if(text_b!="") {
				var text_p=document.createElement('P');
				text_p.innerText=text_b;
console.log('text=',text_b);
				node.appendChild(text_p);
				}
			});
	}
*/

	if(!doc_edit_node) alert('set green line!!');
	else $(node).insertAfter(doc_edit_node);

    	tag_trees=[];
    	tag_trees=get_tagStruct(node,0);
    	if(tag_trees.length>0) doc_deep_level=0;
	doc_edit_node=node;
	doc_origin_node=node;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
	display_current_tag(doc_edit_node);
	}

function one_search(s_node,node) {
	var element=s_node.querySelector('A>H3');
console.log('one_search element=',element);
	if(element==null) return;
			var par_tag=element.parentNode;
console.log('search=',par_tag);//粗これで良いか？

			var title=par_tag.querySelector('H3').innerText;
			var new_title=document.createElement('H4');
			new_title.innerText=title;
			new_title.setAttribute('fig', '見出し');
			var href=par_tag.getAttribute( "href");
    			var newNode =document.createElement('a');
    			newNode.href=href;
    			newNode.setAttribute('fig', 'リンク');
    			newNode.appendChild(new_title);
    			newNode.setAttribute('target', '_blank');
    			newNode.setAttribute('rel', 'noopener');
console.log('newNode=',title,newNode,new_title);
			node.appendChild(newNode);
//.MUxGbd.wuQ4Ob.WZ8Tjf
//OK			var text_a=s_node.querySelector('SPAN');
			var text_b="";

			var node_a=s_node.querySelectorAll('SPAN.wuQ4Ob.WZ8Tjf');
			if(node_a.length>0) {
console.log('s_node num=',i,' node_a=',node_a,node_a[0]);
				var grand=node_a[0].parentNode;
				text_b=grand.innerText;
				}
			else {
				var node_b=element.querySelectorAll('DIV SPAN');
				var text_a="";
				text_b="";
				for(let k=0;k<node_b.length;k++) {
					text_a=(node_b[k].parentNode).innerText;
					if(text_a.length>20) text_b=text_b+text_a;
					}
//console.log('cant catch abstract text=',text_b,node_b);
				}
			if(text_b!="") {
				var text_p=document.createElement('P');
				text_p.innerText=text_b;
console.log('text=',text_b);
				node.appendChild(text_p);
				}

	}

function after_clipboard_goog(node) {
console.log('paste node length=',node);

	new_node=[];
	for(let k=0;k<node.length;k++) {
	　var exst1=node[k].querySelectorAll('.yuRUbf> A');

console.log('extract1=',exst1);
//	  new_node.push({exst1});
	var exst2=node[k].querySelectorAll('span');
console.log('extract2=',exst2);
		}

	node=exst1;

	if(!doc_edit_node) alert('set green line!!');
	else $(node).insertAfter(doc_edit_node);

    	tag_trees=[];
    	tag_trees=get_tagStruct(node,0);
    	if(tag_trees.length>0) doc_deep_level=0;
	doc_edit_node=node;
	doc_origin_node=node;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
	display_current_tag(doc_edit_node);
   }

async function after_clipboard_b(range) {
	const result2 = await getClipboard_text();
//    		var sel = window.getSelection();
//console.log('sel=',sel);
console.log('insert text=',global_htmldoc,'leng=',global_htmldoc.length);
console.log('pos=',range);
console.log('data=',range.startContainer.data);
/*
	// startContainerの親ノードを取得する
	var parentNode = range.startContainer.parentNode;
	// 親ノードの子ノードのリストを取得する
	var childNodes = parentNode.childNodes;
	// startContainerが何番目の子ノードか調べる
	var index = Array.prototype.indexOf.call(childNodes, range.startContainer);

	var index=0;
	var n_pos=sel.focusOffset;
*/
	if(range.startContainer.data===undefined) {
console.log('data undefined');
		range.startContainer.innerHTML=range.startContainer.innerHTML+global_htmldoc;

		}
	else {
		range.startContainer.data = range.startContainer.data.substring(0, range.startOffset)
					+ global_htmldoc 
					+ range.startContainer.data.substring(range.startOffset);

//console.log('doc=',doc_edit_node,'offset=',n_pos);
//		reset_cursor(doc_edit_node,index,n_pos);  	const selection = window.getSelection();
		}
	var sel = window.getSelection();
  	sel.removeAllRanges();
   }

function getCursorPosition() {
  const selection = window.getSelection();
  if (selection.rangeCount === 0) return;

  const range = selection.getRangeAt(0);
  const selectedNode = range.startContainer;
  const selectedOffset = range.startOffset;

  let charCount = 0;
  const childNodes = selectedNode.parentNode.childNodes;
  for (let i = 0; i < childNodes.length; i++) {
    const childNode = childNodes[i];
    if (childNode === selectedNode) {
      charCount += selectedOffset;
      break;
    } else {
      charCount += childNode.textContent.length;
    }
  }

  return { nodeIndex: i, charIndex: charCount };
}

async function after_clipboard_c(target_id) {
	const result2 = await getClipboard_text();
console.log('insert text=',global_htmldoc);
console.log('target=',target_id);
	document.getElementById(target_id).value=global_htmldoc;
   }

function after_clipboard(node) {
console.log('paste node=',node.nodeName,node);
/*
		var level=tag_trees[doc_deep_level].level;
		if(level<=0) {
		var result = window.confirm('先頭への追加となります。追加しますか？');
		if(result==true){
			doc_add_first=true;
			}
			else return;
		}
		if(doc_add_first){
			doc_edit_node.insertBefore(node, doc_edit_node.firstChild);
console.log('add First child');
			}
		else {
			$(node).insertAfter(doc_edit_node);
console.log('not first');
			}
		doc_add_first=false;
*/
	if(!doc_edit_node) alert('set green line!!');
	else $(node).insertAfter(doc_edit_node);

    	tag_trees=[];
    	tag_trees=get_tagStruct(node,0);
    	if(tag_trees.length>0) doc_deep_level=0;
	doc_edit_node=node;
	doc_origin_node=node;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
	display_current_tag(doc_edit_node);
   }

  $("#makeSvg_indiv").on("click", function(){
	my_confirm(10);     
	});
/*
  $("#Cr_to_Br").on("click", function(){
console.log('****Enter Cr_To_Br');

	var tdom=doc_edit_node;

	var nstr=cut_tags(tdom);
	var newar=nstr.split('<br>');
console.log('str=',nstr,'new array=',newar);
	nstr='';
	for(let i=0;i<=newar.length-1;i++) {
		if(newar[i]!='') nstr=nstr+newar[i]+'<br>';
		}

	var new_ptag= document.createElement("p");
	new_ptag.innerHTML=nstr;
console.log(new_ptag);
	var clsname=''
	if(tdom.nodeName=='DIV') clsname=tdom.getAttribute('class');
	if(tdom.nodeName=='DIV' && clsname=='divsvg') {
console.log('replace first tag=',tdom);
		tdom.innerHTML='';
		tdom.insertBefore(new_ptag, tdom.firstChild);
		}
	else {
		$(new_ptag).insertAfter(tdom);
		tdom.remove();
		}

	if(my_html_design_dialog) {
    		tag_trees=[];
    		tag_trees=get_tagStruct(new_ptag,0);
    		if(tag_trees.length>0) doc_deep_level=0;
		doc_edit_node=new_ptag;
		doc_origin_node=new_ptag;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
		cancel_green_line();
		setto_current_tag(doc_edit_node);
		set_parms();
//		display_current_tag(doc_edit_node);
		}
	});  //function Cr to Br end
*/

  $("#Cr_to_Br").on("click", function(){
	if(Editmode!='Edit') return;
console.log('*****Enter Cr to Br')
	const selection = window.getSelection();
	if(!selection.rangeCount) return; 
	
	var range = selection.getRangeAt(0);

	// 選択範囲を含む親タグを取り出す
//console.log('rang parent=',range.commonAncestorContainer);
	var sel_rang=range.commonAncestorContainer;
	var ptags = sel_rang.querySelector('.divsvg');
	var tdom='';
//console.log('*****ptags=',ptags);
	if(ptags) tdom=ptags;
	else tdom=sel_rang;

//	var n_node=tdom.childNodes.length;
//console.log('sel nth=',n_node,tdom);
//console.log('selectio start=',selection.anchorNode.nodeValue,'selection end=',selection.extentNode.nodeValue);
//	var nums=num_search(tdom,selection.anchorNode.nodeValue,tdom,selection.extentNode.nodeValue);
//console.log('***********selectio number first=',nums[0],'last=',nums[1]);

	var nstr=cut_tags(tdom);
	var newar=nstr.split('<br>');
console.log('str=',nstr,'new array=',newar);
	nstr='';
	for(let i=0;i<=newar.length-1;i++) {
		if(newar[i]!='') nstr=nstr+newar[i]+'<br>';
		}

	var new_ptag= document.createElement("p");
	new_ptag.innerHTML=nstr;
console.log(new_ptag);
	var clsname=''
	if(tdom.nodeName=='DIV') clsname=tdom.getAttribute('class');
	if(tdom.nodeName=='DIV' && clsname=='divsvg') {
console.log('replace first tag=',tdom);
		tdom.innerHTML='';
		tdom.insertBefore(new_ptag, tdom.firstChild);
		}
	else {
		$(new_ptag).insertAfter(tdom);
		tdom.remove();
		}

	if(my_html_design_dialog) {
    		tag_trees=[];
    		tag_trees=get_tagStruct(new_ptag,0);
    		if(tag_trees.length>0) doc_deep_level=0;
		doc_edit_node=new_ptag;
		doc_origin_node=new_ptag;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
		cancel_green_line();
		setto_current_tag(doc_edit_node);
		set_parms();
		display_current_tag(doc_edit_node);
		}
	});  //function Cr to Br end

var off_indivx;
var off_indivy;

  $("#jump_svg").on("click", function(){
console.log('Enter JumpTo Svg or Insvg');

	document.getElementById("JumpTo").click();
	var glb_rect=org_container.getBoundingClientRect();
console.log('org=',org_container,'**point=',glb_rect);
	
	//var pnt2=svgPoint(tagn, rect_a.left, rect_a.top);
	off_indivx=glb_rect.left;
	off_indivy=glb_rect.top;

	window.scrollTo(0,off_page.top);

	});

  $("#Br_to_Cr").on("click", function(){
	if(Editmode!='Edit') return;
console.log('*****Enter Br to Cr')
	const selection = window.getSelection();
	if(!selection.rangeCount) return; 

	place_to_tag();
console.log('after place to tag=',doc_edit_node);
	var node=doc_edit_node.nodeName;
	if(node!='P' && node!='DIV') return; 

	var range = selection.getRangeAt(0);
console.log('selection start=',selection.anchorNode.nodeValue,'selection end=',selection.extentNode.nodeValue);
	var term1=selection.anchorNode.nodeValue;
	var term2=selection.extentNode.nodeValue;

	var first=-1;
	var last=-1;
	var temp=0;
	var len=doc_edit_node.childNodes.length;
	for(var k=len-1;k>=0;k--) {
		if(doc_edit_node.childNodes[k].textContent.includes(term1)) first=k;
		if(doc_edit_node.childNodes[k].textContent.includes(term2)) last=k;
console.log('k=',k,doc_edit_node.childNodes[k].textContent,'first=',first,'last=',last);
		if(last>=0) {
			n_text=doc_edit_node.childNodes[k].textContent;
console.log('n_text=',n_text,doc_edit_node.childNodes[k].innerHTML,doc_edit_node.childNodes[k]);
			if(n_text!='') {
				var new_ptag= document.createElement("p");
				new_ptag.innerHTML=n_text;
				if(temp==0) {
					var temp_id='t'+(Date.now()).toString();
					new_ptag.setAttribute('id', temp_id);
					temp=1;
					}
				$(new_ptag).insertAfter(doc_edit_node.childNodes[k]);
				doc_edit_node.removeChild(doc_edit_node.childNodes[k]);
				}
			else doc_edit_node.removeChild(doc_edit_node.childNodes[k]);
			}
		if(first>=0) break;
		}

	reform_html_after_ptag();
	node=document.getElementById(temp_id);
	node.removeAttribute('id');

	if(my_html_design_dialog) {
    		tag_trees=[];
    		tag_trees=get_tagStruct(node,0);
    		if(tag_trees.length>0) doc_deep_level=0;
		doc_edit_node=node;
		doc_origin_node=node;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
		cancel_green_line();
		setto_current_tag(doc_edit_node);
		display_current_tag(doc_edit_node);
		}
	});  //function Br to Cr end

//p_tag(含むEnterキー）,d_tag,Htagなど文章途中での新規tag挿入後のhtmlの成形
function reform_html_after_ptag() {
        	const domParser = new DOMParser();
		var htmldoc = domParser.parseFromString(doc_edit_node.innerHTML, 'text/html');
		var node = htmldoc.body;
console.log('parse doc=',htmldoc,'body=',node);

		let child_count = node.childNodes.length;
console.log('body nodes=',child_count);

		non_tag=0;
		for(let i=child_count-1; i>=0; i--) {
			if(node.childNodes[i].nodeName=="BR" && H_or_P_node_check(node.childNodes[i].previousSibling)) ;
			else if(node.childNodes[i].outerHTML=="<p></p>") ;
			else {
				if(node.childNodes[i].nodeName=="BR" || node.childNodes[i].nodeName=="#text") {
					if(non_tag==0) {
						var new_ptag= document.createElement("p");
console.log('new P tag created');
						}
					non_tag=non_tag+1;
					new_ptag.prepend(node.childNodes[i].cloneNode(true));
console.log('into P tag k=',i,node.childNodes[i]);
					}
				else {
					if(non_tag) {
						$(new_ptag).insertAfter(doc_edit_node);
						non_tag=0;
						}
					$(node.childNodes[i].cloneNode(true)).insertAfter(doc_edit_node);
console.log('Tag append k=',i,node.childNodes[i]);
					}
				}
			}
		if(non_tag) {
			$(new_ptag).insertAfter(doc_edit_node);
			non_tag=0;
			}

		var n_node=doc_edit_node.nextSibling;
		doc_edit_node.remove();
		doc_edit_node=n_node;
	}  //End of reform_html_after_ptag

function H_or_P_node_check(node) {
	var result=false;
	var nodety=node.nodeName[0];
	if(nodety=='H' || nodety=='P') result=true;
console.log('node type result=',nodety,result,node);
	return result;
	}

/*
    function cut_tags2(dom,first,last) {  //dom中にある装飾的tagを取り除いてsimple化する
	var n_child=dom.childNodes.length;
	var ntag='';
console.log('cut_tag2 dom=',dom,'child node leng=',n_child);
	if(n_child>0) {
		for (var k = first; k < last+1; k++) {
			var tag=dom.childNodes[k];
console.log('child k=',k,tag);
			if(tag.nodeName=='A') ntag=ntag+tag.outerHTML+'<br>';
			//else if(tag.nodeName=='FONT') ntag=ntag;
			else ntag=ntag+cut_tags(tag);
console.log('k=',k,' new tag=',ntag);
			}
		}
	else {
		ntag=ntag+dom.textContent+'<br>';
		}
	return ntag;
	} //End function
*/
/*
var num_search=function(dom,term1,term2) {
//console.log('dom=',dom);
	var first=-1;
	var last=-1;
	var tagn=[];
	len=dom.childNodes.length;
//console.log('dom leng=',len,'dom=',dom);
	for(var k=0;k<len;k++) {
//console.log('k=',k,'val=',dom.childNodes[k],'comp=',term1,term2);
//		if(encode(dom.childNodes[k])!='5bobject20htmlbrelement5d') 
			if(dom.childNodes[k].textContent.includes(term1)) first=k;
			if(dom.childNodes[k].textContent.includes(term2)) last=k;
		if(last>=0) break;
		}
	return [first,last];
   }
*/
/**
 * HTML文字列をノードに変換
 * @param {string} htmlStr 変換するHTMLの文字列
 * @return {NodeList} 変換したHTMLのNodeListを返す
 */
var htmlToNode = function(htmlStr) {
	if (!htmlStr || typeof htmlStr !== 'string') return;

	var tmpElmt = document.createElement('div');

	// 高速処理するが対応ブラウザを考えinnerHTMLを使用
	tmpElmt.innerHTML = htmlStr; 
        //tmpElmt.insertAdjacentHTML('beforeend', htmlStr);
//console.log('node=',tmpElmt,tmpElmt.childNodes);
	return tmpElmt.childNodes;
};

  $("#del_tag").on("click", function(){
console.log('delete tag');
	if(doc_deep_level<0) {
		alert('Not selected text');
		return;
		}
	var del_tag;
	var level=tag_trees[doc_deep_level].level;
console.log('doc_edit_node=',doc_edit_node,' level=',level);
	if(level<=0) {
		alert('level=0 Tagの削除はできません。');
		return;
		}
//	if(doc_edit_node.nodeName=='FIGCAPTION') {
//		alert('fig Titleは削除はできません。');
//		return;
//		}
	var par_tag1 = doc_edit_node.previousSibling;
	var par_tag2 = doc_edit_node.nextSibling;
console.log('prev & next=',par_tag1,par_tag2)
	if((par_tag1==null) && (par_tag2==null)) {
		alert("唯一子の要素は削除できません\nCan\'t delete only one child");
		return;
		}
	if(par_tag2) par_tag=par_tag2;
	else par_tag=par_tag1;
console.log('Del tag=',doc_edit_node,'parent=',doc_edit_node.parentNode,'prev=',par_tag1,'next=',par_tag2);
console.log('node=',doc_edit_node.nodeName);
//Enter to delete tag
	if(doc_edit_node.nodeName=='SPAN' || doc_edit_node.nodeName=='A' || doc_edit_node.nodeName=='I') {
		var ntx = document.createTextNode(doc_edit_node.innerHTML);
		var num=my_nodenum(doc_edit_node);
		var parn=doc_edit_node.parentNode;
		var new_par=replace_to_normal(parn,num,ntx);
console.log('new_parent=',new_par);
		parn.innerHTML=new_par.innerHTML;
		var p_node=search_pnode(parn);
		result=check_html_hist(p_node,tag_trees,level,'del_d');
		}
	else {
		result=check_html_hist(doc_edit_node,tag_trees,level,'text');
		if(par_tag1) {
			result=check_html_hist(doc_edit_node,tag_trees,level,'del');
			p_node=par_tag1;
			doc_edit_node.remove();
			}
		else {
			result=check_html_hist(doc_edit_node,tag_trees,level,'del_F');
			p_node=par_tag2;
			doc_edit_node.remove();
			}
		}
console.log('after hist prev tag=',par_tag,' remove_tag=',doc_edit_node);
    	tag_trees=[];
    	tag_trees=get_tagStruct(p_node,0);
    	if(tag_trees.length>0) doc_deep_level=0;
	doc_edit_node=p_node;
console.log('present tag=',doc_edit_node);
	display_current_tag(doc_edit_node);
    });	

   function search_pnode(node) {
	var paren=node;
	do {
		var node_name=paren.nodeName;
console.log('search P=',node_name,paren);
		var retn=false;
		if(node_name[0]=='P' || node_name[0]=='H' || node_name=='TD' || node_name=='TH') retn=true;
		else {
			if(node_name=='DIV') {
//alert('指定ノード不正/not proper node!!');
				return null;
				}
			paren=node.parentNode;
			node=node.parentNode;
			}
		} while (!retn)
	return paren;
	}

   function my_nodenum(edit_node) {
	let targetNode = edit_node;
	let i = 0
	while ((targetNode = targetNode.previousSibling) !== null) {
		  i++
		}
	return i;
	}

   function replace_to_normal(parn,num,ntx) {
		var work = document.createTextNode('');
		var j=0;
		var targetNode=parn.childNodes[0];
		var new_par=document.createElement('P');
		do {
console.log('target num=',j,targetNode,'next',targetNode.nextSibling);
			if(j==num) work.textContent=work.textContent+ntx.textContent;
			else {
				if(targetNode.nodeName=='#text') work.textContent=work.textContent+targetNode.textContent;
				else {
					if(work.textContent!='') {
						new_par.appendChild(work.cloneNode(true));
						work.textContent='';
						}
					new_par.appendChild(targetNode.cloneNode(true));
					}
				}
			j++;
			} while((targetNode = targetNode.nextSibling) !== null)
			if(work.textContent!='') {
				new_par.appendChild(work.cloneNode(true));
				work.textContent='';
				}
//console.log('new_parent=',new_par);]
	return new_par;
	}

  $("#tag_back").on("click", function(){
console.log('Enter tag_back');

	var prev=doc_edit_node.previousElementSibling;
	if(prev) {
		//prev.setAttribute('style',doc_prev_parms);
		tag_trees=[];
    		tag_trees=get_tagStruct(prev,0);
    		if(tag_trees.length>0) doc_deep_level=0;
		doc_edit_node=prev;
		display_current_tag(doc_edit_node);
		}
	else {
alert('Not exist previosSibling')
		} 
    });

  $("#tag_next").on("click", function(){
console.log('Enter tag_next');

	var next=doc_edit_node.nextElementSibling;
	if(next) {
		//next.setAttribute('style',doc_prev_parms);
		tag_trees=[];
    		tag_trees=get_tagStruct(next,0);
    		if(tag_trees.length>0) doc_deep_level=0;
		doc_edit_node=next;
		display_current_tag(doc_edit_node);
		}
	else {
alert('Not exist nextSibling')
		} 
    });

  $("#tag_up").on("click", function(){
console.log('***Up key doc_level=',doc_deep_level,' depth=',tag_trees.length);
    if(doc_deep_level >= tag_trees.length-1) return;
    doc_deep_level=doc_deep_level+1;
console.log('present tag=',doc_edit_node,tag_trees[doc_deep_level].tag);
    var par_n=doc_edit_node.parentElement;
//console.log('parentElem=',par_n);
    if(par_n==null) {
		doc_deep_level=doc_deep_level+1;
		tag_n=tag_trees[doc_deep_level].tag
		par_n=doc_edit_node.closest(tag_n);
//console.log('next_parentElem=',par_n,tag_n,' level=',doc_deep_level);
		}
    	doc_edit_node=par_n;
console.log('doc_edit_node=',doc_edit_node);
	display_current_tag(doc_edit_node);
    });

  $("#tag_down").on("click", function(){
	//alert('Go back to Origin node');
	//doc_deep_level=0;
console.log('Enter tag_down');
//子があればfirstChildを探す
	if(doc_edit_node.childElementCount>0) {
		var node=doc_edit_node.firstChild;
		tag_trees=[];
    		tag_trees=get_tagStruct(node,0);
    		if(tag_trees.length>0) doc_deep_level=0;
		doc_edit_node=node;
		display_current_tag(doc_edit_node);
		}
	else alert('子要素はありません。No Child!');
    });

   function get_tagStruct(node,level) {
console.log('***Get tag_tree=',node,level);
	var node_fig="";
	var node_id=null;
	var index=0;
	var node_lv=null;
	if(node.nodeName=='DIV' || node.nodeName=='NAV') {
		node_fig=node.getAttribute('fig');
		node_id=node.getAttribute('id');
		node_lv=node.getAttribute('level');
		}
//console.log('nodeName=',node.nodeName);
	if(node_lv!='0') {
		var par_n=node.parentNode;
//console.log('node and parent=',node,par_n);
//現Tagが親要素の何番目の子かを取得
//var index = [].slice.call( par_n.childNodes).indexOf( node ) ;
		var collection= Array.from(par_n.children);
		var index=collection.indexOf( node);
//console.log('****oya=',par_n,' node=',node,' index=',index);
		tag_trees.push({tag:node.nodeName,fig:node_fig,level:level,node:node_id,ind:index});
		get_tagStruct(par_n,level+1);
		}
	else {      //Topレベル（divsvg_xx）をlevel=0としての付け替え
		doc_top_node=node;
		tag_trees.push({tag:node.nodeName,fig:node_fig,level:level,node:node_id,ind:index});
    		for(let i=0;i<tag_trees.length;i++) {
			tag_trees[i].level=tag_trees.length-i-1;
			}
		}
	return tag_trees;
	}

   function get_tree_level(nwnode) {      //2022.12.16 Simple化　editor163のul＆ol複雑構造　flex構造もOK
	var node_id=tag_trees[tag_trees.length-1].node;
	var pre_node=document.getElementById(node_id);      //pre_node present node
	var nn;
	var new_node;
console.log('***Trace tree level:present node=',pre_node,' node=',nwnode);
	var deep_level;
    	for(let i=tag_trees.length-1;i>=0;i--) {
console.log('tree i=',i,tag_trees[i].tag,tag_trees[i].ind,tag_trees[i+1]);
		deep_level=i;
		if(pre_node==nwnode) break;
		else {
			if(i-1<0) {
alert('your document structure broken!!');
				return;
				}
			nn=tag_trees[i-1].ind;
			new_node=pre_node.children[nn];
console.log('tree i=',i,tag_trees[i],'search=',nwnode,'next=',new_node,'pre=',pre_node);
			}
		pre_node=new_node;
		}
console.log('match tag=',new_node,nwnode,tag_trees[i],'deep_level=',deep_level);
	return deep_level;
	}
</script>
<!-- ポップアップウィンドウ用basic-draw（テンプレート） -->
<div class="dialog" id="icon_generate" title="Icon Design">
  <div class="dialog-content">
   	<label>&nbsp;name&nbsp;<input type="text" id="icon_name" value="name" style="width:60px;"></label>
	<button class="btn" id="draw_mesh">確認mesh</button><label>&nbsp;</label><button class="btn" id="regi_icon">登録</button>
	<label>Icon Design Area:</label><select id="icon_area" style="width:100px; height:25px;" ></p>
		<option value="s_00">16×16px*8</option>
		<option value="s_01">32×32px*8</option>
		<option value="s_02">48×48px*4</option>
		<option value="s_03">64×64px*2</option>
		<option value="s_04">256×256px</option>
		<option value="s_05" selected="selected">400×400px</option>
		<option value="s_06">600×600px</option>
		<option value="s_07">800×800px</option>
	</select><!--label>　Ongrid&nbsp;<input type="checkbox" id="on_grid" value="" checked></label --><br><br>
	<!-- label>&nbsp;sft_X&nbsp;<input type="text" id="shift_X" value="20" style="width:40px;"></label>
	<label>&nbsp;sft_Y&nbsp;<input type="text" id="shift_Y" value="20" style="width:40px;"></label>
	<label>&nbsp;rate&nbsp;<input type="text" id="red_size" value="0.25" style="width:50px;"></label -->
	<label>背景:<input type="text" id="icon_back" value="none" style="width:40px;"></label>
	<label>&nbsp;枠:<input type="text" id="icon_frame" value="blue" style="width:40px;"></label><label>&nbsp;width:<input type="text" id="icon_width" value="1" style="width:40px;"></label><br>
	<button class="btn" id="export_symbols">export symbol</button><label>&nbsp;　　　　</label><button class="btn" id="export_icon">export svg</button><br><br>
	<button class="btn" id="next_icon">next</button><label>&nbsp;　　　</label><button class="btn" id="cancel_icon">cancel</button>

  </div> 
</div>
<script class="minify" id="smain_11">
   $("#icon_gen").on("click", function(){
	Editmode="Svg";
	Draw_mode='';
	var theDialog=$( '#icon_generate' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:260, width: 360,  position: {my: "right bottom", at: "right bottom", of: window}} );
	//ダイアログを表示する
	icon_gen_dialog=1;
	my_confirm_open(15);
	theDialog.dialog("open");
	});

   $('#icon_generate').on('dialogclose', function(event) {
console.log('icon_gen Dialog closed');
	icon_gen_dialog=0;
	my_confirm_close(15);
	});

var icon_gen_dialog=0;
var g_temp=null;
var x_mesh_offset=40;
var y_mesh_offset=0;
var xy_mesh=10;
var x_last=440;
var y_last=400;
var mesh_draw=false;
var mesh_integer=true;
var icon_regist='';
var box_size;
var expan;

</script>
<!-- ポップアップウィンドウ用basic-draw（テンプレート） -->
<div class="dialog" id="basic-figure" title="Utility図">
  <div class="dialog-content">
   	<select id="figure_no" style="width:80px; height:25px;" ></p>
    		<option value="circle">circle</option>
    		<option value="ellipse">ellipse</option>
		<option value="ellipse">quod_line</option>
   	</select></br>
	<label>&nbsp;p1&nbsp;<input type="text" id="param1" value="50" style="width:40px;"></label>
	<label>&nbsp;p2&nbsp;<input type="text" id="param2" value="50" style="width:40px;"></label>
	<label>&nbsp;p3&nbsp;<input type="text" id="param3" value="50" style="width:40px;"></label></br>
	<label>&nbsp;p4&nbsp;<input type="text" id="param4" value="50" style="width:40px;"></label>
	<label>&nbsp;p5&nbsp;<input type="text" id="param5" value="50" style="width:40px;"></label>
	<label>&nbsp;p6&nbsp;<input type="text" id="param6" value="50" style="width:40px;"></label></br>
  	<label>Trim&nbsp;<input type="checkbox" id="Trim" value=""></label><label>&nbsp;&nbsp;R&nbsp;<input type="text" id="paramR" value="10" style="width:40px;"></label></br>
   	<label>連結&nbsp;<input type="checkbox" id="concat" value=""></label>
	<button class="btn" id="start_draw">Draw</button></br>
   	<label>&nbsp;name&nbsp;<input type="text" id="icon_name" value="name" style="width:60px;"></label>
	<!-- button class="btn" id="draw_mesh">確認mesh</button><label>&nbsp;</label><button class="btn" id="regi_icon">登録</button>
	<label>&nbsp;sft_X&nbsp;<input type="text" id="shift_X" value="20" style="width:40px;"></label>
	<label>&nbsp;sft_Y&nbsp;<input type="text" id="shift_Y" value="20" style="width:40px;"></label>
	<label>&nbsp;rate&nbsp;<input type="text" id="red_size" value="0.25" style="width:50px;"></label -->
	<label>&nbsp;連結&nbsp;<input type="checkbox" id="concat" value=""></label><button class="btn" id="shift_draw">Basic図</button><button class="btn" id="export_basic">export</button></br>
	<button class="btn" id="Bmode_on" >Mode On</button><button class="btn" id="Mesh_on" >On mesh</button>
  </div>
</div>
<script class="minify" id="smain_12">
   $("#basic_fig").on("click", function(){
	Editmode="Svg";
	Draw_mode='';
	document.getElementById("Bmode_on").click();
	var theDialog=$( '#basic-figure' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:340, width: 360,  position: {my: "right bottom", at: "right bottom", of: window}} );
	//ダイアログを表示する
	theDialog.dialog("open");
	});

    start_draw.onclick = function(){
console.log("***Start draw");
	if(figure_no.value=="circle") {
console.log('**enter circle');
/* Circleの場合　p1=cx(R) p2=cy(R) p3=R 扇形の場合　p4=角度360単位　*/
		var cx=Number($("#param1").val());
		var cy=Number($("#param2").val());
		var R=Number($("#param3").val());
		var kaku=0;
		if($("#param4").val()) {
			var kakudo=Number($("#param4").val());
			kaku=2*Math.PI*kakudo/360;
			}
console.log('cx,cy,R,kakudo=',cx,cy,R,kakudo);
		drawingPoints=[];
		for(var i=0;i<13;i++){
			var deg=2*Math.PI/12*i;
			var x=R*Math.cos(deg)+cx;
			var y=R*Math.sin(deg)+cy;
			var break_flag=0;
			if(kaku>0) {
				if(kaku <= (deg+Math.PI/12)) {
					break_flag=1;
					x=R*Math.cos(kaku)+cx;
					y=R*Math.sin(kaku)+cy;
					}
				}
			drawingPoints.push({x: x,y: y});
			if(break_flag) break;
			}

		var {group,fig_id}=make_group('path');
		var c_para="close";
		if(kaku>0) c_para='else';
		group.setAttribute(null,'close', c_para);
		var s_para="smooth";
		group.setAttribute(null,'smooth', s_para);
		drawingPtype=Array(drawingPoints.length);
		drawingPtype.fill(0);
		var path=set_line_group(group,drawingPtype,c_para,s_para);
		group.insertBefore(path, group.firstChild);
//		group.appendChild(path);
		if(kaku>0) {  //扇型の両端の線を引く
        		drawingPath = createPath([{x:cx,y:cy},drawingPoints[0]],0,null,null);
        		Object.assign(drawingPath.style, defaultPathStyle);
        		group.appendChild(drawingPath);
        		drawingPath = createPath([{x:cx,y:cy},drawingPoints[drawingPoints.length-1]],0,null,null);
        		Object.assign(drawingPath.style, defaultPathStyle);
        		group.appendChild(drawingPath);
			}

console.log('**04 append path point=',drawingPoints,group);
		drawingPoints = [];
		}
	else if(figure_no.value=="ellipse") {
console.log('**enter ellipse');
/* Ellipseの場合　p1=cx(中心x) p2=cy(中心y) p3=R(100px) p4=bcy(Rに対する短軸長の比率）扇形の場合　p5=角度360単位　*/
		var cx=Number($("#param1").val());
		var cy=Number($("#param2").val());
		var R=Number($("#param3").val());
		var bcy=Number($("#param4").val());
		var kaku=0;
		if($("#param5").val()) {
			var kakudo=Number($("#param5").val());
			kaku=2*Math.PI*kakudo/360;
			}
console.log('cx,cy,R,bcy=',cx,cy,R,bcy,kakudo);
		drawingPoints=[];
		for(var i=0;i<13;i++){
			var deg=2*Math.PI/12*i;
			var x=R*Math.cos(deg)+cx;
			var y=bcy*R*Math.sin(deg)+cy;
			var break_flag=0;
			if(kaku>0) {
				if(kaku <= (deg+Math.PI/12)) {
					break_flag=1;
					x=R*Math.cos(kaku)+cx;
					y=y=bcy*R*Math.sin(kaku)+cy;
					}
				}
			drawingPoints.push({x: x,y: y});
			if(break_flag) break;
			}
		var {group,fig_id}=make_group('path');
		var c_para="close";
		if(kaku>0) c_para="else";
		group.setAttributeNS(null,'close', c_para);
		var s_para="smooth";
		group.setAttributeNS(null,'smooth', s_para);
		drawingPtype=Array(drawingPoints.length);
		drawingPtype.fill(0);
		var path=set_line_group(group,drawingPtype,c_para,s_para);
		group.insertBefore(path, group.firstChild);
//		group.appendChild(path);
		if(kaku>0) {  //扇型の両端の線を引く
        		drawingPath = createPath([{x:cx,y:cy},drawingPoints[0]],0,null,null);
        		Object.assign(drawingPath.style, defaultPathStyle);
        		group.appendChild(drawingPath);
        		drawingPath = createPath([{x:cx,y:cy},drawingPoints[drawingPoints.length-1]],0,null,null);
        		Object.assign(drawingPath.style, defaultPathStyle);
        		group.appendChild(drawingPath);
			}
console.log('**05 append path');
		drawingPoints = [];
		}
	else {

		}

	}

    shift_draw.onclick = function(){
console.log("***Shift draw");
	var x_sf=Number($("#shift_X").val());
	var y_sf=Number($("#shift_Y").val());
	var rate=Number($("#red_size").val());
console.log('shift XY=',x_sf,y_sf,rate);
	target = document.getElementById('svg_00');    //only g01 is Icon target
	shift_fig(target,x_sf,y_sf,rate);

     }

    Bmode_on.onclick = function(){
	if (Draw_mode=='Basic'){
		Draw_mode='';
		document.getElementById("Bmode_on").innerText='Mode Off';
		Svg_mode="Draw"
console.log("***Basic mode changed to=",Draw_mode);
		}
	else {
		Draw_mode='Basic';
		document.getElementById("Bmode_on").innerText='Mode On';
		Svg_mode="";
console.log("***Basic mode changed to=",Draw_mode);
		}
     }

    Mesh_on.onclick = function(){
	if (mesh_integer==true){
		mesh_integer=false;
		document.getElementById("Mesh_on").innerText='Off mesh';
		}
	else {
		mesh_integer=true;
		document.getElementById("Mesh_on").innerText='On mesh';
		}
     }

    export_basic.onclick = function(){
console.log("***Enter export basic");
console.log('**container nodename= ',container.nodeName,'id= ',fig_id);
console.log('**container child length=',container.childElementCount);
	var svg_tag='';
	for (nn = 0; nn < container.childElementCount; nn++) {
		if(container.children[nn].nodeName!='defs'){
			svg_tag=svg_tag+container.children[nn].outerHTML;
			}
console.log('***list n =',nn,' length = ', svg_tag.length);
		}
//	svg_tag=svg_tag+'</svg>';

let blob = new Blob([svg_tag],{type:"svg"});
let link = document.createElement('a');
link.href = URL.createObjectURL(blob);
link.download = 'testfile.txt';
link.click();
	}
</script>
<!-- ポップアップウィンドウ用mailing_list（テンプレート） -->
<div class="dialog" id="mail_target" title="Mail送信">
  <div class="dialog-content">
	<label>&nbsp;件名(subject)&nbsp;</label><input type="text" id="mail_subject" value="" style="width:380px;"><br>
   	<label>&nbsp;宛先(address)&nbsp;</label><br><textarea type="text" id="mail_list" value="" cols="50" rows=3 style="line-height: 1.2em"></textarea>
	<button class="btn" id="m_list1">list1</button><label>&nbsp;</label><button class="btn" id="m_list2">list2</button><label>&nbsp;</label><button class="btn" id="m_list3">list3</button><label>&nbsp;</label><button class="btn" id="m_list4">list4</button><label>&nbsp;</label><button class="btn" id="m_list5">list5</button><label>&nbsp;　　</label>
	<button class="btn" onclick="mail_send()">送信</button><br>
	<label>&nbsp;コメント&nbsp;</label><br><textarea id="mail_comment" cols="50" rows=5 maxlength="150" style="line-height: 1.2em"></textarea>
  </div>
</div>
<!-- ポップアップウィンドウ用ベースHTML（テンプレート）mail list -->
<div class="dialog" id="m_list_dial" title="Mailリスト">
  <div class="dialog-content">
	<div class="popwindow-content"></div>
	<label>address list</label><br><textarea id="mail_list_enter" cols="50" rows=5 maxlength="150" style="line-height: 1.2em"></textarea>
	<br>
	<button class="btn" id="set_mail_list">Set</button>
  </div>
</div>
<!-- ポップアップウィンドウ用System Parameters（テンプレート） -->
<div class="dialog" id="recipe-table" title="Repair Recipies">
  <div id="recipe_tb_ins" class="dialog-content">
	<button class="btn" onclick="recipe_delete()">delete</button><br>
  </div>
</div>
<script class="minify" id="smain_13">
var m_list=0;
var old_addr="";
var addr_list_mended=0;
var addr_new_list;

var m_list_Dialog=$( '#m_list_dial' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:180, width: 450,  position: {my: "right center", at: "right top", of: window}} );
	//ダイアログを表示する

   $("#mail_to_who").on("click", function(){
	//Editmode="Svg";
	//Draw_mode='';
	//document.getElementById("Bmode_on").click();
	var theDialog=$( '#mail_target' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:300, width: 450,  position: {my: "right bottom", at: "right bottom", of: window}} );
	addr_list_mended=0;
	document.getElementById("mail_comment").value="添付のsample.htmlを御覧下さい。";
	if(old_addr=="") {
		addr_new_list=";;;;".split(/;|,/);
		}
	else {
		addr_new_list=old_addr.split(';');
		addr_new_list.shift();
		}
console.log('old_addr=',old_addr,'list=',addr_new_list);
	//ダイアログを表示する
	theDialog.dialog("open");
	});

   $('#mail_target').on('dialogclose', function(event) {
console.log('Dialog closed');
	});

   $('#set_mail_list').on("click", function(){
console.log('set_mail_list called');
//	document.getElementById("mail_list").value=$("#mail_list").val()+";"+document.getElementById("mail_list_enter").value;
	var now_list=$("#mail_list").val();
	if(now_list) document.getElementById("mail_list").value=now_list+","+$("#mail_list_enter").val();
	else document.getElementById("mail_list").value=$("#mail_list_enter").val();

	if(m_list && addr_new_list[m_list-1]!=$("#mail_list_enter").val()) {
		addr_new_list[m_list-1]=$("#mail_list_enter").val();
		addr_list_mended=1;
console.log('addr list mended=',m_list,addr_new_list[m_list-1]);
		}
	});

   $('#m_list1').on("click", function(){
console.log('m_list1 called');
	m_list=1;
	m_list_Dialog.dialog("open");
	document.getElementById("mail_list_enter").value="";
	if(addr_new_list[m_list-1]!="") {
		document.getElementById("mail_list_enter").value=addr_new_list[m_list-1];
		}
	});
   $('#m_list2').on("click", function(){
console.log('m_list2 called');
	m_list=2;
	m_list_Dialog.dialog("open");
	document.getElementById("mail_list_enter").value="";
	if(addr_new_list[m_list-1]!="") {
		document.getElementById("mail_list_enter").value=addr_new_list[m_list-1];
		}
	});   
   $('#m_list3').on("click", function(){
console.log('m_list3 called');
	m_list=3;
	m_list_Dialog.dialog("open");
	document.getElementById("mail_list_enter").value="";
	if(addr_new_list[m_list-1]!="") {
		document.getElementById("mail_list_enter").value=addr_new_list[m_list-1];
		}
	});
   $('#m_list4').on("click", function(){
console.log('m_list4 called');
	m_list=4;
	m_list_Dialog.dialog("open");
	document.getElementById("mail_list_enter").value="";
	if(addr_new_list[m_list-1]!="") {
		document.getElementById("mail_list_enter").value=addr_new_list[m_list-1];
		}
	});
   $('#m_list5').on("click", function(){
console.log('m_list5 called');
	m_list=5;
	m_list_Dialog.dialog("open");
	document.getElementById("mail_list_enter").value="";
	if(addr_new_list[m_list-1]!="") {
		document.getElementById("mail_list_enter").value=addr_new_list[m_list-1];
		}
	});

function mail_send(){
  var addr_list=$("#mail_list").val();
  var comment=$("#mail_comment").val();
  addr_list=addr_list.trim();
console.log("addr_list=",addr_list);
  if(addr_list=='') {
	alert("mailing list null!!");
	return;
	}

  var title=$("#mail_subject").val();

		//class=Tivの複製
  var data=get_common(7);
//console.log('data=',data);

    const parser = new DOMParser();
    const html_dat = parser.parseFromString(data, "text/html");

    var tagn=document.getElementById('texx');
    var dumy=tagn.cloneNode(true);

	dlist=dumy.querySelectorAll('rect');
	dlist.forEach(function (element) {
		element.remove();
//		element.setAttribute('style','display;block');
//		element.setAttribute('class','canv point_none');
//console.log(element);
		});

	var btag=html_dat.querySelector('body');
//console.log(btag);
	btag.appendChild(dumy);
//	var title='my first mail test';
console.log(html_dat);

	const serializer = new XMLSerializer();
	const es_html = serializer.serializeToString(html_dat);
console.log('mail_to export html length=',es_html.length);
//for デモバージョン
	if(((for_cloud=='yes') || (for_demo=='yes')) && (es_html.length > 60000)) {
		alert('mail to HTML is too large this Demo version!');
		return;
		}

        $.ajax({
            url: "/db_serv/mail_to/",
            async:false,
	    type: "POST",
            data: {
		"type":'html',
		"title":title,
		"addr_list":addr_list,
		"comment":comment,
		"html_dat":es_html,
		},
            dataType: 'json'
        })
        .done((data) => {
            //結果が帰ってきたら、表示します。
console.log('**Ajax Returned result=',data);
        });
//必要ならばsys_parmsの修正を行う。
  if(addr_list_mended) {
	var from_sys=get_common(1);
	var addr_nw="addr_list;";
	for(i=0;i<5;i++) {
		addr_nw=addr_nw+addr_new_list[i]+";";
		}
	addr_nw=addr_nw.slice(0, -1);
	var other="";
	if(old_addr=="") {
		other=from_sys;
		addr_nw=addr_nw+"|<=>|";
		}
	else {
		var cut_len=old_addr.length;
console.log('cut_len=',cut_len,old_addr);
		other=from_sys.slice(cut_len);
		}
console.log('addr_list_mended addr=',addr_nw,'other=',other);
	old_addr=addr_nw;
	var new_sys=addr_nw+other;
//console.log('new_sys_parm=',new_sys);
	update_sysparms(1,new_sys);
	}
$( '#mail_target' ).dialog("close");
alert('mail send');
    }  //End of mail_send

var recipe_max=30;
var recipe_del_rec=[];

   $("#repair_recipe").on("click", function(){
	//Editmode="Svg";
	//Draw_mode='';
	//document.getElementById("Bmode_on").click();
	var theDialog=$( '#recipe-table' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:340, width: 450,  position: {my: "right bottom", at: "right bottom", of: window}} );
	//ダイアログを表示する
	theDialog.dialog("open");
	repair_recipe_table();
	});

   $('#recipe-table').on('dialogclose', function(event) {
console.log('Dialog closed');
	});

    function repair_recipe_table() {
console.log("***Didplay recipe table");
	var heads=['check','recipe name','node name'];
	var terms=[];

	recp_list=read_recipe();
	
	var par_tag= document.createElement('div');
	par_tag.setAttribute('class', 'table');
	par_tag.setAttribute('fig', 'table');
	par_tag.setAttribute('id','recipe_table');
//	var hm_numb=Number(document.getElementById('hm_numb').value);
	var hm_numb=3;
//	var cols=document.getElementById('tabl_cols').value;
	var cols=recp_list.length;
//	var head_yes=document.getElementById('ta_head').value;
	var head_yes=true;
	var tabl_tag=document.createElement('table');
	par_tag.appendChild(tabl_tag);
	if(head_yes) {
		var thead_tag=document.createElement('thead');
		tabl_tag.append(thead_tag);
		var tr_tag=document.createElement('tr');
		for(let i=0;i<hm_numb;i++) {
			var chd_tag = document.createElement('th');
			chd_tag.innerHTML=heads[i];
			tr_tag.appendChild(chd_tag);
			}
		thead_tag.append(tr_tag);
		}
	var tbody_tag=document.createElement('tbody');
	tbody_tag.setAttribute('id','recipe_tbody');
	tabl_tag.append(tbody_tag);
	for(let i=0;i<cols;i++) {			
	var tr_tag=document.createElement('tr');
	for(let j=0;j<hm_numb;j++) {
		var chd_tag = document.createElement('td');
		chd_tag.innerHTML='';
//		parms_1='width:'+parm_w.slice(-1)[0]+';';
//		var parms_1=parms_1+"border-radius:5px; border: solid 1px #008080;";
//		chd_tag.setAttribute('style', parms_1);
		chd_tag.setAttribute('contenteditable', "true"); 
		tr_tag.appendChild(chd_tag);
		}
	tbody_tag.append(tr_tag);
	}
	var line_dw='1px solid black';
console.log('line_dw=',line_dw);
	if(line_dw) {
		//Table罫線のテスト OK
		var td_cell=tabl_tag.querySelectorAll('td ,th');
		console.log('td_cell leng=',td_cell.length);
		var styl='border:'+line_dw;
		for(let i=0;i<td_cell.length;i++) {
			td_cell[i].setAttribute('style',styl);
			}
		}
	var ins_node=document.getElementById('recipe_tb_ins');
	$(par_tag).insertAfter(ins_node);

console.log('table=',tbody_tag,'rows=',tbody_tag.rows.length)
	for( var i = 0; i < cols; i++ ) {
   
       		var cells = tbody_tag.rows[ i ].cells;
console.log('cols=',cells.length);
        	for( var k = 0; k < cells.length; k++ ) {
			if(k==0) {
				cells[k].setAttribute('align','center');
				cells[k].innerHTML="<input type='checkbox' class='checkboxes' onclick='catch_boxes(this.index)' />";
				}
			else if(k==1) cells[k].textContent=recp_list[i][1];
			else cells[k].textContent=recp_list[i][0];
			}
	}

    }  //End of repair

function catch_boxes(value) {
    var tbl = document.getElementById("recipe_tbody");
console.log('Table leng=',tbl.childElementCount,tbl);
    var nlist=tbl.childElementCount;
    var checkbox;
    recipe_del_rec=[];;
    for (var i = 0 ; i < nlist ; ++i) {
        	checkbox=tbl.rows[i].cells[0].firstChild
        	if (checkbox.checked) {
			recipe_del_rec.push(i);
			}
		
	}
console.log('checked=',recipe_del_rec);
}

    function recipe_delete() {
	var sv_recipe='|<=>|';
	var flg=0;
	for(let k=0;k<recp_list.length;k++) {
		flg=flag_inc(k,recipe_del_rec);
		if(!flg) sv_recipe=sv_recipe+recp_list[k][0]+','+recp_list[k][1]+'|@|'+recp_list[k][2]+'|<=>|';
		}
//console.log('Recipe delete called saved recipe=',sv_recipe);
	update_sysparms(3,sv_recipe);

	var numb=recipe_del_rec.length;
alert('munber of '+String(numb)+' recipies deleted');
	$('#recipe-table').dialog("close");
	}

    function flag_inc(nn,matx) {
	len=matx.length;
	flag=0;
	for(let k=0;k<len;k++) {
		if(nn==matx[k]) {
			flag=1;
			break;
			}
		}
	return flag;
	}
</script>
<!-- ポップアップウィンドウ用System Parameters（テンプレート） -->
<div class="dialog" id="sys-parms" title="System Parameters">
  <div id="tb_ins" class="dialog-content">
   	<!--select id="figure_no" style="width:80px; height:25px;" ></p>
    		<option value="circle">circle</option>
    		<option value="ellipse">ellipse</option>
		<option value="ellipse">quod_line</option>
   	</select></br -->
	<label>max_width&nbsp;<input type="text" id="sys_param1" value="1200" style="width:50px;"></label><br>
	<label>L margin&nbsp;<input type="text" id="sys_param2" value="100" style="width:50px;"></label>
	<label>R margin&nbsp;<input type="text" id="sys_param3" value="100" style="width:50px;"></label><br>
   	<select id="param_set" style="width:80px; height:25px;" ></p>
    		<option value="origin"  selected="selected">日本語</option>
    		<option value="english">英語</option>
    		<option value="child">子供</option>
		<option value="favorit">お好み</option>
   	</select><label>　　</label>
   	<label>hist_undo&nbsp;<input type="checkbox" id="undo_hist" value="">　　</label><button class="btn" id="sys_set">設定</button><br>

	<!-- button class="btn" id="start_draw">Draw</button></br>
   	<label>&nbsp;name&nbsp;<input type="text" id="icon_name" value="name" style="width:60px;"></label>
	<button class="btn" id="draw_mesh">確認mesh</button><label>&nbsp;</label -->
	<!-- label>&nbsp;sft_X&nbsp;<input type="text" id="shift_X" value="20" style="width:40px;"></label>
	<label>&nbsp;sft_Y&nbsp;<input type="text" id="shift_Y" value="20" style="width:40px;"></label>
	<label>&nbsp;rate&nbsp;<input type="text" id="red_size" value="0.25" style="width:50px;"></label>
	<label>&nbsp;連結&nbsp;<input type="checkbox" id="concat" value=""></label><button class="btn" id="shift_draw">Basic図</button><button class="btn" id="export_basic">export</button></br>
	<button class="btn" id="Bmode_on" >Mode On</button><button class="btn" id="Mesh_on" >On mesh</button -->
  </div>
</div>
<script class="minify" id="smain_14">
var undo_hist_onoff=0;
var sys_max_width='1200px';

   $("#sys_parms").on("click", function(){
	//Editmode="Svg";
	//Draw_mode='';
	//document.getElementById("Bmode_on").click();
	var theDialog=$( '#sys-parms' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:340, width: 450,  position: {my: "right bottom", at: "right bottom", of: window}} );
	//ダイアログを表示する
	theDialog.dialog("open");
	disp_parm_table();
	});

   $('#sys_parms').on('dialogclose', function(event) {
console.log('Dialog closed');
	});


    function disp_parm_table() {
console.log("***Didplay system parameters");
	var heads=['日本語','英語','子供','お好み'];
	var terms=[];
//var terms=[['navi_list','',''],['検索','Sch',''],['抽出','Disp',''],['編集','Edit',''],['戻る','Rtn',''],['削除','Del','']];
	
	var from_sys=get_common(1);
//console.log('from_sys=',from_sys);
	var parms=from_sys.split('|<=>|');
//console.log('sys parms=',parms);
	len=parms.length;
	
	for(let kn=0;kn<len;kn++){
		var sels=parms[kn].split(/;|,/);
		switch (sels[0]){
			case 'sys_parm':
				var sys_parms_dat=parms[kn];
				var sys_parms=sys_parms_dat.split(/;|,/);
//console.log('sys parm=',parms);
				document.getElementById('sys_param1').value=sys_parms[1];
				document.getElementById('sys_param2').value=sys_parms[2];
				document.getElementById('sys_param3').value=sys_parms[3];
				document.getElementById('param_set').value=sys_parms[4];
				break;
			case 'navi_list':
				var sel2=parms[kn].split(';');
//console.log('sel2=',sel2);
				var elem=[sels[0],'','',''];
				terms.push(elem);
				for(let j=1;j<sel2.length;j++) {
					elem=sel2[j].split(',');
					if(elem!='') terms.push(elem);
					}
				break;
			case 'title_list':
				var sel2=parms[kn].split(';');
//console.log('sel2=',sel2);
				var elem=[sels[0],'','',''];
				terms.push(elem);
				for(let j=1;j<sel2.length;j++) {
					elem=sel2[j].split(',');
					if(elem!='') terms.push(elem);
					}
				break;
			case 'navi_edit':
				var sel2=parms[kn].split(';');
//console.log('sel2=',sel2);
				var elem=[sels[0],'','',''];
				terms.push(elem);
				for(let j=1;j<sel2.length;j++) {
					elem=sel2[j].split(',');
					if(elem!='') terms.push(elem);
					}
				break;
			case 'title_edit':
				var sel2=parms[kn].split(';');
//console.log('sel2=',sel2);
				var elem=[sels[0],'','',''];
				terms.push(elem);
				for(let j=1;j<sel2.length;j++) {
					elem=sel2[j].split(',');
					if(elem!='') terms.push(elem);
					}
				break;
			case 'title_style':
				var sel2=parms[kn].split(';');
//console.log('sel2=',sel2);
				var elem=[sels[0],'','',''];
				terms.push(elem);
				for(let j=1;j<sel2.length;j++) {
					elem=sel2[j].split(',');
					if(elem!='') terms.push(elem);
					}
				break;
			case '':
				break;
       			default:
				break;
			}
		}
//console.log('terms=',terms);

	var par_tag= document.createElement('div');
	par_tag.setAttribute('class', 'table');
	par_tag.setAttribute('fig', 'table');
	par_tag.setAttribute('id','sys_parm');
//	var hm_numb=Number(document.getElementById('hm_numb').value);
	var hm_numb=4;
//	var cols=document.getElementById('tabl_cols').value;
	var cols=120;
//	var head_yes=document.getElementById('ta_head').value;
	var head_yes=true;
	if(hm_numb<2) hm_numb=2;
	if(hm_numb>15) hm_numb=15;
	var tabl_tag=document.createElement('table');
	par_tag.appendChild(tabl_tag);
	if(head_yes) {
		var thead_tag=document.createElement('thead');
		tabl_tag.append(thead_tag);
		var tr_tag=document.createElement('tr');
		for(let i=0;i<hm_numb;i++) {
			var chd_tag = document.createElement('th');
//			var term='　表題'+String(i).slice(-1)[0]+'　';
//			chd_tag.innerHTML=term;
			chd_tag.innerHTML=heads[i];
//			var parms_1=parms_1+"border-radius:5px; border: solid 1px #008080;";
//			chd_tag.setAttribute('style', parms_1); contenteditable="false"
			tr_tag.appendChild(chd_tag);
			}
		thead_tag.append(tr_tag);
		}
	var tbody_tag=document.createElement('tbody');
	tbody_tag.setAttribute('id','sys_parm_table');
	tabl_tag.append(tbody_tag);
	for(let i=0;i<cols;i++) {			
	var tr_tag=document.createElement('tr');
	for(let j=0;j<hm_numb;j++) {
		var chd_tag = document.createElement('td');
		chd_tag.innerHTML='';
//		parms_1='width:'+parm_w.slice(-1)[0]+';';
//		var parms_1=parms_1+"border-radius:5px; border: solid 1px #008080;";
//		chd_tag.setAttribute('style', parms_1);
		chd_tag.setAttribute('contenteditable', "true"); 
		tr_tag.appendChild(chd_tag);
		}
	tbody_tag.append(tr_tag);
	}
	var line_dw='1px solid black';
console.log('line_dw=',line_dw);
	if(line_dw) {
		//Table罫線のテスト OK
		var td_cell=tabl_tag.querySelectorAll('td ,th');
		console.log('td_cell leng=',td_cell.length);
		var styl='border:'+line_dw;
		for(let i=0;i<td_cell.length;i++) {
			td_cell[i].setAttribute('style',styl);
			}
		}
	var ins_node=document.getElementById('tb_ins');
	$(par_tag).insertAfter(ins_node);


console.log('table=',tbody_tag,'rows=',tbody_tag.rows.length)
	for( var i = 0; i < terms.length; i++ ) {
   
       		var cells = tbody_tag.rows[ i ].cells;
console.log('cols=',cells.length);
        	for( var k = 0; k < cells.length; k++ ) {
			cells[k].textContent=terms[i][k];
			}
	}

    }  //End of disp_parm_table

    sys_set.onclick = function(){
console.log("***Set system parameters");
	var sys_parm_text=old_addr;

	var svg_pal=each_charpal(svg_gm_sel,svg_gm_pal);
	svg_pal='svg;'+svg_pal+'|<=>|';
	var html_pal=each_charpal(html_gm_sel,html_gm_pal);
	html_pal='html;'+html_pal+'|<=>|';

	sys_parm_text=svg_pal+html_pal;

	var sys_parm_set='sys_parm;'+$("#sys_param1").val()+','+$("#sys_param2").val()+','+$("#sys_param3").val()+','+param_set.value+';';
	sys_parm_text=sys_parm_text+sys_parm_set;

    	var tbody_tag = document.getElementById("sys_parm_table");
console.log('table=',tbody_tag);
	for( var i = 0; i < tbody_tag.rows.length; i++ ) {
   
       		var cells = tbody_tag.rows[ i ].cells;
console.log('cols=',cells.length);
		if(cells[0].textContent=='') break;
		else if(cells[1].textContent=='') {
			if(sys_parm_text!='') sys_parm_text=sys_parm_text+'|<=>|';
			sys_parm_text=sys_parm_text+cells[0].textContent+';';
			}
        	else for( var k = 0; k < cells.length; k++ ) {
			sys_parm_text=sys_parm_text+cells[k].textContent+',';
			}
		sys_parm_text=sys_parm_text.slice(0, -1)+';';
		}


	sys_parm_text=sys_parm_text+'|<=>|';
	update_sysparms(1,sys_parm_text);
console.log('saved sys_parms=',sys_parm_text);
    }

var lang_org='';

    function change_titles(){
console.log("***Enter chane titles");
	var lang=chan_title.value;
	sys_set_menu=lang;
	lang_org=lang;
console.log('lang=',sys_set_menu);

	var from_sys=get_common(1);
//console.log('from_sys=',from_sys);
	var parms=from_sys.split('|<=>|');
//console.log('sys parms=',parms);
	len=parms.length;
	var sys_parm_text='';

	for(let kn=0;kn<len;kn++){
		var sels=parms[kn].split(/;|,/);
		switch (sels[0]){
			case 'sys_parm':
				var sys_parms_dat=parms[kn];
				var sys_parms=sys_parms_dat.split(/;|,/);
console.log('sys parm=',parms);
				var sys_parm_set='sys_parm;'+sys_parms[1]+','+sys_parms[2]+','+sys_parms[3]+','+lang+';'+'|<=>|';
				sys_parm_text=sys_parm_text+sys_parm_set;
				break;
			case '':
				break;
       			default:
				sys_parm_text=sys_parm_text+parms[kn]+'|<=>|';
				break;
			}
		}
	if(for_cloud=='yes') {
		read_sysparms();
		return;
		}
	else {
		update_sysparms(1,sys_parm_text);
		lang_org='';
		}
console.log('saved sys_parms=',sys_parm_text);
    }

//system functionの起動メカニズム準備
    $(document).on('click', '#sys_exp_func01', function(){
	console.log('sys_exp_func01が押されました');
        var parm=this.getAttribute("parm");
	var result=parm+" complete";
	this.setAttribute("result",result);
	return;
	});

</script>
<!-- ポップアップウィンドウ用basic-draw（テンプレート） -->
<div class="dialog" id="basic-draw" title="Basic図">
  <div class="dialog-content">
	<!-- button id="oper_01" class="btn btn-outline-primary" -->
	<button id="oper_01"><svg class="icon"><use xlink:href="#Text" /></svg></button>
	<button id="oper_02"><svg class="icon"><use xlink:href="#circle" /></svg></button>
	<button id="oper_03"><svg class="icon"><use xlink:href="#smcirc" /></svg></button>
	<button id="oper_04"><svg class="icon"><use xlink:href="#ellips" /></svg></button>
	<button id="oper_05"><svg class="icon"><use xlink:href="#if" /></svg></button>
	<button id="oper_06"><svg class="icon"><use xlink:href="#rectLg" /></svg></button>
	<button id="oper_07"><svg class="icon"><use xlink:href="#rectSm" /></svg></button>
	<button id="oper_08"><svg class="icon"><use xlink:href="#rectRLg" /></svg></button>
	<button id="oper_09"><svg class="icon"><use xlink:href="#rectRSm" /></svg></button>
	<button id="oper_10"><svg class="icon"><use xlink:href="#start" /></svg></button>
	<button id="oper_11"><svg class="icon"><use xlink:href="#node" /></svg></button>
	<button id="oper_12"><svg class="icon"><use xlink:href="#input" /></svg></button>
	<button id="oper_13"><svg class="icon"><use xlink:href="#para" /></svg></button>
	<button id="oper_14"><svg class="icon"><use xlink:href="#print" /></svg></button>
	<button id="oper_15"><svg class="icon"><use xlink:href="#drum" /></svg></button>
	<div class="popwindow-content"></div></br>
	<p>    ---------共通--------</p>
	<label>倍率：x <input type="text" id="input1" value="0.5" style="width:60px;" onchange="basic_change_scale()"></label>
	<label>y <input type="text" id="input2" value="0.5" style="width:60px;" onchange="basic_change_scale()"></label>
   	<select id="place_pos" onchange="place_pos()" style="width:60px; height:25px;" ></p>
    		<option value="s000">none</option>
    		<option value="s001">left</option>
    		<option value="s002">center</option>
		<option value="s003">right</option>
   	</select>
   	<button class="btn" id="option_01">補助線</button>

  </div>
</div>
<!--button id="open-sample-dialog">ダイアログを開く</button -->
<script class="minify" id="smain_15">
   var draw_op = {
	oper:null,
	align : 'none',
	old_align:'none',
	scx:0.5,
	scy:0.5,
	posx :0,
	posy:0,
	aux_line:'',
	aux_pos:0,
	target:null,
	fig:null,
	}
   var aux_pos=0;

   var my_basic_draw_dialog=0;

   $("#basic_figure").on("click", function(){
console.log('Enter to basic_figure');
	//Editmode="Svg";
	Draw_mode="Basic";
	var theDialog=$( '#basic-draw' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:300, width: 300,  position: {my: "right bottom", at: "right bottom", of: window}} );
	//ダイアログを表示する
	my_basic_draw_dialog=1;
	draw_op.aux_line='';
	draw_op.aux_pos=0;
	draw_op.target=null;
	theDialog.dialog("open");
	});

   $('#basic-draw').on('dialogclose', function(event) {
	if(draw_op.oper) draw_op.oper.style.backgroundColor = "#f5f5f5";
//	draw_op.oper.style.backgroundColor = "#f5f5f5";
	if(draw_op.target) {
		container.removeChild(draw_op.target);
		draw_op.target=null;
		}
	if(draw_op.aux_line) {
		container.removeChild(draw_op.aux_line);
		draw_op.aux_line='';
//console.log('aux_line=',draw_op.aux_line);
		}
	if(Draw_mode=="Basic") Svg_mode="Svg_drag";
	Draw_mode="";
	my_basic_draw_dialog=0;
console.log('Dialog closed');
	});

    $(document).on('click', '#oper_01', function(){
	console.log('Oper_01が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=1;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_02', function(){
	console.log('Oper_02が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=2;
	draw_basic_figure(nn);
	});
    $(document).on('click', '#oper_03', function(){
	console.log('Oper_03が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=3;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_04', function(){
	console.log('Oper_04が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=4;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_05', function(){
	console.log('Oper_05が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=5;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_06', function(){
	console.log('Oper_06が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=6;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_07', function(){
	console.log('Oper_07が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=7;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_08', function(){
	console.log('Oper_08が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=8;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_09', function(){
	console.log('Oper_09が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=9;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_10', function(){
	console.log('Oper_10が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=10;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_11', function(){
	console.log('Oper_11が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=11;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_12', function(){
	console.log('Oper_12が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=12;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_13', function(){
	console.log('Oper_13が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=13;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_14', function(){
	console.log('Oper_14が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=14;
	draw_basic_figure(nn);	
	});
    $(document).on('click', '#oper_15', function(){
	console.log('Oper_15が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
console.log('draw_present=',this);
	var nn=15;
	draw_basic_figure(nn);
	});

    function draw_basic_figure(nn) {
	document.getElementById("fig_sel_end").click();
	Draw_mode="Basic";
	if(draw_op.aux_line) Draw_mode="Aux";
	if(draw_op.target) {
		container.removeChild(draw_op.target);
		draw_op.target=null;
		}	
	const basic = document.querySelector('#basic_svg');
        draw_op.target = (basic.children[nn]).cloneNode(true);
	draw_op.target.setAttribute("transform", "translate(0,0)"+"scale(1)");
	if(nn==1) {
//		draw_op.target.setAttribute("transform", "translate(40,20)"+"scale(1)");
//		draw_op.target.setAttribute("transform", "translate(5,5)"+"scale(1)");
		draw_op.target.setAttribute("style", "display:block;");
		draw_op.fig='text';
//console.log('basic text called text=',draw_op.target,draw_op.target.firstChild);
		}
	else {
		draw_op.fig='basic';
		}
	container.append(draw_op.target);

	window.scrollTo(0,off_page.top);

console.log('Basic drawn nn=',nn);
	}

    $(document).on('click', '#option_01', function(){
console.log('option_01が押されました');
console.log('before align=',draw_op.align,' old=',draw_op.old_align);
	const basic = document.querySelector('#basic_svg');
	if(Draw_mode!="Aux") {
		Draw_mode="Aux";
        	this.style.backgroundColor = "#b0c4de";
		draw_op.align=draw_op.old_align;

        	draw_op.aux_line = (basic.children[0]).cloneNode(true);
		container.append(draw_op.aux_line);
		draggable(draw_op.aux_line);
		var xx=draw_op.aux_line.getAttribute('x1');
		if(conv_cord) {
			var xx=-off_indivx;
			var yy=-off_indivy;
        		var tr_parm=`${xx},${yy}`;
			draw_op.aux_line.setAttribute("transform", "translate("+tr_parm+")");
			}
		xx=draw_op.aux_line.getAttribute('x1')
		draw_op.aux_pos = Number(xx);
		draw_op.posx=draw_op.aux_pos;
console.log('aux_line draw xx=',xx,draw_op.posx,draw_op.aux_pos);

		}
	else {
		Draw_mode="Basic";
        	this.style.backgroundColor = "#f5f5f5";
		draw_op.old_align=draw_op.align;
		draw_op.align='none';
		draw_op.aux_line.remove();
		draw_op.aux_line='';
		}
console.log('align=',draw_op.align,' old=',draw_op.old_align);
/*
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
*/
//console.log('draw_present=',this);
/*
	if(!draw_op.aux_line){
        	draw_op.aux_line = (basic.children[0]).cloneNode(true);
		container.append(draw_op.aux_line);
		draggable(draw_op.aux_line);
		var xx=draw_op.aux_line.getAttribute('x1');
		if(conv_cord) {
			var xx=-off_indivx;
			var yy=-off_indivy;
        		var tr_parm=`${xx},${yy}`;
			draw_op.aux_line.setAttribute("transform", "translate("+tr_parm+")");
			}
		xx=draw_op.aux_line.getAttribute('x1')
		draw_op.aux_pos = Number(xx);
		draw_op.posx=draw_op.aux_pos;
console.log('aux_line draw xx=',xx,draw_op.posx,draw_op.aux_pos);
		}
	else {
		//container.removeChild(draw_op.aux_line);
		//container.remove(draw_op.aux_line);
		draw_op.aux_line.remove();
		draw_op.aux_line='';
		}
console.log(draw_op.aux_line,draw_op.align,draw_op.posx);
*/
/*
	var xx=$("#input1").val();
	var yy=$("#input2").val();
	draw_op.scx=Math.min(5,Math.max(0.1,Math.round(Number(xx)*100)/100));
	draw_op.scy=Math.min(5,Math.max(0.1,Math.round(Number(yy)*100)/100));
	$("#input1").value=String(draw_op.scx);
	$("#input2").value=String(draw_op.scy);
*/
//	console.log('xx,yy=',draw_op.scx+'  '+draw_op.scy);
/*
	var tag_elem=[];
	tag_elem.push(dumy);
	DraggableItem.create('svg_00', tag_elem,'single');
*/
	});

    function basic_change_scale() {
	var xx=$("#input1").val();
	var yy=$("#input2").val();
	draw_op.scx=Math.min(5,Math.max(0.1,Math.round(Number(xx)*100)/100));
	draw_op.scy=Math.min(5,Math.max(0.1,Math.round(Number(yy)*100)/100));
	$("#input1").value=String(draw_op.scx);
	$("#input2").value=String(draw_op.scy);
	console.log('change scale xx,yy=',draw_op.scx+'  '+draw_op.scy);
	}

    function fig_resize(target,sx,sy) {
	switch(target.nodeName){
		case "circle":
			target.setAttribute('cx', target.attributes.cx.value*sx);
			target.setAttribute('cy', target.attributes.cy.value*sx);
			target.setAttribute('r', target.attributes.r.value*sx);
			target.setAttribute("stroke", defaultPathStyle.stroke);
			target.setAttribute("stroke-width", defaultPathStyle.strokeWidth);
			target.setAttribute("fill", defaultPathStyle.fill);
		default:
		}
//	circ1.setAttributeNS(null,'fill','red');
//	circ1.setAttributeNS(null,'stroke','black');
//	svg.appendChild(circ1);

    }

    function shift_fig(g_tag,x_sf,y_sf,rate) {  //g_tag中のsvg要素をマイナス方向に（x_shift,y_shift）ずらしてBasic図を形成する
console.log('**shift fig Node=');

console.log('child node leng=',g_tag.childElementCount);
	for (var k = 0; k < g_tag.childElementCount; k++) {
		tag=g_tag.children[k];
		if(tag.nodeName=="path") {
			var path_p=resolv_figure(tag);
console.log(path_p);
			var path_nw=shift_cord(path_p,x_sf,y_sf,rate);
console.log(path_nw);
			var new_pathd=set_phrase(tag,path_nw,0,1);
        		tag.setAttributeNS(null,'d', new_pathd);
			}
		else if(tag.nodeName=='g') {
			shift_fig(tag,x_sf,y_sf,rate);
			}
		else alert('target must be path element');
		}
	} //End function

    function simple_fig_top(g_temp,g_group,top_group,shift,divs) {  //g_group中にあるtagをg_tempにcopyしてtop_groupまでsimple化（matrix解消）する
console.log('**simple fig Node=',g_group,'temp Node=',g_temp);
	if(g_group.nodeName!='g' || g_temp.nodeName!='g' || top_group.nodeName!='g') {
//console.log('cant simplify this element');
alert('cant simplify');
		return;
		}

console.log('@@@@@@@child node leng=',g_group.childElementCount);
	var kn=g_group.childElementCount;
	for (var k = kn-1; k >=0; k--) {
		tag=g_group.children[k];
console.log('@@@@child k=',k,tag,'all child=',g_group.childElementCount);
		if(tag.nodeName=="path") {
			var target=tag.cloneNode(true);
//			shift_tag(target,shift);
			var path_p=resolv_figure(target);
			var path_nw=cord_trans_top(path_p,tag,top_group);
console.log('new_path=',path_nw);
			var new_pathd=set_phrase(target,path_nw,shift,divs);
        		target.setAttributeNS(null,'d', new_pathd);
			target.setAttributeNS(null,'transform','translate(0,0)');
//			Object.assign(target.style, defaultPathStyle);   //Basic図を指定のカラーで描画

			g_temp.appendChild(target);
			}
		else if(tag.nodeName=="g") {
console.log('else tag=',tag);
			simple_fig_top(g_temp,tag,top_group,shift,divs);
			}
		else if(tag.nodeName=="marker") {
			var target=tag.cloneNode(true);
			g_temp.appendChild(target);
//console.log('copy marker at simle_fig');
			}
		else {
console.log('remove Tag=', tag.nodeName,tag);
			}
		}
	} //End simple_fig_top function

    function shift_tag(tag,shift) {
	if(shift==0) return;
	var old_transf="";
	if(tag.transform.baseVal.numberOfItems>0) old_transf=tag.getAttributeNS(null, "transform");
	sx=-shift;
	var parm=`${sx},${sx}`;
console.log('translate shift=',shift,parm);
	var transf="translate("+parm+")";
	transf=transf+old_transf;
console.log('transf=',transf);
	tag.setAttribute('transform', transf);
	}

    function simple_fig(g_temp,g_group) {  //g_group中にあるtagをg_tempにcopyしてsimple化（matrix解消）する
console.log('**simple fig Node=',g_group,'temp Node=',g_temp);
	if(g_group.nodeName!='g' || g_temp.nodeName!='g') {
//console.log('cant simplify this element');
alert('cant simplify');
		return;
		}
	if(text_To_path) {
		var kn=g_group.childElementCount;
		for (var k = kn-1; k >=0; k--) {
			tag=g_group.children[k];
			if(tag.nodeName=="g") {
				var fig_ty=tag.getAttributeNS(null,'fig');
				if(fig_ty=='text') tag.remove();
				}
			}
		}
console.log('@@@@@@@child node leng=',g_group.childElementCount);
	var kn=g_group.childElementCount;
	for (var k = kn-1; k >=0; k--) {
		tag=g_group.children[k];
console.log('@@@@child k=',k,tag,'all child=',g_group.childElementCount);
		if(tag.nodeName=="path") {
			var target=tag.cloneNode(true);
//			var path_p=resolv_figure(target);
			var {path_p,p_type,tot_path}=resolv_figure_B(target);
			var path_nw=cord_trans(tot_path,g_group);

console.log('new_path=',path_nw);
			var new_pathd=set_phrase(target,path_nw,0,1);
        		target.setAttributeNS(null,'d', new_pathd);
			Object.assign(target.style, defaultPathStyle);   //Basic図を指定のカラーで描画
			var fig_ty=tag.getAttributeNS(null,'fig');
			if(fig_ty=='text_conv') {
console.log('***text_conv at simple_fig tag=',target,target.firstChild);
				pathTotext(g_temp,target,path_nw);
				}
			g_temp.appendChild(target);
			}
		else if(tag.nodeName=="g") {
			var target=tag.children[0].cloneNode(true);
//console.log('target=',target);
			if(target.nodeName=='text' && !text_To_path) {
				target=textTopath(tag,target);
				}
//			var path_p=resolv_figure(target);
			var {path_p,p_type,tot_path}=resolv_figure_B(target);
//console.log(path_p);
			var path_nw=cord_trans(tot_path,g_group);
//console.log(path_nw);
			var new_pathd=set_phrase(target,path_nw,0,1);
        		target.setAttributeNS(null,'d', new_pathd);
			Object.assign(target.style, defaultPathStyle);   //2022.7.6 Basic図を指定のカラーで描画
			g_temp.appendChild(target);
			var fig_ty=target.getAttributeNS(null,'fig');
			if(fig_ty=='text_conv' && !text_To_path) {
				var tx=target.children[0].cloneNode(true);
				tx.setAttributeNS(null,'style', 'display:block;');
				tx.setAttribute("transform", "");
				var tr_parm=`${path_nw[0].x},${path_nw[0].y}`;
				tx.setAttribute("transform", "translate("+tr_parm+")");
				g_temp.appendChild(tx);
				}
			}
		else if(tag.nodeName=="marker") {
			var target=tag.cloneNode(true);
			g_temp.appendChild(target);
//console.log('copy marker at simle_fig');
			}
		}
	if(!text_To_path) text_To_path=1;
	} //End simple_fig function

function pathTotext(group,target,points) {

	font.old_elem=Drag_elem;
	target.setAttributeNS(null,'style', 'display:none;');
	Drag_elem=target.firstChild.cloneNode(true);
	font.title=target.getAttribute('txterms');
	var vtext=font.title.split('<br>');
	var txleng=vtext.length;
	if(vtext[txleng-1]=="") txleng=txleng-1;
	txleng=Math.max(1,txleng);
	var txht=(points[1].y-points[0].y)/txleng;
	font.size=Math.min(80,Math.max(4,Math.round(Number(txht)*7)/10));
console.log('title=',font.title,'size=',font.size,Drag_elem);
	Drag_elem.setAttributeNS(null,'style', 'display:block;');
	Drag_elem.setAttribute("transform", "");
	tr_parm=`${points[0].x},${points[0].y}`;
	Drag_elem.setAttribute("transform", "translate("+tr_parm+")");
	compose_text(font.title,Drag_elem);
	var rtn=Drag_elem;
	group.appendChild(rtn);
	Drag_elem=font.old_elem;
	}

var text_To_path=0;

function textTopath(txgroup,text_tag) {
console.log('*****Enter textTopath **text=',text_tag,'group=',txgroup);
	var rect=txgroup.getBoundingClientRect();
//console.log('**rect=',rect);
	var atex=decompose_text(txgroup);
console.log('text=',atex);
	drawingPoints=[];
        drawingPoints.push({x: rect.left,y: rect.top});
        drawingPoints.push({x: rect.left,y: rect.bottom});
        drawingPoints.push({x: rect.right,y: rect.bottom});
        drawingPoints.push({x: rect.right,y: rect.top});
//console.log('points=',drawingPoints);
	let {group,fig_id}=make_group('path');
	drawingPtype=Array(drawingPoints.length);
	drawingPtype.fill(0);
	var path=set_line_group(group,drawingPtype,c_para,s_para);
	group.insertBefore(path, group.firstChild);
//	var path=set_line_group(group,'close','else');
console.log('set_line=',path,group);
	group.remove();
	path.setAttribute("fig","text_conv");
	path.setAttribute("txterms",atex);
	path.setAttribute('style','display:none;');
	path.appendChild(txgroup);
console.log('result group=',path);
	return path;
	}

    function copy_svgtag(to_tag,from_tag) {  //from_tag<g>中にあるtagをto_tag<g>に移し替える
console.log('copy_svgtag to_tag=',to_tag.nodeName,'from_tag=',from_tag.nodeName);
	if(from_tag.nodeName!='g') {
		console.log('cant simplify this element');
alert('cant copy');
		return;
		}

	to_tag.setAttribute("transform","translate(0,0)");
	to_tag.transform.baseVal=[];
        while (to_tag.lastElementChild) {
            	to_tag.removeChild(to_tag.lastElementChild);
		}

console.log('from_tag=',from_tag);
console.log('child node leng=',from_tag.childElementCount);
	for (var k = from_tag.childElementCount-1; k >=0; k--) {
		tag=from_tag.children[k];
console.log('child k=',k,tag);
		to_tag.insertBefore(tag, to_tag.firstChild);
		}
	from_tag.remove();
console.log('to_tag=',to_tag);
	} //End function


    function plane_simple_fig(g_temp,parent,g_group) {  //g_group中にあるtagをg_tempにcopyしてsimple化（matrix解消）する
	len=g_group.length;
console.log('**g_group len=',len,'g_group=',g_group);
	for(let k=0;k<len;k++) {
		g_tagn=document.getElementById(g_group[k].id_n);
console.log('g_group[k]=',g_tagn);
		fig=g_tagn.getAttribute('fig');
//		fig=g_group[k].nodeName;
console.log('*****fig type=',fig);
//fig='group'下の最下位には<path>タグでfigが定義されていない場合の扱い注意
		error=0;
		if(fig=="group") {
//			sublen=g_group[k].childElementCount;
			sublen=g_tagn.childElementCount;
			for(let n=0;n<sublen;n++) {
//				sub=g_group[k].children[n];
				sub=g_tagn.children[n];
				if(sub.nodeName=="g") {
//					plane_simple_fig(g_temp,g_group[k],sub);
					plane_simple_fig(g_temp,g_tagn,sub);
					}
				else if(sub.nodeName=="path"){
					var target=sub.cloneNode(true);
					var path_p=resolv_figure(target);
console.log(path_p);
//					var path_nw=cord_trans(path_p,g_group[k]);
					var path_nw=cord_trans(path_p,g_tagn);

console.log(path_nw);
					var new_pathd=set_phrase(target,path_nw,0,1);
        				target.setAttributeNS(null,'d', new_pathd);
					g_temp.appendChild(target);
					}
				else {
					error=100;
					alert('cant simplyfy elements');
					return error;
					}
				}
			}
		else if(fig=="text") {
			var target=g_group[k].temp.cloneNode(true);
			g_temp.appendChild(target);
			}
		else if(fig=="line") {
			}
		else {
			simple_fig(g_temp,g_group[k]);
			}
		}
		return error;
     } //End function plane_simple_fig

function shift_cord(path_p,x_sf,y_sf,rate) {

console.log('Points=',path_p);
	nw_path=[];
	for ( var i = 0;  i < path_p.length ; i++ ){
		var pt=path_p[i];
		pt.x=(pt.x-x_sf)*rate;
		pt.y=(pt.y-y_sf)*rate;
		nw_path.push({x:pt.x,y:pt.y});
		}
	return nw_path;
	} //End of function

function cord_trans_top(path_p,path_tag,top_group) {
	var par_tag=path_tag;
	var nw_path;
console.log('par_tag=',par_tag);
	do {
		par_tag=par_tag.parentNode;
console.log('par_tag2=',par_tag);
		nw_path=cord_trans(path_p,par_tag);
		path_p=nw_path;
console.log('cord_trans endcond top & present=',top_group,par_tag);
		} while (par_tag!=top_group);
console.log('cord_trans Stop');
	return nw_path;
    }

function cord_trans(path_p,group) {

console.log('Points=',path_p,group);
	var len=group.transform.baseVal.numberOfItems;
	var nw_path;
	var nm;
console.log('matrix len=',len);
	if(len==0) {
		nw_path=path_p;
		return nw_path;
		}
//	for( k=0 ; k<len ; k++) {      2023.5.21 修正
	for( k=len-1 ; k>=0 ; k--) {
		mat=group.transform.baseVal[k].matrix;
console.log('matric=',mat);
		nw_path=[];
		for ( var i = 0;  i < path_p.length ; i++ ){
			nm=Object.keys(path_p[i]).length;
console.log('treat matrix i nm=',i,nm,path_p[i]);
			if(nm>6) {
				var pnx=mat.a*path_p[i].x+mat.c*path_p[i].y+mat.e;
				var pny=mat.b*path_p[i].x+mat.d*path_p[i].y+mat.f;
				nw_path.push({rx: path_p[i].rx,ry: path_p[i].ry,r:path_p[i].r,a:path_p[i].a,s:path_p[i].s,x:pnx,y:pny});
				}
			else if(path_p[i].x=='H' || path_p[i].x=='h' || path_p[i].x=='V' || path_p[i].x=='v') {
					nw_path.push({x:path_p[i].x,y:path_p[i].y});
					}
			else {
				var pt=path_p[i];
				var pnx=mat.a*pt.x+mat.c*pt.y+mat.e;
				var pny=mat.b*pt.x+mat.d*pt.y+mat.f;
				pt.x=pnx;
				pt.y=pny;
				nw_path.push({x:pt.x,y:pt.y});
				}
console.log('old to new=',path_p[i],nw_path[i]);
			}
		path_p=nw_path;
		}
	return nw_path;
	} //End of function

    function set_phrase(tag,path,shift,divs) {
console.log('Enter set_phrase shift and divs=',shift,divs);
	attr_char=tag.getAttribute("d"); 
console.log('**set phrase attr= ',attr_char);
	var replaced = attr_char.replace(/-/g, ',-');
//	var replace2 = replaced.split(/M|T|Q|q|S|s|C|c|L|l|Z/g);
	var replace3 = replaced.split(/(?=[MmTtAaQqSsCcLlVvHhZz])/);
		
	var result='';
	var kk=0;
	for (i=0 ; i<replace3.length ; i++) {
		var cat=replace3[i].replace(/,/g,' ');
		var sub = cat.split(' ');
console.log('leng=',sub.length,'sub=',sub);
		var leng=0;
		for(j=0; j<sub.length ; j++) {
			if(sub[j]!="") leng+=1;
			}
console.log('leng=',leng);
		var res=cat.slice(0,1);
		if(leng>=2) {
			if(res=='A' || res=='a') {
console.log('pattern A=',path[kk]);
				res=res+path[kk].rx+' '+path[kk].ry+' '+path[kk].r+' '+path[kk].a+' '+path[kk].s+' '+(path[kk].x-shift)/divs+' '+(path[kk].y-shift)/divs;
				kk=kk+1;
				}
			else if(res=='M' || res=='m' || res=='L' || res=='l'|| res=='T' || res=='t') {
console.log('pattern M=',path[kk]);
				res=res+String(Math.round((path[kk].x-shift)/divs*10)/10)+','+String(Math.round((path[kk].y-shift)/divs*10)/10)+' ';       
				kk=kk+1;
				}
			else if(res=='S' || res=='s' || res=='Q' || res=='q') {
				res=res+String(Math.round((path[kk].x-shift)/divs*10)/10)+','+String(Math.round((path[kk].y-shift)/divs*10)/10)+' ';       
				kk=kk+1;
				res=res+String(Math.round((path[kk].x-shift)/divs*10)/10)+','+String(Math.round((path[kk].y-shift)/divs*10)/10)+' ';       
				kk=kk+1;
				}
			else if(res=='C' || res=='c') {
				res=res+String(Math.round((path[kk].x-shift)/divs*10)/10)+','+String(Math.round((path[kk].y-shift)/divs*10)/10)+' ';       
				kk=kk+1;
				res=res+String(Math.round((path[kk].x-shift)/divs*10)/10)+','+String(Math.round((path[kk].y-shift)/divs*10)/10)+' ';       
				kk=kk+1;
				res=res+String(Math.round((path[kk].x-shift)/divs*10)/10)+','+String(Math.round((path[kk].y-shift)/divs*10)/10)+' ';       
				kk=kk+1;
				}
			else if(res=='H' || res=='h' || res=='V' || res=='v') {
				res=res+String(Math.round((path[kk].y-shift)/divs*10)/10)+' ';
				kk=kk+1;
				}
			}
		result=result+res;
console.log('res=',res);
		}
	return result;
	}

    function place_pos() {
　　let select = document.getElementById('place_pos');
    //選択したf_editによって分岐
    switch (select.selectedIndex){
      case 0:               
		draw_op.align='none';
		break;
      case 1:               
		draw_op.align='left';
		break;
      case 2:               
		draw_op.align='center';
		break;
      case 3:               
		draw_op.align='right';
		break;
		}
console.log('align set=',draw_op.align);
    }

</script>
<!-- ポップアップウィンドウdraw-svg用HTML -->
<div class="dialog" id="draw-svg" title="描画">
  <div class="dialog-content">
	<button id="draw_01"><svg class="icon"><use xlink:href="#line" /></svg></button>
	<button id="draw_02"><svg class="icon"><use xlink:href="#line-endar" /></svg></button>
	<button id="draw_03"><svg class="icon"><use xlink:href="#line-sttar" /></svg></button>
	<button id="draw_04"><svg class="icon"><use xlink:href="#line-stedar" /></svg></button>
	<button id="draw_05"><svg class="icon"><use xlink:href="#serial" /></svg></button>
	<button id="draw_06"><svg class="icon"><use xlink:href="#closed" /></svg></button>
	<button id="draw_07"><svg class="icon"><use xlink:href="#smooth" /></svg></button>
	<button id="draw_08"><svg class="icon"><use xlink:href="#c-smooth" /></svg></button>
	<button id="draw_12"><svg class="icon"><use xlink:href="#free" /></svg></button>
	<button id="draw_09"><svg class="icon"><use xlink:href="#q-bezier" /></svg></button>
	<button id="draw_10"><svg class="icon"><use xlink:href="#c-bezier" /></svg></button>
	<button id="draw_11"><svg class="icon"><use xlink:href="#free" /></svg></button>
    <div class="popwindow-content"></div></br>
    <p>    ---------共通--------</p>
        <form name="selbox">
	<label>線幅</label>
	   <input type="text" name="width_combo" list="width_A" id="line_size" onchange="chng_width()" autocomplete="off" style="height:25px; width:55px;">
	   <datalist id="width_A">
		<option>1</option>
    		<option selected>2</option>
		<option>4</option>
    		<option>8</option>
    		<option>12</option>
	   </datalist><label>　　same&nbsp;<input type="checkbox" id="same_path" value=""></label><br>
	</form>
        <label>矢印</label>
        <select id="arrow" onchange="chng_arrow()" style="width:100px; height:25px;" >
    		<option value="" selected></option>
    		<option value="fw/">fw/</option>
		<option value="bw/">bw/</option>
    		<option value="/fw">/fw</option>
		<option value="/bw">/bw</option>
    		<option value="fw/fw">fw/fw</option>
    		<option value="fw/bw">fw/bw</option>
    		<option value="bw/fw">bw/fw</option>
    		<option value="bw/bw">bw/bw</option>
    		<option value="none/none">none/none</option>
	</select></br>
	<label>線種</label>
        <select id="Lstyle" onchange="chng_Lstyle()" style="width:60px; height:25px;" >
    		<option value="s000" selected></option>
    		<option value="s001">none</option>
    		<option value="s002">dash</option>
		<option value="s003">1dash</option>
    		<option value="s004">2dash</option>
	</select></br>
  	<label>Trim&nbsp;<input type="checkbox" id="Ftrim" value=""></label><label>&nbsp;&nbsp;R&nbsp;<input type="text" id="Trim_R" value="10" style="width:60px;"></label></br>
  </div>
</div>

<script class="minify" id="smain_16">
   var S_line_Trim=0;
   var my_draw_fig_dialog=0;

   $("#draw_fig").on("click", function(){
console.log('***draw_fig');
//	Svg_mode="";
//	Draw_mode="";
	drawingPoints = [];
	var theDialog=$( '#draw-svg' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:320, width: 250,  position: {my: "right bottom", at: "right bottom", of: window}} );
	//ダイアログを表示する
	theDialog.dialog("open");
console.log('default_size=',defaultPathStyle.strokeWidth);
//	$('#line_size').value="2"; jQueryでは設定できない
	document.getElementById( "line_size" ).value = defaultPathStyle.strokeWidth;
	document.getElementById( "Trim_R" ).value = 10;
	my_draw_fig_dialog=1;
	//user_select('none');
	});

   $('#draw-svg').on('dialogclose', function(event) {
	drawingPoints = [];
	control.value="none";
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
	my_draw_fig_dialog=0;
//	user_select('auto');
	if(Svg_mode=="Draw")Svg_mode="Svg_drag";
	Draw_mode="";
console.log('Dialog closed');
	});

function draw_focusin() {
	document.getElementById("fig_sel_end").click();
	Svg_mode="Draw";
	Draw_mode="Draw";
	if(draw_op.target) {
		container.removeChild(draw_op.target);
		draw_op.target=null;
		}
	if(draw_op.aux_line) {
		//container.removeChild(draw_op.aux_line);
		//container.remove(draw_op.aux_line);
		draw_op.aux_line.remove();
		}
	window.scrollTo(0,off_page.top);

	}

    $(document).on('click', '#draw_01', function(){
	draw_focusin();
	console.log('draw_01が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
	control.value='simp_line';
	tempArrowStyle='';
	});
    $(document).on('click', '#draw_02', function(){
	draw_focusin();
	console.log('draw_02が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
	control.value='simp_line';
	tempArrowStyle='/fw';
	});
    $(document).on('click', '#draw_03', function(){
	draw_focusin();
	console.log('draw_03が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
	control.value='simp_line';
	tempArrowStyle='bw/';
	});
    $(document).on('click', '#draw_04', function(){
	draw_focusin();
	console.log('draw_04が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
	control.value='simp_line';
	tempArrowStyle='bw/fw';
	});
    $(document).on('click', '#draw_05', function(){
	draw_focusin();
	console.log('draw_05が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
	control.value='seri_line';
	S_line_Trim=0;
	var trim=document.getElementById("Ftrim").checked;
	if(trim==true){
		S_line_Trim=Number(document.getElementById("Trim_R").value);
	}
console.log('trim=',trim,'value=',S_line_Trim);
	});
    $(document).on('click', '#draw_06', function(){
	draw_focusin();
	console.log('draw_06が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
	control.value='close_line';
	S_line_Trim=0;
	var trim=document.getElementById("Ftrim").checked;
	if(trim==true){
		S_line_Trim=Number(document.getElementById( "Trim_R" ).value);
	}
console.log('trim=',trim,'value=',S_line_Trim);
	});
    $(document).on('click', '#draw_07', function(){
	draw_focusin();
	console.log('draw_07が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
	control.value='smooth';
	});
    $(document).on('click', '#draw_08', function(){
	draw_focusin();
	console.log('draw_08が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
	control.value='close_smooth';
	});
    $(document).on('click', '#draw_12', function(){
	draw_focusin();
	console.log('draw_12が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
	control.value='free_smooth';
	});
    $(document).on('click', '#draw_09', function(){
	draw_focusin();
	console.log('draw_09が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
	control.value='quad_bezier';
	});
    $(document).on('click', '#draw_10', function(){
	draw_focusin();
	console.log('draw_10が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
	control.value='cubic_bezier';
	});
    $(document).on('click', '#draw_11', function(){
	draw_focusin();
	console.log('draw_11が押されました');
	if(draw_op.oper) {
		draw_op.oper.style.backgroundColor = "#f5f5f5";
		}
        this.style.backgroundColor = "#b0c4de";
	draw_op.oper=this;
	control.value='free_line';
	});

   function chng_width()　{
console.log('**Enter change svg linewidth**',Editmode);
　　//let select = document.getElementById('line_size');
    //選択したf_editによって分岐
        var line_width=$("#line_size").val();
	defaultPathStyle.strokeWidth=String(line_width)+"px";
console.log('line width=',line_width,defaultPathStyle.strokeWidth);

	}
</script>

<!-- ポップアップウィンドウdraw-svg用HTML -->
<div class="dialog" id="pop_input_search" title="概要">
  <div class="dialog-content">
	<form name="selboxB">
	<p><label>課題名</label><br>
	<input type="text" name="comboA" list="list_A" id="comA" onchange="chanComA()" autocomplete="off" style="height:25px; width:180px;">
	<datalist id="list_A"></datalist>
	<p><label>大分類</label><br>
	<input type="text" name="comboB" list="list_B" id="comB" onchange="chanComB()"  autocomplete="off" style="height:25px; width:180px;">
	<datalist id="list_B"></datalist>
	<p><label>中分類</label><br>
	<input type="text" name="comboC" list="list_C" id="comC" onchange="chanComC()"  autocomplete="off" style="height:25px; width:180px;">
	<datalist id="list_C"></datalist>
	<p><label>小分類</label><br>
	<input type="text" name="comboD" list="list_D" id="comD" onchange="chanComD()"  autocomplete="off" style="height:25px; width:180px;">
	<datalist id="list_D"></datalist>
	<p><label>概要</label><br>
	<textarea name="viewText" id="Texview" cols="32" rows=5 maxlength="150" style="line-height: 1em"></textarea>
	<p><label>更新日</label><br>
	<input type="date" id="T_date"></input>
	</form>
   	<button id="pop_save">Save</button>　<button id="pop_cancel">Cancel</button>
  </div>
</div>
<script class="minify" id="smain_17">
//　My_Indexモデルのixdata_n　よりコンボデータを作成する
   var gDataCombobox = [{ id: 0, value: "" ,pk:0,nn:0}];
   var gDataComboboxA = [{ id: 0, value: "" ,pk:0,nn:0}];
   var gDataComboboxB = [{ id: 0, value: "" ,pk:0,nn:0}];
   var gDataComboboxC = [{ id: 0, value: "" ,pk:0,nn:0}];
   var gDataComboboxD = [{ id: 0, value: "" ,pk:0,nn:0}];

   var set_ComboA = { id: 0, value: "" ,pk:0,nn:0};
   var set_ComboB = { id: 0, value: "" ,pk:0,nn:0};
   var set_ComboC = { id: 0, value: "" ,pk:0,nn:0};
   var set_ComboD = { id: 0, value: "" ,pk:0,nn:0};

   var old_ComboA = { id: 0, value: "" ,pk:0,nn:0};
   var old_ComboB = { id: 0, value: "" ,pk:0,nn:0};
   var old_ComboC = { id: 0, value: "" ,pk:0,nn:0};
   var old_ComboD = { id: 0, value: "" ,pk:0,nn:0};

   var Pop_Edit=0;

function pop_inp_search() {
console.log('***popup_input検索');
	var theDialog=$( '#pop_input_search' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:450, width: 320,  position: {my: "right bottom", at: "right bottom", of: window}} );
	//ダイアログを表示する
	theDialog.dialog("open");
	get_index(0,1,'');    // Top indexを取得する
//indexdata（keyword）の読み込み
	if (my_overview!='') {
//documentを既に読み込んでいる場合（Edit又はCopy新規の場合）
//		overview_term=my_overview.split('|<=>|');
console.log('overviews=',overview_term);
		document.getElementById( "comA" ).value=overview_term[0];
		chanComA();
		document.getElementById( "comB" ).value=overview_term[1];
		chanComB();
		document.getElementById( "comC" ).value=overview_term[2];
		chanComC();
		document.getElementById( "comD" ).value=overview_term[3];
		chanComD();
		document.getElementById( "Texview" ).value=overview_term[7];
		old_ComboA.value=set_ComboA.value;
		old_ComboA.pk=set_ComboA.pk;
		old_ComboB.value=set_ComboB.value;
		old_ComboB.pk=set_ComboB.pk;
		old_ComboC.value=set_ComboC.value;
		old_ComboC.pk=set_ComboC.pk;
		old_ComboD.value=set_ComboD.value;
		old_ComboD.pk=set_ComboD.pk;
console.log('old_Combo=',old_ComboA,old_ComboB,old_ComboC,old_ComboD);
		Pop_Edit=0;
		}
}  //End pop_inp_search

/*  index dataの要求　　　　*/
function ret_index(){
	gDataComboboxA=gDataCombobox;
console.log('gDataComboboxA=',gDataComboboxA);

  	//EditorTabのDropDownリストを設定する
	remove_all_child(document.getElementById("list_A"));
	remove_all_child(document.getElementById("list_B"));
	remove_all_child(document.getElementById("list_C"));
	remove_all_child(document.getElementById("list_D"));
console.log(document.getElementById("list_A").children);
  	for(var i=0;i<gDataComboboxA.length;i++){
	    	var op = document.createElement("option");
    		op.value = gDataComboboxA[i].value;
    		document.getElementById("list_A").appendChild(op);
  		}
	document.getElementById( "comA" ).value='';
	document.getElementById( "comB" ).value='';
	document.getElementById( "comC" ).value='';
	document.getElementById( "comD" ).value='';
   }  //End of function get_topindex

function remove_all_child(elem) {
	while( elem.firstChild ){
  		elem.removeChild( elem.firstChild );
	}
   }

function get_index(level,pk_num,key_wd) {
console.log('*** get index data require　Entered  ***');
console.log('level=',level,' pk_num=',pk_num,' key_wd=',key_wd);
        $.ajax({
            url: "/db_serv/get_index/",
            async:false,
            data: {
		"level":level,
		"pk_num":pk_num,
		"key_wd":key_wd
		},
            dataType: 'json'
        })
        .done((data) => {
            //結果が帰ってきたら、表示します。
		console.log('**Ajax Returned result=',data);
		var key_elem=data['key_tags'].split('|<=>|');
		console.log('keys=',key_elem);
		gDataCombobox = [{ id: 0, value: "" ,pk:0,nn:0}];
		for(var i=0;i<key_elem.length;i++) {
			var dkey=key_elem[i].split(',');
			var item = new Object();
			item.id = i; // input value
			item.value = dkey[0];
			item.pk=dkey[1];
			item.nn=dkey[2];
			gDataCombobox.push(item)
			}
console.log('level=',data['level']);
		 switch (data['level']){
      			case 0:
console.log('enter case 0');
				ret_index();
				break;
      			case 1:
 				ret_chngcombA();
				Pop_Edit=4;
				break;
      			case 2:
 				ret_chngcombB();
				if (Pop_Edit<3) {
					Pop_Edit=3;
					}
				break;
	  		case 3:
 				ret_chngcombC();
				if (Pop_Edit<2) {
					Pop_Edit=2;
					}
				break;
	  		case 4:
				if (Pop_Edit<1) {
					Pop_Edit=1;
					}
				break;
			default:
				break;
			}
        });
   }  //End function get_index

pop_save.onclick = function(){
console.log('** Enter pop Save Pop_Edit=',Pop_Edit)
//new keys 及び　old keysの健全性checkと変更をAjax送信（mod_index())
console.log('new_Combo=',set_ComboA,set_ComboB,set_ComboC,set_ComboD);
console.log('old_Combo=',old_ComboA,old_ComboB,old_ComboC,old_ComboD);
	if(Pop_Edit>0) {
		var save_Pop_Edit=Pop_Edit;
		set_new_index()
		Pop_Edit=save_Pop_Edit;
		set_old_index()
		mod_index('last',0,1,'');
		}

//テスト用としてここでdocumentをsaveする
//my_overviewの生成
	overview_term[0]=set_ComboA.value;
	overview_term[1]=set_ComboB.value;
	overview_term[2]=set_ComboC.value;
	overview_term[3]=set_ComboD.value;
	var dat=formatDate(new Date());
	overview_term[5]=dat;
	overview_term[7]=(document.getElementById("Texview").value).trim();
console.log(my_overview);
	my_confirm(6);
console.log('**doc saved at throught pop_input_search');
//alert('document saved!!');
	$( '#pop_input_search' ) . dialog("close");
//Doc　本体のSave(set key_wd to my_overview, set my_head, 本体（html　and　Svg）
   }  //End of function pop_save

pop_cancel.onclick = function(){
console.log('** Enter pop Cancel');
	Popcheck=0;
	$( '#pop_input_search' ) . dialog("close");
alert('document not saved!!');
   }

function newdoc_compose(){
	const ary = new Array(9);
	for (let i = 0, len = ary.length; i < len; i++) {
    		ary[i] = '';
		}
	ary[7]='';
	var dat=formatDate(new Date());
	ary[4]=dat;
	ary[5]=dat;
	ary[8]='doc_parm;'+sys_max_width+','+sys_marginL+','+sys_marginR+';|<=>|';
//	var ret=compose_overview(ary[0],ary[1],ary[2],ary[3],ary);
console.log(ary);
	return ary;
	}  //End newdoc_compose

// 日付をYYYY-MM-DDの書式で返すメソッド
function formatDate(dt) {
  var y = dt.getFullYear();
  var m = ('00' + (dt.getMonth()+1)).slice(-2);
  var d = ('00' + dt.getDate()).slice(-2);
  return (y + '-' + m + '-' + d);
}

function compose_overview(a,b,c,d,term){
	var ret=omit_escape(a)+'|<=>|'+omit_escape(b)+'|<=>|'+omit_escape(c)+'|<=>|'+omit_escape(d);
console.log('ret first',ret);
console.log('term=',term,term.length);
	for(var k=4;k<term.length;k++) {
//		ret=ret+'|<=>|'+escapeHtml(escape(term[k]));
		ret=ret+'|<=>|'+escape(term[k]);
		}
console.log(ret);
	return ret;
	}

function set_new_index(){
	start_ind=0;
	if(Pop_Edit>3) {
console.log('Pop_Edit=',Pop_Edit,'start from Top_index');
console.log('modify_index=',set_ComboA,old_ComboA);
		start_ind=1;
		mod_index('start',0,1,'');
		if(set_ComboA.pk==0) {
			mod_index('new',1,set_ComboA.pk,set_ComboA.value);
			}
		else if(set_ComboA.pk!=0) {
			mod_index('add',1,set_ComboA.pk,set_ComboA.value);
			}
		Pop_Edit=3;
		}
	if(Pop_Edit>2) {
console.log('Pop_Edit=',Pop_Edit,'start_index=',set_ComboA);
console.log('modify_index=',set_ComboB,old_ComboB);
		if(start_ind==0) {
			start_ind=1;
			mod_index('start',1,set_ComboA.pk,set_ComboA.value);
			}
		if((set_ComboB.pk==0)&&(set_ComboB.value!='')) {
			mod_index('new',2,set_ComboB.pk,set_ComboB.value);
			}
		else if(set_ComboB.pk!=0){
			mod_index('add',2,set_ComboB.pk,set_ComboB.value);
			}
		Pop_Edit=2;
		}
	if(Pop_Edit>1) {
console.log('Pop_Edit=',Pop_Edit,'start_index=',set_ComboB);
console.log('modify_index=',set_ComboC,old_ComboC);
		if(start_ind==0) {
			start_ind=1;
			mod_index('start',2,set_ComboB.pk,set_ComboB.value);
			}
		if((set_ComboC.pk==0)&&(set_ComboC.value!='')) {
			mod_index('new',3,set_ComboC.pk,set_ComboC.value);
			}
		else if(set_ComboC.pk!=0) {
			mod_index('add',3,set_ComboC.pk,set_ComboC.value);
			}
		Pop_Edit=1;
		}
	if(Pop_Edit>0) {
console.log('Pop_Edit=',Pop_Edit,'start_index=',set_ComboC);
console.log('modify_index=',set_ComboD,old_ComboD);
		if(start_ind==0) {
			start_ind=1;
			mod_index('start',3,set_ComboC.pk,set_ComboC.value);
			}
		if((set_ComboD.pk==0)&&(set_ComboD.value!='')) {
			mod_index('new',4,set_ComboD.pk,set_ComboD.value);
			}
		else if(set_ComboD.pk!=0) {
			mod_index('add',4,set_ComboD.pk,set_ComboD.value);
			}
		Pop_Edit=0;
		}
	} //End set_new_index

function set_old_index(){
	start_ind=0;
	if(Pop_Edit>3) {
console.log('Pop_Edit=',Pop_Edit,'start from Top_index');
console.log('modify_index=',set_ComboA,old_ComboA);
		start_ind=1;
		mod_index('start',0,1,'');
		if((set_ComboA.pk!=old_ComboA.pk)&&(old_ComboA.pk!=0)){
			mod_index('del',1,old_ComboA.pk,old_ComboA.value);
			}
		Pop_Edit=3;
		}
	if(Pop_Edit>2) {
console.log('Pop_Edit=',Pop_Edit,'start_index=',set_ComboA);
console.log('modify_index=',set_ComboB,old_ComboB);
		if(start_ind==0) {
			start_ind=1;
			mod_index('start',1,set_ComboA.pk,set_ComboA.value);
			}
		if((set_ComboB.pk!=old_ComboB.pk)&&(old_ComboB.pk!=0)){
			mod_index('del',2,old_ComboB.pk,old_ComboB.value);
			}
		Pop_Edit=2;
		}
	if(Pop_Edit>1) {
console.log('Pop_Edit=',Pop_Edit,'start_index=',set_ComboB);
console.log('modify_index=',set_ComboC,old_ComboC);
		if(start_ind==0) {
			start_ind=1;
			mod_index('start',2,set_ComboB.pk,set_ComboB.value);
			}
		if((set_ComboC.pk!=old_ComboC.pk)&&(old_ComboC.pk!=0)){
			mod_index('del',3,old_ComboC.pk,old_ComboC.value);
			}
		Pop_Edit=1;
		}
	if(Pop_Edit>0) {
console.log('Pop_Edit=',Pop_Edit,'start_index=',set_ComboC);
console.log('modify_index=',set_ComboD,old_ComboD);
		if(start_ind==0) {
			start_ind=1;
			mod_index('start',3,set_ComboC.pk,set_ComboC.value);
			}
		if((set_ComboD.pk!=old_ComboD.pk)&&(old_ComboD.pk!=0)){
			mod_index('del',4,old_ComboD.pk,old_ComboD.value);
			}
		Pop_Edit=0;
		}
	}  //End set_old_index

function mod_index(mod,level,pk_num,key_wd) {
console.log('*** modify index Ajax mod=',mod,'level=',level,'pk=',pk_num,'key=',key_wd);
	var es_key_wd=omit_escape(key_wd);
        $.ajax({
            url: "/db_serv/mod_index/",
            async:false,
            data: {
		"mod":mod,
		"level":level,
		"pk_num":pk_num,
		"key_wd":es_key_wd
		},
            dataType: 'json'
        })
        .done((data) => {
            //結果が帰ってきたら、表示します。
		console.log('**Ajax Returned result=',data);
        	})

   }  //End function mod_index


//Editor画面 combobox ComA onchange function 
function chanComA() {
   E_selA=$("#comA").val();
console.log('**Editor SelectA =',E_selA);
console.log('gDataComboboxA=',gDataComboboxA,'leng=',gDataComboboxA.length);
	n_selA=0;
	for(i=0; i<gDataComboboxA.length ;i++) {
		if(gDataComboboxA[i].value==E_selA) {
			n_selA=i;
			break;
			}
		}
	E_selA=cutescape(E_selA.trim());
	if(n_selA!=0){
		var level=1;
		var pk_num=gDataComboboxA[n_selA].pk
		set_ComboA=gDataComboboxA[n_selA];
console.log('comA=',gDataComboboxA[n_selA]);
		get_index(level,pk_num,E_selA);
		}
	else {
		set_ComboA.value=E_selA;
		set_ComboA.pk=0;
		dmret_chngcombA();
		Pop_Edit=4;
		}
   }

function ret_chngcombA(){
	gDataComboboxB=gDataCombobox;
console.log('gDataComboboxB=',gDataComboboxB);
	dmret_chngcombA();

  	for(var i=0;i<gDataComboboxB.length;i++){
    		var op = document.createElement("option");
    		op.value = gDataComboboxB[i].value;
    		document.getElementById("list_B").appendChild(op);
  		}
//console.log(document.getElementById("list_B").children);
	}

function dmret_chngcombA(){
  	//EditorTabのDropDownリストを設定する
	remove_all_child(document.getElementById("list_B"));
	remove_all_child(document.getElementById("list_C"));
	remove_all_child(document.getElementById("list_D"));

	document.getElementById( "comB" ).value='';
	document.getElementById( "comC" ).value='';
	document.getElementById( "comD" ).value='';
	set_ComboB = { id: 0, value: "" ,pk:0,nn:0};
	set_ComboC = { id: 0, value: "" ,pk:0,nn:0};
	set_ComboD = { id: 0, value: "" ,pk:0,nn:0};

   }  //End of function ret_chngcombA

// combobox CombB onchange function
function chanComB() {
   E_selB=$("#comB").val();
console.log('**Editor SelectB =',E_selB);
console.log('gDataComboboxB=',gDataComboboxB,'leng=',gDataComboboxB.length);
	n_selB=0;
	for(i=0; i<gDataComboboxB.length ;i++) {
		if(gDataComboboxB[i].value==E_selB) {
			n_selB=i;
			break;
			}
		}
	E_selB=cutescape(E_selB.trim());
	if(n_selB!=0){
		var level=2;
		var pk_num=gDataComboboxB[n_selB].pk
		set_ComboB=gDataComboboxB[n_selB];
console.log('comB=',gDataComboboxB[n_selB]);
		get_index(level,pk_num,E_selB);
		}
	else {
		set_ComboB.value=E_selB;
		set_ComboB.pk=0;
		dmret_chngcombB();
		if(Pop_Edit<3){
			Pop_Edit=3;
			}
		}
   }

function ret_chngcombB(){
	gDataComboboxC=gDataCombobox;
console.log('gDataComboboxC=',gDataComboboxC);
	dmret_chngcombB();
  	for(var i=0;i<gDataComboboxC.length;i++){
    		var op = document.createElement("option");
    		op.value = gDataComboboxC[i].value;
    		document.getElementById("list_C").appendChild(op);
  		}
//console.log(document.getElementById("list_C").children);
   }

function dmret_chngcombB(){
  	//EditorTabのDropDownリストを設定する
	remove_all_child(document.getElementById("list_C"));
	remove_all_child(document.getElementById("list_D"));

	document.getElementById( "comC" ).value='';
	document.getElementById( "comD" ).value='';
	set_ComboC = { id: 0, value: "" ,pk:0,nn:0};
	set_ComboD = { id: 0, value: "" ,pk:0,nn:0};

   }  //End of function ret_chngcombB

// combobox CombC onchange function
function chanComC() {
   E_selC=$("#comC").val();
console.log('**Editor SelectC =',E_selC);
console.log('gDataComboboxC=',gDataComboboxC,'leng=',gDataComboboxC.length);
	n_selC=0;
	for(i=0; i<gDataComboboxC.length ;i++) {
		if(gDataComboboxC[i].value==E_selC) {
			n_selC=i;
			break;
			}
		}
	E_selC=cutescape(E_selC.trim());
	if(n_selC!=0){
		var level=3;
		var pk_num=gDataComboboxC[n_selC].pk
		set_ComboC=gDataComboboxC[n_selC];
console.log('comC=',gDataComboboxC[n_selC]);
		get_index(level,pk_num,E_selC);
		}
	else {
		set_ComboC.value=E_selC;
		set_ComboC.pk=0;
		dmret_chngcombC();
		if(Pop_Edit<2){
			Pop_Edit=2;
			}
		}
   }

function ret_chngcombC(){
	gDataComboboxD=gDataCombobox;
console.log('gDataComboboxD=',gDataComboboxD);
	dmret_chngcombC();
  	for(var i=0;i<gDataComboboxD.length;i++){
    		var op = document.createElement("option");
    		op.value = gDataComboboxD[i].value;
    		document.getElementById("list_D").appendChild(op);
  		}
//console.log(document.getElementById("list_D").children);
   }

function dmret_chngcombC(){
  	//EditorTabのDropDownリストを設定する
	remove_all_child(document.getElementById("list_D"));
	document.getElementById( "comD" ).value='';
	set_ComboD = { id: 0, value: "" ,pk:0,nn:0};
   }  //End of function ret_chngcombB

function chanComD() {
   E_selD=$("#comD").val();
console.log('**Editor SelectD =',E_selD);
//console.log('gDataComboboxD=',gDataComboboxD,'leng=',gDataComboboxD.length);
	n_selD=0;
	for(i=0; i<gDataComboboxD.length ;i++) {
		if(gDataComboboxD[i].value==E_selD) {
			n_selD=i;
			break;
			}
		}
	E_selD=cutescape(E_selD.trim());;
	if(n_selD!=0){
		var level=4;
		var pk_num=gDataComboboxD[n_selD].pk
		set_ComboD=gDataComboboxD[n_selD];
console.log('comD=',gDataComboboxD[n_selD]);
		get_index(level,pk_num,E_selD);
   		}
	else {
		set_ComboD.value=E_selD;
		set_ComboD.pk=0;
		if(Pop_Edit<1){
			Pop_Edit=1;
			}
		}
   }

function make_url(num){
console.log('make_url num=',num);
   //window.location.href = "{% url 'editor' 123 %}".replace(/123/,num);
   window.open().location.href = "{% url 'editor' 123 %}".replace(/123/,num);
}

//新規Svg領域の作成（chain_svg）
chain_svg.onclick = function() {
    const selectedText = window.getSelection().toString();
console.log('**Chain svg at text=',selectedText);
    if(Editmode!='Edit') {
		alert('Only Edit mode');
		return;
		}
    place_to_tag();
console.log('top_node=',doc_top_node,'edit_node=',doc_edit_node,'level=',tag_trees[doc_deep_level].level,'tag_tree=',tag_trees);
    var level=tag_trees[doc_deep_level].level;
    if(level!=1) {
	alert('新Svg位置が正しくありません！not proper position');
	return;
	}
    cancel_green_line();
    var text=split_div(doc_top_node,doc_edit_node);
console.log('split text=',text);
//現在のcnsvgを2つのdivに分割して後半部を新たなcnsvgとする
    doc_top_node.innerHTML=text[0];

    var svg_div = document.createElement('div');
    var newtag=getname_cnsvg(cnsvg_tags);
console.log('new cnsvg=',newtag);
    cnsvg_nums=cnsvg_nums+1;
    var divtag='div'+newtag;
    svg_div.setAttribute('id', divtag);
    var parms=doc_top_node.getAttribute('style');
    svg_div.setAttribute('style', parms);
    svg_div.setAttribute('class', 'divsvg');
    svg_div.setAttribute('level', '0');

    var oya=doc_top_node.parentNode;
    $(svg_div).insertAfter(doc_top_node);
    svg_div.innerHTML=text[1];

    var tagn=document.getElementById('chain');
    var newsvg=tagn.cloneNode(true);
    newsvg.setAttribute('id', newtag);
    newsvg.setAttribute('style', 'display:block;');
	var rect=createRectFig(0,0,20,20);
	rect.setAttribute('class', 'chain_svg_mark');
	rect.setAttribute('stroke', 'blue');
	rect.setAttribute('stroke-width', '1');
	rect.setAttribute('fill', 'blue');
	newsvg.appendChild(rect);
console.log('***make g01 group as container');
    container=newsvg;
    var {group,fig_id}=make_group('top');
    group.setAttribute('class', 'top');
    group.removeAttribute('opacity');
console.log(newsvg,svg_div);
    oya.insertBefore(newsvg,svg_div);
    svg_tag_add(newtag);

//    var res=confirm("This position OK ?");
//新規My_CnSvgのAjaxへの設定と書き込み
    var cn_header=cnhead_compose('0','CnSvg','False','False');
    var svg_tags=fold_svg(newtag);
    save_cnsvg(cn_header,svg_tags);
console.log('cnsvg_header=',cn_header);
//My_Dtataのcnsvg_tagsへの変更処理とDBへの書き込み
    cnsvg_tags.push({name: newtag,pk: cnsvg_new_pk,head:wfcn_header});
console.log('cnsvg_tags=',cnsvg_tags);
//    var tags_header=cntags_compose();
//    update_head(header_term[0],String(cnsvg_nums),tags_header);
//console.log('My_Data mend nk=',header_term[0],String(cnsvg_nums),tags_header);
    set_svg('svg_00');
    change_css(Editmode);
    }

function split_div(dom,node) {
console.log('dom=',dom);
	var text1='';
	var text2='';
	var fst=0;
//	len=dom.childNodes.length;
	len=dom.children.length;
console.log('dom leng=',len,'dom=',dom);
	for(var k=0;k<len;k++) {
//		if(dom.childNodes[k].textContent.includes(term1)) fst=1;
		if(dom.children[k]==node) fst=1;
		if(fst==0) text1=text1+dom.children[k].outerHTML;
		else text2=text2+dom.children[k].outerHTML;
		}
	return [text1,text2];
   }

function getname_cnsvg(){
	nn=cnsvg_tags.length;
	var max=0;
	for(var i=0;i<nn;i++){
		var name=cnsvg_tags[i].name;
		var num = Number(name.slice( -2 ));
		if(num>max) {
			max=num;
			}
		}
	max=max+1;
	var newtag='svg_'+("00" + max).slice( -2 );
	return newtag;
	}

function cnhead_compose(a,b,c,d) {
	ret=a+','+b+','+c+','+d;
console.log(ret);
	return ret;
	}

function svgtag_decompose(nums,header) {
	var elem=header.split(';');
console.log('elems leng=',elem.length,elem);
//cn_svgs = [{ name: "" ,pk:0}];
	var cn_svgs=[];
	for(var i=0;i<elem.length-1;i++) {
		var value=elem[i].split(',');
		cn_svgs.push({name: value[0],pk: value[1]});
		}
	return cn_svgs;
	}

function cntags_compose(){
	tags='';
	if(cnsvg_nums>0) {
		for(var i=0;i<cnsvg_nums;i++) {
		tags=tags+cnsvg_tags[i].name+','+String(cnsvg_tags[i].pk)+';';
			}
		}
	return tags;
	}

function svg_tag_add(newtag) {
	var element = document.getElementById( "svg_tag_menu" ) ;
	var newElement = new Option(newtag,newtag) ;	// <option value="baz">選択肢3</option>
	element.add( newElement ) ;
}

function svg_tag_del() {
	var sl = document.getElementById( "svg_tag_menu" ) ;
	while(sl.childElementCount>1)
		{
		sl.removeChild(sl.lastChild);
		}
}

  function chang_svg() {
console.log('**Change svg_tag');

//     id="svg_tag_menu" onchange="chang_svg()
    console.log('selectIndex=',svg_tag_menu.selectedIndex);
	var k=svg_tag_menu.selectedIndex;
console.log(svg_tag_menu,svg_tag_menu.options[k].value);
	var tag=svg_tag_menu.options[k].value;
        var target = document.getElementById("JumpTo");
        target.href = "#"+tag;

	svg_now=tag;
	set_svg(tag);

//        document.getElementById('JumpTo').click();
	window.scrollTo(0,off_page.top);
    }

var off_page;

function set_svg(tag) {
console.log('set_svg org=',tag);
	org_container = document.getElementById(tag);
console.log('org_container=',org_container);
	var heit=org_container.getAttribute('height');
	if(heit!='auto') {
		heit=heit.slice(0,-2);
		var divtag='div'+tag;
		var divsvg = document.getElementById(divtag);
		var div_heit=divsvg.clientHeight;
console.log('set_svg org=',tag,'height=',heit,'div_heit=',div_heit);
		if(div_heit>heit)　org_container.setAttribute('height','auto');
		}
//	var off_tag='#'+'div'+tag;
	var off_tag='#'+tag;
	off_page=$(off_tag).offset();
console.log('Svg offset=',off_tag,'XY=',off_page.left,off_page.top);
//mend 2022.9.8
		var top=org_container.lastElementChild;
		if(top) {
console.log('top tag=',top);
			 var cls=top.getAttribute('class');
			if(cls!='top') {
				top.setAttribute('class','top');
				top.setAttribute('fig','top');
				}
			}
	container=org_container.querySelector('.top');
	if(container==null) {
console.log('***make g01 group as container');
		var {group,fig_id}=make_group('top');
		group.setAttribute('class', 'top');
		group.removeAttribute('opacity');
		container=org_container.appendChild(group);
		}
console.log('change container to=',org_container,container);
} //End set_svg

//クリック時の動作
function keyClick(event) { //*2
	//イベント処理
	var key_event = event || window.event; //*3
	var key_shift = (key_event.shiftKey); //*4
	var key_ctrl = (key_event.ctrlKey);
	var key_alt = (key_event.altKey);
	var key_meta = (key_event.metaKey);
	//キーに対応した処理
	var s = "click! ";
	if (key_shift) s += "shiftキー ";
	if (key_ctrl) s += "ctrlキー ";
	if (key_alt) s += "altキー ";
	if (key_meta) s += "metaキー ";
	//出力
console.log(s);
}
function sfift_key(event) { //*2
	//イベント処理
	var key_event = event || window.event; //*3
	var key_shift = (key_event.shiftKey); //*4
	return key_shift;
}

function key_event(event) { //*2
	//イベント処理
	var key_event = event || window.event; //*3
	return key_event;
}
/*
function code_to_html(e){
   var res='';
   if(Editmode=="Thtm")　{   //　Editモードの場合のみhtml変換
	if(window.event.keyCode==13){
		if(window.event.shiftKey){ //Shift+Enterの場合
			var res="<br>"
			}
		else {  //Enterの場合
			var res="</p>"
			}
		//テキストエリアと挿入する文字列を取得
console.log('***Inskey***');
		var area = document.getElementById('texh');
		//カーソルの位置を基準に前後を分割して、その間に文字列を挿入
		area.value = area.value.substring(0, area.selectionStart)
			+ res
			+ area.value.substring(area.selectionStart);

		}
	}
   else {
	if (Editmode=="Edit") {
console.log('event=',window.event.keyCode);
		if(window.event.keyCode==8){
			return false;
			}
		}
	}
   }
*/
</script>
<script  class="minify" id="smain_18">
//ダブルクリック時の処理を入れる
var dbl_click_func=function(e){
// ダブルクリックイベントの処理内容
console.log( "ダブルクリック!!" ) ;
//simple lineなのにdouble clickで終わった場合を入れる
//serial_line　close_line　smooth_line smooth & close lineの場合
	clickCount = 0 ;
	if(Svg_mode=="Svg_reshape_pending") return;
	Oper=2;
		var x0=e.clientX;
		var y0=e.clientY;
//		var x0=e.pageX;
//		var y0=e.pageY;
		if(conv_cord) {
console.log('convert indiv',x0,y0,off_indivx,off_indivy);
			x0=x0-off_indivx;
			y0=y0-off_indivy;
			}
		if(mesh_draw && mesh_integer) {
			x0=Math.round(x0/10)*10;
			y0=Math.round(y0/10)*10;
			}
		else {
			x0=Math.round(x0*10)/10;
			y0=Math.round(y0*10)/10;
			}
        	drawingPoints.push({x: x0,y: y0});
		my_confirm(13);
	} //End dbl_click
////
    function set_line_group(group,drawingPtype,c_para,s_para) {
console.log('****Enter set_line_group c_para,s_para=',c_para,s_para);
	if(s_para===null) s_para='else';
	if(c_para===null) c_para='else';
	var result = s_para.split(' ');
	var smooth =result[0];
	var trim_val=result[1];
	var old_control=control.value;
	control.value="else"
	if(c_para=="close" && smooth!="else") control.value="close_smooth";
console.log('c_para=',c_para,' smooth=',smooth,'trim_val=',trim_val);
		if((smooth!= 'else') && (drawingPoints.length>2)) {
			my_confirm(4);
console.log('*****Exec Cubic code Path_P=',path_p);
			var path=createCubicBezier_B(path_p,drawingPtype,c_para);
//			group.insertBefore(path, group.firstChild);
//			remake_group(group,path,defaultArrowStyle);
		        var rtn_path=path;
console.log('**after cubic interpol');
			}
		else  {           //if ((control.value== 'line')||(control.value== 'close_line') の場合
			if(smooth=='trim') {
//console.log(drawingPoints);
				var f_cls=0;
				var nn=drawingPoints.length;
				var x0=drawingPoints[0].x;
				var y0=drawingPoints[0].y;
				var R=trim_val;
				var vx;
				var vy;
				var vlen;
				var xs,xe,ys,ye,qx,qy;
				var def_points='';
				if(close== 'close') f_cls=1;
				for (let i=0;i<nn-1;i++) {
					vx=drawingPoints[i+1].x-drawingPoints[i].x
					vy=drawingPoints[i+1].y-drawingPoints[i].y
					vlen=Math.sqrt(vx**2+vy**2);
					vx=vx/vlen;
					vy=vy/vlen;
					xs=Math.round((drawingPoints[i].x+R*vx)*100)/100;
					ys=Math.round((drawingPoints[i].y+R*vy)*100)/100;
					xe=Math.round((drawingPoints[i+1].x-R*vx)*100)/100;
					ye=Math.round((drawingPoints[i+1].y-R*vy)*100)/100;
console.log('x y=',xs,ys,xe,ye);
					if(i==0) {
						if(f_cls==1) {
							x0=xs;
							y0=ys;
							def_points=def_points+` M${xs}, ${ys} `;
							}
						else {
							def_points=def_points+` M${x0}, ${y0} `;
							}
						}
					if(i>0){
						def_points=def_points+` ${xs}, ${ys} `;
						def_points=def_points+` M${xs}, ${ys} `;
						}
					if((i==nn-2)&&(f_cls==0)){
						def_points=def_points+` ${drawingPoints[i+1].x}, ${drawingPoints[i+1].y} `;
						}
					else {
						def_points=def_points+` ${xe}, ${ye} `;
						def_points=def_points+` M${xe}, ${ye} Q${drawingPoints[i+1].x}, ${drawingPoints[i+1].y}`;
						}
					}
				if(f_cls==1) {
					def_points=def_points+` ${x0}, ${y0} `;
					}
console.log('Points=',def_points);
        			var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        			path.setAttributeNS(null, 'd', def_points);
				Object.assign(path.style, defaultPathStyle);
//				group.insertBefore(path, group.firstChild);
//				remake_group(group,path,defaultArrowStyle);
				var rtn_path=path;
				}
			else {
console.log('drawingPoints=',drawingPoints);
	        		path = createPath(drawingPoints,c_para,rect,def_points);
        			Object.assign(path.style, defaultPathStyle);
//				group.insertBefore(path, group.firstChild);
//				remake_group(group,path,defaultArrowStyle);
				var rtn_path=path;
console.log('**none cubic and none c_para=',c_para);
				}
			}
		control.value=old_control;
		var def_points='';
		var rect='';
		Oper=0;
		Step=0;
		return(rtn_path);
	}　　　//　End　of　line、close_line、smooth、close_smooth

        function set_common(code,name){
	    var script00=document.getElementById('exe02');
console.log('set_common script=',script00,name);
	    if(script00 && name=='exe02') return;
            var script = document.createElement('script');
	    script.setAttribute('id', name);
	    script.innerHTML =code ;
//            script.innerText =code ;
//            script.textContent = code;
console.log('set_common name=',name);
            document.body.appendChild(script);
	}

   function get_common(n_rec){
	var script='';
	rec_num=String(n_rec);
		
        	$.ajax({
            		url: "/db_serv/get_timing/",
            		async:false,
            		data: {
				"rec_num":rec_num,
				},
            		dataType: 'json'
        		})
        	.done((data) => {
            		//結果が帰ってきたら、表示します。
console.log('**Ajax Returned result=',data);
			script=data['script'];
			script=unescapeHtml(unescape(script));
//			script=unescape(script);
//console.log('length,script=',script.length,script);
        		});
	return script;
	}

function my_confirm(n) {
	var exe_script01=get_common(n);
	set_common(exe_script01,'exe01');
	var script00=document.getElementById('exe01');
	script00.remove();
	}

var sys_script00="";
var sys_script01="";

function my_confirm_open(n) {
	var exe_script01=get_common(n);
	set_common(exe_script01,'exe01');
	sys_script00=document.getElementById('exe01');
//	script00.remove();
	}

function my_confirm_close() {
	sys_script00.remove();
	}

function my_confirm_open2(n) {
	var exe_script01=get_common(n);
	set_common(exe_script01,'exe02');
	sys_script01=document.getElementById('exe02');
//	script01.remove();
	}

function my_confirm_close2() {
	sys_script01.remove();
	}

</script>
<script class="minify" id="smain_19">
var ch_check_flag=0;
var export_disp_flag=0;

var svg_tex='';

var org_window_w;
var org_window_h;
window.onload = function() {
			// ブラウザのウインドウサイズを取得する
			org_window_w = window.innerWidth;
			org_window_h = window.innerHeight;
console.log('window size width=',org_window_w,'height=',org_window_h);
//
/*
//ソース隠蔽部
//ソース隠蔽用のscriptレーコードのDB save
//ソースは<textarea>タグにid名を付けて準備する
//

   function generate_source(rec,tagn){
		var origin = document.getElementById(tagn);
		var src_script=origin.innerHTML;
//console.log('length & script=',src_script.length,src_script);
		update_sysparms(rec,src_script);
	}

//script01はsysparms
//script02はSvg_scriptのcopy＆pasteのwork用
//script03はレシピdata
	generate_source(4,'script04');
console.log('script04 complete');
	generate_source(5,'script05');
console.log('script05 complete');
	generate_source(6,'script06');
console.log('script06 complete');
	generate_source(7,'script07');
console.log('script07 complete');
	generate_source(8,'script08');
console.log('script08 complete');
	generate_source(9,'script09');
console.log('script09 complete');
	generate_source(10,'script10');
console.log('script10 complete');
	generate_source(11,'script11');
console.log('script11 complete');
	generate_source(12,'script12');
console.log('script12 complete');
	generate_source(13,'script13');
console.log('script13 complete');
	generate_source(14,'script14');
console.log('script14 complete');
	generate_source(15,'script15');
console.log('script15 complete');
	generate_source(16,'script16');
console.log('script16 complete');
	generate_source(17,'script17');
console.log('script17 complete');
//	my_confirm(4);     実行部はcode内に設置
//alert('code generated stop');
//
//ソース隠蔽終了部
//
*/
/*
//ソース隠蔽部(demo版、cloud版、製品版への対応）
//ソース隠蔽用のscriptレーコードのDB save
//ソースは<textarea>タグにid名を付けて準備する
//
   function generate_source(rec,tagn){
		var origin = document.getElementById(tagn);
		var src_script=origin.innerHTML;
console.log('length & script=',src_script.length,src_script);
		update_sysparms(rec,src_script);
	}

	generate_source(11,'script11');
console.log('script11 complete');
//ソース隠蔽終了部
//
*/
//
//System構成　①Main　Program　②Display document　③System Controle(mousehandling)　④HTML　edit
//　　　　　　⑤SVG　drawing　⑥SVG　edit
//
//ブラウザ表示用データの準備(DbデータのDjango（Python）からの受取りとinlinesvgへの書き込み
//system parameterの読み込み
     my_confirm_open(11);
     read_sysparms();
     my_confirm_close();
//
/*
//ソース隠蔽部
console.log('version cloud=',for_cloud,' demo=',for_demo);
	if(for_cloud=='yes') {
		alert('This is Cloud version');
		}
	else if(for_demo=='yes') {
		alert('This is Demo version');
		}
	else alert('This is Product version');
//ソース隠蔽部終了
*/

//      texxx=unescapeHtml(unescape('{{view_tex}}'));
      	my_header=unescapeHtml(unescape('{{header}}'));
	if(my_header=='') {
console.log('header null entered');
//		document.getElementById("doc_new").click();
alert('Entered from null header');
		}
      texxx=unescape('{{view_tex}}');
//      my_header=unescape('{{header}}');
console.log('my_header=',my_header);
      header_term=my_header.split('|<=>|');
console.log('header=',header_term);
//
//Document Title（overviews）の展開と本文の表示とfirst_containerを設定
//
      my_overview=unescapeHtml(unescape('{{overviews}}'));
//      my_overview=unescape('{{overviews}}');

      overview_term=my_overview.split('|<=>|');
	if(overview_term[8]=='') {
		default_margin_L=sys_marginL;
		default_margin_R=sys_marginR;
		}
	else {
		var parms=overview_term[8].split(/;|,/);
console.log('sys parm=',parms);
		default_margin_L=parms[2];
		default_margin_R=parms[3];
		}
console.log('margin L&R=',default_margin_L,default_margin_R);
console.log('overviews=',overview_term);
      document.getElementById("texx").innerHTML=texxx;
　　  first_container = document.getElementById('texx');
console.log('first_container=',first_container);
//      svg_tex=unescapeHtml(unescape('{{svg_field}}'));
      svg_tex=unescape('{{svg_field}}');

console.log('**svg length=',svg_tex.length);

	var all_divsvg=$("div[id^='divsvg']");
console.log('divsvg_all=',all_divsvg);
	for(let i=0;i<all_divsvg.length;i++){
		var idname=all_divsvg[i].getAttribute('id');
		if(idname.slice(0,6)=='divsvg') {
			all_divsvg[i].setAttribute('class','divsvg');
			all_divsvg[i].setAttribute('level','0');
			}
console.log('idname=',idname,all_divsvg[i].getAttribute('class'));
		}

	var svg_tagss=first_container.querySelectorAll('svg.canv');
console.log('svg_tags=',svg_tagss);
	
//document text部のdivsvgタグのcheckと再編集
      	var fst_tag=first_container.firstChild;
console.log('First node=',fst_tag.nodeName);
	var idname=''
	var clsname=''
	if(fst_tag.nodeName=='DIV') {
		idname=fst_tag.getAttribute('id');
		clsname=fst_tag.getAttribute('class');
		}
	if(fst_tag.nodeName=='DIV' && clsname=='divsvg') {
		if(idname!='divsvg_00') {
console.log('Enter to set divsvg tag',fst_tag);
	      		var cnsvg_tags=svgtag_decompose(header_term[5],header_term[6]);
console.log('cnsvg_tags=',cnsvg_tags);
	      		var cnsvg_nums=cnsvg_tags.length;
console.log('chain svg_nums=',cnsvg_nums);
			if(cnsvg_nums>0) {
				var html_str=document.getElementById("texx").innerHTML;
//console.log('html_str=',html_str);
				while (first_container.firstChild) {
	            			first_container.removeChild(first_container.firstChild);
		    			}
				var text='';
				var st_p=0;
				var end_p=html_str.length;
				var newtag='divsvg_00';
				for(let i=0;i<cnsvg_nums;i++){
					var tagn=cnsvg_tags[i].name;
					var div_name='div'+tagn;
					var svg_div=document.getElementById('div'+tagn);
					var cnsv_tag=document.getElementById(tagn);
console.log('cnsvg tag=',tagn,div_name,svg_div,'svg=',cnsv_tag);
				
					var {pt1,pt2}=catch_cnsvg(div_name,html_str,st_p);
					text=html_str.substring(st_p,pt1);
//console.log('select text=',text);
    					var svg_div = document.createElement('div');
    					svg_div.setAttribute('id', newtag);
    					svg_div.setAttribute('class', 'divsvg');
    					svg_div.setAttribute('level', '0');
					var marginLR='margin-left:'+default_margin_L+'; margin-right:'+default_margin_R+';';
					svg_div.setAttribute('style', marginLR);

					var p_node = document.createElement('p');
					p_node.innerHTML=text;
					svg_div.appendChild(p_node);

					first_container.appendChild(svg_div);
console.log('loop tag=',svg_div);
					newtag=div_name;
					st_p=pt1;
					}
				text=html_str.substring(st_p,end_p);
//console.log('end text=',text);
    				var svg_div = document.createElement('div');
    				svg_div.setAttribute('id', newtag);
    				svg_div.setAttribute('class', 'divsvg');
    				svg_div.setAttribute('level', '0');
				var marginLR='margin-left:'+default_margin_L+'; margin-right:'+default_margin_R+';';
				svg_div.setAttribute('style', marginLR);

				var p_node = document.createElement('p');
				p_node.innerHTML=text;
				svg_div.appendChild(p_node);

				first_container.appendChild(svg_div);
console.log('end tag=',svg_div);
				}
			}
		}
	else {                                             //Top textのみの場合
    		var newtag='divsvg_00';
		var node=document.getElementById(newtag);
console.log('old node=',svg_div,'node=',node);
    		//var div_parent=document.getElementById("wClone")
    		var svg_div = document.createElement('div');
    		svg_div.setAttribute('id', newtag);
    		svg_div.setAttribute('class', 'divsvg');
    		svg_div.setAttribute('level', '0');
		var marginLR='margin-left:'+default_margin_L+'; margin-right:'+default_margin_R+';';
		svg_div.setAttribute('style', marginLR);
		if(node==newtag) svg_div.innerHTML=document.getElementById(newtag).innerHTML;
		else {
			var p_node = document.createElement('p');
			p_node.innerHTML=document.getElementById("texx").innerHTML;
			svg_div.appendChild(p_node);
			}
console.log('only Top text=',svg_div,'node=',node);
    		//div_parent.appendChild(svg_div);
		while (first_container.firstChild) {
            		first_container.removeChild(first_container.firstChild);
	    		}
		first_container.appendChild(svg_div);
		}

      my_confirm(5);
      confirm_last2line();
console.log('**doc loaded at my_confirm(5)');
//      my_confirm_open2(17);

//     var doc_parm=set_doc_parms();
//console.log('doc_parms=',doc_parm);

	var width=$("#texx").width();

	for(let i=0;i<all_divsvg.length;i++){
		var idname=all_divsvg[i].getAttribute('id');
		var styles=all_divsvg[i].getAttribute('style');
console.log('********** divsvg idname=',idname,width,styles);
		}


    var NS = first_container.getAttribute('xmlns');
//
//②Display document (editor初期表示モードの設定）
//
		nodisp=document.getElementById('tab2');
       		nodisp.style.display='none';
       		disp=document.getElementById('tab1');
       		disp.style.display='block';
		document.getElementById(svg_now).style.display="block";
		document.getElementById( "texx" ).style.zIndex ='40';
		document.getElementById( "texh" ).style.zIndex ='20';
		document.getElementById("texh").value=document.getElementById("texx").innerHTML;
//		document.getElementById("texh").innerHTML=escapeHtml(escape(document.getElementById("texx").innerHTML));
		Editmode='Tvis';
    　		chng_menu(Editmode);
		change_css(Editmode);

//Pasteを禁止する
//      document.body.onpaste=function(){return false;}

//特定のキー入力に対してのVisual Editorでの処理
//document.getElementById('texx').onkeypress=code_to_html;
} //End of window.onload = function()

function catch_cnsvg(name,text,stp) {
	var text_n='';
	var point_n=0;
	var st_a1=st_b1=st_c1=stp;
	var st_a2,st_b2,st_c2;

	var st_a2=text.indexOf(name, st_a1);
	var st_b2=text.indexOf('<div', st_b1);
	var st_c2=text.indexOf('</div>', st_c1);
console.log('a =',st_a1,st_a2,'b =',st_b1,st_b2,'c =',st_c1,st_c2);

	while(st_a2>st_c2) {
		st_c1=st_b1=st_c2+6;
		var st_b2=text.indexOf('<div', st_b1);
	        var st_c2=text.indexOf('</div>', st_c1);
		}
	if(st_b2<st_a2) {
		var pt1=st_b2;
		var pt2=st_c2+6
		}
	return {pt1:pt1,pt2:pt2};
	}

function confirm_last2line(){
	var last_div=first_container;
//console.log('last_div=',last_div);
	var attr=last_div.getAttribute('class');
	if(attr!='divsvg') return;
	var last_line=last_div.lastChild;
console.log('last_line=',last_line,last_line.innerHTML);
	if(last_line.innerHTML!='&nbsp;&nbsp;') {
console.log('add last2line=',last_line);
		last_div.innerHTML=last_div.innerHTML+'<p>&nbsp;&nbsp;</p><p>&nbsp;&nbsp;</p>';
		}
	}

function goScriptC(nn) {
alert('this part is under construction');
	if(nn==2) {
		for_cloud='no';
		for_demo='no';
		}
//console.log('nn=',nn,' for_cloud=',for_cloud);
	}

   function update_sysparms(rec,data) {
console.log('**Enter Ajax Update_sys rec=',rec);
		var save_data=escapeHtml(escape(data));
//		var save_data=escape(data);
		n_rec=String(rec);
		
        	$.ajax({
            		url: "/db_serv/update_sys/",
            		async:false,
			type: "POST",
            		data: {
				"rec_num":n_rec,
				"script":save_data,
				},
            		dataType: 'json'
        		})
        	.done((data) => {
            		//結果が帰ってきたら、表示します。
console.log('**Ajax Update_sys Returned result=',data);
        		});
		}

//script_pallet 
var gm_selpal=['#000000','#000000','#ffffff'];
var gm_stand01=['#ffffff','#c8c8cb','#84919e','#000000','#ffcabf','#ffff80','#d8f255','#bfe4ff','#ffca80','#77d9a8'];
var gm_stand02=['#c9ace6','#804000','#990099','#f6aa00','#ff8082','#4dc4ff','#005aff','#03af7a','#fff100','#ff4b00'];
var gm_stand03=['#ffffff','#ffffff','#ffffff','#ffffff','#ffffff','#ffffff','#ffffff','#ffffff'];
var pallet_dialog_flag=0;
var pall_init=true;
var changed_pallet=99;
var pallet_mend_flag=false;
var pallet_mode='';
var gm_sel_num=0;
var gm_pal_num=0;
var gm_sel_tag='';
var gm_sel=[];
var gm_pal=[];
var svg_gm_sel=[];
var svg_gm_pal=[];
var html_gm_sel=[];
var html_gm_pal=[];
var fw_colval;
var bk_colval;
var bd_colval;
var svg_moji_color;
var svg_bk_color;
var svg_bd_color;

var sys_max_width='1200px';
var sys_marginL='50px';
var sys_marginR='100px';
var sys_set_menu='origin';
var set_menu=0;
var html_design_title;
var style_design_title;

   $("#pallet_dialog").on("click", function(){
	if(!sys_script00) my_confirm_open(11);

console.log('***pallet');
	var theDialog=$( '#pallet' ) . dialog( { autoOpen: false, draggable: true, resizable: false,
		height:230, width: 350,  position: {my: "right top", at: "right top", of: window}} );
	//ダイアログを表示する
	if(Editmode!="Edit" && 	Editmode!="Svg") {
alert('pallet must be at Edit or Svg');
		return;
		}
	if(Editmode=="Edit") {
console.log('Edit pallet');
		$('#pallet').dialog('option', 'title', 'カラーパレット(html)');
//パレットの表題を下記の方式で線色と文字などを置き換える
   		document.getElementById("pal_Label_01").innerHTML = '<span class="mgr-50" style="font-size:12px; font-weight:bold;">文字:</span><span class="mgr-50" style="font-size:12px; font-weight:bold;">背景:</span><span class="mgr-50" style="font-size:12px; font-weight:bold;">境界:</span>';
		set_pallet(html_gm_sel,html_gm_pal);
		document.getElementById("pal_Label_02").innerHTML='<span style="font-size:12px;">&nbsp;&nbsp;無</span>';
		}
	if(Editmode=="Svg") {
console.log('Svg pallet');
		//document.getElementById('#pallet').value="カラーパレット(svg)";
		$('#pallet').dialog('option', 'title', 'カラーパレット(svg)');
//パレットの表題を下記の方式で線色と文字などを置き換える
		document.getElementById("pal_Label_01").innerHTML = '<span class="mgr-50" style="font-size:12px; font-weight:bold;">線色:</span><span class="mgr-50" style="font-size:12px; font-weight:bold;">塗色:</span><span class="mgr-50" style="font-size:12px; font-weight:bold;">文字:</span>';
		set_pallet(svg_gm_sel,svg_gm_pal);
		document.getElementById("pal_Label_02").innerHTML='<span style="font-size:12px;">&nbsp;&nbsp;無</span>';
		}
	pallet_dialog_flag=1;
	theDialog.dialog("open");
	});

   $("#pallet_dialog2").on("click", function(){
console.log('Enter pallet dialog2');
	document.getElementById("pallet_dialog").click();
	});

   $('#pallet').on('dialogclose', function() {
	pallet_dialog_flag=0;
console.log('Pallet Dialog closed');
	my_confirm_close();
	});

</script>
<!-- ポップアップウィンドウ カラーパレット　pallet用HTML -->
<div class="dialog" id="pallet" title="カラーパレット">
  <div class="dialog-content" style="position:absolute; Top:0;">
    <svg id="pallet_svg" version="1.1" style="position:absolute; Top:0;" width="300"height="88%" xmlns="http://www.w3.org/2000/svg">
          <!-- circle id="pal_circ01" cx="20" cy="20" r="5" stroke="blue" fill="yellow" stroke-width="2"/ -->
    </svg>
	</br>
    <label id='pal_Label_01'></label><br><!--span class="mgr-50" style="font-size:12px; font-weight:bold;">線色:</span><span class="mgr-50" style="font-size:12px; font-weight:bold;">塗色:</span><span class="mgr-50" style="font-size:12px; font-weight:bold;">文字:</span></br -->
    <div class="popwindow-content"></div></br>
	<p>----------------------------------------------　　　　　　　　</p>
	<label id='pal_Label_02'></label></br></br></br></br></br><span style="font-size:12px; font-weight:bold;">&nbsp;&nbsp;&nbsp;追加:</span></br></br><input type="text" id="color_code" value="" style="position:relative; left:100px; width:65px;" ></br></br>
	<div id="set_color" style="display:none;">
	<input type="color" id="color_box">
	</div>
  </div>
</div>
<textarea id="script04" class="special" style="display:none;">
function Cubic_interpol(pts,p_type,controle){
   var iLen= pts.length;
   var cubics=[];
   var sn=[];
   var vn=[];
   var wn=[];

   for ( var i = 0;  i < iLen ; i++ ){
	pts[i].x=Number(pts[i].x);
	pts[i].y=Number(pts[i].y);
	sn[i]=[0,0];
	vn[i]=[0,0];
	wn[i]=[0,0];
	}
console.log('Enter Cubic inter controle and points=',controle,pts);
//slope vector の作成   pts[i]からpts[i-1]→pts[i+1]の方向(snは終点のベクトル（始点＋方向成分）
   for ( var i = 1;  i < iLen-1 ; i++ ){
	sn[i][0]=pts[i].x+pts[i+1].x-pts[i-1].x;
	sn[i][1]=pts[i].y+pts[i+1].y-pts[i-1].y;
	}

     if (controle=='close_smooth') {
	sn[iLen-1][0]=pts[iLen-1].x+pts[1].x-pts[iLen-2].x;
	sn[iLen-1][1]=pts[iLen-1].y+pts[1].y-pts[iLen-2].y;

	sn[0][0]=pts[0].x+pts[1].x-pts[iLen-2].x;
	sn[0][1]=pts[0].y+pts[1].y-pts[iLen-2].y;
//console.log('smooth close [0] [iLen-1]=',sn[0],sn[iLen-1]);
	}

     else{
	sn[0][0]=pts[0].x+pts[1].x-pts[0].x;
	sn[0][1]=pts[0].y+pts[1].y-pts[0].y;

	sn[iLen-1][0]=pts[iLen-1].x+pts[iLen-2].x-pts[iLen-1].x;
	sn[iLen-1][1]=pts[iLen-1].y+pts[iLen-2].y-pts[iLen-1].y;
/*
var drawPoint=[];
var x0,y0,x1,x2;
drawPoint.push({x: pts[iLen-1].x,y: pts[iLen-1].y});
drawPoint.push({x: sn[iLen-1][0],y: sn[iLen-1][1]});
bezier_line=createPath(drawPoint,0);
Object.assign(bezier_line.style, tempoPathStyle);
container.appendChild(bezier_line);
*/
     }

var drawPoint=[];
var x0,y0,x1,x2;
   for ( var i = 0; i < iLen-1 ; i++ ){
/*
drawPoint.push({x: pts[i].x,y: pts[i].y});
drawPoint.push({x: sn[i][0],y: sn[i][1]});
console.log(drawPoint);
bezier_line=createPath(drawPoint,0);
Object.assign(bezier_line.style, tempoPathStyle);
container.appendChild(bezier_line);
drawPoint=[];
*/
	var vn0x=(2*pts[i].x+pts[i+1].x)/3;
	var vn0y=(2*pts[i].y+pts[i+1].y)/3;
	var vnx=vn0x-(pts[i+1].y-pts[i].y);
	var vny=vn0y+(pts[i+1].x-pts[i].x);

	var point1 = {
	    start : { x : pts[i].x, y : pts[i].y }, // 始点
	    end   : { x : sn[i][0], y : sn[i][1] }    // 終点
	};
	var point2 = {
	    start : { x : vn0x, y : vn0y }, // 始点
	    end   : { x : vnx, y : vny }   // 終点
	};
	var result = Inter_Line(point1, point2);
	vn[i][0]=result.x;
	vn[i][1]=result.y;
//console.log('point 1 i,pt,slope=',i,pts[i],sn[i]);
/*
drawPoint.push({x: result.x, y: result.y});
console.log(drawPoint);
bezier_line=createPath(drawPoint,0);
Object.assign(bezier_line.style, tempoPathStyle2);
container.appendChild(bezier_line);
drawPoint=[];
*/
	var vn0x=(pts[i].x+2*pts[i+1].x)/3;
	var vn0y=(pts[i].y+2*pts[i+1].y)/3;
	var vnx=vn0x-(pts[i+1].y-pts[i].y);
	var vny=vn0y+(pts[i+1].x-pts[i].x);
	
	var point1 = {
	    	start : { x : pts[i+1].x, y : pts[i+1].y }, // 始点
	    	end   : { x : sn[i+1][0], y : sn[i+1][1] }    // 終点
	};

	var point2 = {
	    start : { x : vn0x, y : vn0y }, // 始点
	    end   : { x : vnx, y : vny }   // 終点
	};
	var result = Inter_Line(point1, point2);
	wn[i][0]=result.x;
	wn[i][1]=result.y;
//console.log('point 2 i+1,pt,slope=',i+1,pts[i+1],sn[i+1]);
/*
drawPoint.push({x: result.x, y: result.y});
console.log(drawPoint);
bezier_line=createPath(drawPoint,0);
Object.assign(bezier_line.style, tempoPathStyle2);
container.appendChild(bezier_line);
drawPoint=[];
*/
	}
//console.log('vn ,wn=',vn,wn);

   for ( var i = 0; i < iLen-1 ; i++ ){
	pts[i].x=Math.round(pts[i].x*100)/100;
	pts[i].y=Math.round(pts[i].y*100)/100;
	cubics.push({x: pts[i].x,y: pts[i].y});
	vn[i][0]=Math.round(vn[i][0]*100)/100;
	vn[i][1]=Math.round(vn[i][1]*100)/100;
	cubics.push({x: vn[i][0],y: vn[i][1]});
	wn[i][0]=Math.round(wn[i][0]*100)/100;
	wn[i][1]=Math.round(wn[i][1]*100)/100;
	cubics.push({x: wn[i][0],y: wn[i][1]});
	}

   pts[iLen-1].x=Math.round(pts[iLen-1].x*100)/100;
   pts[iLen-1].y=Math.round(pts[iLen-1].y*100)/100;
   cubics.push({x: pts[iLen-1].x,y: pts[iLen-1].y});
//console.log('Cubics=',cubics);
   return cubics;
}  //End of Cubic_interpol
var path_p=Cubic_interpol(drawingPoints,drawingPtype,control.value);
</textarea>
<textarea id="script05" class="special" style="display:none;">
//
//Chain Svgの展開
//
      cnsvg_tags=svgtag_decompose(header_term[5],header_term[6]);
      cnsvg_nums=cnsvg_tags.length;
//console.log('tags leng=',cnsvg_tags.length,cnsvg_tags);
//CnSvg(複数個所の読み込みと展開
//console.log('*Start set cnsvg tag leng=',cnsvg_tags.length);
	for(var i=0;i<cnsvg_tags.length;i++) {
		var tagn=cnsvg_tags[i].name;
		get_cnsvg(cnsvg_tags[i].pk)
		cnsvg_tags[i].head=wfcn_header;
		var svg_div=document.getElementById('div'+tagn);
    		var oya = svg_div.parentNode;
    		var dumy=document.getElementById('chain');
    		var newsvg=dumy.cloneNode(true);
    		newsvg.setAttribute('id', tagn);
    		newsvg.setAttribute('style', 'display:block;');
//console.log(newsvg,svg_div);
		var rect=createRectFig(0,0,20,20);
		rect.setAttribute('class', 'chain_svg_mark');
		rect.setAttribute('stroke', 'blue');
		rect.setAttribute('stroke-width', '1');
		rect.setAttribute('fill', 'blue');
		newsvg.appendChild(rect);
//		cnsvg_field=unescapeHtml(unescape(cnsvg_field));
		cnsvg_field=unescape(cnsvg_field);
//console.log(cnsvg_field,svg_div,oya);
    		oya.insertBefore(newsvg,svg_div);
//console.log('expand chain_svg');
		expand_svg(cnsvg_field,tagn);
//console.log(cnsvg_field,svg_div,oya);
		svg_tag_add(tagn)
		}
//console.log('cnsvg tags leng=',cnsvg_tags.length,cnsvg_tags);

//
//Top Svgの展開と表示
//
      var first_child = first_container.firstChild ;
      var dumy=document.getElementById('chain');
      var newsvg=dumy.cloneNode(true);
      newsvg.setAttribute('id', 'svg_00');
      newsvg.setAttribute('style', 'display:block;');
	var rect=createRectFig(0,0,20,20);
	rect.setAttribute('class', 'chain_svg_mark');
	rect.setAttribute('stroke', 'blue');
	rect.setAttribute('stroke-width', '1');
	rect.setAttribute('fill', 'blue');
	newsvg.appendChild(rect);
      first_container.insertBefore(newsvg,first_child);

      org_container = document.getElementById('svg_00');
//containerは下記expand_svgnの中でsvg_00中のg01を設定
//console.log('expand top_svg leng=',svg_tex.length);
      expand_svg(svg_tex,'svg_00');
      set_svg(svg_now);

	if(org_container.querySelector('.top')==null) {
//console.log('***make g01 group as container');
		container=org_container;
		var {group,fig_id}=make_group('top');
		group.setAttribute('class', 'top');
		group.removeAttribute('opacity');
		container=org_container.appendChild(group);
		}
	else {
		container=org_container.querySelector('.top');
		}
</textarea>
<textarea id="script06"  class="special" style="display:none;">
	var text_to_serv;
	var svg_tag;
//Saveの順番は①最初にChain_CnSvgが最初でその後②本体HTML（含む本体SVG（svg_00)のsaveとする
//CnSvgのsaveはcnsvg_tagで分かる
//console.log('**Save CnSvg Enter leng=',cnsvg_tags.length,cnsvg_tags);
		for(var i=0;i<cnsvg_tags.length;i++){
			svg_tag=fold_svg(cnsvg_tags[i].name);
//console.log('each cnsvg lenth=',svg_tag.length,svg_tag,'head=',cnsvg_tags[i].head);
			save_cnsvg(cnsvg_tags[i].head,svg_tag);
			}
		my_confirm(8);

    		var tags_header=cntags_compose();
		overview_term[8]=set_doc_parms();
		my_overview=compose_overview(overview_term[0],overview_term[1],overview_term[2],overview_term[3],overview_term);

//console.log('my_header=',my_header);
//console.log('text_to_serv=',tex_to_serv);
//console.log('svg=',svg_tag);
//console.log('my_overview=',my_overview);
//console.log('svg_tag',svg_tag);
console.log('at save demo='+for_demo,' text=',String(tex_to_serv.length),' svg=',String(svg_tag.length));
	if((for_demo=='yes') && ((svg_tag.length > 50000) || (tex_to_serv.length > 50000)) ) {
		alert('保存できません。Cant Save Document! too large in this Demo version');
		}
	else {

        	$.ajax({
            		url: "/db_serv/update/",
            		async:true,
			type: "POST",
            		data: {
				"description":tex_to_serv,
				"my_header":my_header,
				"my_overview":my_overview,
				"cnsvg_nums":cnsvg_nums,
				"cnsvg_header":tags_header,
				"svg":svg_tag,
				},
            		dataType: 'json'
        		})
        	.done((data) => {
            		//結果が帰ってきたら、表示します。
//console.log('**Doc really saved Ajax Returned result=',data);
        		});
alert('保存されました。document saved!!');
		}
//    var tags_header=cntags_compose();
//    update_head(header_term[0],String(cnsvg_nums),tags_header);
//console.log('My_Data mend nk=',header_term[0],String(cnsvg_nums),tags_header);
	Popcheck=0;
</textarea>
<textarea id="script07"  class="special" style="display:none;">
<!DOCTYPE html>
<html lang="en">
<head>
  <title>SVG Editor</title>
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
  <!--Bootstrap４を３に変え下記３行の変更でBottomメニュー可能となる-->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
</head>
<style>
            @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP&display=swap');
            @import url('https://fonts.googleapis.com/css2?family=Open+Sans&display=swap');
            @import url('https://fonts.googleapis.com/css2?family=Kaisei+Opti&display=swap');
            @import url('https://fonts.googleapis.com/css2?family=Reggae+One&display=swap');
            @import url('https://fonts.googleapis.com/css2?family=Kaushan+Script&display=swap');
* { 
    margin: 0px; 
    padding: 0px; 
}
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: auto;
	    font-family: "Noto Serif JP",sans-serif;
        }
	.container-fluid {
            margin: 0;
            padding: 0;
	}
        .row {
            margin: 0;
            padding: 0;
        }
        nav.mt-3 {
	    margin-top: 0 !important;
	    padding: 0;
        }
        .tool {
  	    display: flex;
        }
        .menu {
  	    display: flex;
        }
        .navbar {
	    height: 30px;
	    min-height: 30px;
	}

* {box-sizing: border-box;}
.tool , .tool form , .tool div .tool button .menu , .menu00 .menu01 .menu02 .menu03 {
	display:inline-block;  
	display: flex;
	}
 .tool select{
		font-family: fontAwesome;
	/*	height:30px;  */
		position: relative; top: 0;
		width:100px;
		margine:0px;
		padding:0px;
/*	background-color: #4CAF50; */
	background-color: #337ab7;
	color: #fff;
	}
 .tool button{
		font-family: fontAwesome;
	/*	height:30px;  */
		margine:0px;
		padding:0px;
/*	background-color: #4CAF50;  */
	background-color: #337ab7;
	color: #fff;
	}
 .tool select:hover {
	opacity: 0.6;
}
 .tool button:hover {
	opacity: 0.6;
}

.Thtm {
  position: absolute;
  left: 20px; top: 0px;
  padding:0 0px 0 0px;
  width: 1200px;
  height: auto;
  outline: none;
}
.Tvis {
  position: absolute;
  left: 20px; top: 0px;
  padding:0 0px 0 0px;
  width:1200px;
  height:auto;
  z-index: 30;
  opacity: 0.;
  outline: none;
}

.canv {
  z-index:20;
  padding:0px;
  left: -20px;
  margin:0px;
  width:1200px;
  position: absolute;
  opacity: 0.;  
}

.canv2 {
  z-index:20;
  margin:0px;
  padding;0px;
  position: absolute;
}

.my_button {
  display: block;
  width: 100px;
  height: 36px;
  margin: 10px 10px 10px 10px; /* 外側の時計回りの余白 */
  text-align: center;
  color: #fff;
  line-height: 36px;
  text-decoration: none;
  background-color: #69c;
  border: 1px solid #69c;
  border-radius: 5px;
  float: left;
}
.my_button:hover {color:#ffffff; background:#0000cc;}


.flex_box {
    display: flex;              /* フレックスボックスにする */
    align-items:stretch;        /* 縦の位置指定 */
}

.colm_flex {
    display: flex;              /* フレックスボックスにする */
    flex-direction:column;        /* 縦の位置指定 */
}

.point_none {
  pointer-events:none;
}
.point_auto {
  pointer-events: auto;
}

.select_none {
  user-select:none;
}

.select_auto {
  user-select:auto;
}

/*
.mgr-50{
    margin-right : 50px;
}

#trig1{
	height:25px;
        background-color:#ffffdd;
}
#trig2{
	height:25px;
        background-color:#ffffdd;
}
#trig3{
	height:25px;
        background-color:#ffffdd;
}
#svgtrig1{
	height:25px;
        background-color:#ffffdd;
}
#svgtrig2{
	height:25px;
        background-color:#ffffdd;
}

#svgtrig3{
	height:25px;
        background-color:#ffffdd;
}

.file {
    display: inline-block;
    overflow: hidden;
    position: relative;
    box-sizing: border-box;
    padding: 6 -6 6 -6px;
    margin:-6px;
    border: 1px solid #000;
}
 
.file input[type="file"] {
    opacity: 0;  
    filter: progid:DXImageTransform.Microsoft.Alpha(opacity=0);
    position: absolute;
    right: 0;
    top: 0;
    margin: 0;
    font-size: 12px;
    cursor: pointer;
}

      #contextmenu_a {
        display:none;
        position:fixed;
        left:0px;
        top:0px;
        width:100px;
        height:160px;
        border:1px solid #000;
        background-color:#fff;
        list-style-position: inside;
  	z-index:1000;
      }
      #contextmenu_a li {
        cursor:pointer;
      }

      #contextmenu_c {
        display:none;
        position:fixed;
        left:0px;
        top:0px;
        width:110px;
        height:50px;
        border:1px solid #000;
        background-color:#fff;
        list-style-position: inside;
  	z-index:1000;
      }
      #contextmenu_c li{
        cursor:pointer;
      }

      #contextmenu_d {
        display:none;
        position:fixed;
        left:0px;
        top:0px;
        width:110px;
        height:65px;
        border:1px solid #000;
        background-color:#fff;
        list-style-position: inside;
  	z-index:1000;
      }
      #contextmenu_d li{
        cursor:pointer;
      }

      #contextmenu_e {
        display:none;
        position:fixed;
        left:0px;
        top:0px;
        width:130px;
        height:110px;
        border:1px solid #000;
        background-color:#fff;
        list-style-position: inside;
  	z-index:1000;
      }

      .contex:hover { 
	background-color: rgba(102, 102, 255, 0.50);
      }
*/
/*
.dialog {
  overflow: hidden;
  position: absolute;
  top: 30%;
  height: auto;
  width: 300px;
  display: none;
  border:1px solid #aaa;
  z-index:1000;
}
.dialog-header {
  border: 1px solid #aaa;
  background: #cccccc;
  color: #222222;
  font-weight: bold;
  overflow: hidden;
  padding:5px;
}
.dialog-title {
  float: left;
}
.dialog-close {
  float: right;
  border: 1px solid #d3d3d3;
  background: #e6e6e6;
  font-weight: normal;
  color: #555555;
}
.dialog-content {
  position: relative;
  border: 0;
  padding: .5em 1em;
  background: #fff;
  overflow: auto;
  width: auto;
  height: auto;
  font-size:12px;
  font-weight:normal;
  line-height:0.8;
}

.movable {   /* これは有効　下のhoverは効かない　*/
  pointer-events: all;
  cursor: pointer;
}

.draggable {   /* これは有効　下のhoverは効かない　*/
  pointer-events: all;
  cursor: move;
}

.draggable:hover {
  backgroundColor = "orange";
}

.btn:hover {
      background-color: rgba(102, 102, 255, 0.50);
    }
*/

.my_navi ul {
  display: flex;
  flex-flow: column;
  margin: 0;
  padding: 6px;
  list-style-type: none;
}
.my_navi li.my_hamburger {
  align-self: flex-end;
}
.my_navi a {
  display: block;
  border-radius: 4px;
  padding: 12px 24px;
  color:white;
  background-color:blue;
  text-decoration: none;
}
.my_navi li a:hover {
  opacity: 0.6;
}

@media only screen and (min-width:550px) {
.my_navi ul {
    display: flex;
    flex-flow: row;
    margin: 0;
    padding: 6px;
    list-style-type: none;
  }

.my_navi li.my_hamburger {
     display: none;
  }
}
</style>
<body class="point_auto select_auto">

        <svg id="mesh_canv" class="canv" width="1000" height="1000" version="1.1" xmlns="http://www.w3.org/2000/svg" >
	    <defs>
	      <marker id="start_arw" viewBox="-10 -3 10 6" refX="-10" refY="0" markerWidth="10" markerHeight="6" orient="auto">
	        <path d="M -10 0 L 0 -3 L 0 3 Z"/>
	      </marker>
	      <marker id="end_arw" viewBox="0 -3 10 6" refX="10" refY="0" markerWidth="10" markerHeight="6" orient="auto">
	        <path d="M 0 -3 L 0 3 L 10 0 Z"/>
	      </marker>
	    </defs>
	</svg>
<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
  crossorigin="anonymous">
</script>
<script>
$(function () {
  $('#my_nav_togl').on('click', function () {        // js-btnクラスをクリックすると、
//console.log('click');
	$('li.my_nav').slideToggle();  // こちらがOK
  })
});
</script>
</body>
</html>
</textarea>
<textarea id="script08"  class="special" style="display:none;">
//Text本体部分（含むTop_svg）のsaveをするがその前にCnSvg部分を削除後の残り部分とする
//console.log('***Enter to Save HTML_Text');
//const element = document.querySelector('section')
//element.remove()
		dumy_div=document.getElementById('wClone').cloneNode(true);
		var dumy=document.getElementById('texx').cloneNode(true);
    		dumy.appendChild(dumy_div);

		del_tags = dumy.querySelectorAll('svg');
//console.log('del_tags leng=',del_tags.length,del_tags);
		var leng=del_tags.length;
		for(let k=0;k<leng;k++){
//console.log(del_tags[k]);
			var cls=del_tags[k].getAttributeNS(null,'my_class');
			if(cls!='indiv')　{
//console.log('del tag class=',cls,del_tags[k]);
				del_tags[k].remove();
				}
			}
        	while (del_tag = dumy.querySelector('#wClone')) {
//console.log(del_tag);
			del_tag.remove();
			}
//console.log(dumy);

//		tex_to_serv=escapeHtml(escape(dumy.innerHTML));
		tex_to_serv=escape(dumy.innerHTML);

//console.log('**save text=',text_to_serv);
		svg_tag=fold_svg('svg_00');
//		svg_tag=escapeHtml(escape(svg_tag));
		svg_tag=escape(svg_tag);
		dumy.remove();
		dumy_div.remove();
</textarea>
<textarea id="script09"  class="special" style="display:none;">
	export_html();
function export_html(){
//class=Tivの複製
  var data=get_common(7);
//console.log('data=',data);

    const parser = new DOMParser();
    const html_dat = parser.parseFromString(data, "text/html");

    var tagn=document.getElementById('texx');
    var dumy=tagn.cloneNode(true);

	dlist=dumy.querySelectorAll('rect');
	dlist.forEach(function (element) {
		element.remove();
//		element.setAttribute('style','display;block');
//		element.setAttribute('class','canv point_none');
//console.log(element);
		});

	var btag=html_dat.querySelector('body');
//console.log(btag);
	btag.appendChild(dumy);
//console.log(html_dat);
	const serializer = new XMLSerializer();
	const es_html = serializer.serializeToString(html_dat);
console.log('export html length=',es_html.length);
//for デモバージョン
	if(((for_cloud=='yes') || (for_demo=='yes')) && (es_html.length > 80000)) {
		alert('Download HTML is too large this Demo version!');
		return;
		}

let blob = new Blob([es_html],{type:"html"});
let link = document.createElement('a');
link.href = URL.createObjectURL(blob);
link.download = 'testfile.html';
link.click();
   }
</textarea>
<textarea id="script10"  class="special" style="display:none;">
	enter_to_insvg();
function enter_to_insvg(){  //cont_d_menu4()
//console.log('**********Enter to insvg setting',doc_edit_node);
	if(check_svgindiv(doc_edit_node)) {
		alert('svg origin not in this div');
		return;
		}
	fgedit.selectedIndex=2;
	from_svg='indiv';
	chng_mode();
	set_svgindiv(doc_edit_node);
	if(org_container) {
//console.log('indiv container=',org_container);
		var svgheit=org_container.getAttribute('height');
//console.log('svg height=',svgheit,org_container,container);
		if(svgheit!='auto') {
			var max_heit=0;
			for(let k=0;k<doc_edit_node.childElementCount;k++) {
				var tag=doc_edit_node.children[k];
				var heit=tag.clientHeight;
				if(max_heit<heit) max_heit=heit;
//console.log('child k=',k,tag,'height=',heit,'max_heit=',max_heit);
				}
//			if(max_heit>svgheit) org_container.setAttribute('height','auto');
//			org_container.setAttribute('height',max_heit);
			org_container.setAttribute('height','auto');
			}
		}
   }
function check_svgindiv(tag) {
	var error=0;
	var svgtag = tag.querySelector('svg');
//console.log('check insvg mode tag and svgtag=',tag,svgtag);
	if(!svgtag) error=1;
	return error;
	}

function set_svgindiv(tag) {
	var svgtag = tag.querySelector('svg');
	org_container = svgtag;

	if(org_container.querySelector('.top')==null) {
//console.log('***make g01 group as container');
		container=org_container;
		var {group,fig_id}=make_group('top');
		group.setAttribute('class', 'top');
		group.removeAttribute('opacity');
		container=org_container.appendChild(group);
		var rect=createRectFig(0,0,20,20);
		var indiv_id='in'+(Date.now()).toString();
		rect.setAttribute('id', indiv_id);
		rect.setAttribute('class', 'indiv_svg_mark');
		rect.setAttribute('stroke', 'blue');
		rect.setAttribute('stroke-width', '1');
		rect.setAttribute('fill', 'blue');
		org_container.appendChild(rect);
		}
	else {
		container=org_container.querySelector('.top');
		var indiv_id=org_container.getAttribute('id');
		var svg_mark=org_container.querySelector('.indiv_svg_mark');
//console.log('svg_mark=',svg_mark,'length=',!svg_mark);
		if(!svg_mark) {
			var rect=createRectFig(0,0,20,20);
			var indiv_id='in'+(Date.now()).toString();
			rect.setAttribute('id', indiv_id);
			rect.setAttribute('class', 'indiv_svg_mark');
			rect.setAttribute('stroke', 'blue');
			rect.setAttribute('stroke-width', '1');
			rect.setAttribute('fill', 'blue');
			org_container.appendChild(rect);		
			}
		else {
			var indiv_id=svg_mark.getAttribute('id');
			if(!indiv_id) {
				var indiv_id='in'+(Date.now()).toString();
				svg_mark.setAttribute('id', indiv_id);
				}
			svg_mark.setAttribute('stroke', 'blue');
			svg_mark.setAttribute('stroke-width', '1');
			svg_mark.setAttribute('fill', 'blue');
			svg_mark.setAttribute('opacity', '0.6');
			}
		}
	var off_tag='#'+indiv_id;
	off_page=$(off_tag).offset();
//console.log('divSvg offset=',off_tag,'XY=',off_page.left,off_page.top);
      	//var org=document.getElementById(org_container);
	org_container.setAttribute('class','canv2 point_auto select_none');

        var target = document.getElementById("JumpTo");
    	target.href = '#'+indiv_id;
//console.log('jump to Svg_indiv set=',target.href);
        document.getElementById('jump_svg').click();

//console.log('change svg_indiv container to=',svgtag);
} //End set_svgindiv
</textarea>
<textarea id="script11"  class="special" style="display:none;">
/*
var gm_selpal=['#000000','#000000','#ffffff'];
var gm_stand01=['#ffffff','#c8c8cb','#84919e','#000000','#ffcabf','#ffff80','#d8f255','#bfe4ff','#ffca80','#77d9a8'];
var gm_stand02=['#c9ace6','#804000','#990099','#f6aa00','#ff8082','#4dc4ff','#005aff','#03af7a','#fff100','#ff4b00'];
var gm_stand03=['#ffffff','#ffffff','#ffffff','#ffffff','#ffffff','#ffffff','#ffffff','#ffffff'];
var pallet_dialog_flag=0;
var pall_init=true;
var changed_pallet=99;
var pallet_mend_flag=false;
var pallet_mode='';
var gm_sel_num=0;
var gm_pal_num=0;
var gm_sel_tag='';
var gm_sel=[];
var gm_pal=[];
var svg_gm_sel=[];
var svg_gm_pal=[];
var html_gm_sel=[];
var html_gm_pal=[];
var fw_colval;
var bk_colval;
var bd_colval;
var svg_moji_color;
var svg_bk_color;
var svg_bd_color;
*/
//ソース隠蔽部
//for_test,for_sale,for_demo,for_cloud
var for_cloud='no';
//var for_cloud='yes';
var for_demo='no';
//var for_demo='yes';

function pallet_init() {
//console.log('pallet init');
	cx=-35;
	cy=20;
	for(let k=0; k<3;k++){
	  cx=cx+80;
	  let circ_id='sel_'+("00" + (k+1)).slice( -2 );
	  gm_sel.push([k,circ_id,cx,cy,gm_selpal[k]]);
	}

	var stand=gm_stand01.concat(gm_stand02,gm_stand03);
	nn=0;
	cy=40;
	for(let j=0; j<3 ;j++ ){
	  	cx=-10;
		st=10;
		if(j==2) {
				cx=40;
				st=8;
			}
	  	cy=cy+25;
		for(let k=0; k<st; k++){
			nn=nn+1;
	  		cx=cx+25;
	  		let circ_id='pal_'+("00" + (nn)).slice( -2 );
	  		gm_pal.push([nn-1,circ_id,cx,cy,stand[nn-1]]);
			}
		}
//console.log('sel=',gm_sel,'pal=',gm_pal);
	return {gm_sel:gm_sel,gm_pal:gm_pal};
   }

function set_pallet(sel,pal) {
//console.log('set pallet ',sel,pal);
	var pal_tag=document.getElementById('pallet_svg');
	cx=-35;
	cy=20;
	for(let k=0; k<3;k++){
	  c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
	  cx=cx+80;
	  c.setAttributeNS(null, 'cx', cx);
	  c.setAttributeNS(null, 'cy', cy);
	  c.setAttributeNS(null, 'r', 10);
	  c.setAttributeNS(null,'id',sel[k][1]);
	  if(sel[k][4]=="none") c.setAttributeNS(null,'fill','#ffffff');
          else c.setAttributeNS(null,'fill',sel[k][4]);
	  c.setAttributeNS(null,'stroke', 'green');
	  c.setAttributeNS(null, 'stroke-width', '1');
	  pal_tag.append(c);
	}

	nn=0;
	cy=40;
	for(let j=0; j<3 ;j++ ){
	  	cx=-10;
		st=10;
		if(j==2) {
				cx=40;
				st=8;
			}
	  	cy=cy+25;
		for(let k=0; k<st; k++){
			nn=nn+1;
	  		c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
	  		cx=cx+25;
	  		c.setAttributeNS(null, 'cx', cx);
	  		c.setAttributeNS(null, 'cy', cy);
	  		c.setAttributeNS(null, 'r', 10);
			c.setAttributeNS(null,'id',pal[nn-1][1]);
          		c.setAttributeNS(null,'fill',pal[nn-1][4]);
	  		c.setAttributeNS(null,'stroke', 'green');
	  		c.setAttributeNS(null, 'stroke-width', '1');
			if(nn==1) c.setAttributeNS(null,'opacity', '0.5');
	  		pal_tag.append(c);
			}
		}
   }

$(document).on('click', '#pallet', function(){
	if(Editmode=="Edit") {
//console.log('Treat Edit pallet');
		treat_pallet(html_gm_sel,html_gm_pal);
		set_changed_pallet();
		}
	if(Editmode=="Svg") {
//console.log('Treat Svg pallet');
		treat_pallet(svg_gm_sel,svg_gm_pal);
		set_changed_pallet();
		}
});

function treat_pallet(gm_sel,gm_pal) {
//console.log('Enter treat_pallet',gm_sel,gm_pal);
	var pal_tag=document.getElementById('pallet_svg');
	var code_box = document.getElementById('color_code');
	var pnts=jQuery(":hover");
	var leng=pnts.length;
	var sel_tag=pnts[leng-1];
	var sel_id=sel_tag.id;
	var sel_kind=sel_id.slice(0,3);
//console.log('catch leng=',pnts.length,' clicked=',jQuery(":hover"),'tag=',sel_tag,'catch=',sel_id,'kind=',sel_kind);
	if(sel_id=='pallet_svg') return;
	if(sel_kind=='sel') {
		num=Number(sel_id.slice(-2))-1;
		code_box.value=gm_sel[num][4];
		code_box.select();
		document.execCommand("copy");
		}
	if(sel_kind=='pal') {
		var num=Number(sel_id.slice(-2))-1;
		code_box.value=gm_pal[num][4];
		code_box.select();		
		document.execCommand("copy");
		}
	if( sel_kind!='sel' && sel_kind!='pal'&& pallet_mode!='pick') return;
	switch (pallet_mode){
      		case 'sel':
//console.log('selモード');
			//既にselモードだった場合は前の選択タグを元に戻す。
			//新たに選択されたselタグを協調表示してselモードに設定する
			if(sel_kind=='sel') {
				gm_sel_tag.setAttributeNS(null, 'stroke-width', '1');
				gm_sel_tag.setAttributeNS(null, 'stroke', 'green');
				pallet_mode='';
//console.log('Sel mode canceld');
				}
			else if(sel_kind=='pal') {
				var pal_num=Number(sel_id.slice(-2))-1;
				gm_pal_num=pal_num+1;
				gm_sel[gm_sel_num][4]=gm_pal[pal_num][4];
//console.log('selected color=',gm_sel_num,gm_sel[gm_sel_num],gm_sel[gm_sel_num][4],'from= ',pal_num,gm_pal[pal_num],gm_pal[pal_num][4]);
          			gm_sel_tag.setAttributeNS(null,'fill',gm_sel[gm_sel_num][4]);
	  			gm_sel_tag.setAttribute('stroke', 'green');
	  			gm_sel_tag.setAttributeNS(null, 'stroke-width', '1');
				pallet_mode='';
				pallet_mend_flag=true;
				changed_pallet=gm_sel_num+1;
				}
			else return;
				break;
      		case 'pick':
//console.log('Enter to Pick mode and sel_kind=',sel_kind);
			//setモードで選択されたタグがpalタグであれば選択されたタグのcolorを取得しselタグに設定し表示する
				if(sel_kind=='sel' || sel_kind=='pal' ) {
					gm_sel_tag.setAttributeNS(null, 'stroke-width', '1');
					gm_sel_tag.setAttribute('stroke', 'green');
//console.log('Pick mode canceled');
					pallet_mode='';
					}
				else {
					let color_box = document.getElementById('color_box');
					var set_color=color_box.value;
//console.log('Pick color=',set_color,'sel_num=',gm_sel_num);
					if(set_color!='#ffffff') {
						gm_pal[gm_sel_num][4]=set_color;
						gm_sel_tag.setAttributeNS(null, 'stroke-width', '1');
          					gm_sel_tag.setAttributeNS(null,'fill',gm_pal[gm_sel_num][4]);
						gm_sel_tag.setAttribute('stroke', 'green');
						pallet_mode='';
						var set_color = document.getElementById('set_color');
						set_color.setAttribute('style', 'display:none;');
						pallet_mend_flag=true;
						code_box.value=gm_pal[gm_sel_num][4];
						code_box.select();		
						document.execCommand("copy");
						}
					}
				break;
		default:
			//選択されたselタグを強調表示してselモードに設定する
			if(sel_kind=='sel') {
				gm_sel_num=Number(sel_id.slice(-2))-1;
				pallet_mode='sel';
//console.log('Enter to Select mode id=',sel_id,'num=',gm_sel_num);
				sel_tag.setAttributeNS(null, 'stroke', 'red');
				sel_tag.setAttributeNS(null, 'stroke-width', '3');
				gm_sel_tag=sel_tag;
				}
			//選択されたタグが追加タグの場合(21以上）は協調表示してpickモードに設定する
			else if(sel_kind=='pal') {
				gm_sel_num=Number(sel_id.slice(-2))-1;
				if(gm_sel_num<20 || isNaN(gm_sel_num)) return;
				pallet_mode='pick';
//console.log('Enter to Set mode id=',sel_id,'num=',gm_sel_num);
				sel_tag.setAttributeNS(null, 'stroke', 'red');
				sel_tag.setAttributeNS(null, 'stroke-width', '3');
				gm_sel_tag=sel_tag;
				var set_color = document.getElementById('set_color');
				set_color.setAttribute('style', 'display:block;');
				let color_box = document.getElementById('color_box');
				color_box.value='#ffffff';
				}
			break;
			}
	set_changed_pallet();
   }

function set_changed_pallet() {
	if(changed_pallet==0) return;
	if(changed_pallet==99) {
		defaultPathStyle.stroke=svg_gm_sel[0][4];
//		document.querySelector('#svgtrig1').style.backgroundColor = svg_gm_sel[0][4];
		var back="background-color: "+svg_gm_sel[0][4]+";";
		var moji_s1=blackOrWhite(svg_gm_sel[0][4]);
		var styl_s1="color:"+moji_s1+";"+" opacity:0.8;"+back;
		document.getElementById('svgtrig1').setAttribute('style', styl_s1);
		defaultPathStyle.fill=svg_gm_sel[1][4];
//		document.querySelector('#svgtrig2').style.backgroundColor = svg_gm_sel[1][4];
		var back="background-color: "+svg_gm_sel[1][4]+";";
		var moji_s2=blackOrWhite(svg_gm_sel[1][4]);
		var styl_s2="color:"+moji_s2+";"+" opacity:0.8;"+back;
		document.getElementById('svgtrig2').setAttribute('style', styl_s2);
		defaultCharStyle.fill=svg_gm_sel[2][4];
//		document.querySelector('#svgtrig3').style.backgroundColor = svg_gm_sel[2][4];
		var back="background-color: "+svg_gm_sel[2][4]+";";
		var moji_s3=blackOrWhite(svg_gm_sel[2][4]);
		var styl_s3="color:"+moji_s3+";"+" opacity:0.8;"+back;
		document.getElementById('svgtrig3').setAttribute('style', styl_s3);
		fw_colval=html_gm_sel[0][4];
		bk_colval=html_gm_sel[1][4];
		bd_colval=html_gm_sel[2][4];
//		document.querySelector('#trig1').style.backgroundColor=html_gm_sel[0][4];
		var back="background-color: "+html_gm_sel[0][4]+";";
		var moji_h1=blackOrWhite(html_gm_sel[0][4]);
		var styl_h1="color:"+moji_h1+";"+" opacity:0.8;"+back;
		document.getElementById('trig1').setAttribute('style', styl_h1);
//		document.querySelector('#trig2').style.backgroundColor=html_gm_sel[1][4];
		var back="background-color: "+html_gm_sel[1][4]+";";
		var moji_h2=blackOrWhite(html_gm_sel[1][4]);
		var styl_h2="color:"+moji_h2+";"+" opacity:0.8;"+back;
		document.getElementById('trig2').setAttribute('style', styl_h2);
//		document.querySelector('#trig3').style.backgroundColor=html_gm_sel[2][4];
		var back="background-color: "+html_gm_sel[2][4]+";";
		var moji_h3=blackOrWhite(html_gm_sel[2][4]);
		var styl_h3="color:"+moji_h3+";"+" opacity:0.8;"+back;
		document.getElementById('trig3').setAttribute('style', styl_h3);
		}
	else if(Editmode=="Edit") {
		if(changed_pallet==1) {
			fw_colval=html_gm_sel[0][4];
//			document.getElementById('trig1').style.backgroundColor=html_gm_sel[1][4];
			var back="background-color: "+fw_colval+";";
			var moji_h1=blackOrWhite(html_gm_sel[0][4]);
			var styl_h1="color:"+moji_h1+";"+" opacity:0.8;"+back;
			document.getElementById('trig1').setAttribute('style', styl_h1);
			}
		if(changed_pallet==2) {
			bk_colval=html_gm_sel[1][4];
//			document.getElementById('trig2').style.backgroundColor=html_gm_sel[1][4];
			var back="background-color: "+bk_colval+";";
			var moji_h2=blackOrWhite(html_gm_sel[1][4]);
			var styl_h2="color:"+moji_h2+";"+" opacity:0.8;"+back;
			document.getElementById('trig2').setAttribute('style', styl_h2);
			if(gm_pal_num==1) html_gm_sel[1][4]='none';
			}
		if(changed_pallet==3) {
			bd_colval=html_gm_sel[2][4];
//			document.getElementById('trig3').style.backgroundColor=html_gm_sel[2][4];
			var back="background-color: "+bd_colval+";";
			var moji_h3=blackOrWhite(html_gm_sel[2][4]);
			var styl_h3="color:"+moji_h3+";"+" opacity:0.8;"+back;
			document.getElementById('trig3').setAttribute('style', styl_h3);
			}
		}
	else {   //Editmode=="Svg"
		if(changed_pallet==1) {
			defaultPathStyle.stroke=svg_gm_sel[0][4];
			svg_bd_color=svg_gm_sel[0][4];
//			document.querySelector('#svgtrig1').style.backgroundColor = svg_gm_sel[0][4];
			var back="background-color: "+svg_gm_sel[0][4]+";";
			var moji_s1=blackOrWhite(svg_gm_sel[0][4]);
			var styl_s1="color:"+moji_s1+";"+" opacity:0.8;"+back;
			document.getElementById('svgtrig1').setAttribute('style', styl_s1);
			}
		if(changed_pallet==2) {
//			document.querySelector('#svgtrig2').style.backgroundColor = svg_gm_sel[1][4];
			var back="background-color: "+svg_gm_sel[1][4]+";";
			var moji_s2=blackOrWhite(svg_gm_sel[1][4]);
			var styl_s2="color:"+moji_s2+";"+" opacity:0.8;"+back;
			document.getElementById('svgtrig2').setAttribute('style', styl_s2);
			if(gm_pal_num==1) svg_gm_sel[1][4]='none';
			//if(svg_gm_sel[1][4]=='#ffffff') svg_gm_sel[1][4]='none';
//console.log('***paste pal_num=',gm_pal_num);
			defaultPathStyle.fill=svg_gm_sel[1][4];
			}
		if(changed_pallet==3) {
			defaultCharStyle.fill=svg_gm_sel[2][4];
			svg_moji_color=svg_gm_sel[2][4];
//			document.querySelector('#svgtrig3').style.backgroundColor = svg_gm_sel[2][4];
			var back="background-color: "+svg_gm_sel[2][4]+";";
			var moji_s3=blackOrWhite(svg_gm_sel[2][4]);
			var styl_s3="color:"+moji_s3+";"+" opacity:0.8;"+back;
			document.getElementById('svgtrig3').setAttribute('style', styl_s3);
			}		
		}
	changed_pallet=0;
	gm_pal_num=0;
//console.log('Style=',defaultPathStyle);
	}

/*
function save_sysparms() {
	var svg_pal=each_charpal(svg_gm_sel,svg_gm_pal);
	svg_pal='svg;'+svg_pal+'|<=>|';

	var html_pal=each_charpal(html_gm_sel,html_gm_pal);
	html_pal='html;'+html_pal+'|<=>|';

	var pal_data=svg_pal+html_pal;
//console.log('save system_data=',pal_data);
	//変数palletをDB　My_SysにEditor終了時に書き込む
	update_sysparms(1,pal_data);

	}
*/

function each_charpal(gm_sel,gm_pal) {
	var pal_data='';
	for(let k=0; k<3;k++){
	  pal_data=pal_data+String(gm_sel[k][0])+','+gm_sel[k][1]+','+String(gm_sel[k][2])+','+String(gm_sel[k][3])+','+gm_sel[k][4]+';'
	}
	var st=10;
	var kk=0;
	for(let j=0; j<3 ;j++ ){
		if(j==2) st=8;
		for(let k=0; k<st; k++){
	  		pal_data=pal_data+String(gm_pal[kk][0])+','+gm_pal[kk][1]+','+String(gm_pal[kk][2])+','+String(gm_pal[kk][3])+','+gm_pal[kk][4]+';'
			kk+=1;
			}
		}
	return pal_data;
	}

function each_numpal(sels) {
	var sel=[];
	sel_n=0;
	for(let k=0; k<3;k++){
		sel_elem=[Number(sels[sel_n+1]),sels[sel_n+2],Number(sels[sel_n+3]),Number(sels[sel_n+4]),sels[sel_n+5]];
		sel.push(sel_elem);
		sel_n=sel_n+5;
	}
	var pal=[];
	st=10;
	for(let j=0; j<3 ;j++ ){
		if(j==2) st=8;
		for(let k=0; k<st; k++){
			pal_elem=[Number(sels[sel_n+1]),sels[sel_n+2],Number(sels[sel_n+3]),Number(sels[sel_n+4]),sels[sel_n+5]];
			pal.push(pal_elem);
			sel_n=sel_n+5;
			}
		}
	return {sel:sel,pal:pal};
	}

/*
var sys_max_width='1200px';
var sys_marginL='50px';
var sys_marginR='100px';
var sys_set_menu='origin';
var set_menu=0;
var html_design_title;
var style_design_title;
*/
function read_sysparms() {
	//Editor開始時にDB My_Sysからデータを読み込んでSvg用及びHTML用pallet変数にセットする
	var from_sys=get_common(1);
//from_sys='';
//console.log('from_sys=',from_sys);
	if(from_sys=='') {
//console.log('sysdata initial');
		var {gm_sel,gm_pal}=pallet_init();
		svg_gm_sel=gm_sel;
		svg_gm_pal=gm_pal;
		html_gm_sel=gm_sel;
		html_gm_pal=gm_pal;
		}
	else {
		var parms=from_sys.split('|<=>|');
//console.log('sys parms=',parms);
		len=parms.length;
		for(let kn=0;kn<len;kn++){
			var sels=parms[kn].split(/;|,/);
		 	switch (sels[0]){
      				case 'svg':
//console.log('enter pallet svg');
					var {sel,pal}=each_numpal(sels);
					svg_gm_sel=sel;
					svg_gm_pal=pal;
					svg_bd_color=svg_gm_sel[0][4];
					svg_bk_color=svg_gm_sel[1][4];
					svg_moji_color=svg_gm_sel[2][4];
//console.log('svg pallet sel=',svg_gm_sel,'pal=',pal);
					break;
      				case 'html':
//console.log('enter pallet html');
					var {sel,pal}=each_numpal(sels);
					html_gm_sel=sel;
					html_gm_pal=pal;
					fw_colval=html_gm_sel[0][4];
					bk_colval=html_gm_sel[1][4];
					bd_colval=html_gm_sel[2][4];
//console.log('html pallet sel=',svg_gm_sel,'pal=',pal);
					break;
				case 'sys_parm':
					var sys_parms_dat=parms[kn];
					var sys_parms=sys_parms_dat.split(/;|,/);
//console.log('sys parm=',parms);
					sys_max_width=sys_parms[1];
					sys_marginL=sys_parms[2];
					sys_marginR=sys_parms[3];
					if(lang_org) sys_set_menu=lang_org;
					else sys_set_menu=sys_parms[4];

					$(".Tvis").width(sys_max_width);
					$(".Thtm").width(sys_max_width);
					$(".canv").width(sys_max_width);
					switch(sys_set_menu) {
						case 'origin':
							set_menu=0;
							break;
						case 'english':
							set_menu=1;
							break;
						case 'child':
							set_menu=2;
							break;
						case 'favorit':
							set_menu=3;
							break;
						default:
							break;
						}
					break;
				case 'navi_list':
					var navi_list_dat=parms[kn];
					break;
				case 'title_list':
					var navi_list_dat=parms[kn];
					break;
				case 'navi_edit':
					var sel2=parms[kn].split(';');
//console.log('sel2=',sel2);
					terms=[];
					var elem=[sels[0],'','',''];
					terms.push(elem);
					for(let j=1;j<sel2.length;j++) {
						elem=sel2[j].split(',');
						if(elem!='') terms.push(elem);
						}
					if(set_menu>=0) {
   						document.getElementById('fgedit').children[0].innerHTML=terms[1][set_menu];
						document.getElementById('fgedit').children[1].innerHTML='&#xf044; '+terms[2][set_menu];
						document.getElementById('fgedit').children[2].innerHTML='&#xf1fe; '+terms[3][set_menu];
						document.getElementById('fgedit').children[3].innerHTML=terms[4][set_menu];

   						document.getElementById('menu00').children[0].innerHTML='&#xf02f; '+terms[5][set_menu];
   						document.getElementById('menu00').children[1].innerHTML=terms[6][set_menu];
						document.getElementById('menu00').children[2].innerHTML=terms[7][set_menu];

   						document.getElementById('chan_title').children[0].innerHTML=terms[8][set_menu];
						document.getElementById('chan_title').children[1].innerHTML=terms[9][set_menu];
						document.getElementById('chan_title').children[2].innerHTML=terms[10][set_menu];
						document.getElementById('chan_title').children[3].innerHTML=terms[11][set_menu];

   						document.getElementById('menu01').children[0].innerHTML='&#xf1c0; '+terms[12][set_menu];
   						document.getElementById('menu01').children[1].innerHTML=terms[13][set_menu];
						document.getElementById('menu01').children[2].innerHTML='&#xf0c5; '+terms[14][set_menu];
   						document.getElementById('menu01').children[3].innerHTML=terms[15][set_menu];
   						document.getElementById('menu01').children[4].innerHTML=terms[21][set_menu];
   						document.getElementById('menu01').children[5].innerHTML=terms[16][set_menu];
   						document.getElementById('menu01').children[6].innerHTML=terms[17][set_menu];
   						document.getElementById('menu01').children[7].innerHTML=terms[18][set_menu];
   						document.getElementById('menu01').children[8].innerHTML=terms[19][set_menu];
   						document.getElementById('menu01').children[9].innerHTML=terms[20][set_menu];

   						document.getElementById('menu02').children[1].innerHTML=terms[22][set_menu];
   						document.getElementById('menu02').children[2].innerHTML=terms[23][set_menu];
   						document.getElementById('menu02').children[3].innerHTML=terms[24][set_menu];
   						document.getElementById('menu02').children[4].innerHTML=terms[25][set_menu];
   						document.getElementById('menu02').children[5].innerHTML=terms[26][set_menu];

   						document.getElementById('menu02').children[8].innerHTML=terms[27][set_menu];
   						document.getElementById('menu02').children[10].innerHTML=terms[28][set_menu];
   						document.getElementById('menu02').children[11].innerHTML=terms[29][set_menu];
   						document.getElementById('menu02').children[12].innerHTML=terms[30][set_menu];
   						document.getElementById('menu02').children[13].innerHTML=terms[31][set_menu];
   						document.getElementById('menu02').children[14].innerHTML=terms[36][set_menu];
   						document.getElementById('menu02').children[15].innerHTML=terms[32][set_menu];
   						document.getElementById('menu02').children[16].innerHTML=terms[33][set_menu];
   						document.getElementById('menu02').children[17].innerHTML=terms[34][set_menu];
   						document.getElementById('menu02').children[18].innerHTML=terms[35][set_menu];
						}
					break;
				case 'title_edit':
					var sel2=parms[kn].split(';');

					terms=[];
					var elem=[sels[0],'','',''];
					terms.push(elem);
					for(let j=1;j<sel2.length;j++) {
						elem=sel2[j].split(',');
						if(elem!='') terms.push(elem);
						}
					html_design_title=terms;
//console.log('sel2=',sel2,'title=',html_design_title);
					break;
				case 'title_style':
					var sel2=parms[kn].split(';');
					terms=[];
					var elem=[sels[0],'','',''];
					terms.push(elem);
					for(let j=1;j<sel2.length;j++) {
						elem=sel2[j].split(',');
						if(elem!='') terms.push(elem);
						}
					style_design_title=terms;
//console.log('sel2=',sel2,'title=',style_design_title);
					break;
				case '':
					break;
				case 'addr_list':
					old_addr=parms[kn];
					break;
       				default:
					break;
				}

			}
		}
	set_changed_pallet();
//console.log('svg pallet=',svg_gm_sel,svg_gm_pal);
//console.log('html pallet=',html_gm_sel,html_gm_pal);
	} //End of read_sysparms
</textarea>
<textarea id="script12"  class="special" style="display:none;">
	tempo_export_html();
function tempo_export_html(){
  var data='<!DOCTYPE html><html lang="en"><body>';
//console.log('data=',data);

    const parser = new DOMParser();
    const html_dat = parser.parseFromString(data, "text/html");

    var tagn=document.getElementById('texx');
    var dumy=tagn.cloneNode(true);

	dlist=dumy.querySelectorAll('rect');
	dlist.forEach(function (element) {
		element.remove();
//		element.setAttribute('style','display;block');
//		element.setAttribute('class','canv point_none');
//console.log(element);
		});

	var btag=html_dat.querySelector('body');
//console.log(btag);
	btag.appendChild(dumy);
//console.log(html_dat);
	const serializer = new XMLSerializer();
	const es_html = serializer.serializeToString(html_dat);
//console.log('export html length=',es_html.length);

let blob = new Blob([es_html],{type:"html"});
let link = document.createElement('a');
link.href = URL.createObjectURL(blob);
link.download = 'tempofile.html';
link.click();
   }

</textarea>
<textarea id="script13"  class="special" style="display:none;">
   after_dbl_click();
   function after_dbl_click() {
	if ((control.value== 'simp_line')||(control.value== 'seri_line')||(control.value== 'close_line')||(control.value== 'smooth')||(control.value== 'close_smooth')){

		if((key_shift)&&(drawingPoints.length>1)) {
//console.log('x0,y0=',x0,y0);
			mend_points();
			}
		if(drawingPoints.length<2) {
			alert('not proper figure');
			drawingPoints = [];
			Step=0;
			return;
			}
		else if((drawingPoints.length==2) && (control.value=='simp_line')){
			var {group,fig_id}=make_group('line');
console.log('make_group=',group,fig_id,'Step=',Step);
			}
		else {
			var {group,fig_id}=make_group('path');
console.log('make_group=',group,fig_id,'Step=',Step);
			}
console.log('***fig id= ',fig_id);
		var c_para="else";
		if((control.value== 'close_line')||(control.value== 'close_smooth')) {
			c_para="close";
			drawingPoints.push(drawingPoints[0]);
			}
		if (first_point){
			container.removeChild(first_point);
			first_point=null;
			}
		if(drawingPath){
        		container.removeChild(drawingPath);
                	drawingPath=null;
			}
        	drawingPath = null;
        	var path;
		group.setAttributeNS(null,'close', c_para);
		var s_para="else";
console.log(drawingPoints);
		if((control.value== 'smooth')||(control.value== 'close_smooth')) {
			//3次ベジエで滑らかにするアルゴリズム　resultPoints=catmullRom2bezier(drawingPoints);では上手くいかず
			s_para="smooth";
			}
		else if(((control.value== 'seri_line')||(control.value== 'close_line'))&&(S_line_Trim>0)) {
			var R=S_line_Trim;
			s_para='trim '+String(S_line_Trim);
			}

		group.setAttribute('smooth', s_para);
		drawingPtype=Array(drawingPoints.length);
		drawingPtype.fill(0);
console.log('**01 remove path Ptype=',drawingPtype);
		var path=set_line_group(group,drawingPtype,c_para,s_para);
		group.insertBefore(path, group.firstChild);
		remake_group(group,path,defaultArrowStyle);
		

console.log('**06 append path');
		drawingPoints = [];
	}
   }  //after dbl_click
</textarea>
<textarea id="script14"  class="special" style="display:none;">
   add_tag_func();
   function add_tag_func() {
console.log('Enter add_tag');
	var add_tag;
	//let select = document.getElementById('sel_add_tag');
	var tag_name=document.getElementById('sel_add_tag').value;
console.log('selected add tag=',tag_name);
	let new_tag;
	if(doc_deep_level<0) {
		alert('Not selected text');
		return;
		}
	var level=tag_trees[doc_deep_level].level;
console.log('doc_edit_node=',doc_edit_node,'deep level=',doc_deep_level,' level=',level);
	if(level<=0) {
		var result = window.confirm('先頭への追加となります。追加しますか？');
		if(result==true){
			doc_add_first=true;
			}
			else return;
		}
    	//選択したtagによって分岐
    	switch (tag_name) {
      		case 'div':               
			add_tag="<div> 大枠   typ_chng_flg=1 //基本配置 ";
console.log('select=',add_tag);

			if(!check_structure_tag(doc_edit_node)) return;

			var par_tag= document.createElement('div');
			//var parms="width:50%;float:left;height:auto;";
			//par_tag.setAttribute('style', parms);
			//par_tag.setAttribute('height', 'auto');
			//par_tag.setAttribute('width', '50%');
			var chd_tag = document.createElement('p');
			chd_tag.innerHTML='DIVタグ＆Pタグを挿入しました。';
			par_tag.setAttribute('fig', '大枠');
			par_tag.setAttribute('class', 'div');
			chd_tag.setAttribute('fig', '段落');
			chd_tag.setAttribute('class', 'p');
			par_tag.appendChild(chd_tag);
			if(doc_add_first){
				doc_edit_node.insertBefore(par_tag, doc_edit_node.firstChild);
console.log('add First child');
				}
			else {
				$(par_tag).insertAfter(doc_edit_node);
console.log('not first');
				}
			doc_add_first=false;
			cancel_green_line();

    			tag_trees=[];
    			tag_trees=get_tagStruct(par_tag,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=par_tag;
			doc_origin_node=par_tag;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
			setto_current_tag(doc_edit_node);
			set_parms();
			var result=check_html_hist(par_tag,tag_trees,level,'add');
			display_current_tag(doc_edit_node);
			break;
      		case 'flex':               
			add_tag="<flex>　横小枠  typ_chng_flg=3 //並び・装飾　";
console.log('select=',add_tag);

			if(!check_structure_tag(doc_edit_node)) return;

			var par_tag= document.createElement('div');
			par_tag.setAttribute('class', 'flex_box');
			par_tag.setAttribute('fig', '横小枠');
			var hm_numb=Number(document.getElementById('hm_numb').value);
			var parm_w=document.getElementById('flex_width').value;
			dwidth='';
			if(hm_numb<2) hm_numb=2;
			if(hm_numb>10) hm_numb=10;
			var w_parm=document.getElementById('flex_width').value;
			if(w_parm==''){
				var dwidth=Math.round(100/hm_numb*10)/10;
				var parm_w=[String(dwidth)+'%'];
				document.getElementById('flex_width').value=parm_w;
				}
			else {
				var parm_w=w_parm.split(' ');
console.log('width modified');
				}
			leng_wd=parm_w.length;
console.log('width%=',parm_w);
			for(let i=0;i<hm_numb;i++) {
				var chd_tag = document.createElement('div');
				chd_tag.setAttribute('fig', '小枠');
				chd_tag.setAttribute('class', 'flex');
				chd_tag.innerHTML='<p>コンテンツが入ります</p>';
				if(i<leng_wd) parms_1='width:'+parm_w[i]+';';
				else parms_1='width:'+parm_w.slice(-1)[0]+';';
				var parms_1=parms_1+"padding:0 10px;border-radius:5px; border: solid 1px #008080;";
				chd_tag.setAttribute('style', parms_1);
				chd_tag.setAttribute('height', 'auto');
				par_tag.appendChild(chd_tag);
				}
			if(doc_add_first){
				doc_edit_node.insertBefore(par_tag, doc_edit_node.firstChild)
console.log('add First child');
				}
			else {
				$(par_tag).insertAfter(doc_edit_node);
console.log('not first');
				}
console.log('01 parm type=',typ_chng_flg);
			doc_add_first=false;
			cancel_green_line();
    			tag_trees=[];
    			tag_trees=get_tagStruct(par_tag,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=par_tag;
			doc_origin_node=par_tag;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
console.log('02 parm type=',typ_chng_flg);
			setto_current_tag(doc_edit_node);
console.log('03 parm type=',typ_chng_flg);
			set_parms();
			var result=check_html_hist(par_tag,tag_trees,level,'add');
			display_current_tag(doc_edit_node);
			break;
      		case 'colm_flex':               
			add_tag="<flex>　縦小枠　　typ_chng_flg=1;　　//基本配置　";
console.log('select=',add_tag);

			if(!check_structure_tag(doc_edit_node)) return;

			var par_tag= document.createElement('div');
			par_tag.setAttribute('class', 'colm_box');
			//par_tag.setAttribute('flex-direction', 'column');
			par_tag.setAttribute('fig', '縦小枠');
			var hm_numb=Number(document.getElementById('hm_numb').value);
			var parm_w=document.getElementById('flex_width').value;
			dwidth='';
			if(hm_numb<2) hm_numb=2;
			if(hm_numb>10) hm_numb=10;
			var w_parm=document.getElementById('flex_width').value;
			if(w_parm==''){
				var dwidth=Math.round(100/hm_numb*10)/10;
				var parm_w=[String(height)+'%'];
				document.getElementById('flex_width').value=parm_w;
				}
			else {
				var parm_w=w_parm.split(' ');
console.log('width modified');
				}
			leng_wd=parm_w.length;
console.log('width%=',parm_w);
			for(let i=0;i<hm_numb;i++) {
				var chd_tag = document.createElement('div');
				chd_tag.setAttribute('fig', '小枠');
				chd_tag.setAttribute('class', 'colm_flex');
				chd_tag.innerHTML='<p>コンテンツが入ります</p>';
				//if(i<leng_wd) parms_1='height:'+parm_w[i]+';';
				//else parms_1='height:'+parm_w.slice(-1)[0]+';';
				var parms_1=parms_1+"border: solid 1px #008080;";
				chd_tag.setAttribute('style', parms_1);
				chd_tag.setAttribute('height', 'auto');
				par_tag.appendChild(chd_tag);
				}
			if(doc_add_first){
				doc_edit_node.insertBefore(par_tag, doc_edit_node.firstChild)
console.log('add First child');
				}
			else {
				$(par_tag).insertAfter(doc_edit_node);
console.log('not first');
				}
			doc_add_first=false;
			cancel_green_line();

    			tag_trees=[];
    			tag_trees=get_tagStruct(par_tag,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=par_tag;
			doc_origin_node=par_tag;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
			setto_current_tag(doc_edit_node);
			set_parms();
			var result=check_html_hist(par_tag,tag_trees,level,'add');
			display_current_tag(doc_edit_node);
			break;
      		case 'ul':               
			add_tag="<div><ul>　箇条書　typ_chng_flg=1;　　//基本配置　";
console.log('select=',add_tag);

			if(!check_structure_tag(doc_edit_node)) return;

			var chd_tag = document.createElement('ul');
			chd_tag.setAttribute('class', 'ul_list');
			//chd_tag.setAttribute('style','list-style-position:inside;');
			chd_tag.setAttribute('fig', '箇条書');
			var hm_numb=Number(document.getElementById('hm_numb').value);
			if(hm_numb<2) hm_numb=2;
			if(hm_numb>10) hm_numb=10;
			var dwidth=Number(100/hm_numb*10)/10;
			for(let i=0;i<hm_numb;i++) {
				var chd_chd_tag = document.createElement('li');
				chd_chd_tag.innerHTML='text';
				chd_chd_tag.setAttribute('fig', '項目');
				chd_tag.appendChild(chd_chd_tag);
				}
			if(doc_add_first){
				doc_edit_node.insertBefore(chd_tag, doc_edit_node.firstChild)
console.log('add First child');
				}
			else {
				$(chd_tag).insertAfter(doc_edit_node);
console.log('not first');
				}
			doc_add_first=false;
			cancel_green_line();

    			tag_trees=[];
    			tag_trees=get_tagStruct(chd_tag,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=chd_tag;
			doc_origin_node=chd_tag;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
			setto_current_tag(doc_edit_node);
			set_parms();
			var result=check_html_hist(chd_tag,tag_trees,level,'add');
			display_current_tag(doc_edit_node);
			break;
      		case 'ol':               
			add_tag="<div><ol>　数列挙　typ_chng_flg=1　　//基本配置";
console.log('select=',add_tag);

			if(!check_structure_tag(doc_edit_node)) return;

			var chd_tag = document.createElement('ol');
			chd_tag.setAttribute('class', 'ol_list');
			//chd_tag.setAttribute('style','list-style-position:inside;');
			chd_tag.setAttribute('fig', '数列挙');
			var hm_numb=Number(document.getElementById('hm_numb').value);
			if(hm_numb<2) hm_numb=2;
			if(hm_numb>10) hm_numb=10;
			var dwidth=Number(100/hm_numb*10)/10;
			for(let i=0;i<hm_numb;i++) {
				var chd_chd_tag = document.createElement('li');
				chd_chd_tag.innerHTML='text';
				chd_chd_tag.setAttribute('fig', '項目');
				chd_tag.appendChild(chd_chd_tag);
				}
			if(doc_add_first){
				doc_edit_node.insertBefore(chd_tag, doc_edit_node.firstChild)
console.log('add First child');
				}
			else {
				$(chd_tag).insertAfter(doc_edit_node);
console.log('not first');
				}
			doc_add_first=false;
			cancel_green_line();

    			tag_trees=[];
    			tag_trees=get_tagStruct(chd_tag,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=chd_tag;
			doc_origin_node=chd_tag;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
			setto_current_tag(doc_edit_node);
			set_parms();
			var result=check_html_hist(chd_tag,tag_trees,level,'add');
			display_current_tag(doc_edit_node);
			break;
      		case 'title':
			add_tag="<title>　見出し　typ_chng_flg=3：　//並び・装飾　　";
    			var selectedText = window.getSelection().toString();
console.log('Enter add　H tag');
			var sel = window.getSelection();
  			if(!sel.rangeCount) return; 
  			var range = sel.getRangeAt(0);

			if(!check_structure_tag(doc_edit_node)) return;

			var H_size=document.getElementById("tit_size").value;
			if(H_size=='none') {
				alert('Title size not selected');
				return;
				}

			if(selectedText.length>0){
    				range.deleteContents();    // 範囲選択箇所を一旦削除
				var par_tag= document.createElement(H_size);
				par_tag.setAttribute('class', 'title');
				par_tag.setAttribute('fig', '見出し');
				var temp_id='t'+(Date.now()).toString();
				par_tag.setAttribute('id', temp_id);
				par_tag.innerHTML=selectedText;
    				range.insertNode(par_tag);

				reform_html_after_ptag();
				par_tag=document.getElementById(temp_id);
				par_tag.removeAttribute('id');
				}
			else {
				var par_tag= document.createElement(H_size);
				par_tag.setAttribute('class', 'title');
				par_tag.setAttribute('fig', '見出し');
				if(document.getElementById('tit_title').value) {
					par_tag.innerHTML=document.getElementById('tit_title').value;
					}
console.log('edit_node=',doc_edit_node);
				if(doc_add_first){
					doc_edit_node.insertBefore(par_tag, doc_edit_node.firstChild)
console.log('add First child');
					}
				else {
					$(par_tag).insertAfter(doc_edit_node);
console.log('not first');
					}
				}
			doc_add_first=false;
			cancel_green_line();

    			tag_trees=[];
    			tag_trees=get_tagStruct(par_tag,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=par_tag;
			doc_origin_node=par_tag;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
			setto_current_tag(doc_edit_node);
			set_parms();
			var result=check_html_hist(par_tag,tag_trees,level,'add');
			display_current_tag(doc_edit_node);
			break;
      		case 'photo':                        
			add_tag="<photo>　絵写真　　typ_chng_flg=4:  //画像・リンク　";
console.log('photo present=',doc_edit_node,'level=',doc_deep_level,'dog_tree=',tag_trees);
			var tempnode=doc_edit_node;
			if(doc_edit_node.nodeName!='P') {
alert('指定位置が違います textを選択下さい。');
				return;
				}
			tempnode= doc_edit_node.parentNode;
			photo_type='new';
			var type=tempnode.getAttribute('class');
			if(type=='flex' || type=='div' ) photo_type='flex';
//			else {
//alert('絵写真の配置は小枠内のみです。');
//				return;
//				}

console.log('photo type=',photo_type,'tempnode=',tempnode);
			var rect=doc_edit_node.getBoundingClientRect();
console.log('context_pos=',rect.left,rect.top);

			document.getElementById('contextmenu_c').style.left=(rect.left+20)+"px";
                	document.getElementById('contextmenu_c').style.top=(rect.top+20)+"px";
		        document.getElementById('contextmenu_c').style.display="block";
console.log('Create photo tag End');
			break;
      		case 'p_tag':                        
			add_tag="<p>　段落　　typ_chng_flg=1:  //基本配置　";
    			var selectedText = window.getSelection().toString();
console.log('Enter add　P tag');
			var sel = window.getSelection();
  			if(!sel.rangeCount) return; 
  			var range = sel.getRangeAt(0);

			if(!check_structure_tag(doc_edit_node)) return;

			var par_tag= document.createElement('p');
			//var parms="background-color:#edf7ff;";
			par_tag.setAttribute('fig', '段落');
			par_tag.innerHTML='新規の段落です。';
console.log('edit_node=',doc_edit_node);
			if(doc_add_first){
				doc_edit_node.insertBefore(par_tag, doc_edit_node.firstChild)
console.log('add First child');
				}
			else {
				$(par_tag).insertAfter(doc_edit_node);
console.log('not first');
				}
			doc_add_first=false;
			cancel_green_line();

    			tag_trees=[];
    			tag_trees=get_tagStruct(par_tag,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=par_tag;
			doc_origin_node=par_tag;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
			setto_current_tag(doc_edit_node);
			set_parms();
			var result=check_html_hist(par_tag,tag_trees,level,'add');
			display_current_tag(doc_edit_node);
			break;
      		case 'svg_indiv':                        
			add_tag="<svg>　段落 in DIV　　typ_chng_flg=1:  //基本配置　";
console.log('Enter add　Svg_indiv tag');

			var node=doc_edit_node.nodeName;
			if(node!='DIV') {
alert('svg must be made in DIV');
				return;
				}
			var svgtags = doc_edit_node.querySelector('svg');
			if(svgtags) {
alert('svg tag already exis in DIV');
				return;				
				}
			var svg_div = document.createElementNS('http://www.w3.org/2000/svg','svg');
			svg_div.setAttributeNS(null,'version', "1.1");
			svg_div.setAttributeNS(null,'my_class', "indiv");
			svg_div.setAttributeNS(null,'class', "canv2 point_auto select_auto");
			svg_div.setAttributeNS(null,'width', "100%");
			var fig_id='svg'+(Date.now()).toString();
			svg_div.setAttribute('id', fig_id);
			svg_div.setAttributeNS(null,'height', "auto");
			//svg_div.setAttributeNS(null,'viewBox', "0 0 400 200");

			doc_edit_node.insertBefore(svg_div, doc_edit_node.firstChild);
			cancel_green_line();
			setto_current_tag(doc_edit_node);
			set_parms();
			//Svg_indivを作成時一度はSvg_indivに入る必要がある。
			document.getElementById("makeSvg_indiv").click();
			break;
      		case 'table':
			add_tag="<table>　作表  typ_chng_flg=4 //並び・装飾　";
console.log('select=',add_tag);

			if(!check_structure_tag(doc_edit_node)) return;

			var par_tag= document.createElement('div');
			par_tag.setAttribute('class', 'table');
			par_tag.setAttribute('fig', 'table');
			var tabl_id='ta'+(Date.now()).toString();
			par_tag.setAttribute('id', tabl_id);
			var hm_numb=Number(document.getElementById('hm_numb').value);
			var cols=document.getElementById('tabl_cols').value;
			var head_yes=document.getElementById('ta_head').value;
			if(hm_numb<2) hm_numb=2;
			if(hm_numb>10) hm_numb=10;
			var tabl_tag=document.createElement('table');
			par_tag.appendChild(tabl_tag);
			if(head_yes) {
				var thead_tag=document.createElement('thead');
				tabl_tag.append(thead_tag);
				var tr_tag=document.createElement('tr');
				for(let i=0;i<hm_numb;i++) {
					var chd_tag = document.createElement('th');
					var term='　表題'+String(i).slice(-1)[0]+'　';
					chd_tag.innerHTML=term;
//					var parms_1=parms_1+"border-radius:5px; border: solid 1px #008080;";
//					chd_tag.setAttribute('style', parms_1);
					tr_tag.appendChild(chd_tag);
					}
				thead_tag.append(tr_tag);
				}
			var tbody_tag=document.createElement('tbody');
			tabl_tag.append(tbody_tag);
			for(let i=0;i<cols;i++) {			
				var tr_tag=document.createElement('tr');
				for(let j=0;j<hm_numb;j++) {
					var chd_tag = document.createElement('td');
					chd_tag.innerHTML='　項目　';
//					parms_1='width:'+parm_w.slice(-1)[0]+';';
//					var parms_1=parms_1+"border-radius:5px; border: solid 1px #008080;";
//					chd_tag.setAttribute('style', parms_1);
					tr_tag.appendChild(chd_tag);
					}
				tbody_tag.append(tr_tag);
				}
			var line_dw=document.getElementById('tabl_parm01').value;
console.log('line_dw=',line_dw);
			if(line_dw) {
				//Table罫線のテスト OK
				var td_cell=tabl_tag.querySelectorAll('td ,th');
				console.log('td_cell leng=',td_cell.length);
				var styl='border:'+line_dw;
				for(let i=0;i<td_cell.length;i++) {
					td_cell[i].setAttribute('style',styl);
					}
				}

/*
//列cellの合体（rowspan）のテスト OK
console.log('tbody=',tbody_tag);
console.log('rows=',tbody_tag.rows);
console.log('tr=',tbody_tag.rows[0].cells);
console.log('td=',tbody_tag.rows[0].cells[0]);
tbody_tag.rows[1].cells[1].setAttribute('rowspan','2');
tbody_tag.rows[2].cells[1].remove();
//行列の追加
var row = tabl_tag.insertRow( -1 );
//tabl_tag.appendChild(row);
var td = row.insertCell( -1 );
td.innerHTML='追加';
//row.appendChild(td);
var col = tabl_tag.insertCol( -1 );
//tabl_tag.appendChild(row);
var tr = col.insertCell( -1 );
tr.innerHTML='追加';
*/

			if(doc_add_first){
				doc_edit_node.insertBefore(par_tag, doc_edit_node.firstChild)
console.log('add First child');
				}
			else {
				$(par_tag).insertAfter(doc_edit_node);
console.log('not first');
				}
console.log('01 parm type=',typ_chng_flg);
			doc_add_first=false;
			cancel_green_line();
    			tag_trees=[];
    			tag_trees=get_tagStruct(par_tag,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=par_tag;
			doc_origin_node=par_tag;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
console.log('02 parm type=',typ_chng_flg);
			setto_current_tag(doc_edit_node);
console.log('03 parm type=',typ_chng_flg);
			set_parms();
			var result=check_html_hist(par_tag,tag_trees,level,'add');
			display_current_tag(doc_edit_node);
			break;
      		case 'span':               
			add_tag="<span>　強調　　　　typ_chng_flg=2:  //文字書式　";
			var selectedText = window.getSelection().toString();
console.log('Enter span sel=',selectedText);

			var sel = window.getSelection();
  			if(!sel.rangeCount) return; 
  			var range = sel.getRangeAt(0);　　　　　　　　　　　//OK!!　<font>でも下記の<span>でもOK
console.log('#####selection=',sel,range);
console.log('text and Node=',selectedText,sel.focusNode);
console.log('start=',range.startContainer,'end=',range.endContainer);
if(range.startContainer!=range.endContainer) console.log('start and end not equal');
			if(selectedText=="" || range.startContainer!=range.endContainer) {
				alert('not proper selection');
				return;
				}
  			var span = document.createElement("span");
			span.setAttribute('fig', '強調');
console.log('catch span text=',range);

			if(selectedText.length>0){
    				range.deleteContents();    // 範囲選択箇所を一旦削除
				span.innerHTML=selectedText;
    				range.insertNode(span);
				}
			else {
				span.innerHTML='span';
    				range.insertNode(span);
//				$(span).insertAfter(doc_edit_node);
				}
			var old_trees=tag_trees;
			var old_level=level;
			cancel_green_line();
    			tag_trees=[];
    			tag_trees=get_tagStruct(span,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=span;
			doc_origin_node=span;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
			setto_current_tag(doc_edit_node);
			set_parms();

			var span_par=doc_edit_node.parentNode;
console.log('span tag=',span,span_par);
			var result=check_html_hist(span_par,old_trees,old_level,'add_d');
			display_current_tag(doc_edit_node);
			window.getSelection().removeAllRanges();
			break;
		case 'button':
			add_tag="<a>　ボタン　　typ_chng_flg=4:  //画像・リンク　";
    			var selectedText = window.getSelection().toString();
console.log('Enter button');

			var sel = window.getSelection();
  			if(!sel.rangeCount) return; 
  			var range = sel.getRangeAt(0);　　　　　　　　　　　//OK!!　<font>でも下記の<span>でもOK
//<a>タグを作成
    			var newNode =document.createElement('a');
			newNode.setAttribute('fig', 'ボタン');

			if(selectedText.length>0){
    				range.deleteContents();    // 範囲選択箇所を一旦削除
    				range.insertNode(newNode);
				document.getElementById('im_pam5').value=selectedText;
				}
			else {
				if(document.getElementById('im_pam5').value) {
					newNode.innerHTML=document.getElementById('im_pam5').value;
					}
				else newNode.innerHTML='google';
				range.insertNode(newNode);
				}

			if(document.getElementById('link_targ').value) {
				newNode.href=document.getElementById('link_targ').value;
				}
			newNode.setAttribute('target', '_blank');
			var parms='';
			if(document.getElementById('hm_parm1').value) {
				parms=parms+'color:'+document.getElementById('hm_parm1').value+';';
				}
//			if(document.getElementById('hm_parm2').value) {
//				parms=parms+'background-color:'+document.getElementById('hm_parm2').value+';';
//				}
			if(document.getElementById('hm_parm14').value) {
				parms=parms+'font-weight:'+document.getElementById('hm_parm14').value+';';
				}
			newNode.setAttribute('style', parms);
/*
			if(document.getElementById('tit_title').value) {
				par_tag.innerHTML=document.getElementById('tit_title').value;
				}
*/
			var new_par=new_Node.parentNode;
			cancel_green_line();

    			tag_trees=[];
    			tag_trees=get_tagStruct(newNode,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=newNode;
			doc_origin_node=newNode;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
			setto_current_tag(doc_edit_node);
			set_parms();
			var result=check_html_hist(new_par,tag_trees,level,'add_d');
			display_current_tag(doc_edit_node);
			break;
		case 'link':
			add_tag="<a>　link　　typ_chng_flg=4:  //画像・リンク　";
    			var selectedText = window.getSelection().toString();
console.log('Enter link');
			var sel = window.getSelection();
  			if(!sel.rangeCount) return; 
  			var range = sel.getRangeAt(0);　　　　　　　　　　　//OK!!　<font>でも下記の<span>でもOK
console.log('catch link text=',range);

//<a>タグを作成
    			var newNode =document.createElement('a');
			newNode.setAttribute('fig', 'リンク');
			if(selectedText.length>0){
    				range.deleteContents();    // 範囲選択箇所を一旦削除
    				range.insertNode(newNode);
				document.getElementById('im_pam5').value=selectedText;
				newNode.innerHTML=selectedText;
				}
			else {
				if(document.getElementById('im_pam5').value) {
					newNode.innerHTML=document.getElementById('im_pam5').value;
					}
				else newNode.innerHTML='google';
				range.insertNode(newNode);
//				$(newNode).insertBefore(doc_edit_node);
				}

			if(document.getElementById('link_targ').value) {
				newNode.href=document.getElementById('link_targ').value;
				}
			var new_par=newNode.parentNode;

			newNode.setAttribute('target', '_blank');
			cancel_green_line();

    			tag_trees=[];
    			tag_trees=get_tagStruct(newNode,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=newNode;
			doc_origin_node=newNode;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
			setto_current_tag(doc_edit_node);
			set_parms();
			var result=check_html_hist(new_par,tag_trees,level,'add_d');
			display_current_tag(doc_edit_node);
			break;
		case 'nav_menu':
			add_tag="<nav>menu <ul>+ <li humburger>  typ_chng_flg=1：//基本配置 ";
console.log('select=',add_tag);

			if(!check_structure_tag(doc_edit_node)) return;

//<nav class="my_navi" style="color:white; background-color:blue;">
			var oya_tag= document.createElement('nav');
			oya_tag.setAttribute('fig', 'メニュー');
			oya_tag.setAttribute('class', 'my_navi')
//<ul id="my_resp_menu" >
			var par_tag= document.createElement('ul');
			par_tag.setAttribute('id', 'my_resp_menu');
			par_tag.setAttribute('style','color:white;background-color:yellow;font-weight:bold;list-style-type:none;');
			var hm_numb=Number(document.getElementById('hm_numb').value);
			if(hm_numb<2) hm_numb=2;
			if(hm_numb>10) hm_numb=10;
//<li class='my_nav'><a href="home.html" >Home</a></li>
			for(let i=0;i<hm_numb;i++) {
				var chd_tag = document.createElement('li');
				chd_tag.setAttribute('class', 'my_nav');
				chd_tag.setAttribute('fig', '項目');
				chd_tag.innerHTML='<a href="https://www.google.com/">google</a>';
				par_tag.appendChild(chd_tag);
				}
//<li>のfirstChildとして次にhumburgerを追加
//    <li class="my_hamburger" id="my_nav_togl"><a href="#my_resp_menu"><i class="fa fa-bars"></i></a></li>
				var chd_tag = document.createElement('li');
				chd_tag.setAttribute('id', 'my_nav_togl');
				chd_tag.setAttribute('class', 'my_hamburger');
				chd_tag.innerHTML='<a href="#my_resp_menu"><i class="fa fa-bars"></i></a>';
				par_tag.insertBefore(chd_tag, par_tag.firstChild)
			if(doc_add_first){
				doc_edit_node.insertBefore(oya_tag, doc_edit_node.firstChild)
console.log('add First child');
				}
			else {
				$(oya_tag).insertAfter(doc_edit_node);
console.log('not first');
				}
			doc_add_first=false;
			oya_tag.appendChild(par_tag);
			cancel_green_line();
			
			tag_trees=[];
    			tag_trees=get_tagStruct(oya_tag,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=oya_tag;
			doc_origin_node=oya_tag;
			setto_current_tag(doc_edit_node);
			set_parms();
			var result=check_html_hist(oya_tag,tag_trees,level,'add');
			display_current_tag(doc_edit_node);
			break;
		case 'I_con':
			add_tag="<i>　Icon　　typ_chng_flg=4:  //画像・リンク　";
    			//const selectedText = window.getSelection().toString();
console.log('Enter Icon');
			var sel = window.getSelection();
  			if(!sel.rangeCount) return; 
  			var range = sel.getRangeAt(0);　　　　　　　　　　　//OK!!　<font>でも下記の<span>でもOK
//<i>タグを作成
    			var newNode =document.createElement('i');
			newNode.setAttribute('fig', 'Icon');
    			range.insertNode(newNode);
			if(document.getElementById('link_targ').value) {
				var font_code=document.getElementById('link_targ').value;
				}
			newNode.setAttribute('class', font_code);
			var new_par=new_Node.parentNodel
			cancel_green_line();

    			tag_trees=[];
    			tag_trees=get_tagStruct(newNode,0);
    			if(tag_trees.length>0) doc_deep_level=0;
			doc_edit_node=newNode;
			doc_origin_node=newNode;
console.log('After add tag tree=',tag_trees,'levels=',tag_trees.length);
			setto_current_tag(doc_edit_node);
			set_parms();
			var result=check_html_hist(new_par,tag_trees,level,'add_d');
			display_current_tag(doc_edit_node);
			break;
		case 'recipe':
			add_tag="<i>　recipe　　typ_chng_flg=4:  //画像・リンク　";
console.log('Enter recipe');
			var sl = document.getElementById( "style_recipe_tag" ) ;
			while(sl.lastChild)
				{
				sl.removeChild(sl.lastChild);
				}
			var newElement = new Option("","none") ;	// <option value="newtag">newtag</option>を追加する
			sl.add( newElement );
			if(recipe_selection) {

　　				const domParser = new DOMParser();
　　				var parsed = domParser.parseFromString(recp_list[recipe_selection-1][2], 'text/html');
console.log('parsed',parsed);
　　				var new_node = parsed.body.childNodes[0];
console.log('new_node=',new_node);
				makepalce_recipe(new_node);
				if(doc_add_first){
					doc_edit_node.insertBefore(new_node, doc_edit_node.firstChild)
console.log('add First child');
					}
				else {
					$(new_node).insertAfter(doc_edit_node);
console.log('not first');
					}
				doc_add_first=false;
				cancel_green_line();
    				tag_trees=[];
    				tag_trees=get_tagStruct(new_node,0);
    				if(tag_trees.length>0) doc_deep_level=0;
				doc_edit_node=new_node;
				doc_origin_node=new_node;
				setto_current_tag(doc_edit_node);
				set_parms();
				var result=check_html_hist(new_node,tag_trees,level,'add');
				display_current_tag(doc_edit_node);
				}
			break;
		}
    }      //End of add_tag_func
</textarea>
<textarea id="script15"  class="special" style="display:none;">
    $(document).on('click', '#regi_icon', function(){
	icon_regist='regist';
	document.getElementById("draw_mesh").click();
	});
    $(document).on('change', '#icon_area', function(){
	mesh_draw=0;
	icon_regist='';	
	document.getElementById("draw_mesh").click();
	});
    $(document).on('click', '#draw_mesh', function(){
console.log("***Enter draw_mesh");
	var mesh_container = document.getElementById('mesh_canv');

	if(!icon_regist) {
		mesh_draw=0;
		icon_regist='';
		}
	if(!mesh_draw){
			switch (icon_area.selectedIndex){
      				case 0:               
					box_size=16;
					expan=8;
					break;
      				case 1:               
					box_size=32;
					expan=8;
					break;
      				case 2:
					box_size=48;
					expan=4;               
					break;
      				case 3:
					box_size=64;
					expan=4;               
					break;
      				case 4:
					box_size=256;
					expan=1;               
					break;
      				case 5:
					box_size=400;
					expan=1;               
					break;
      				case 6:
					box_size=600;
					expan=1;               
					break;
      				case 7:
					box_size=800;
					expan=1;               
					break;
				}
console.log('icon_size selected=',icon_area.selectedIndex,'box_size=',box_size);
		// div要素を生成
		var show_area=document.getElementById('icon_show_area');
		if(!show_area) {
			var div = document.createElement('div');
			div.setAttribute('id','icon_show_area');
			// classを追加
			div.className = 'show_icon';
			var p_area = document.createElement('p');
			p_area.textContent = "icon_show area";
			div.appendChild(p_area);
			// 生成したdiv要素を追加する
			document.getElementById('tab1').appendChild(div);
			var div_b = document.createElement('div');
			div_b.setAttribute('id', 'use_icon');
			div.appendChild(div_b);
			}
		}
	if(icon_regist=='regist') {
		var result = window.prompt("symbol name:", "name");
		if(result!=null){ 
console.log('result=',result);
			var symbol = document.createElementNS('http://www.w3.org/2000/svg', 'symbol');
			var fig_id=result;
			symbol.setAttribute('id', fig_id);
			var zero=0;
			symbol.setAttribute('viewBox', `${zero} ${zero} ${box_size} ${box_size}`);
			symbol.setAttribute('preserveAspectRatio', "none");
			mesh_container.appendChild(symbol);
			target = container;
console.log("target=",target);
        			var g_temp = document.createElementNS('http://www.w3.org/2000/svg', 'g');
				var fig_id2='g'+(Date.now()).toString();
				g_temp.setAttribute('id', fig_id2);
				g_temp.setAttribute('fig', 'group');
//				container.appendChild(g_temp);
console.log('g_temp=',g_temp);
//Iconの場合はtargetはsvg00のcontainerそのもので含まれる<g>タグをすべてIconに入れる
			var shift=20;
			var divs=expan;
			simple_fig_top(g_temp,target,target,shift,divs);              //transform matrixを適用して図形simple化

console.log('g_temp,target=',g_temp,target);
/*
元々のIcon用描画は削除しない。
			while (target.lastElementChild) {
				target.removeChild(target.lastElementChild);
				}
       			while (g_temp.lastElementChild) {
				target.append(g_temp.lastElementChild.cloneNode(true));
				g_temp.removeChild(g_temp.lastElementChild);
				}
*/
console.log('g_temp2,target2=',g_temp,target);
//本システムは<g>タグ下のpath要素が基本なのでこのレベルから連結化及びSimple化を実施する
			　var back=$("#icon_back").val();
			  var wdt=$("#icon_width").val();
			  var frm=$("#icon_frame").val();

			for (k = 0; k < g_temp.childElementCount; k++) {
//				symbol.append(target.children[k].cloneNode(true));
				symbol.appendChild(g_temp.children[k].cloneNode(true));
console.log('symbol=',symbol);
				}

			var svg_a = document.createElementNS('http://www.w3.org/2000/svg','svg');
			svg_a.setAttributeNS(null,'viewBox', "0 0 200 100");
			var use_a=document.createElementNS('http://www.w3.org/2000/svg','use');
			use_a.setAttributeNS(null,'width', '25');
			use_a.setAttributeNS(null,'height', '25');
			use_a.setAttributeNS(null,'href', '#'+fig_id);
console.log('use_a=',use_a);
			svg_a.appendChild(use_a);

			var recta=createRectFig(0,0,25,25);
			if(Number(wdt)>0 && (frm!="none" || frm!='')) {
			  	recta.setAttribute('stroke', frm);
			  	recta.setAttribute('stroke-width',wdt);
				}
//			if(back!="none" || back!='') recta.setAttribute('fill',back)
			svg_a.appendChild(recta);

			var use_b=document.createElementNS('http://www.w3.org/2000/svg','use');
			use_b.setAttributeNS(null,'x', '30');
			use_b.setAttributeNS(null,'y', '0');
			use_b.setAttributeNS(null,'width', '50');
			use_b.setAttributeNS(null,'height', '50');
			use_b.setAttributeNS(null,'href', '#'+fig_id);
console.log('use_a=',use_b);
			svg_a.appendChild(use_b);

			var rectb=createRectFig(30,0,50,50);
			if(Number(wdt)>0 && (frm!="none" || frm!='')) {
			  	rectb.setAttribute('stroke', frm);
			  	rectb.setAttribute('stroke-width',wdt);
				}
//			if(back!="none" || back!='') rectb.setAttribute('fill',back)
			svg_a.appendChild(rectb);

			var use_c=document.createElementNS('http://www.w3.org/2000/svg','use');
			use_c.setAttributeNS(null,'x', '100');
			use_c.setAttributeNS(null,'y', '0');
			use_c.setAttributeNS(null,'width', '100');
			use_c.setAttributeNS(null,'height', '100');
			use_c.setAttributeNS(null,'href', '#'+fig_id);
console.log('use_a=',use_c);
			svg_a.appendChild(use_c);

			var rectc=createRectFig(100,0,100,100);
			if(Number(wdt)>0 && (frm!="none" || frm!='')) {
			  	rectc.setAttribute('stroke', frm);
			  	rectc.setAttribute('stroke-width',wdt);
				}
//			if(back!="none" || back!='') rectc.setAttribute('fill',back)
			svg_a.appendChild(rectc);

			document.getElementById('use_icon').appendChild(svg_a);   //tab1に生成したid=”use_icon”に生成したiconを書き出す
			}
		}
	else {
//最初のmeshボタンが押された場合のみmesh線を引く
		var group = document.getElementById('mesh01');
		if(group) group.remove();
        	group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
		var fig_id='mesh01';
		group.setAttribute('id', 'mesh01');
		mesh_container.appendChild(group);
console.log('***fig id= ',fig_id);
		//draw x_line
		x_last=box_size*expan+x_mesh_offset;
		y_last=box_size*expan+y_mesh_offset;
		var imod=4;
		var g_span=expan;
		if(box_size>=64) {
			imod=4;
			g_span=16;
			}
		if(box_size>=400) {
			imod=10;
			g_span=10;
			}
		var x0=x_mesh_offset,x1=x_last;
		var y0=y_mesh_offset;
		for ( var i = 0 ; y0+g_span*i <= y_last ; i++ ){
			var y=y0+g_span*i;
			var drawPoint=[];
			drawPoint.push({x: x0,y: y});
			drawPoint.push({x: x1,y: y});
			bezier_line=createPath(drawPoint,0);
			mod_i=i % imod;
			if(mod_i==0) {
				Object.assign(bezier_line.style, tempoPathStyle);
				}
			else {
				Object.assign(bezier_line.style, tempoPathStyle2);
				}
			group.appendChild(bezier_line);
			}
		//draw y_line
		var y0=y_mesh_offset,y1=y_last;
		var x0=x_mesh_offset;
		for ( var i = 0 ; x0+g_span*i <= x_last ; i++ ){
			var x=x0+g_span*i;
			var drawPoint=[];
			drawPoint.push({x: x,y: y0});
			drawPoint.push({x: x,y: y1});
			bezier_line=createPath(drawPoint,0);
			mod_i=i % imod;
			if(mod_i==0) {
				Object.assign(bezier_line.style, tempoPathStyle);
				}
			else {
				Object.assign(bezier_line.style, tempoPathStyle2);
				}
			group.appendChild(bezier_line);
			}
		mesh_draw=true;
		}
    });

    next_icon.onclick = function(){
//svg_00領域をclearする
        				while (container.lastElementChild) {
console.log('**lastChild nodename= ',container.lastElementChild.nodeName);
						if(container.lastElementChild.nodeName!='defs'){
            						container.removeChild(container.lastElementChild);
							}
						}
	icon_regist='';
//	disp_yn_check();
	document.getElementById("icon_area").click();
	}

    cancel_icon.onclick = function(){
//cancelの場合　symbol(id)と最後のuse_iconを削除する
					var canv=document.getElementById('mesh_canv');
					var last_symb=canv.querySelectorAll('symbol');
					last_symb[last_symb.length-1].remove();
					var icons=document.getElementById('use_icon');
console.log('delete last_one icons=',icons);
					icons.lastElementChild.remove();
				icon_regist='';
//				disp_yn_check();
	document.getElementById("icon_area").click();
	}

    export_symbols.onclick = function(){
//function export_symbols() {
console.log("***Enter export");
	var canv=document.getElementById("mesh_canv");
console.log('canv=',canv);
//	icons=canv.queryselectorAll('symbol');
	var tag_icons=canv.getElementsByTagName('symbol');
console.log('symbols=',tag_icons);
	var use_tag=document.getElementById("use_icon");
console.log('use_icon=',use_tag);

	svg_tag='<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">'+'\n';
console.log('outerHTML=',svg_tag);
console.log('**icons length=',tag_icons.length);
	for (nn = 0; nn < tag_icons.length; nn++) {
console.log('icon id=',tag_icons[nn].id,document.getElementById(tag_icons[nn].id));
		var tagn=document.getElementById(tag_icons[nn].id).cloneNode(true);
		svg_tag=svg_tag+tagn.outerHTML+'\n';
		}
	svg_tag=svg_tag+use_tag.outerHTML;
	svg_tag=svg_tag+'</svg>';
console.log('***svg_tag length = ', svg_tag.length);	
console.log('svg_tag=',svg_tag);
//for デモバージョン
	if(((for_cloud=='yes') || (for_demo=='yes')) && (svg_tag.length > 10000)) {
		alert('Download symbols is too large this Demo version!');
		return;
		}

	let blob = new Blob([svg_tag],{type:"svg"});
	let link = document.createElement('a');
	link.href = URL.createObjectURL(blob);
	link.download = 'symbol_files.svg';
	link.click();
	if(icon_gen_dialog) $('#icon_generate').dialog("close");
	icon_gen_dialog=0;
    }

    export_icon.onclick = function(){
//function export_icon() {
console.log("***Enter export_icon");
var box='viewBox='+'"'+'0 0 '+`${box_size}`+' '+`${box_size}`+'"';
var view_size="width="+'"'+`${box_size}`+'"'+" height="+'"'+`${box_size}`+'" '+box+' ';
console.log('view=',view_size);
	var canv=document.getElementById("mesh_canv");
	var tag_icons=canv.getElementsByTagName('symbol');
console.log('symbols=',tag_icons);
	var paths=tag_icons[tag_icons.length-1].getElementsByTagName('path');

	var waku=document.createElementNS('http://www.w3.org/2000/svg','rect');
	waku.setAttribute('x',0);
	waku.setAttribute('y',0);
	waku.setAttribute('width',box_size);
	waku.setAttribute('height',box_size);
	　var back=$("#icon_back").val();
//	  waku.setAttribute('fill',back)
	  var wdt=$("#icon_width").val();
	  var frm=$("#icon_frame").val();
	  if(Number(wdt)>0 && frm!="none") {
	  	waku.setAttribute('stroke', frm);
	  	waku.setAttribute('stroke-width',wdt);
		}
console.log('waku=',waku);
	svg_tag='<svg version="1.1" '+view_size+' xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">'+'\n';
//	svg_tag=svg_tag+waku.outerHTML+'\n';
console.log('outerHTML=',svg_tag);
console.log('**icons paths=',paths.length);
	for (nn = 0; nn < paths.length; nn++) {
//console.log('icon paths=',paths[nn]);
		var tagn=paths[nn].cloneNode(true);
console.log('style width=',tagn.style.strokeWidth);
		var width=tagn.style.strokeWidth;
		if(width && Number(width)<5) tagn.style.strokeWidth="5";
		svg_tag=svg_tag+tagn.outerHTML+'\n';
		}
	svg_tag=svg_tag+'</svg>';

console.log('***svg_tag length = ', svg_tag.length);
console.log('svg_tag=',svg_tag);
//for デモバージョン
	if(((for_cloud=='yes') || (for_demo=='yes')) && (svg_tag.length > 10000)) {
		alert('Download svg is too large this Demo version!');
		return;
		}

	let blob = new Blob([svg_tag],{type:"svg"});
	let link = document.createElement('a');
	link.href = URL.createObjectURL(blob);
	link.download = 'icon_file.svg';
	link.click();
//	if(icon_gen_dialog) $('#icon_generate').dialog("close");
//	icon_gen_dialog=0;
    }
</textarea>
<textarea id="script16"  class="special" style="display:none;">
   add_more.onclick = function(){
console.log('***sub animation');
	var theDialog=$( '#more_anime' ) . dialog( { autoOpen: false, draggable: true, resizable: true,
		height:260, width: 420,  position: {my: "right bottom", at: "right top", of: window}} );
	//ダイアログを表示する
	subanimation_dialog=1;
	add_more_type();
//	set_gradpallet();
	theDialog.dialog("open");
	}

   $('#more_anime').on('dialogclose', function(event) {
console.log('subAnimation Dialog closed');
	subanimation_dialog=0;
	});

function set_gradpallet() {
//console.log('set gradpallet ',sel,pal);
	var pal_tag=document.getElementById('grad_pallet');
	var cx=10;
	var cy=100;
	var w=40;
	var h=20;
	for(let k=0; k<5;k++){
	  let rect=createRectFig(cx,cy,w,h);
	  rect.setAttribute('stroke', 'blue');
	  rect.setAttribute('stroke-width', '1');
	  cx=cx+50;

	  //c.setAttributeNS(null,'id',sel[k][1]);
	  //if(sel[k][4]=="none") c.setAttributeNS(null,'fill','#ffffff');
          //else c.setAttributeNS(null,'fill',sel[k][4]);
	  //rect.setAttribute('stroke', 'green');
	  //rect.setAttribute('stroke-width', '1');
	  pal_tag.append(rect);
//console.log('grad pallet draw');
	  }
    }

    function animation_type() {
    	//選択したfontによって分岐
console.log('anime_type selected num=',anime_tp.selectedIndex);
    	switch (anime_tp.selectedIndex){
      		case 0:
			anime_type=0;
			font.type='startOffset';
			document.getElementById('key_time').value="0;1";
			document.getElementById('key_value').value="0;1";
			break;
      		case 1:
			anime_type=1;
			font.type='stroke-dashoffset';
			document.getElementById('key_time').value="0;1";
			document.getElementById('key_value').value="1;0";
			break;
      		case 2:
			anime_type=2;
			font.type='stroke-dashoffset';
			document.getElementById('key_time').value="0;0.5;1";
			document.getElementById('key_value').value="0;1;0";
			break;
      		case 3:
			anime_type=3;
			font.type='d';
//			document.getElementById('key_time').value="0;0.5;1";
//			document.getElementById('key_value').value="0;1;0";
			break;
		}
	}

    function moving_position() {
    	//選択したfontによって分岐
console.log('move_pos selected num=',move_pos.selectedIndex);
    	switch (move_pos.selectedIndex){
      		case 0:
			font.position=0;
			break;
      		case 1:
			font.position=1;               
			break;
      		case 2:
			font.position=2;
			break;
		}
	}

    function pare_object() {
    	//選択したfontによって分岐
console.log('move_pos selected num=',move_pos.selectedIndex);
    	switch (move_pos.selectedIndex){
      		case 0:
			pare_revers=0;
			break;
      		case 1:
			pare_revers=0;
			break;
      		case 2:
			pare_revers=1;
			break;
		}
	}

setset_animation.onclick = function(){
console.log('Enter set_animation anime_type=',anime_type);
	if(anime_fig_type=='anime_top') {
		alert('go to mend Anime');
		return;
		}
	animation_type();
	if(anime_fig_type=='anime' && anime_type!=0) {
		alert('go to mend Anime');
		return;
		}
	moving_position();
	var key_time=$("#key_time").val();
	var key_value=$("#key_value").val();
console.log('000 timing=',key_time,'values=',key_value);

	var path_st=document.getElementById('animPath').value;
console.log('set fig or textが押されました path=',path_st);
	if(anime_type==0 && path_st=='') {
		alert('not selected Path Element');
		return;
		}
    	if(anime_type==0) {
console.log('Drag_elem =',Drag_elem.nodeName,Drag_elem);
		fig_ty=Drag_elem.getAttribute('fig');
console.log('Drag_elem tyoe=',fig_ty);
		if(fig_ty=='text') set_text_animation();
		else set_figure_animation();
		}
	else if(anime_type==1 || anime_type==2) set_other_animation();
		else set_deform_animation();
	}

function set_figure_animation() {
console.log('set_fig_animeが押されました');

	var anim_durtime=$("#time_figanime").val();
	var anim_start=$("#time_figbegin").val();
console.log('anime dur_time,start_time=',anim_durtime,anim_start);
	if(!font.path) {
		alert('animation path not specify');
		return;
		}
//	var parnt=document.getElementById(font.path).parentNode;
//	var path_id=parnt.getAttribute('id');
//console.log('parent=',parnt,path_id);
	if(anim_durtime<=0.1) {
		alert('set animate time not right');
		return;
		}
console.log('Drag_elem=',Drag_elem.nodeName,Drag_elem);
	if(Drag_elem.nodeName=='g') {
		fig_id=Drag_elem.getAttribute('id');
		}
//	if(!fig_id || path_id==fig_id) {
	if(!fig_id) {
		alert('selected figure is not proper');
		return;
		}
		var offx=-drag.center_x;
		var offy=-drag.center_y;
    		switch (font.position){
      			case 0:               
				offy=offy+drag.hf_height;
				break;
      			case 1:
				break;
      			case 2:
				offy=offy-drag.hf_height;
				break;
		}
		var parm=`${offx},${offy}`;
		var transf="translate("+parm+")";
		Drag_elem.setAttribute('transform', transf);
		Drag_elem.removeAttribute('opacity');

//useタグを作る場合
	var key_time=$("#key_time").val();
	var key_value=$("#key_value").val();
	var len1=(key_time.split(';')).length;
	var len2=(key_value.split(';')).length;
	if(len1!=len2) {
		alert('timing length and value length not match');
		return;
		}

	var use_node = document.createElementNS('http://www.w3.org/2000/svg', 'use');
	use_node.setAttribute('xlink:href','#'+fig_id);
	var anime_node = document.createElementNS('http://www.w3.org/2000/svg', 'animateMotion');
	anime_node.setAttribute('repeatCount', "indefinite");
	anime_node.setAttribute('rotate', "auto");
	anime_node.setAttribute('dur', String(anim_durtime)+"s");
	anime_node.setAttribute('begin', String(anim_start)+"s");
	anime_node.setAttribute('keyTimes',key_time);
	anime_node.setAttribute('keyPoints',key_value);
	var mpath_node = document.createElementNS('http://www.w3.org/2000/svg', 'mpath');
	mpath_node.setAttribute('xlink:href','#'+font.path);
	anime_node.appendChild(mpath_node);
	use_node.appendChild(anime_node);
console.log('new_use_node=',use_node);
//	if(last_anime_node=="") {
		var anime_group= document.createElementNS('http://www.w3.org/2000/svg', 'g');
		anime_group.setAttribute('fig', "anime");
		fig_id='g'+(Date.now()).toString();
		anime_group.setAttribute('id', fig_id);
		anime_group.appendChild(former_path_tag);
		container.appendChild(anime_group);
		last_anime_node=anime_group;
//		}
console.log('last_node,former path=',last_anime_node,former_path_tag);
	last_anime_node.appendChild(use_node);

	var angle=document.getElementById('path_angle').value;
	if(angle) tilt_anime(angle,anime_group);

	document.getElementById("start_anime").click();
	}

    function tilt_anime(angle,anime_group) {
	var angle=document.getElementById('path_angle').value;
	if(angle){
		var old_transf=anime_group.getAttribute('transform');
		if(old_transf==null) old_transf='';
		var rect_a=anime_group.getBoundingClientRect();
		let w=rect_a.right-rect_a.left;
		let h=rect_a.bottom-rect_a.top;
		var pnt2=svgPoint(anime_group, rect_a.left, rect_a.top);
		var cntx=pnt2.x+w/2;
		var cnty=pnt2.y+h/2;
console.log('****angle cntx cnty=',angle,cntx,cnty);
		var rol_parm=`${angle},${cntx},${cnty}`;
console.log('rotate transform=',rol_parm);
		var transf="rotate("+rol_parm+")"+old_transf;
		anime_group.setAttribute('transform',transf);
		}
	}

function set_text_animation() {
console.log('set_text_Animeが押されました');
//最初にｇタグ下のtextタグを取り出して、その下にある<span>タグを取り出して置く
	var anim_durtime=$("#time_figanime").val();
	var anim_start=$("#time_figbegin").val();
console.log('anime dur_time,start_time=',anim_durtime,anim_start);
	if(anim_durtime<=0.1) {
		alert('set animate time not right');
		return;
		}
//textタグを含む親タグの<g>タグ=Drag_elemはmv_nodeとして確保
	var tx=Drag_elem.querySelector('text');
	var rect=Drag_elem.querySelector('rect');
	Drag_elem.setAttribute("transform", "");
	var tspan=tx.querySelector('tspan');
	tspan.setAttributeNS(null,'x', '0');
	tspan.setAttributeNS(null,'y', '0');
	rect.remove();
//ここでtextPathを作り、そのchildタグにspanタグとanimateタグを入れる
	var textpath = document.createElementNS('http://www.w3.org/2000/svg', 'textPath');
	var path_st=document.getElementById('animPath').value;
	textpath.setAttributeNS(null,'href', '#'+path_st);
	textpath.setAttributeNS(null,'startOffset', '0%');
	textpath.appendChild(tspan);
console.log('textpath=',textpath);

	if(anim_durtime>0) {
		var key_time=$("#key_time").val();
		var key_value=$("#key_value").val();
		var len1=(key_time.split(';')).length;
		var len2=(key_value.split(';')).length;;
		if(len1!=len2) {
			alert('timing length and value length not match');
			return;
			}
		key_value=key_value.split(';');
		var values="";
		for(k=0;k<len2;k++) {
			values=values+String(100*key_value[k])+'%;';
			}
		values=values.slice(0,-1);
console.log('values=',values);
		var anime_node = document.createElementNS('http://www.w3.org/2000/svg', 'animate');
		anime_node.setAttribute('attributeName', "startOffset");
		anime_node.setAttribute('keyTimes',key_time);
		anime_node.setAttribute('values',values);
//		anime_node.setAttribute('from', "0%");
//		anime_node.setAttribute('to', "100%");
		anime_node.setAttribute('repeatCount', "indefinite");
		anime_node.setAttribute('calcMode', "linear");
		anime_node.setAttribute('dur', String(anim_durtime)+"s");
		anime_node.setAttribute('begin', String(anim_start)+"s");
//親要素.appendChild(追加要素)
		textpath.appendChild(anime_node);
		tx.appendChild(textpath);

//		if(last_anime_node=="") {
			var anime_group= document.createElementNS('http://www.w3.org/2000/svg', 'g');
			anime_group.setAttribute('fig', "anime");
			fig_id='g'+(Date.now()).toString();
			anime_group.setAttribute('id', fig_id);
			anime_group.appendChild(former_path_tag);
			container.appendChild(anime_group);
			last_anime_node=anime_group;
//			}
console.log('former path=',former_path_tag);
		last_anime_node.appendChild(tx);

		var angle=document.getElementById('path_angle').value;
		if(angle) tilt_anime(angle,anime_group);

		}
	}

function set_other_animation() {
console.log('set_other_Animeが押されました');
	if(anime_fig_type=='anime') {
		alert('go to mend Anime');
		return;
		}
	var anim_durtime=$("#time_figanime").val();
	var anim_start=$("#time_figbegin").val();
console.log('anime dur_time,start_time=',anim_durtime,anim_start);
	if(anim_durtime<=0.1) {
		alert('set animate time not right');
		return;
		}

	var tags=Drag_elem.querySelectorAll('path');
console.log('path_tags leng=',tags.length,tags,Drag_elem);

	if(anim_durtime>0) {
		var anime_group= document.createElementNS('http://www.w3.org/2000/svg', 'g');
		anime_group.setAttribute('fig', "anime");
		fig_id='g'+(Date.now()).toString();
		anime_group.setAttribute('id', fig_id);
		container.appendChild(anime_group);
console.log('added to container=',container);
		}

	for(i=0;i<tags.length;i++) {
		var error=set_anime_types(tags[i]);
		if(error) break;
		}
	var rect=Drag_elem.querySelectorAll('rect');
console.log('rect=',rect);
	for(k=rect.length-1;k>=0;k--) {
		rect[k].remove();
		}
	anime_group.appendChild(Drag_elem);
console.log('before start anime_type=',anime_type);

	var angle=document.getElementById('path_angle').value;
	if(angle)　tilt_anime(angle,anime_group);

	if(anime_type==2) document.getElementById("start_anime").click();
	}

function set_deform_animation() {
console.log('set_deform_Animeが押されました');
//最初にｇタグ下のtextタグを取り出して、その下にある<span>タグを取り出して置く
	var anim_durtime=$("#time_figanime").val();
	var anim_start=$("#time_figbegin").val();
console.log('anime dur_time,start_time=',anim_durtime,anim_start);
	if(anim_durtime<=0.1) {
		alert('set animate time not right');
		return;
		}
console.log('deform_path=',deform_path);
	if(deform_path.length<2) {
		alert('selected deform path not proper!');
		return;
		}

	if(anim_durtime>0) {
		}

	var anime_node = document.createElementNS('http://www.w3.org/2000/svg', 'animate');
	var value='';
	for(i=0;i<deform_path.length;i++) {
		var tag=document.getElementById(deform_path[i]);
		var path_d=tag.getAttribute("d");
console.log('path =',i,tag,tag.parentNode);
		value=value+path_d+';';
		(tag.parentNode).style.display='none';
		}
	var styl=tag.getAttribute("style");
	r_value='';
    if(pare_revers) {
	for(i=deform_path.length-1;i>=0;i--) {
		var tag=document.getElementById(deform_path[i]);
		var path_d=tag.getAttribute("d");
console.log('path =',i,tag,tag.parentNode);
		r_value=r_value+path_d+';';
		}
	    }
	deform_path=[];

	anime_node.setAttribute('attributeType', "XML");
	anime_node.setAttribute('attributeName', "d");
//	anime_node.setAttribute('keyTimes',key_time);
	anime_node.setAttribute('repeatCount', "indefinite");
//	anime_node.setAttribute('calcMode', "linear");
	anime_node.setAttribute('dur', String(anim_durtime)+"s");
//	anime_node.setAttribute('begin', String(anim_start)+"s");
	anime_node.setAttribute('values',value);

	var anime_group= document.createElementNS('http://www.w3.org/2000/svg', 'g');
	anime_group.setAttribute('fig', "anime");
//	var fig_id='g'+(Date.now()).toString();
//	anime_group.setAttribute('id', fig_id);
//console.log('new fig_id=',fig_id);
        var anime_path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
	anime_path.setAttribute('style',styl);
	anime_path.appendChild(anime_node);
	anime_group.appendChild(anime_path);
	if(pare_revers) {
		var r_anime_group = anime_group.cloneNode(true);
console.log('r_anime_group=',r_anime_group);
		r_anime_group.firstChild.firstChild.setAttribute('values',r_value);
		}
	last_anime_node=anime_group;
	var anime_top= document.createElementNS('http://www.w3.org/2000/svg', 'g');
	anime_top.setAttribute('fig', "anime");
	anime_top.setAttribute('deform', deform_parms);
	fig_id='g'+(Date.now()).toString();
	anime_top.setAttribute('id', fig_id);
	anime_top.appendChild(anime_group);
	if(pare_revers) anime_top.appendChild(r_anime_group);
	container.appendChild(anime_top);
	deform_parms="";
	}

function set_anime_types(tags) {
	var anim_durtime=$("#time_figanime").val();
	var anim_start=$("#time_figbegin").val();

	var key_time=$("#key_time").val();
	var key_value=$("#key_value").val();
console.log('timing=',key_time,'values=',key_value);
	var len1=(key_time.split(';')).length;
	var len2=(key_value.split(';')).length;
console.log('timing=',key_time,'values=',key_value,' len1&len2=',len1,len2);
	if(len1!=len2) {
		alert('timing length and value length not match');
		return 1;
		}
	var fig_id=tags.getAttribute('id');
console.log('old fig_id=',fig_id);
	if(!fig_id) {
		fig_id='p'+(Date.now()).toString();
		tags.setAttribute('id', fig_id);
console.log('new fig_id=',fig_id);
		}
	var path_id=fig_id;

	var anime_node = document.createElementNS('http://www.w3.org/2000/svg', 'animate');

	switch (anime_tp.selectedIndex){
      		case 1:
			font.type='stroke-dashoffset';

			var value = tags.getTotalLength();
			value=Math.round(Number(value/10)*10);
console.log('value=',value);
			var styl=tags.getAttribute('style');            //style指定必要な場合
			styl=styl+' stroke-dasharray:'+value+';';
			tags.setAttribute('style', styl);

			key_value=key_value.split(';');
			var values="";
			for(k=0;k<len2;k++) {
				values=values+String(value*key_value[k])+';';
				
				}
			values=values.slice(0,-1);
console.log('values=',values);
			break;
      		case 2:
			font.type='stroke-dashoffset';

			var value = tags.getTotalLength();
			value=Math.round(Number(value/10)*10);
console.log('value=',value);
			var mask_node = document.createElementNS('http://www.w3.org/2000/svg', 'mask');
			var mask_id='m'+(Date.now()).toString();
			mask_node.setAttribute('id',mask_id);

			//tags.removeAttribute('id');
			var mask_path=tags.cloneNode(true);
			mask_path.removeAttribute('stroke-dasharray');
			mask_path.removeAttribute('id');

			var m_path_id='q'+(Date.now()).toString();
			mask_path.setAttribute('id',m_path_id);
			path_id=m_path_id;
			var styl=mask_path.getAttribute('style');            //style指定必要な場合
			var styl_char=[];
			if(styl!=null) sty_char=styl.split(';');
console.log(sty_char);
			styl="";
			if(sty_char.length>0) {
				for(let i=0;i<sty_char.length;i++) {
					let splt=sty_char[i].split(':');
					splt[0]=splt[0].trim();
					if(splt[0]!='stroke' && splt[0]!='stroke-dasharray' && splt[0]!='') styl=styl+sty_char[i]+';';
					}
				}
			styl=styl+'stroke:#fff;'+'stroke-dasharray:'+value+';'+'stroke-dashoffset:'+value+';';
			mask_path.setAttribute('style', styl);
			mask_node.appendChild(mask_path);
//mask="url(#svgAnimationMask)"
			tags.setAttribute('mask', "url(#"+mask_id+")");
			tags.parentNode.prepend(mask_node);
			key_value=key_value.split(';');
			var values="";
			for(k=0;k<len2;k++) {
				values=values+String(value*key_value[k])+';';
				}
			values=values.slice(0,-1);
console.log('values=',values);
			break;
		default:
			return 2;
			break;
		}

//	var anime_node = document.createElementNS('http://www.w3.org/2000/svg', 'animate');
	anime_node.setAttribute('attributeName', font.type);
console.log('**path_id=',path_id);
	anime_node.setAttribute('xlink:href','#'+path_id);
	anime_node.setAttribute('keyTimes',key_time);
	anime_node.setAttribute('values',values);
//	anime_node.setAttribute('from', key_value);
//	anime_node.setAttribute('to', "0");
	anime_node.setAttribute('repeatCount', "indefinite");
	anime_node.setAttribute('calcMode', "linear");
	anime_node.setAttribute('dur', String(anim_durtime)+"s");
	anime_node.setAttribute('begin', String(anim_start)+"s");
//親要素.appendChild(追加要素)
	var rect=tags.querySelector('rect');
	if(rect) rect.remove();
	tags.parentNode.appendChild(anime_node);
	last_anime_node=tags.parentNode;
console.log('parent=',tags.parentNode);
	return 0;
	}

    get_anime_Path.onclick = function(){
console.log('get_anime_pathが押されました');
	if(Drag_elem) {
		Drag_elem.style.display='block';
		var tags=Drag_elem.querySelector('path');
console.log('path_tags=',tags);
		var deltag=Drag_elem.querySelector('rect');
		if(deltag) deltag.remove();
		if(!tags) {
			alert('not selected Path Element');
			return;
			}
		else {
			var fig_id=tags.getAttribute('id');
console.log('old fig_id=',fig_id);
			if(!fig_id) {
				fig_id='p'+(Date.now()).toString();
				tags.setAttribute('id', fig_id);
console.log('new fig_id=',fig_id);
				}
			font.path=fig_id;
			document.getElementById('animPath').value=font.path;
console.log('path id=',font.path);
			if(anime_type==3) {
				deform_path.push(fig_id);
				var p_id=Drag_elem.getAttribute('id');
				deform_parms=deform_parms+p_id+',';
console.log('deform_path=',deform_path.length,deform_path);
				}
			}
		former_path_tag=Drag_elem;
		}
	else {
		alert('not selected Path Element');
		return;
		}
	}

    function add_more_type() {
//元dialogでのamine_tagを設定していない場合　last_anime_node==""の場合
	former_anime_tag="";
	if(Drag_elem) last_anime_node=Drag_elem;
	var rect=last_anime_node.getBoundingClientRect();
console.log('rect=',rect);
//	getrect_shape(rect_node);
//console.log('shape center=',drag.center_x,drag.center_y)

	var center_x=Math.round(Number((rect.left+rect.width/2)*10)/10);
	var center_y=Math.round(Number((rect.top+rect.height/2)*10)/10);
console.log('center=',center_x,center_y);

console.log('anime_type selected num=',anime_tp.selectedIndex);
    	switch (more_tp.selectedIndex){
      		case 0:
			more_anime_type=0;
			document.getElementById('more_key_time').value="0;0.5;1";
			var parm1=String(-100)+',0';
			var parm2=String(100)+',0';
			document.getElementById('more_key_value').value=parm1+';'+parm2+';'+parm1;
			break;
      		case 1:
			more_anime_type=1;
			document.getElementById('more_key_time').value="0;1";
			var parm=String(center_x)+','+String(center_y);
			document.getElementById('more_key_value').value='0 '+parm+';'+'360 '+parm;
			break;
      		case 2:
			more_anime_type=2;
			color_val='';
			document.getElementById('more_key_time').value="";
			document.getElementById('more_key_value').value="";
			break;
		}
	}

    more_animation.onclick = function(){
console.log('Enter set_more_animation last_anime=',last_anime_node);
//最初にｇタグ下のtextタグを取り出して、その下にある<span>タグを取り出して置く
	var anim_durtime=$("#time_more").val();
	var anim_start=$("#time_morebegin").val();
	var more_time=$(more_key_time).val();
console.log('anime dur_time,start_time=',anim_durtime,anim_start);
	if(anim_durtime<=0.1) {
		alert('set animate time not right');
		return;
		}

	if(anim_durtime>0) {
/*
		var my_anime=last_anime_node.getAttribute('fig','anime_top');
		if(!my_anime){
			my_anime = document.createElementNS('http://www.w3.org/2000/svg', 'g');
			my_anime.setAttribute('fig','anime_top');
			fig_id='g'+(Date.now()).toString();
			my_anime.setAttribute('id', fig_id);
console.log('anime_top fig_id=',fig_id);
			container.appendChild(my_anime);
console.log('added to container=',container);
			}
*/
		}

	if(Drag_elem) last_anime_node=Drag_elem;

	if(more_anime_type==0 || more_anime_type==1) {
		var anime_node = document.createElementNS('http://www.w3.org/2000/svg', 'animateTransform');
		}
	else {
		var anime_node = document.createElementNS('http://www.w3.org/2000/svg', 'animate');
		}

	var anime_group= document.createElementNS('http://www.w3.org/2000/svg', 'g');
	anime_group.setAttribute('fig', "anime");
	fig_id='g'+(Date.now()).toString();
	anime_group.setAttribute('id', fig_id);
console.log('new fig_id=',fig_id);

	var value=document.getElementById('more_key_value').value;
console.log('color_val,value=',value,color_val);
	anime_node.setAttribute('attributeType', "XML");
	anime_node.setAttribute('repeatCount', "indefinite");
//	anime_node.setAttribute('calcMode', "linear");
	anime_node.setAttribute('dur', String(anim_durtime)+"s");
//	anime_node.setAttribute('begin', String(anim_start)+"s");

console.log('more type=',more_anime_type);
	if(more_anime_type==0 || more_anime_type==1) {
		anime_node.setAttribute('attributeName', "transform");
		if(more_anime_type==0) anime_node.setAttribute('type', "translate");
		else anime_node.setAttribute('type', "rotate");
		anime_node.setAttribute('values',value);
		anime_node.setAttribute('keyTimes',more_time);
		if(last_anime_node) {
			var node_id=last_anime_node.getAttribute('id');
			var node=document.getElementById(node_id);
console.log('move node=',node);
			anime_group.appendChild(node);
			}
		anime_group.appendChild(anime_node);
		}
	if(more_anime_type==2) {
		anime_node.setAttribute('attributeName', "fill");
console.log('222color_val,value=',value,color_val);
		anime_node.setAttribute('values',value);
		var pnode=last_anime_node.querySelector('path');
console.log('path_node=',pnode);
		pnode.appendChild(anime_node);
		anime_group.appendChild(last_anime_node);
		}
	container.appendChild(anime_group);
	last_anime_node=anime_group;
console.log('set last_anime_node=',last_anime_node);
	}

   var color_val='';
   c_add_palt01.onclick = function(){
	color_val=color_val+'#E60012;';
	document.getElementById('more_key_value').value=color_val;
	}
   c_add_palt02.onclick = function(){
	color_val=color_val+'#F39800;';
	document.getElementById('more_key_value').value=color_val;
	}
   c_add_palt03.onclick = function(){
	color_val=color_val+'#FFF100;';
	document.getElementById('more_key_value').value=color_val;
	}
   c_add_palt04.onclick = function(){
	color_val=color_val+'#8FC31F;';
	document.getElementById('more_key_value').value=color_val;
	}
   c_add_palt05.onclick = function(){
	color_val=color_val+'#009944;';
	document.getElementById('more_key_value').value=color_val;
	}
   c_add_palt06.onclick = function(){
	color_val=color_val+'#009E96;';
	document.getElementById('more_key_value').value=color_val;
	}
   c_add_palt07.onclick = function(){
	color_val=color_val+'#00A0E9;';
	document.getElementById('more_key_value').value=color_val;
	}
   c_add_palt08.onclick = function(){
	color_val=color_val+'#0068B7;';
	document.getElementById('more_key_value').value=color_val;
	}
   c_add_palt09.onclick = function(){
	color_val=color_val+'#1D2088;';
	document.getElementById('more_key_value').value=color_val;
	}
   c_add_palt10.onclick = function(){
	color_val=color_val+'#920783;';
	document.getElementById('more_key_value').value=color_val;
	}
   c_add_palt11.onclick = function(){
	color_val=color_val+'#E4007F;';
	document.getElementById('more_key_value').value=color_val;
	}
   c_add_palt12.onclick = function(){
	color_val=color_val+'#E5004F;';
	document.getElementById('more_key_value').value=color_val;
	}

   p_disp_on.onclick= function(){
//   function p_disp_onoff(v_path){
console.log('**display on/off called');
	var disp_path_id=document.getElementById('animPath').value;
	var disp_path=document.getElementById(disp_path_id);
console.log('disp_path=',disp_path);
//	v_path = (typeof v_path !== 'undefined') ?  v_path : Drag_elem;
//	var disp_path=v_path;

	var styl=disp_path.getAttribute('style');            //style指定必要な場合
	var sty_char=[];
	if(styl!=null) sty_char=styl.split(';');
console.log(sty_char)
	styl="";
	var path_disp_on_off=1;
	if(sty_char.length>0) {
		let splt=sty_char[0].split(':');
		if(splt[1]=='none') path_disp_on_off=0;
		}
console.log('style=',sty_char,'disp_on=',path_disp_on_off);

	if(path_disp_on_off) {
		styl=styl+'display:none;'; 
		path_disp_on_off=0;
		document.getElementById('p_disp_on').value="disp_on";
		}
	else {
		styl=styl+'display:block;';
		path_disp_on_off=1;
		document.getElementById('p_disp_on').value="disp_off";
		}
	disp_path.setAttribute('style', styl);
    }

    start_anime.onclick = function(){
console.log('start_animeが押されました');
	fgedit.selectedIndex=3;
	chng_mode();
	fgedit.selectedIndex=2;
	chng_mode();
      }

   function select_anime_tag() {
console.log('Check tags Tags No.=',select_mend_node,svg_mend_tags);
	var mend_tag=svg_mend_tags[select_mend_node]; 
console.log('mend_tag=',mend_tag);

   	var node_type=check_animetype(mend_tag);
console.log('anime_type=',node_type);
	document.getElementById('anim_tag_num').value=String(select_mend_node+1);
	switch (node_type){
		case "path_along_g":
			document.getElementById('mend_time_figanime').value=mend_tag.getAttribute('dur');
			document.getElementById('time_figbegin').value=mend_tag.getAttribute('begin');
			document.getElementById('mend_key_time').value=mend_tag.getAttribute('keyTimes');
			document.getElementById('mend_key_value').value=mend_tag.getAttribute('keyPoints');
			var parent=mend_tag.parentNode;
			var svg_node=(parent.getAttribute('xlink:href')).slice(1);
			svg_edit_node=document.getElementById(svg_node);
			var rect_a=svg_edit_node.getBoundingClientRect();
			var w=rect_a.right-rect_a.left;
			var h=rect_a.bottom-rect_a.top;
			var pnt2=svgPoint(svg_edit_node, rect_a.left, rect_a.top);
			rect01=createRectFig(pnt2.x,pnt2.y,w,h);
//			rect01.setAttribute('id', 'rect01');
			rect01.setAttribute('fig', 'temp');
			svg_edit_node.appendChild(rect01);
			former_parent=svg_edit_node;
			break;
		case "path_along_tx":
		case "one-stroke":
		case "draw_hide":
		case "path_deform":
		case "translate":
		case "rotate":
		case "gradation":
			document.getElementById('mend_time_figanime').value=mend_tag.getAttribute('dur');
			document.getElementById('mend_time_figbegin').value=mend_tag.getAttribute('begin');
			document.getElementById('mend_key_time').value=mend_tag.getAttribute('keyTimes');
			document.getElementById('mend_key_value').value=mend_tag.getAttribute('values');
			var parent=mend_tag.parentNode;
			var rect_a=parent.parentNode.getBoundingClientRect();
			var w=rect_a.right-rect_a.left;
			var h=rect_a.bottom-rect_a.top;
			var pnt2=svgPoint(parent.parentNode, rect_a.left, rect_a.top);
			var rect01=createRectFig(pnt2.x,pnt2.y,w,h);
//			rect01.setAttribute('id', 'rect01');
			rect01.setAttribute('fig', 'temp');
			Drag_elem.appendChild(rect01);
			former_parent=Drag_elem;
			break;
		}
	}

   function former_animetype() {
	var mend_tag=Drag_elem.querySelector('animate,animateMotion,animateTransform');
	var parent=mend_tag.parentNode;
	var attr=mend_tag.getAttribute('attributeName');

	if(parent.nodeName=='use')  {                       //animateMotion and <g> along the pass
		var tagn=parent.querySelector('mpath');
		var svg_node=(tagn.getAttribute('xlink:href')).slice(1);
		return type;
		}
	if(parent.nodeName=='textPath') {                        //animate and <text> along the pass
		var svg_node=(parent.getAttribute('href')).slice(1);
		return type;
		}
	}


   function check_animetype(mend_tag) {
	var type="";
	var parent=mend_tag.parentNode;
	var attr=mend_tag.getAttribute('attributeName');

	if(parent.nodeName=='use')  {                       //animateMotion and <g> along the pass
		document.getElementById('mend_anime_type').value="go along the path";
		type="path_along_g";
		return type;
		}
	if(parent.nodeName=='textPath') {                        //animate and <text> along the pass
		document.getElementById('mend_anime_type').value="go along the path";
		type="path_along_tx";
		return type;
		}
	if(mend_tag.nodeName=='animate' && attr=="d") {        //animate attributeName="d" deform
		document.getElementById('mend_anime_type').value="path deformation";
		type="path_deform";
		return type;
		}		
	if(mend_tag.nodeName=='animate' && attr=="fill") {        //animate 	gradation
		document.getElementById('mend_anime_type').value="gradation";
		type="gradation";
		return type;
		}
	if(mend_tag.nodeName=='animate' && attr=="stroke-dashoffset") {        
		var mask_tag=parent.querySelector('mask');
		if(mask_tag) {						//draw and hide	
			document.getElementById('mend_anime_type').value="draw and hide";
			type="draw_hide";
			return type;
			}	  
		else { 								//animate maskを含まないone-stroke-write
			document.getElementById('mend_anime_type').value="one-stroke writing";
			type="one-stroke";
			return type;
			}
		}
	if(mend_tag.nodeName=="animateTransform") {        //animateTansform   transform
		var attr_type=mend_tag.getAttribute('type');
		if(mend_tag.nodeName=='animate' && attr_type=="rotate") {  //animateTansform   transform and rotate
			document.getElementById('mend_anime_type').value="rotate";
			type="rotate";
			return type;
			}	  		    
		else { 								//animate maskを含まないone-stroke-write
			document.getElementById('mend_anime_type').value="translate";
			type="translate";
			return type;
			}
		}
	return type;
	}

   modify_parms.onclick=function() {
console.log('Enter to modify parms mend tags No.=',select_mend_node,svg_mend_tags);
	var mend_tag=svg_mend_tags[select_mend_node]; 
console.log('mend_tag and Drag_elem=',mend_tag,Drag_elem);

   	var node_type=check_animetype(mend_tag);
console.log('anime_type=',node_type);
	document.getElementById('anim_tag_num').value=String(select_mend_node+1);
	switch (node_type){
		case "path_along_g":
			mend_tag.setAttribute('dur',document.getElementById('mend_time_figanime').value);
			var begin=document.getElementById('time_figbegin').value;
			if(begin) mend_tag.setAttribute('begin',begin);
			else mend_tag.removeAttribute('begin');
			mend_tag.setAttribute('keyTimes',document.getElementById('mend_key_time').value);
			var value=document.getElementById('mend_key_value').value;
			if(value) mend_tag.setAttribute('keyPoints',value);
			else mend_tag.removeAttribute('keyPoints');
			break;
		case "path_deform":
			mend_tag.setAttribute('dur',document.getElementById('mend_time_figanime').value);
			var begin=document.getElementById('time_figbegin').value;
			if(begin) mend_tag.setAttribute('begin',begin);
			else mend_tag.removeAttribute('begin');
			break;
		case "path_along_tx":
		case "one-stroke":
		case "draw_hide":
		case "translate":
		case "rotate":
		case "gradation":
			var dura=document.getElementById('mend_time_figanime').value;
			if(dura) mend_tag.setAttribute('dur',dura);
			var begin=document.getElementById('mend_time_figbegin').value;
			if(begin) mend_tag.setAttribute('begin',begin);
			else mend_tag.removeAttribute('begin');
			var times=document.getElementById('mend_key_time').value;
			if(times) mend_tag.setAttribute('keyTimes',times);
			var value=document.getElementById('mend_key_value').value;
			if(value) mend_tag.setAttribute('values',value);
			break;
		}
	}

   remove_all_anime.onclick = function(){
console.log('Enter remove_all_anime');
	var core_tag=Drag_elem;
	var mend_tag=null;
	var mend_tag=Drag_elem.querySelector('animate,animateMotion,animateTransform');
	while(mend_tag){
		var parent=mend_tag.parentNode;
		if(parent.nodeName=='use') {    //use idを元の位置に戻す
			var fig_id=parent.getAttribute('xlink:href');
			fig_id=fig_id.slice( 1 ) ;
			var fig_tag=document.getElementById(fig_id);
console.log('anime tag=',fig_id,fig_tag);
			fig_tag.setAttribute("transform", "translate(0,0)");
			parent.remove();
			}
		var attr_d=mend_tag.getAttribute('attributeName');
console.log('mend_tag and attributeName=',mend_tag,attr_d);
		if(mend_tag.nodeName=='animate' && attr_d=="d") {
			var def_path=parent.parentNode.parentNode.getAttribute('deform');
			if(def_path==null) def_path="";
console.log('def_path,node=',def_path,parent.parentNode.parentNode);
			var pathes=def_path.split(',');
console.log('pathes=',pathes);
			for(let k=0;k<pathes.length;k++) {
				if(pathes[k]) {
					var path_tag=document.getElementById(pathes[k]);
					path_tag.style.display="block";
					}
				}
			parent.parentNode.parentNode.remove();
			}
		else {
			var mask_tag=parent.querySelector('mask');
			if(mask_tag) {
				mask_tag.remove();
				var path_tag=parent.querySelector('path');
				if(path_tag) path_tag.removeAttribute("mask");
				}
  			mend_tag.remove();
			mend_tag=parent.querySelector('animate,animateMotion,animateTransform');
console.log('tag in parent=',mend_tag,parent);
			if(mend_tag==null) {
				var fig=parent.getAttribute('fig');
console.log('parent and Drag=',parent,Drag_elem);
				if(fig=='anime' && parent!=Drag_elem) {
					var grand=parent.parentNode;
					var old_transf=grand.getAttribute('transform');
					if(old_transf==null) old_transf="";
					var len=parent.childNodes.length;
					for(let k=len;k>0;k--) {
						var tagn=parent.childNodes[k-1];
						var add_transf=tagn.getAttribute('transform');
						if(add_transf==null) add_transf="";
						var transf=old_transf+add_transf;
						if(transf) tagn.setAttribute("transform",transf);
console.log('move_tag=',tagn);
						$(tagn).insertAfter(parent);
						}
					parent.remove();
console.log('parent removed');
					}
				}
			}
		var mend_tag=Drag_elem.querySelector('animate,animateMotion,animateTransform');
console.log('animeNode and Drag_elem=',mend_tag,Drag_elem);
		}
	var rect=former_parent.querySelector('rect');
	if(rect) rect.remove();
	var fig=Drag_elem.getAttribute('fig');
	var old_transf=Drag_elem.getAttribute('transform');
	if(old_transf==null) old_transf="";
console.log('Drag=',Drag_elem);
	if(fig=='anime' || fig=='anime_top') {
		var len=Drag_elem.childNodes.length;
		for(let k=len;k>0;k--) {
			var tagn=Drag_elem.childNodes[k-1];
			var add_transf=tagn.getAttribute('transform');
			if(add_transf==null) add_transf="";
			var transf=old_transf+add_transf;
			if(transf) tagn.setAttribute("transform",transf);
console.log('move_tag=',tagn);
			$(tagn).insertAfter(Drag_elem);
			}
		Drag_elem.remove();
		}
console.log('Drag_elem removed');
	}

   remove_one_anime.onclick = function() {
console.log('Check tags Tags No.=',select_mend_node,svg_mend_tags);
	var mend_tag=svg_mend_tags[select_mend_node]; 
console.log('mend_tag=',mend_tag);

   	var node_type=check_animetype(mend_tag);
console.log('anime_type=',node_type);
	document.getElementById('anim_tag_num').value=String(select_mend_node+1);
	switch (node_type){
		case "path_along_g":
			var parent=mend_tag.parentNode;
			var fig_id=parent.getAttribute('xlink:href');
			fig_id=fig_id.slice( 1 ) ;
			var fig_tag=document.getElementById(fig_id);
console.log('anime tag=',fig_id,fig_tag);
			fig_tag.setAttribute("transform", "translate(0,0)");
			parent.remove();
			break;
		case "path_along_tx":
		case "one-stroke":
			mend_tag.remove();
			break;
		case "draw_hide":
			var parent=mend_tag.parentNode;
			var mask_tag=parent.querySelector('mask');
			if(mask_tag) {
				mask_tag.remove();
				var path_tag=parent.querySelector('path');
				if(path_tag) path_tag.removeAttribute("mask");
				}
  			mend_tag.remove();
			break;
		case "path_deform":
			var parent=mend_tag.parentNode;
			var attr_d=mend_tag.getAttribute('attributeName');
console.log('mend_tag and attributeName=',mend_tag,attr_d);
			if(mend_tag.nodeName=='animate' && attr_d=="d") {
				var def_path=parent.parentNode.parentNode.getAttribute('deform');
				if(def_path==null) def_path="";
console.log('def_path,node=',def_path,parent.parentNode.parentNode);
				var pathes=def_path.split(',');
console.log('pathes=',pathes);
				for(let k=0;k<pathes.length;k++) {
					if(pathes[k]) {
						var path_tag=document.getElementById(pathes[k]);
						path_tag.style.display="block";
						}
					}
				parent.parentNode.parentNode.remove();
				}
			break;
		case "translate":
		case "rotate":
		case "gradation":
			mend_tag.remove();
			break;
		}
	var mend_tagn=Drag_elem.querySelector('animate,animateMotion,animateTransform');
console.log('animeNode and Drag_elem=',mend_tagn,Drag_elem);
	var rect=Drag_elem.querySelector('rect');
	if(rect) rect.remove();
	var fig=Drag_elem.getAttribute('fig');
	var old_transf=Drag_elem.getAttribute('transform');
	if(old_transf==null) old_transf="";
	if(mend_tagn==null && (fig=='anime' || fig=='anime_top')) {
		var len=Drag_elem.childNodes.length;
		for(let k=len;k>0;k--) {
			var tagn=Drag_elem.childNodes[k-1];
			var add_transf=tagn.getAttribute('transform');
			if(add_transf==null) add_transf="";
			var transf=old_transf+add_transf;
			if(transf) tagn.setAttribute("transform",transf);
console.log('move_tag=',tagn);
			$(tagn).insertAfter(Drag_elem);
			}
		Drag_elem.remove();
		}
	}

  $("#svg_tag_next").on("click", function(){
console.log('Nextが押されました');
	var max_num=svg_mend_tags.length;

	var nn=select_mend_node+1;
	if(nn<max_num) {
		select_mend_node=nn;
		var rect=former_parent.querySelector('rect');
		if(rect) rect.remove();
//console.log('before select_anime_tag=',select_mend_node);
		select_anime_tag();
//console.log('after select_anime_tag=',select_mend_node);
		}
	});

  $("#svg_tag_back").on("click", function(){
console.log('Backが押されました');
	var max_num=svg_mend_tags.length;

	var nn=select_mend_node-1;
	if(nn>=0) {
		select_mend_node=nn;
		var rect=former_parent.querySelector('rect');
		if(rect) rect.remove();
//console.log('before select_anime_tag=',select_mend_node);
		select_anime_tag();
//console.log('after select_anime_tag=',select_mend_node);
		}
	});
</textarea>
<textarea id="script17"  class="special" style="display:none;">
/*
//mouseup時の処理
//    var hand_up=org_container.addEventListener('mouseup', draw_up,false);
document.onmouseup = function (e) {
console.log('mouse up');
		var range=window.getSelection();
		if(range!='') {
console.log('selection=',range);
			}
　　　　	++Up_count;
		drag.isMouseDown = false;
　　　　	if(mouse_Error) {
　　　　　　		mouse_Error=false;
　　　　　　		Up_count=0;
　　　　　　		}
　　　　	if(Move_mode) {
console.log('canceled Move_mode');
    			switch (Draw_mode){
      		 	   case 'Aux':
console.log('** element drag stop');
				drag.isMouseDown = false;
				draw_op.aux_pos=e.clientX;
				break;
      			   case 'Basic':
	  		    default:
console.log('** element draw stop');
				draw_up(e);
				break;
				}
			Move_mode=0;
			Up_count=0;
console.log('After basic_moveup=',Up_count);
   			}
//	disp_yn_check();
    }//mouseup end]
*/

    function disp_yn_check() {
    	if((for_cloud=='yes') || (for_demo=='yes')) ch_check_func();
	}

    function ch_check_func() {
console.log('####### enter check func for_cloud,for_demo=',for_cloud,for_demo);
	var flag=some_check();
	if(flag==0 && ch_check_flag==1) {
console.log('none To disp old & flag=',ch_check_flag,flag);
		let menyu_dispnone = document.getElementById('fgedit');
		menyu_dispnone.options[3].style.display="block";
		document.getElementById('mail_to_who').style.display="inline";
		document.getElementById('Exp').style.display="inline";
		document.getElementById('send_to_yourPc').style.display="inline";
		document.getElementById('export_symbols').style.display="inline";
		document.getElementById('export_icon').style.display="inline";
		ch_check_flag=0;
		}
	else if(flag==1 && ch_check_flag==0) {
console.log('disp To none old & flag=',ch_check_flag,flag);
		let menyu_dispnone = document.getElementById('fgedit');
		menyu_dispnone.options[3].style.display="none";
		document.getElementById('mail_to_who').style.display="none";
		document.getElementById('Exp').style.display="none";
		document.getElementById('send_to_yourPc').style.display="none";
		document.getElementById('export_symbols').style.display="none";
		document.getElementById('export_icon').style.display="none";
		ch_check_flag=1;
		}
    }

    function some_check() {
	var flag=0;

	var canv=document.getElementById("mesh_canv");
	var tags=canv.getElementsByTagName('symbol');
	if(tags.length>0) {
		flag=1;
console.log('symbol detected tags=',tags);
		return flag;
		}

	tags=document.querySelector('animate');
	if(tags) {
		flag=1;
console.log('animate detected tags=',tags);
		return flag;
		}

	tags=document.querySelector('animateMotion');
	if(tags) {
		flag=1;
console.log('animateMotion detected tags=',tags);
		return flag;
		}
	return flag;
	}
</textarea>
{% include 'db_serv/footer.html' %}
